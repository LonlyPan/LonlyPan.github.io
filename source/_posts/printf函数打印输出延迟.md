---
layout: post
title:  "printf函数打印输出延迟"
date:   2019-05-15 22:46
categories: 单片机
---

最近编写 STM32 的 USART 函数是遇到了一个问题，重定义 printf 函数时，单独在主函数循环执行输出可以正常及时输出信息，但当加上延时函数，间断输出信息时，出现了延时输出的现象：等待一段时间后，一次性输出之前的所有信息，这期间无任何输出。且这个等待时间随着延时增减而增加。遂在网上查询到了解决方法：
<!--more-->
问题出在 printf 涉及到的缓冲机制上，最初，printf() 语句会把输出先发送到一个叫**缓冲区（buffer）**的中间存储区域，然后缓冲区中的内容在不断发送到屏幕上。而缓冲区只会在以下5种情况下刷新：

 - 使用fflush（stdout）强制刷新标准输出缓冲区 
 - 缓冲区已满 
 - `scanf()`要在缓冲区里取数据时会先将缓冲区刷新 
 - \n进入缓冲区时
 - 程序结束时

对于printf 函数而言，它只是将打印内容输出到标准输出流中 stdout，而一般 stdout 是行缓冲机制，遇到 \n 才会刷新缓冲区，输出到打印设备。如果将输出重定向到文件，那么 \n 不会刷新，得等到缓冲区满才刷新，这时候就会出现输出延迟的问题。

可以通过以下方法解决：

1. 在主函数前添加 `setvbuf(stdout,NULL,_IONBF,0);` 作用是在整个项目中禁止缓存的功能
2. 在printf函数之后添加`fflush(stdout);` 强制刷新缓冲区

参考文章：  
[如何解决printf日志输出延迟问题](https://blog.csdn.net/LuyaoYing001/article/details/79750905)  
[printf函数打印延时现象](https://blog.csdn.net/u011073673/article/details/81632783)






