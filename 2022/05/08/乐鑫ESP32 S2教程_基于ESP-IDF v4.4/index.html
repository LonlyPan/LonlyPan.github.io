

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="LonlyPan">
  <meta name="keywords" content="LonlyPan个人站，LonlyPan，Lonly，致简，丢了幸福的猪，逍遥勿忘心安">
  
    <meta name="description" content="个人教程，第一次制作，有配套视频教程，bilibili个人空间：合集和列表，文章章节顺序和列表一致。">
<meta property="og:type" content="article">
<meta property="og:title" content="乐鑫ESP32 S3教程_基于ESP-IDF v5.0">
<meta property="og:url" content="http://lonlypan.com/2022/05/08/%E4%B9%90%E9%91%ABESP32%20S2%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF%20v4.4/index.html">
<meta property="og:site_name" content="LonlyPan个人站">
<meta property="og:description" content="个人教程，第一次制作，有配套视频教程，bilibili个人空间：合集和列表，文章章节顺序和列表一致。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/乐鑫ESP32_S2教程_基于ESP-IDF_v4.4/ESP32_S2教程封面-合集.png">
<meta property="article:published_time" content="2022-05-08T11:23:00.000Z">
<meta property="article:modified_time" content="2023-02-22T15:23:00.000Z">
<meta property="article:author" content="LonlyPan">
<meta property="article:tag" content="LonlyPan个人站，LonlyPan，Lonly，致简，丢了幸福的猪，逍遥勿忘心安">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/乐鑫ESP32_S2教程_基于ESP-IDF_v4.4/ESP32_S2教程封面-合集.png">
  
  
  <title>乐鑫ESP32 S3教程_基于ESP-IDF v5.0 - LonlyPan个人站</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"lonlypan.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"f56279d43c733d547ea06f75f8e05d89","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>LonlyPan的博客站</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/books/">
                <i class="iconfont icon-book"></i>
                书影
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                朋友
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="乐鑫ESP32 S3教程_基于ESP-IDF v5.0"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-05-08 19:23" pubdate>
          2022年5月8日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          88k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          738 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">乐鑫ESP32 S3教程_基于ESP-IDF v5.0</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2023年2月22日 晚上
                  
                
              </p>
            
            <div class="markdown-body">
              
              <p>个人教程，第一次制作，有配套视频教程，bilibili个人空间：<a target="_blank" rel="noopener" href="https://space.bilibili.com/94050349/channel/series">合集和列表</a>，文章章节顺序和列表一致。</p>
<span id="more"></span>
<h1 id="内容简介"><a href="#内容简介" class="headerlink" title="内容简介"></a>内容简介</h1><p>本手册将由浅入深，带领大家学习 ESP32-S3-WROOM-1-N16R8模组（ESP32-S3） 的各个功能，为您开启 ESP32-S3 的学习<br>之旅。本手册总共分为三篇： </p>
<ol>
<li>硬件篇：主要介绍本手册配套的硬件平台（开发板）；</li>
<li>软件篇：主要介绍ESP32-S3常用开发软件的使用以及一些下载调试的技巧，并详细介绍了几个常用的系统文件（程序）；</li>
<li>实战篇，主要通过 n 个实例（绝大部分都是使用 EDP-IDF 库完成的）带领大家一步步深入了解 ESP32-S3。</li>
</ol>
<p>本手册为 ESP32-S3-WROOM-1-N16R8模组的配套教程，有详细原理图以及所有实例的完整代码，这些代码都有详细的注释，所有源码都经过我们严格测试，不会有任何警告和错误，另外，源码有我们生成好的 hex 文件，大家只需要通过仿真器下载到开发板即可看到实验现象，亲自体验实验过程。</p>
<p>本手册不仅非常适合广大学生和电子爱好者学习  ESP32-S3-WROOM-1-N16R8模组，其大量的实验以及详细的解说，也是公司产品开发的不二参考</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="01-开发板"><a href="#01-开发板" class="headerlink" title="01-开发板"></a>01-开发板</h2><p>使用<a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=a230r.1.14.1.283f2d6cAjCT7l&id=669443108979&ns=1&abbucket=6#detail">源地ESP32-S3核心板</a><br>也可以购买复刻版：<a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?_u=fpkffgdda1e&id=695554257902">ESP32 S3核心板</a></p>
<p>N16R8（16M 外扩flash&#x2F;8M PSRAM）&#x2F;双Type-C USB口&#x2F;W2812 rgb&#x2F;高速USB转串口<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v4.4/1676468214198.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v4.4/ESP32-S3-0702_9_.PNG" srcset="/img/loading.gif" lazyload alt="ESP32-S3-0702 _9_"></p>
<h2 id="02-模组资料：模组和芯片关系"><a href="#02-模组资料：模组和芯片关系" class="headerlink" title="02-模组资料：模组和芯片关系"></a>02-模组资料：模组和芯片关系</h2><p>简单来说，模组包含芯片，是一个最小系统，我们只需要模组供电，并引出引脚等，就构成了开发板。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/image.jpg" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>如下图所示，单独的芯片时不能直接工作的，还需要外接晶振、Flash（基本所有的ESP32都是没有内部flash的，都需要外接flash工作）等才能正常工作</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677294268773.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="02-资料获取"><a href="#02-资料获取" class="headerlink" title="02-资料获取"></a>02-资料获取</h2><p>牢记：官网是最佳的学习渠道</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.espressif.com.cn/zh-hans/support/documents/technical-documents">官方技术文档下载中心</a></li>
</ul>
<p>以下是从官网提取的关于S3芯片的几个重要文档，其它文档（如硬件设计指南等）请去上面文档中心下载</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.espressif.com/sites/default/files/documentation/esp32-s3_datasheet_cn.pdf">ESP32 S3芯片技术规格书</a></li>
<li><a target="_blank" rel="noopener" href="https://www.espressif.com/sites/default/files/documentation/esp32-s3_technical_reference_manual_cn.pdf">ESP32-S3 芯片技术参考手册</a></li>
<li><a target="_blank" rel="noopener" href="https://www.espressif.com/sites/default/files/documentation/esp32-s3-wroom-1_wroom-1u_datasheet_cn.pdf">ESP32-S3-WROOM-1 模组技术规格书</a></li>
</ul>
<p>另外还有一个最重要的在线文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/index.html">ESP-IDF 编程指南</a></li>
<li>pdf格式文档-英文：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/esp-idf-en-v5.1-dev-3619-g57b6be22a7-esp32s3.pdf">下载</a></li>
</ul>
<p>推荐访问在线文档，该文档随时都会更新。另外轻易英文内容为准，中文的可能有翻译错误和更新延迟。</p>
<p>官方开发板资料：（产品开发参考，初学者不用看）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/hw-reference/esp32s3/user-guide-devkitc-1.html">ESP32-S3-DevKitC-1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/espressif/esp-box">ESP32-S3-BOX</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/espressif/esp-who/blob/master/docs/en/get-started/ESP32-S3-EYE_Getting_Started_Guide.md">ESP32-S3-EYE</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/espressif/esp-skainet/blob/master/docs/en/hw-reference/esp32s3/user-guide-korvo-1.md">ESP32-S3-Korvo-1</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-adf/zh_CN/latest/get-started/user-guide-esp32-s3-korvo-2.html">ESP32-S3-Korvo-2</a></li>
</ul>
<h2 id="03-例程创建和项目文件结构介绍"><a href="#03-例程创建和项目文件结构介绍" class="headerlink" title="03-例程创建和项目文件结构介绍"></a>03-例程创建和项目文件结构介绍</h2><ul>
<li>新建工程<ul>
<li>示例</li>
<li>默认</li>
<li>文件夹介绍（基本）</li>
<li>ESP IDF介绍</li>
<li>RTOS</li>
</ul>
</li>
</ul>
<h2 id="04-GPIO引脚介绍"><a href="#04-GPIO引脚介绍" class="headerlink" title="04-GPIO引脚介绍"></a>04-GPIO引脚介绍</h2><p>参考资料：</p>
<ul>
<li>ESP32­S3­WROOM 技术规格书</li>
<li>ESP32-S3 系列芯片 技术规格书</li>
</ul>
<p>我们已经知道芯片模组是在芯片基础上添加外设得来的。所以其中的部分引脚是被外设芯片占用了，是无法使用的。<br>参考下列芯片和模组引脚对比，我们可以发现</p>
<ul>
<li>模组少了GPIO26-32，GPIO33-34引脚<br>我们从芯片引脚介绍得知，GPIO26-32用于内部falsh&#x2F;PSRAM通信<br>另外我们在模组的最下面介绍也得知：在带有 OSPI PSRAM（即内置芯片为 ESP32-S3xxR8）的模组中，管脚 IO35、 IO36、 IO37 用于连接至模组内部集成的 OSPI PSRAM，不可用于其他功能</li>
<li>部分引脚只能作为单输入、输出的。GPIO39、41、42、44只能输入、无高阻态<br> GPIO26、29、30、40、43、47、48只能输出，其中43无高阻态</li>
<li>当WIFI一致保持连接时，ADC2不可用<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680676644231.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>我们可以继续查看下面的关系表，可以发现</li>
<li>对于八线SPI（内置R8 PSRAM），GPIO26-37都不可使用</li>
<li>对于八线已下的，GPIO26-32都不可使用<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680677098426.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>那么GPIO22-34引脚去哪了呢，查看模组原理图，发现</li>
<li>GPIO22-34官方并没有被引出来<br>所以如果我们使用的是八线以下的falsh&#x2F;PSRAM，那么这两个引脚就被浪费了，所以我们自己设计模组时，是可以使用这两个引脚的，这样就相对于官方模组额外多了两个引脚（仅限八线以下的falsh&#x2F;PSRAM）<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680676995114.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<p>另外我们还要看另一组特殊的IO口，Strapping 管脚 。</p>
<ul>
<li>GPIO0</li>
<li>GPIO45</li>
<li>GPIO46</li>
<li>GPIO3<br>芯片每次上电或复位时，都需要一些初始配置参数，如加载芯片的启动模式、 flash 存储器的电压等。这些参数通过 strapping 管脚控制。复位放开后， strapping 管脚和普通 IO 管脚功能相同。<br>芯片复位时， strapping 管脚在复位时控制以下参数：<br>• 芯片启动模式 – GPIO0 和 GPIO46<br>• VDD_SPI 电压 – GPIO45<br>• ROM 代码日志打印 – GPIO46<br>• JTAG 信号源 – GPIO3<br>总之请确保这些引脚在上电时，都能处于默认配置值。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680686239146.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<p><strong>总结：</strong></p>
<ul>
<li>对于八线SPI（内置R8 PSRAM），GPIO26-37都不可使用</li>
<li>对于八线以下的，GPIO26-32都不可使用</li>
<li>Strapping 管脚上电保持默认值</li>
<li>使用USB下载时，软件会自动复位芯片，并进入boot下载模式。GPIO0不要有外部上拉，否则无法自动下载</li>
<li>GPIO22-34在官方模组中并没有被引出来</li>
<li>EN引脚，上拉，上电使能芯片</li>
</ul>
<h3 id="ESP32-C3"><a href="#ESP32-C3" class="headerlink" title="ESP32 C3"></a>ESP32 C3</h3><p>对于内置flash版本的，以下引脚不可用<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/flash%E5%BC%95%E8%84%9A.jpg" srcset="/img/loading.gif" lazyload alt="flash引脚"><br>GPIO11不可用<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680697605040.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>GPIO2、8、9为 strapping 管脚，GPIO9 内部默认弱上拉</p>
<ul>
<li>实测GPIO2悬空也能用，但最好外部上拉</li>
<li>GPIO8必须外部上拉，否则无法进入boot下载模式<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680697215544.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<h2 id="05-IO-MUX-和-GPIO-交换矩阵"><a href="#05-IO-MUX-和-GPIO-交换矩阵" class="headerlink" title="05-IO MUX 和 GPIO 交换矩阵"></a>05-IO MUX 和 GPIO 交换矩阵</h2><p>ESP32-S3 芯片有 45 个物理通用输入输出管脚 (GPIO Pin)。每个管脚都可用作一个通用输入输出，或连接一个<br>内部外设信号。利用 GPIO 交换矩阵、IO MUX 和 RTC IO MUX，可配置外设模块的输入信号来源于任何的 GPIO<br>管脚，并且外设模块的输出信号也可连接到任意 GPIO 管脚。这些模块共同组成了芯片的输入输出控制。</p>
<blockquote>
<p>注意：这 45 个物理 GPIO 管脚的编号为：0 ~ 21、26 ~ 48。这些管脚既可作为输入又可作为输出管脚。</p>
</blockquote>
<h3 id="GPIO-交换矩阵特性"><a href="#GPIO-交换矩阵特性" class="headerlink" title="GPIO 交换矩阵特性"></a>GPIO 交换矩阵特性</h3><ul>
<li>GPIO 交换矩阵是外设输入输出信号和 GPIO 管脚之间的全交换矩阵；</li>
<li>175 个数字外设输入信号可以选择任意一个 GPIO 管脚的输入信号；</li>
<li>每个 GPIO 管脚的输出信号可以来自 184 个数字外设输出信号的任意一个；</li>
<li>支持输入信号经 GPIO SYNC 模块同步至 APB 时钟总线；</li>
<li>支持输入信号滤波；</li>
<li>支持 Sigma Delta 调制输出 (SDM)；</li>
<li>支持 GPIO 简单输入输出。</li>
</ul>
<h3 id="IO-MUX-特性"><a href="#IO-MUX-特性" class="headerlink" title="IO MUX 特性"></a>IO MUX 特性</h3><p>• 为每个 GPIO 管脚提供一个寄存器 IO_MUX_GPIOn_REG，每个管脚可配置成：<br>– GPIO 功能，连接 GPIO 交换矩阵；<br>– 直连功能，旁路 GPIO 交换矩阵。<br>• 支持快速信号如 SPI、JTAG、UART 等可以旁路 GPIO 交换矩阵以实现更好的高频数字特性。所以高速信号会直接通过 IO MUX 输入和输出</p>
<h3 id="RTC-IO-MUX-特性"><a href="#RTC-IO-MUX-特性" class="headerlink" title="RTC IO MUX 特性"></a>RTC IO MUX 特性</h3><p>• 控制 22 个 RTC GPIO 管脚的低功耗特性；<br>• 控制 22 个 RTC GPIO 管脚的模拟功能；<br>• 将 22 个 RTC 输入输出信号引入 RTC 系统</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681051710765.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>GPIO 交换矩阵就是说所有的外设都可以映射到设疑引脚，但有的速度可能会慢些</li>
<li>IO MUX 特指GPIO功能和部分外设直连。不经过GPIO交换矩阵，速度快，性能好，但只支持部分外设（目前只有SPI和UART）</li>
<li>RTC与低功耗和模拟输入输出有关，和IO MUX平级</li>
<li>在设计时，优先使用IO MUX引脚功能，在使用GPIO 交换矩阵</li>
<li>在程序编程时，软件会自动匹配，无需配置IO MIX和GPIO矩阵</li>
</ul>
<p>以下有两张表说明GPIO 交换矩阵和IO MUX 区别<br>IO MUX管教表格就说明引脚的一般功能，非常类似于一般STM32的引脚图，这里的功能0-4说的就是引脚的不能复用功能，不需要经过内部的GPIO矩阵，速度快，性能好<br>ESP32­S3 技术参考手册：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681052328794.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>外设管脚分配表，说明除了ADC、触摸、SPI0&#x2F;1 外设，其它的外设都可以映射到任意引脚<br>ESP32-S3 系列芯片 技术规格书<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681052787157.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h1 id="环境篇"><a href="#环境篇" class="headerlink" title="环境篇"></a>环境篇</h1><h2 id="Espressif-IDE简介与安装"><a href="#Espressif-IDE简介与安装" class="headerlink" title="Espressif-IDE简介与安装"></a>Espressif-IDE简介与安装</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Espressif IDE 是乐鑫基于 Eclipse CDT，专为乐鑫物联网开发框架 ESP-IDF 打造的独立集成开发环境 (Integrated Development Environment, IDE)，支持用户使用 ESP-IDF 实现端到端物联网应用开发。</p>
<p>Espressif IDE 附带最新的 ESP-IDF Eclipse 插件、基本的 Eclipse CDT 插件、OpenOCD 插件以及其他来自 Eclipse 平台的第三方插件，以支持构建 ESP-IDF 应用程序。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1676987553649.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>ESP IDF 是乐鑫官方推出的物联网开发框架（类似标准库或HAL库）</p>
<p><strong>Espressif IDE 的主要特性</strong></p>
<ul>
<li>在 Eclipse CDT 环境下构建，易于使用</li>
<li>专为 ESP-IDF 应用程序开发而打造</li>
<li>集成编译所需的 ESP 工具链配置</li>
<li>可自动配置编译环境变量</li>
<li>提供新建项目向导以及 ESP-IDF 快速入门模板</li>
<li>具备领先的的编辑、编译以及语法着色功能</li>
<li>配有预建的函数头和函数定义导航</li>
<li>支持安装一个全新的 ESP-IDF 或是配置现有的 ESP-IDF</li>
<li>可直接从 IDE 中安装和配置 ESP-IDF 工具</li>
<li>配有用于项目设置的 SDK 配置编辑器</li>
<li>集成 CMake 编辑器，用于编辑 CMake 文件，如 CMakeLists.txt</li>
<li>支持基于 CMake 的编译系统</li>
<li>支持通过 UART 和 JTAG 烧录</li>
<li>支持自定义的 ESP-IDF OpenOCD 调试功能，包含预配置和设置</li>
<li>支持 GDB 硬件调试</li>
<li>集成 ESP-IDF 串行监视器，用于查看程序的串行输出</li>
<li>配备预置编译环境变量的 ESP-IDF 终端</li>
<li>配备应用程序大小分析编辑器，用于分析应用程序的静态内存使用情况</li>
<li>支持堆分析，用于进行内存分析并发现内存泄漏</li>
<li>支持 Panic 模式下 GDB Stub 调试</li>
<li>提供应用层跟踪，以便使用启动和停止命令，分析程序行为</li>
<li>支持 ESP32、ESP32-S2、ESP32-S3 和 ESP32-C3 系列芯片</li>
<li>支持中英文</li>
<li>具备可扩展性，适用于 Eclipse 生态体系中的其他第三方插件</li>
<li>支持 Windows、macOS 和 Linux 操作系统</li>
</ul>
<p>Espressif-IDE 离线安装器，集成了 OpenJDK、Python、CMake、Git、ESP-IDF、Eclipse IDE、IDF Eclipse 插件及相关构建工具，类似与Keil。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>下载：<a target="_blank" rel="noopener" href="https://dl.espressif.cn/dl/esp-idf/?idf=4.4">Espressif-IDE 离线安装器</a><br>如果上述链接失效，可按下述方法找到：</p>
<ol>
<li>进入<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/index.html">ESP-IDF 编程指南</a></li>
<li>左侧栏，找到手动安装，单击右侧链接进入下载界面<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1676986539661.png" srcset="/img/loading.gif" lazyload alt="3."></li>
</ol>
<p>这里选择 <strong>espressif-ide-setup-2.8.1-with-esp-idf-5.0</strong> 离线安装包，包含IDE和IDF。上面第一个选项是在线安装，会很慢，不推荐<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/image.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li>双击下载的安装包，开始安装<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677066678273.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>语言默认中文，点击<strong>确定</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677066547246.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>同意协议，单击<strong>下一步</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677070188632.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>等待软件完成系统检查（如果检查有问题则无法安装，需要根据提示解决相应问题），单击下一步<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677070216736.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>选择安装路径。<strong>注意路径一定不要有中文、括号、空格及其它字符</strong><br> <strong>强烈建议保持默认路径及C盘不动，否则后续在编译和调试可能会出现一系列离谱错误，所以请保持默认路径不要动。光软件安装测试就用了两周时间的吐血教训！</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679409094136.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>选择组件，我们选择<strong>完全安装</strong>，单击<strong>下一步</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677070528143.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>单击 <strong>安装</strong>，软件即开始自动安装，这个过程可能又10-30min，请耐心等待，中途不要退出安装或关机（最好什么都不要操作）<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677070627287.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>安装完成，这里默认勾选所有，单击<strong>完成</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677070693424.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>之后软件会自动运行类似下面的命令行，我们等待最后一行出现 <code>esp-idf</code> 字段时（此时命令行已停止自动运行），右上角❌关闭命令行即可<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677070758002.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>此时桌面会出现三个软件图标，我们只需要使用 <strong>Espressif IDE</strong> 就行了，另两个不用关心<br> <img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677071231020.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ol>
<h2 id="新建工程与工程结构讲解"><a href="#新建工程与工程结构讲解" class="headerlink" title="新建工程与工程结构讲解"></a>新建工程与工程结构讲解</h2><p>打开并运行软件，会提示我们选择工作空间，工作空间相当于一个存档，保存了IDE的相关设置，如字体、排版、界面设置等自定义设置。如果下一次换了一个工作空间位置，软件就会恢复到默认设置。</p>
<p>工作空间的目的在于协作，我们将工程文件和工作空间文件夹一同发给别人，另一个人打开软件时，在下面界面就可以选择我们发送的那个工作空间文件夹，这样别人就能保持和你一样的软件设置，放置不同人使用的软件不用，导致一些位置错误。</p>
<p>这里我们时第一次使用，保持默认即可。你也可以自定义位置<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679194613824.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>首次运行会显示欢迎界面，这里有两个很重要的链接，不过如果你点击链接后，会直接在软件中打开，而不是浏览器打开，你也可以通过下方的链接访问</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/espressif/idf-eclipse-plugin/blob/master/README_CN.md">Espressif-IDE Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/index.html">ESP-IDF 编程指南-中文</a></li>
</ul>
<p>第一个链接其实是 ESP-IDF Eclipse 插件的使用说明，但我们的Espressif-IDE就是基于Eclipse 的，所以也可以阅读参考学习IDE的使用<br>第二个链接就是关于ESP-IDF的教程了，类似于标准库或HAL库，这是官方教程， 是最好的学习资料，当然本教程也是基于官方资料讲解，并且更加细、易懂，欢迎大家学习参考</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/image_1_.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>关闭欢迎界面，来到主窗口，主要分为5个区域</p>
<ol>
<li>菜单栏</li>
<li>项目浏览器，显示项目文件</li>
<li>编辑页面，编写代码的地方</li>
<li>信息栏，包含有信息窗口、查找、错误信息等关于工程和代码的信息</li>
<li>辅助栏，类似信息栏，也会显示部分信息，主要帮助理解代码结构的，必须显示一些类、函数名、全局变量等</li>
</ol>
<p>以上窗口的详细介绍，会在后续的教程内容中逐步讲解<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677074804627.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>大家可能也注意到，我们安装时，选择了中文，但这里的界面只有部分时中文，这个是官方还没汉化完全，所以只能这么使用了<br>特别提醒大家，在菜单栏是有更改语言的选项的，但请<strong>不要点击！不要点击！不要点击！</strong> 否则软件会直接崩溃，彻底无法打开，只能重装软件。这是IDE软件已知有的bug了，至今还未修复。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677075285286.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="新建样例工程"><a href="#新建样例工程" class="headerlink" title="新建样例工程"></a>新建样例工程</h3><p>工程结构：<br><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/ddb67ebf28bfe7fecce6a2368">https://xie.infoq.cn/article/ddb67ebf28bfe7fecce6a2368</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40500005/article/details/113840391">https://blog.csdn.net/qq_40500005/article/details/113840391</a></p>
<ol>
<li>有两种方式新建工程，如下图所示</li>
</ol>
<ul>
<li>通过项目浏览器中的快捷链接</li>
<li>左上角 <strong>File</strong> - &gt; <strong>New</strong> -&gt;  <strong>乐鑫IDF项目</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677074767312.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<ol start="2">
<li>输入项目名 <code>SampleProject</code>，并选择项目存放位置，我们建议给项目新建一个文件夹 <code>01-SampleProject</code>，另外<strong>注意路径不要有中文、空格、括号等</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677077335557.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>选择模板，这里我们选择官方提供的 <code>sample_project</code> 项目模板（至于为什么要使用模板，待会就会讲到），单击 <strong>Finish</strong> 完成工程创建<br> 在这里我们也可以看到，官方提供了很多模板例程，这是一个很好的学习资料，大家可以自行尝试不同模板例程。<blockquote>
<p>使用模板创建工程，有一个问题就是，IDE会自动修改项目名称。所以你需要在这里再次手动修改项目名</p>
</blockquote>
</li>
</ol>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677077564989.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>4. 以下就是我们的工程了。此时 main.c 里只有一个主函数，还没有任何功能。<br>   同时也可以发现，程序中会有波浪线，和其它错误警告，在下面的编译完成后，就会都消失的<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677077700612.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>这里我们可以发现，主程序并不是常见的 <code>main</code>，而是 <code>app_main</code>，这是因为esp32默认待 Free RTOS 系统，关于该操作系统后面涉及时在讲解；对于初学，只需要把它当成 <code>main</code> 函数就行了。<img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95.jpg" srcset="/img/loading.gif" lazyload alt="项目目录"></p>
<h3 id="编译和下载"><a href="#编译和下载" class="headerlink" title="编译和下载"></a>编译和下载</h3><ol start="5">
<li>在编译前我们需要选择目标芯片。单击齿轮图标<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078067775.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>IDF目标选择芯片类型 <code>esp32s3</code><blockquote>
<p>注意这里一定要先选择芯片型号，IDE有时会抽风，会自动变更这里的芯片型号，所以每次编译前最好都确认下。</p>
</blockquote>
</li>
</ol>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078239625.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>7. 单击左上角锤子图标，编译程序<br>   编译就是将我们编写的程序变成可以在芯片上运行的文件，然后可以被我们下载到芯片中，芯片才能工作。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078273263.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>8. 我们可以在控制台（Console）窗口看到编译过程，同时在其右下角看到编译进度条。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078430451.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>9. 编译完成，我们可以看到0个错误、0个警告，说明我们的程序没有任何问题，可以下载了。如果这里有错误我们就需要根据提示修复错误，警告看情况修复。<br>    我们也可以在该窗口看到程序文件大小、占用内存大小等信息。<br>    编译完成后，程序中一开始的那些警告、波浪线也会随之消失<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078731730.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>同时在工程名，右键，可以打开快捷菜单，打开 应用程序内存分析<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677158442918.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>可以更加直观的观察到内存占用情况<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677158536155.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>10. 下载。点击芯片类型边的齿轮图标<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078898832.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>11. 在串口号选择开发板串口号。如果不确定是那个端口，可以插拔一下开发板，有变动的端口就是我们需要确定的端口号。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677078097687.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>12. 单击开始图标，开始下载<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677079011588.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>13. 在控制台窗口，可以观看到下载进度。最后一行显示 <strong>Done</strong> 表示下载完成<br>      由于我们程序中什么都没有，因此下载后，开发板并没有任何反应。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677079075614.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>如果下载时遇到如下错误提示：<br>说明串口被其它软件（串口调试助手等）占用了，断开该软件的连接，重新下载即可</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">A</span> fatal error occurred: Could not open COM9, the port doesn&#x27;t exist<br><br><span class="hljs-attribute">CMake</span> Error at run_serial_tool.cmake:<span class="hljs-number">55</span> (message):<br>  <br>  <span class="hljs-attribute">python</span>;;C:/Espressif/frameworks/esp-idf-v5.<span class="hljs-number">0</span>/components/esptool_py/esptool/esptool.py;--chip;esp32s3<br>  <span class="hljs-attribute">failed</span><br><br><br><span class="hljs-attribute">FAILED</span>: CMakeFiles/flash D:/<span class="hljs-number">00</span>-learning/<span class="hljs-number">010</span>-ESP32/S3/<span class="hljs-number">2</span>_sources/<span class="hljs-number">05</span>-Log/build/CMakeFiles/flash <br><br><span class="hljs-attribute">cmd</span>.exe /C <span class="hljs-string">&quot;cd /D C:\Espressif\frameworks\esp-idf-v5.0\components\esptool_py &amp;&amp; C:\Espressif\tools\cmake\3.24.0\bin\cmake.exe -D IDF_PATH=C:/Espressif/frameworks/esp-idf-v5.0 -D SERIAL_TOOL=python;;C:/Espressif/frameworks/esp-idf-v5.0/components/esptool_py/esptool/esptool.py;--chip;esp32s3 -D SERIAL_TOOL_ARGS=--before=default_reset;--after=hard_reset;write_flash;@flash_args -D WORKING_DIRECTORY=D:/00-learning/010-ESP32/S3/2_sources/05-Log/build -P C:/Espressif/frameworks/esp-idf-v5.0/components/esptool_py/run_serial_tool.cmake&quot;</span><br><br><span class="hljs-attribute">ninja</span>: build stopped: subcommand failed.<br><br><span class="hljs-attribute">ninja</span> failed with exit code <span class="hljs-number">1</span>, output of the command is in the d:\<span class="hljs-number">00</span>-learning\<span class="hljs-number">010</span>-esp32\s3\<span class="hljs-number">2</span>_sources\<span class="hljs-number">05</span>-log\build\log\idf_py_stderr_output_5680 and d:\<span class="hljs-number">00</span>-learning\<span class="hljs-number">010</span>-esp32\s3\<span class="hljs-number">2</span>_sources\<span class="hljs-number">05</span>-log\build\log\idf_py_stdout_output_5680<br></code></pre></td></tr></table></figure>
<h3 id="新建默认工程"><a href="#新建默认工程" class="headerlink" title="新建默认工程"></a>新建默认工程</h3><p>步骤和上面类似。只是在模板选择界面，我们保持默认，不选择任何模板，直接点击 Finish 完成工程创建<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677158681308.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>可以看到，默认工程中，main函数中是有一个打印函数的，打印函数的功能就是将其中的字符串通过串口发送给电脑，我们可以通过串口助手查看到开发板发送的信息<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677158721461.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>如下所示，串口波特率默认115200<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1677158824071.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h2><p>之所叫导入教程，是因为IDE的bug，无法正常打开工程</p>
<ol>
<li>按照一般如Eclipse和STM32CubeIDE使用方式，我们直接点击 <strong>从文件系统打开工程</strong><br>  <img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217079133.jpg" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>选择我们的工程文件夹，不要勾选main文件<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217142118.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>否则你的mian文件夹也会出现 .project 文件。如果你的已经有了，直接删除即可<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217195936.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>你会发现，无论怎么编译，你的工程都会有这个波浪线，提示错误和警告。所以该方法导入项目并不可行<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217408699.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ol>
<p>我们选择另一种可行方案，导入工程</p>
<ol>
<li>按以下来个那种方式，都可以，单击导入 <strong>import</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217587342.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>选择 <strong>乐鑫 -&gt; 现有IDF项目</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217642183.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>单击<strong>浏览</strong>选择项目文件夹。单击<strong>Finish</strong>完成导入<br> <img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217712322.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>此时编译就不会有任何错误了<br> <img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679217792777.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ol>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>要启用调试功能，需要先配置ESP-IDF工具</p>
<p>如果后续编译时遇到如下报错“</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">ninja:</span> <span class="hljs-keyword">error</span>: loading <span class="hljs-comment">&#x27;build.ninja&#x27;: esp32</span><br></code></pre></td></tr></table></figure>
<p>按下面教程重新安装ESP-IDF工具即可。一般都是因为windows系统自动更新导致的，更换工作空间也会导致这个错误。</p>
<blockquote>
<p>至于为什么这样做，我也不知道，只知道按下面操作才能启动调试功能。参考视频 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1D8411Y7Vz/?share_source=copy_web&vd_source=8ebff88ae6397c9ea01f30029bc60928">【乐鑫开发者大会-13】在 Espressif-IDE 中使用 ESP-IDF 开发应用】</a>，3分35秒开始</p>
</blockquote>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679412350559.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>然后选择使用文件系统现有ESP-IDF，选择软件安装目录下的文件夹，如果你的软件默认在C盘，路径应该和下图一致<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679412423265.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>Yess<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679412428834.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>保持默认，点击 <strong>安装工具</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679412440813.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>等待系统下载安装完成，这个过程可能很慢或者失败，一般半小时左右。如果半小时还没动静，建议关闭软件重新安装。右下角是进度条<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679413054380.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>显示如下，标志安装完成<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679413036536.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>安装完成，<strong>重启电脑。一定要重启电脑。</strong><br>重新打开软件，可能会弹出如下提示，点击 <strong>是</strong> 即可。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679413448639.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>在工程名下拉，选择<strong>New Launch Configuration</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679414163305.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>单击 <strong>Debug</strong>，选择  <strong>ESP-IDF GDB OpenOCD Debugging</strong> 这里是配置调试工具，<strong>Next</strong><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679414244524.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>Main 标签页保持默认，注意这里要有 .elf文件<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679414393337.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>Debugger 标签页，目标选择问哦们的芯片 S3，开发板应该翻译为调试工具，选择芯片内部 USB-JTAG，点击 <strong>Apply</strong> 保存设置，单击 <strong>Finish</strong> 退出设置<img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/JTAG%E8%B0%83%E8%AF%95.jpg" srcset="/img/loading.gif" lazyload alt="JTAG调试"></p>
<blockquote>
<p>根据官方描述，ESP32 C3和S3都内置JTAG调试器，即我们只需要通过USB线连接到ESP32的USB引脚，就能通过IDE直接调试，不需要额外的如ST-Link或Jtag调试硬件工具，非常方便。</p>
</blockquote>
<blockquote>
<p>USB接口同时也支持虚拟串口，所以在接USB后，我们就不要再接串口RX和TX调试了，反而还省了两个口。否则像其它ESP32都需要使用串口下载程序的，因为S3和C3的USB自带虚拟串口，所以就不需要串口 引脚了。所以建议用S3和C3时，使用USB口调试、调试、虚拟串口打印。我们在使用USB连接ESP32时，电脑会自动生成一个串口，就跟普通的串口一样，使用即可。</p>
</blockquote>
<blockquote>
<p>同时注意，使用调试功能，USB引脚就不能用于其它功能了。除非后续不再使用调试功能，usb两个引脚才可以作为他用。</p>
</blockquote>
<blockquote>
<p>后面教程都会只用USB接口和虚拟串口，虚拟串口默认和串口0相连</p>
</blockquote>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679414453939.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>此时我们的目标文件名，已经自动变成 <strong>test Configuration</strong>，同时还需要将左侧的<strong>Run</strong>改为<strong>Debug</strong><br>这里可以发现出现波浪线提示错误，单击最左侧 build 重新编译即可。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679414891654.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>检查目标芯片和串口号没有错误<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679414982158.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>单击左侧的虫子图标，开始调试<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679415017729.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>等待软件编译完成，出现如下弹窗，选择 <strong>Switch</strong>，切换到调试界面<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679415114430.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>软件会自动停留在程序开始位置，可以使用工具栏的调试工具进行调试运行。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679415345863.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>值得注意的是，当我们停止调试并返回到Run模式，是需要我们手动操作的，如下，都需要我们手动选择。</p>
<blockquote>
<p>所以这里建议，以后的项目都默认直接使用Debug模式。在Debug模式下编写程序和调试。避免来回切换。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679415475910.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>在调试模式下，如果不想调试，只想下载，可以单击<strong>运行</strong>图标，选择<strong>工程文件名</strong>，即可下载。<br>注意不要选错了，不要选第二个Configurantion（用于调试的）。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1679415991099.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
</blockquote>
<h2 id="自带终端，串口助手使用"><a href="#自带终端，串口助手使用" class="headerlink" title="自带终端，串口助手使用"></a>自带终端，串口助手使用</h2><p>打开终端，选择串口号，其它保持默认（串口监控）<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689431232157.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>界面底部栏，终端标签页会显示板子发送过来的串口信息<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689431271222.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<blockquote>
<p>建议还是使用专门的串口调试软件，如正点原子的 XCOM 调试软件<br>默认波特率115200<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/%E4%B8%B2%E5%8F%A3%E5%8A%A9%E6%89%8B.jpg" srcset="/img/loading.gif" lazyload alt="串口助手"></p>
</blockquote>
<h2 id="内存分析查看"><a href="#内存分析查看" class="headerlink" title="内存分析查看"></a>内存分析查看</h2><p><a target="_blank" rel="noopener" href="https://blog.espressif.com/esp32-programmers-memory-model-259444d89387">ESP32 Programmers’ Memory Model</a></p>
<p>编译后，在信息里会输出内存大小，如下图所示，总内存<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681829080985.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<ul>
<li>IRAM用于代码（指令），DRAM用于数据。这里有两个是因为S3是双核</li>
<li>Iram是用于代码的，也就是函数，但只是那些需要在iram中快速执行的函数，而不是flash。 例如中断处理程序。 基于链接器脚本或手动标记具有iram属性的函数，将代码放置在iram中。 有许多menuconfig设置与iram函数放置相关。</li>
</ul>
<p>也可以使用乐鑫的工具查看，如下图，在项目名上右键<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681829817296.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>软件会以图形形式展现内存占用情况<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681829825780.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>Details细节可以查看每个文件的内存占用<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681829981340.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="新建组件"><a href="#新建组件" class="headerlink" title="新建组件"></a>新建组件</h2><p>内容参考：ESP-IDF编程指南 ：API 指南 » 构建系统</p>
<p>espressif IDE如果导入外部文件夹是一件比较麻烦的事，涉及CmakeLists文件的编写，并且IDE的图形操作见面并没有添加源文件的设置选项（原Eclipse是有的），这就意味着不能和Eclipse一样自己新建文件夹，再将文件夹包含到头文件，实现文件的导入或新建</p>
<p>但Espressif IDE给了我们另一个选择，<strong>组件</strong>。组件其实就是具备一个单独功能的文件夹，包含一个 .c和.h文件，保存在指定文件夹 components 下。实现模块化编程。</p>
<p>file -&gt; New -&gt; 乐鑫IDF组件</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680941021419.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>输入组件名称<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680942893052.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>确认OK<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680941065501.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>软件会自动在项目文件夹下创建 components文件和test组件文件夹。</p>
<ul>
<li>components是系统目录，不可更改</li>
<li>test是我们自己的组件名</li>
<li>这里的test组件实际和IDF目录下的components下的组件是一个意思，就类似于库<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680942978635.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>但这里有个小问题。就是组件依赖。比如我们要在test.h 文件中包含 <code>#include &quot;driver/gpio.h&quot;</code>是不行的，编译会显示错误。但这个问题再以前IDE版本中并没有。为了解决这个问题。<br>我们需要打开test目录下的 CMakeLists.txt 文件。其中源码如下：<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">idf_component_register</span>(<span class="hljs-variable">SRCS</span> <span class="hljs-string">&quot;test.c&quot;</span></span><br><span class="hljs-function">                    <span class="hljs-variable">INCLUDE_DIRS</span> <span class="hljs-string">&quot;include&quot;</span>)</span><br></code></pre></td></tr></table></figure>
我们需要修改源码。修改后如下<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">idf_component_register</span>(<span class="hljs-variable">SRCS</span> <span class="hljs-string">&quot;test.c&quot;</span></span><br><span class="hljs-function">                    <span class="hljs-variable">INCLUDE_DIRS</span> <span class="hljs-string">&quot;include&quot;</span></span><br><span class="hljs-function">                    <span class="hljs-variable">REQUIRES</span> <span class="hljs-variable">driver</span>)</span><br></code></pre></td></tr></table></figure>
意思就是告诉编译器我们的组件依赖driver组件（IDF目录下的components下）。这样我们再去头文件包含就不会又错了。。</li>
</ul>
<h2 id="FreeRTOS操作系统"><a href="#FreeRTOS操作系统" class="headerlink" title="FreeRTOS操作系统"></a>FreeRTOS操作系统</h2><p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/believe666/article/details/127205502">https://blog.csdn.net/believe666/article/details/127205502</a></p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>我们以前在使用 51、AVR、STM32 单片机裸机(未使用系统)的时候一般都是在<br>main 函数里面用 while(1)做一个大循环来完成所有的处理，即应用程序是一个无限的循环，循<br>环中调用相应的函数完成所需的处理。有时候我们也需要中断中完成一些处理。相对于多任务<br>系统而言，这个就是单任务系统，也称作前后台系统，中断服务函数作为前台程序，大循环<br>while(1)作为后台程序，如图所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680785317036.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>前后台系统的实时性差，前后台系统各个任务(应用程序)都是排队等着轮流执行，不管你<br>这个程序现在有多紧急，没轮到你就只能等着！相当于所有任务(应用程序)的优先级都是一样<br>的。但是前后台系统简单啊，资源消耗也少啊！在稍微大一点的嵌入式应用中前后台系统就明<br>显力不从心了，此时就需要多任务系统出马了。</p>
<p>多任务系统会把一个大问题(应用)“分而治之”，把大问题划分成很多个小问题，这些小问题可以单独的作为一个小任务来处理。这些小任务是并发处理的，注意，并不是说同一时刻一起执行很多个任务，而是由于每个任务执行的时间很短，导致看起来像是同一时刻执行了很多个任务一样。多个任务带来了一个新的问题，究竟哪个任务先运行，哪个任务后运行呢？</p>
<p>完成这个功能的东西在 RTOS 系统中叫做任务调度器。不同的系统其任务调度器的实现方法也不同，比如 FreeRTOS 是一个抢占式的实时多任务系统，那么其任务调度器也是抢占式的，运行过程如图 5.1.2 所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680785378299.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>高优先级的任务可以打断低优先级任务的运行而取得 CPU 的使用权，这样就保证了那些紧急任务的运行。这样我们就可以为那些对实时性要求高的任务设置一个很高的优先级，比如自动驾驶中的障碍物检测任务等。高优先级的任务执行完成以后重新把 CPU 的使用权归还给低优先级的任务，这个就是抢占式多任务系统的基本原理。</p>
<h3 id="任务状态切换"><a href="#任务状态切换" class="headerlink" title="任务状态切换"></a>任务状态切换</h3><p>任务挂起函数<br>vTaskSuspend() </p>
<p>挂起指定任务，被挂起的任务绝不会得到 CPU 的使用权<br>vTaskSuspendAll() </p>
<p>将所有的任务都挂起  任务恢复函数</p>
<p>复制<br>vTaskResume()<br>vTaskResume()<br>xTaskResumeFromISR()<br>1.<br>2.<br>3.<br>任务恢复就是让挂起的任务重新进入就绪状态，恢复的任务会保留挂起前的状态信息，在恢复的时候根据挂起时的状态继续运行。xTaskResumeFromISR() 专门用在中断服务程序中。无论通过调用一次或多次vTaskSuspend()函数而被挂起的任务，也只需调用一次恢复即可解挂 。</p>
<p> 任务删除函数 vTaskDelete()用于删除任务。当一个任务可以删除另外一个任务，形参为要删除任 务创建时返回的任务句柄，如果是删除自身， 则形参为 NULL。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680786241251.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<ol>
<li><p>函数 vTaskDelete()<br>被删除了的任务不再存在，也就是说再也不会进入运行态。任务被删除以后就不能再使用此任务的句柄！如果此任务是使用动态方法创建的，也就是使用函数 xTaskCreate()创建的，那么在此任务被删除以后此任<br>务之前申请的堆栈和控制块内存会在空闲任务中被释放掉，因此当调用函数 vTaskDelete()删除任务以后必须给空闲任务一定的运行时间。<br>只有那些由内核分配给任务的内存才会在任务被删除以后自动的释放掉，用户分配给任务的内存需要用户自行释放掉，比如某个任务中用户调用函数 pvPortMalloc()分配了 500 字节的内存，那么在此任务被删除以后用户也必须调用函数 vPortFree()将这 500 字节的内存释放掉，否则会导致内存泄露。</p>
</li>
<li><p>函数 vTaskSuspend()<br>此函数用于将某个任务设置为挂起态，进入挂起态的任务永远都不会进入运行态。退出挂起态的唯一方法就是调用任务恢复函数 vTaskResume()或 xTaskResumeFromISR()。，函数原型如<br>注意！如果参数为 NULL 的话表示挂起任务自己。</p>
</li>
<li><p>函数 vTaskResume()<br>将一个任务从挂起态恢复到就绪态，只有通过函数 vTaskSuspend()设置为挂起态的任务才可以使用 vTaskRexume()恢复！恢复的任务会保留挂起前的状态信息，在恢复的时候根据挂起时的状态继续运行。</p>
</li>
<li><p>函数 xTaskResumeFromISR()<br>此函数是 vTaskResume()的中断版本，用于在中断服务函数中恢复一个任务。</p>
</li>
</ol>
<h3 id="任务创建"><a href="#任务创建" class="headerlink" title="任务创建"></a>任务创建</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">BaseType_t <span class="hljs-title">xTaskCreate</span><span class="hljs-params">( TaskFunction_t 			pxTaskCode,</span></span><br><span class="hljs-params"><span class="hljs-function">						<span class="hljs-type">const</span> <span class="hljs-type">char</span> * <span class="hljs-type">const</span> 		pcName,</span></span><br><span class="hljs-params"><span class="hljs-function">						<span class="hljs-type">const</span> <span class="hljs-type">uint16_t</span> 			usStackDepth,</span></span><br><span class="hljs-params"><span class="hljs-function">						<span class="hljs-type">void</span> * <span class="hljs-type">const</span> 			pvParameters,</span></span><br><span class="hljs-params"><span class="hljs-function">						UBaseType_t 			uxPriority,</span></span><br><span class="hljs-params"><span class="hljs-function">						TaskHandle_t * <span class="hljs-type">const</span> 	pxCreatedTask )</span></span><br></code></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>pxTaskCode：任务函数。</li>
<li>pcName：任务名字，一般用于追踪和调试，任务名字长度不能超过。configMAX_TASK_NAME_LEN</li>
<li>usStackDepth：任务堆栈大小，注意实际申请到的堆栈是 usStackDepth 的 4 倍。其中空闲任务的任务堆栈大小为 configMINIMAL_STACK_SIZE。</li>
<li>pvParameters: 传递给任务函数的参数。</li>
<li>uxPriotiry: 任务优先级，范围 0~ configMAX_PRIORITIES-1。</li>
<li>pxCreatedTask: 任务句柄，任务创建成功以后会返回此任务的任务句柄，这个句柄其实就是任务的任务堆栈。此参数就用来保存这个任务句柄。其他 API 函数可能会使用到这个句柄</li>
</ul>
<p>pxCreatedTask 任务句柄才是我们创建的任务，他是任务的ID，相当于身份证，可以通过句柄就能获取任务的所有信息。<br>而pxTaskCode 任务函数，是任务的执行部分，就是任务要做什么。因此多个不同任务是可以有相同的任务函数的。如果我们的任务函数是唯一的，并且也不需要对任务做任何额外操作，只是作为一个任务运行。那么pxCreatedTask 可以为空。（但要注意变量共享问题）<br>而pcName 只是一个名字，为了在调试时，可以打印这个名字，识别是什么任务，在程序中并无实际意义</p>
<p>建议自行参考视频资料学习：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.openedv.com/docs/book-videos/zdyzshipin/4free/zdyz-freertos-book.html">手把手教你学FreeRTOS</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1q54y1Z7ca/?vd_source=03b483801bb82304e4324482b60bb93f">什么是RTOS? - 孤独的二进制 - ESP32上的FREERTOS</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Nb4y1q7xz/?vd_source=03b483801bb82304e4324482b60bb93f">ESP32_freeRTOS教程一： 入门介绍</a></li>
</ul>
<h2 id="IDE使用常见问题"><a href="#IDE使用常见问题" class="headerlink" title="IDE使用常见问题"></a>IDE使用常见问题</h2><h3 id="1-has-no-explicit-encoding-set警告"><a href="#1-has-no-explicit-encoding-set警告" class="headerlink" title="1. has no explicit encoding set警告"></a>1. has no explicit encoding set警告</h3><p>编译时报如下警告</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">has <span class="hljs-keyword">no</span> explicit <span class="hljs-keyword">encoding</span> <span class="hljs-keyword">set</span><br></code></pre></td></tr></table></figure>
<p>解决办法</p>
<ul>
<li>在Problems视图中，选择警告，按Ctrl+1并应用提供的QuickFix（将项目编码显式设置为工作区编码）</li>
<li>在“项目属性”中手动更改项目&gt;：资源。Project &gt; Properties: Resource</li>
</ul>
<p>如果您希望忽略所有项目的此警告，则可以更改首选项：</p>
<ul>
<li>General -&gt; Workspace -&gt; Report missing project encoding as: Ignore<br>常规-&gt;工作区-&gt;将缺少的项目编码报告为：忽略<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681009711482.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/72692978/eclipse-project-project-name-has-no-explicit-encoding-set">Eclipse: Project ‘PROJECT_NAME’ has no explicit encoding set</a></li>
</ul>
<h1 id="软件篇"><a href="#软件篇" class="headerlink" title="软件篇"></a>软件篇</h1><h2 id="Flash-Download-Tools-固件烧录工具的使用"><a href="#Flash-Download-Tools-固件烧录工具的使用" class="headerlink" title="Flash Download Tools 固件烧录工具的使用"></a>Flash Download Tools 固件烧录工具的使用</h2><p>软件下载地址：<a target="_blank" rel="noopener" href="https://www.espressif.com.cn/zh-hans/support/download/other-tools">https://www.espressif.com.cn/zh-hans/support/download/other-tools</a><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689079998677.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>软件安装包里有教程，这里说明几个重点</p>
<p><strong>如何确认下载地址</strong><br>首先你需要使用IDE个要下载的芯片下载程序，后在 Console 信息输出栏找到如下语句</p>
<ul>
<li>可以通过找到 COMx 口语句找到</li>
</ul>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689081713829.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>bin文件在项目文件夹下的build 文件夹下<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689081903621.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>后按提示信息将 .bin 文件和对应地址填到选项框中。文件前后顺序无要求，只要对应的地址是对的就行</p>
<ul>
<li>这里有一个问题。就是bootloader的地址应该是0x1000，详见 <a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/bootloader.html">引导加载程序 (Bootloader)</a></li>
<li>但测试写0x0也是没问题的，之后为了安全还是改为0x1000</li>
</ul>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/flash_tools.jpg" srcset="/img/loading.gif" lazyload alt="flash tools"></p>
<h2 id="ESP-IDF编译原理简述-CMakeLists-x2F-CMake-和构建自定义项目"><a href="#ESP-IDF编译原理简述-CMakeLists-x2F-CMake-和构建自定义项目" class="headerlink" title="ESP-IDF编译原理简述(CMakeLists&#x2F;CMake)和构建自定义项目"></a>ESP-IDF编译原理简述(CMakeLists&#x2F;CMake)和构建自定义项目</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/kangweijian/article/details/123283714">https://blog.csdn.net/kangweijian/article/details/123283714</a></p>
<h2 id="固件大小优化"><a href="#固件大小优化" class="headerlink" title="固件大小优化"></a>固件大小优化</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/kangweijian/article/details/127497916">https://blog.csdn.net/kangweijian/article/details/127497916</a></p>
<h2 id="Partition-Tables分区表"><a href="#Partition-Tables分区表" class="headerlink" title="Partition Tables分区表"></a>Partition Tables分区表</h2><p>一个ESP32的闪存（Flash存储芯片）可以包含多个应用程序，以及许多不同类型的数据（校准数据、文件系统、参数存储等）。因此，分区表在闪存中被刷新到（默认偏移量）0x8000。</p>
<p>分区表长度为0xC00字节，因为我们允许最多95个条目。MD5校验和用于在运行时检查分区表的完整性，被附加在表数据之后。因此，分区表占据了大小为0x1000（4KB）的整个闪存扇区。因此，它后面的任何分区必须至少位于（默认偏移量）+ 0x1000。</p>
<p>分区表就是一张表格，是 .csv格式文件，下载时转换成bin文件存储在0x8000位置，并且占据占据了大小为0x1000（4KB）</p>
<p>我们在项目名右键，找到Partition Table Editor就能打开分区表，这个是默认的<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/Partition_Tables%E5%88%86%E5%8C%BA%E8%A1%A8.jpg" srcset="/img/loading.gif" lazyload alt="Partition Tables分区表"></p>
<ul>
<li>NVS主要是给我们存储数据用的，类似EEPROM，比如wifi数据，用户信息、开机次数等等信息</li>
<li>PHY分区主要和射频通信配置相关，例如WIFI、RF、蓝牙，存储一些校准数据（一般用不到），参考：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/RF_calibration.html">RF calibration射频校准</a>、<a target="_blank" rel="noopener" href="https://www.esp32.com/viewtopic.php?t=1020">什么是与ESP32相关的PHY？</a></li>
</ul>
<p>以上两个分区时可以任意配置的，也可以直接删除不要。但下面的factory谨慎修改，factory里面存的就是我们的应用程序，系统在初始化后会自动跳转到该地址（0x10000） 运行程序，所以最后修改这里的偏移位置（0x10000），但我们可以修改其大小（Size），可以看到默认只有1M-Byte大小，如果我们的程序太大的话，是没办法下载运行的，就需要我们自行修改了分区表了。</p>
<p>系统自带几个默认的分区表配置，可以直接在 sdconfig 文件中修改，不需要在这里需改分区表。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/sdconfig_Partition_Table.jpg" srcset="/img/loading.gif" lazyload alt="sdconfig Partition Table"><br>有三种默认配置</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 配置1：Factory app，two OTA definitions</span><br><br><span class="hljs-comment"># ESP-IDF Partition Table</span><br><span class="hljs-comment"># Name,   Type, SubType, Offset,  Size, Flags</span><br><span class="hljs-attribute">nvs</span>,      data, nvs,     <span class="hljs-number">0</span>x9000,  <span class="hljs-number">0</span>x6000,<br><span class="hljs-attribute">phy_init</span>, data, phy,     <span class="hljs-number">0</span>xf000,  <span class="hljs-number">0</span>x1000,<br><span class="hljs-attribute">factory</span>,  app,  factory, <span class="hljs-number">0</span>x10000, <span class="hljs-number">1</span>M,<br><br><span class="hljs-comment"># 配置2：Factory app，two OTA definitions</span><br><br><span class="hljs-comment"># ESP-IDF Partition Table</span><br><span class="hljs-comment"># Name,   Type, SubType, Offset,  Size, Flags</span><br><span class="hljs-attribute">nvs</span>,      data, nvs,     <span class="hljs-number">0</span>x9000,  <span class="hljs-number">0</span>x6000,<br><span class="hljs-attribute">phy_init</span>, data, phy,     <span class="hljs-number">0</span>xf000,  <span class="hljs-number">0</span>x1000,<br><span class="hljs-attribute">factory</span>,  app,  factory, <span class="hljs-number">0</span>x10000, <span class="hljs-number">1</span>.<span class="hljs-number">5</span>M,<br><br><span class="hljs-comment"># 配置2：Factory app，two OTA definitions</span><br><br><span class="hljs-comment"># ESP-IDF Partition Table</span><br><span class="hljs-comment"># Name,   Type, SubType, Offset,  Size, Flags</span><br><span class="hljs-attribute">nvs</span>,      data, nvs,     <span class="hljs-number">0</span>x9000,  <span class="hljs-number">0</span>x4000,<br><span class="hljs-attribute">otadata</span>,  data, ota,     <span class="hljs-number">0</span>xd000,  <span class="hljs-number">0</span>x2000,<br><span class="hljs-attribute">phy_init</span>, data, phy,     <span class="hljs-number">0</span>xf000,  <span class="hljs-number">0</span>x1000,<br><span class="hljs-attribute">factory</span>,  app,  factory, <span class="hljs-number">0</span>x10000,  <span class="hljs-number">1</span>M,<br><span class="hljs-attribute">ota_0</span>,    app,  ota_0,   <span class="hljs-number">0</span>x110000, <span class="hljs-number">1</span>M,<br><span class="hljs-attribute">ota_1</span>,    app,  ota_1,   <span class="hljs-number">0</span>x210000, <span class="hljs-number">1</span>M,<br></code></pre></td></tr></table></figure>
<p>配置三主要用于OTA升级程序使用的。可以看出来如果我们的Flash大小大于4M（ESP32模组默认最小内存2MByte），那么这三个默认配置其实都没有用到Flash的全部内存位置，并不适合实际使用</p>
<p>我们可以自定义分区表：</p>
<ul>
<li>分区表选择 Custom</li>
<li>flash大小设置成我们芯片模组的真实大小，默认是2M，我的是16M的</li>
</ul>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/partition_table_config.jpg" srcset="/img/loading.gif" lazyload alt="partition table config"></p>
<ul>
<li>项目右键、打开分区表编辑器</li>
<li>将app内存大小增大，保存退出</li>
<li>工程目录下会多出一个 partition 文件</li>
<li>我们不需要单独下载，在程序下载时，IDE会自动编译下载这个分区表，替换掉默认的分区表</li>
</ul>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/partition_table_edit.jpg" srcset="/img/loading.gif" lazyload alt="partition table edit"></p>
<p>下面这张图可以帮助我们更好的理解分区</p>
<ul>
<li>boot 的地址是固定的 0x1000 （ESP8266 的 boot 地址为固定的 0x0000），而且 boot 地址的加载早于分区表的加载，因此无需在分区表中表现，大小与 boot 配置项有关，可以在编译完成后查看build&#x2F;bootloader&#x2F;bootloader.bin 来确认当前配置项 boot 大小。</li>
<li>boot分区位置和大小是不能自定义的，但我们可以修改这里的bootloader.bin文件<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689418793406.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<p>结合之前flash下载工具的内存地址</p>
<ul>
<li>boot在0x1000，分区表在0x8000，程序在0x10000</li>
<li>0x8000-0x10000钟中间的是nvs和phy_init ，是运行时使用，存储信息的，因此不下载文件<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/flash_tools.jpg" srcset="/img/loading.gif" lazyload alt="flash tools"></li>
</ul>
<h2 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h2><p>参考资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Marchtwentytwo/article/details/117924506">基于 ESP-IDF 将自定义的静态库制作成组件</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Marchtwentytwo/article/details/121560498">使用 ESP-IDF 生成第三方的 .a 静态库并使用的流程</a></p>
<h1 id="实战篇"><a href="#实战篇" class="headerlink" title="实战篇"></a>实战篇</h1><h2 id="1、printf"><a href="#1、printf" class="headerlink" title="1、printf"></a>1、printf</h2><p>参考IDF官方例程：C:\Espressif\frameworks\esp-idf-v5.0\examples\get-started\hello_world\main\hello_world_main.c</p>
<p>新建样例工程（最简工程）。<br>添加如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello\n&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>编译下载程序，打开终端监视器<br>可以发现串口成功输出</p>
<blockquote>
<p>USB虚拟串口和串口0都可以输出，应该时映射的，所以此时接串口0和USB虚拟串口都会有输出<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689431390706.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>如果将后面换行符 <code>\n</code>去除，再下载</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>会发现并没有输出。这是因为串口发送会有一个缓存机制，芯片再检测到缓存满后，才会发送一次数据。而我们现在发送的数据并不能填充满缓存区，所以就没有输出。<br>有两种解决办法</p>
<ol>
<li>和上面一样，再输出内容最后加上换行符，可以强制打印输出</li>
<li>加 <code>fflush(stdout)</code> ，也是强制刷新缓冲区，冲洗掉缓存区内容<br>该方法仅适用于传统串口，不适用于USB虚拟串口<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello&quot;</span>);<br>	<span class="hljs-built_in">fflush</span>(stdout);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="sdkconfig项目配置"><a href="#sdkconfig项目配置" class="headerlink" title="sdkconfig项目配置"></a>sdkconfig项目配置</h3><p>串口默认串口0，即GPIO43、44。默认波特率115200<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680532028556.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>我们也可以修改默认串口。按下图打开sdkconfig项目配置工具，找到ESP System Setttings，找到console输出配置，这里有两个关于串口的配置，我们可以点击右侧问好查看帮助信息<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680532051942.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>我们可以修改默认串口为用户自定义，这是后我们可以定义串口引脚（串口引脚需要查看芯片手册，按照引脚功能选择）和波特率。这里不推荐修改默认串口配置。</p>
<p>同时我们这里也可以看到，串口的第二通道，输出默认是USB-JTAG，这就解释了为什么我们的USB虚拟串口会和默认串口是一样可以打印输出了。如果这里我们关闭辅助输出功能，USB虚拟串口将不会打印输出，但还会保留启动输出。</p>
<blockquote>
<p>如果我们的默认串口连接了串口助手，那么USB虚拟串口的输出将会关闭。</p>
</blockquote>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680532143489.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<blockquote>
<p>设置完成，ctrl+s保存配置，重新编译下载才能生效</p>
</blockquote>
<h4 id="帮助信息："><a href="#帮助信息：" class="headerlink" title="帮助信息："></a>帮助信息：</h4><p><strong>配置esp_CONSOLE_uart</strong><br>控制台输出通道<br>选择控制台输出的发送位置（通过stdout和stderr）。<br>默认情况是在预定义的GPIO上使用UART0。<br>如果选择“自定义”，则可以选择UART0或UART1，并且可以选择任何引脚。<br>如果选择“None”（无），则除ROM引导加载程序的初始输出外，任何UART上都不会有控制台输出。此ROM输出可以通过GPIO捆扎或EFUSE抑制，详细信息请参阅芯片数据表。<br>在带有USB OTG外围设备的芯片上，“USB CDC”选项将输出重定向到CDC端口。此选项使用芯片ROM中的CDC驱动程序。此选项与TinyUSB堆栈不兼容。<br>在带有USB串行&#x2F;JTAG调试控制器的芯片上，选择将输出重定向到该设备的CDC&#x2F;ACM（串行端口仿真）组件的选项。<br>可用选项：</p>
<ul>
<li>默认值：UART0（ESP_CONSOLE_ART_Default）</li>
<li>USB CDC（ESP_CONSOLE_USB_CDC）</li>
<li>USB串行&#x2F;JTAG控制器（ESP_CONSOLE_USB_Serial_JTAG）</li>
<li>自定义UART（ESP_CONSOLE_ART_Custom）</li>
<li>无（ESP_CONSOLE_None）</li>
</ul>
<p><strong>配置sp_CONSOLE_SECONDARY</strong><br>控制台二次输出通道<br>位于：组件配置&gt;ESP系统设置<br>当选择UART0端口作为主要端口但未连接时，此辅助选项支持通过其他特定端口（如USB_SERIAL_JTAG）输出。此辅助输出当前仅支持不使用REPL的非阻塞模式。如果您想用REPL以阻塞模式输出或通过该辅助端口输入，请在控制台输出菜单的通道中将主配置更改为该端口。<br>可用选项：<br>     - 无辅助控制台（ESP_console_CONDARY_NONE）<br>     - USB_SERIAL_JTAG端口（ESP_CONSOLE_condary_USB_SERIAL_JTAG）</p>
<p><strong>当UART0端口未连接时，此选项支持通过USB_SERIAL_JTAG端口输出。</strong> 输出当前仅支持非阻塞模式，而不使用控制台。如果您想使用REPL以阻塞模式输出或通过USB_SERIAL_JTAG端口输入，请将主配置更改为上面的ESP_CONSOLE_USB_SERIAL_JTAG。</p>
<h2 id="2、sleep-延时"><a href="#2、sleep-延时" class="headerlink" title="2、sleep 延时"></a>2、sleep 延时</h2><p>在上一节课基础上，添加延时函数，时间间隔定时输出<br>需要包含头文件 <code>#include &lt;unistd.h&gt;</code>,完整程序如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from app_man!\n&quot;</span>);<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>我们选中sleep单词，按F3或右键单击Open Declaration，可以其具体实现<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/%E5%8F%B3%E9%94%AE%E5%8D%95%E5%87%BB%E5%8E%BB%E5%AE%9A%E4%B9%89.gif" srcset="/img/loading.gif" lazyload alt="右键单击去定义"><br>可以看到，<code>sleep</code>实际调用的<code>usleep</code>，<code>usleep</code>则调用的<code>vTaskDelay</code><br>而 <code>vTaskDelay</code> 实际和FreeRTOS有关，我们的EPS32 运行时离不开FreeRTOS的，相关的教程完成也有很多，这里不再讲解，大家可以参下网络教程学习，</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/believe666/article/details/127175049?spm=1001.2014.3001.5502">ESP32 FreeRTOS-任务的创建与删除 (1)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45652444/article/details/118867092?spm=1001.2014.3001.5502">ESP32编程指南 —— Task API （任务）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/redlightASl/p/15539672.html">ESP32_IDF学习4【ESP32上的FreeRTOS】</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liaozhelin/p/16290465.html">【深入浅出】FreeRTOS 学习笔记</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yangfengwu/p/15089797.html">006-ESP32学习开发(SDK)-关于操作系统-任务,任务堆栈空间,任务的挂起,恢复,删除</a></li>
</ul>
<h2 id="3、Log日志输出"><a href="#3、Log日志输出" class="headerlink" title="3、Log日志输出"></a>3、Log日志输出</h2><p>参考：ESP-IDF 编程指南：API参考» 系统接口» 日志库</p>
<p>Log日志输出其实和printf类似，也是调用的默认串口输出信息。但它多了一个等级控制，可以方便程序员在调试时使用最高等级打印调试信息，在发布时关闭信息输出，或者打开部分输出。总之是非常方便程序员调试使用的。</p>
<p>Log一共5个输出等级：</p>
<ul>
<li>ESP_LOGE- 错误（最低）</li>
<li>ESP_LOGW- 警告</li>
<li>ESP_LOGI- 信息</li>
<li>ESP_LOGD-调试</li>
<li>ESP_LOGV- 详细（最高）</li>
</ul>
<p>要使用log打印，需包含库：esp_log.h</p>
<p>源码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;esp_log.h&gt;</span></span><br><span class="hljs-comment">// 定义一个标签，方便批量换名字</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span>* tagMyModule = <span class="hljs-string">&quot;MyModule&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br><br>    	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from app_main!\n&quot;</span>);<br>    	<span class="hljs-comment">// 错误</span><br>    	<span class="hljs-built_in">ESP_LOGE</span>(tagMyModule,<span class="hljs-string">&quot;error&quot;</span>);  <span class="hljs-comment">// 最低级别</span><br>    	<span class="hljs-comment">// 警告</span><br>    	<span class="hljs-built_in">ESP_LOGW</span>(tagMyModule,<span class="hljs-string">&quot;warning&quot;</span>);<br>    	<span class="hljs-comment">// 信息</span><br>    	<span class="hljs-built_in">ESP_LOGI</span>(tagMyModule,<span class="hljs-string">&quot;information&quot;</span>);<br>    	<span class="hljs-comment">// 调试</span><br>    	<span class="hljs-built_in">ESP_LOGD</span>(tagMyModule,<span class="hljs-string">&quot;debug&quot;</span>);<br>    	<span class="hljs-comment">// 详细</span><br>    	<span class="hljs-built_in">ESP_LOGV</span>(tagMyModule,<span class="hljs-string">&quot;verbose&quot;</span>); <span class="hljs-comment">// 最高级别</span><br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>串口打印输出<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680674347417.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>可以发现只打印三个，高级别的两个没有打印。这是因为Log打印输出是由等级控制的，在sdkconfig中设置，搜索log</p>
<ul>
<li>默认等级：info。即info级别以下的都可以打印输出。可以自己更改选项</li>
<li>最高等级：如果这里设置的级别比上面默认等级低，那么打印等级就会被限制在最高等级。这里默认和默认等级一致，也就是我们默认等级设置多少，最高等级就是多少。</li>
</ul>
<p>修改完成后，重新编译下载即可生效</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680672831189.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>上面的等级修改是在编译时就固定好的，我们也可以使用函数在程序中实时修改等级。</p>
<blockquote>
<p>如果在程序修改等级，我们需要将sdkconfig中的最高等级改为最大（默认和默认等级一致），否则我们的等级也会被现在在最高等级<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680673522763.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>程序中如果修改了等级，则sdkconfig中的配置将失效，以程序中的设置为准</p>
</blockquote>
<p>主要程序：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br><br>	<span class="hljs-comment">// 指定tagMyModule标签的等级</span><br>	esp<span class="hljs-constructor">_log_level_set(<span class="hljs-params">tagMyModule</span>, ESP_LOG_WARN)</span>;<br>	<span class="hljs-comment">// 设置全局的等级</span><br>	<span class="hljs-comment">// 与上面指定标签，分先后顺序</span><br>	<span class="hljs-comment">// 如果最后一步设置的是全局的，则指定等级失效，以全局为准，例如现在的程序，则tagMyModule等级就等于全局等级ESP_LOG_DEBUG</span><br>	<span class="hljs-comment">// 如果是先设置的全局，则指定标签等级=指定的等级，其它的=全局等级，可以将这两两行代码调换顺序尝试。</span><br>	esp<span class="hljs-constructor">_log_level_set(<span class="hljs-string">&quot;*&quot;</span>, ESP_LOG_DEBUG)</span>;<br><br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br><br>    	printf(<span class="hljs-string">&quot;Hello from app_main!\n&quot;</span>);<br>    	<span class="hljs-comment">// 错误</span><br>    	<span class="hljs-constructor">ESP_LOGE(<span class="hljs-params">tagMyModule</span>,<span class="hljs-string">&quot;error&quot;</span>)</span>;  <span class="hljs-comment">// 最低级别</span><br>    	<span class="hljs-comment">// 警告</span><br>    	<span class="hljs-constructor">ESP_LOGW(<span class="hljs-params">tagMyModule</span>,<span class="hljs-string">&quot;warning&quot;</span>)</span>;<br>    	<span class="hljs-comment">// 信息</span><br>    	<span class="hljs-constructor">ESP_LOGI(<span class="hljs-params">tagMyModule</span>,<span class="hljs-string">&quot;information&quot;</span>)</span>;<br>    	<span class="hljs-comment">// 调试</span><br>    	<span class="hljs-constructor">ESP_LOGD(<span class="hljs-params">tagMyModule</span>,<span class="hljs-string">&quot;debug&quot;</span>)</span>;<br>    	<span class="hljs-comment">// 详细</span><br>    	<span class="hljs-constructor">ESP_LOGV(<span class="hljs-params">tagMyModule</span>,<span class="hljs-string">&quot;verbose&quot;</span>)</span>; <span class="hljs-comment">// 最高级别</span><br>        sleep(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>打印输出内容：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680674407523.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="4、GPIO-输出"><a href="#4、GPIO-输出" class="headerlink" title="4、GPIO 输出"></a>4、GPIO 输出</h2><p>参考：ESP-IDF 编程指南：API参考» 外设接口» GPIO &amp; RTC GPIO<br>参考IDF官方例程：C:\Espressif\frameworks\esp-idf-v5.0\examples\get-started\blink\main\blink_example_main.c<br>要使用log打印，需包含库：#include “driver&#x2F;gpio.h”</p>
<p>初始化配置。有两种方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@brief</span>  led初始化，设置推挽输出，设置初始电平。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@note</span> 引脚会默认上拉</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">gpio_init</span>(<span class="hljs-params"></span>)<br>&#123;<br>	<span class="hljs-comment">// 将 gpio 重置为默认状态（选择 gpio 功能，启用上拉并禁用输入和输出）。</span><br>    <span class="hljs-title function_">gpio_reset_pin</span>(<span class="hljs-variable constant_">BLINK_GPIO</span>);<br>    <span class="hljs-comment">// 配置GPIO方向</span><br>    <span class="hljs-title function_">gpio_set_direction</span>(<span class="hljs-variable constant_">BLINK_GPIO</span>, <span class="hljs-variable constant_">GPIO_MODE_OUTPUT</span>);<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@brief</span>  led初始化，设置推挽输出，设置初始电平。推荐使用该方式</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@note</span> 这里和gpio_reset_pin底层实现很相似，但可以自定义修改配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">led_init</span>(<span class="hljs-params"></span>)<br>&#123;<br>    gpio_config_t io_conf;<br>    <span class="hljs-comment">//bit mask of the pins that you want to set,e.g.GPIO18/19 配置GPIO_OUT寄存器</span><br>    io_conf.<span class="hljs-property">pin_bit_mask</span> = <span class="hljs-title class_">BIT64</span>(<span class="hljs-variable constant_">BLINK_GPIO</span>) | <span class="hljs-title class_">BIT64</span>(<span class="hljs-variable constant_">BLINK_GPIO2</span>);  <span class="hljs-comment">// 使用BIT64替代1ULL&lt;&lt;BLINK_GPIO2</span><br>    <span class="hljs-comment">//IO模式：输入输出</span><br>    io_conf.<span class="hljs-property">mode</span> = <span class="hljs-variable constant_">GPIO_MODE_OUTPUT</span>;<br>    <span class="hljs-comment">//下拉电阻：禁止</span><br>    io_conf.<span class="hljs-property">pull_down_en</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//上拉电阻：禁止</span><br>    io_conf.<span class="hljs-property">pull_up_en</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//IO中断类型：禁止中断</span><br>    io_conf.<span class="hljs-property">intr_type</span> = <span class="hljs-variable constant_">GPIO_INTR_DISABLE</span>;<br>    <span class="hljs-comment">//使用给定设置配置GPIO</span><br>    <span class="hljs-title function_">gpio_config</span>(&amp;io_conf);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制输出使用 <code>gpio_set_level</code>，下面是主程序</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">void <span class="hljs-built_in">app_main</span>(void)<br>&#123;<br>	<span class="hljs-built_in">gpio_init</span>();<br>	<span class="hljs-comment">//led_init();</span><br>    while (true) &#123;<br>        <span class="hljs-comment">/* Blink off (output low) */</span><br>        <span class="hljs-built_in">ESP_LOGI</span>(tagInfo,&quot;Turning off the LED\n&quot;);<br>        <span class="hljs-built_in">gpio_set_level</span>(BLINK_GPIO, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">/* Blink on (output high) */</span><br>        <span class="hljs-built_in">ESP_LOGI</span>(tagInfo,&quot;Turning on the LED\n&quot;);<br>        <span class="hljs-built_in">gpio_set_level</span>(BLINK_GPIO, <span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测量引脚输出波形，周期2S<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1680701159744.jpg" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="3、GPIO-输入"><a href="#3、GPIO-输入" class="headerlink" title="3、GPIO 输入"></a>3、GPIO 输入</h2><p>参考：ESP-IDF 编程指南：API参考» 外设接口» GPIO &amp; RTC GPIO</p>
<p>引脚内部是弱上拉，很容易受到外部干扰，最好外部硬件上拉保证稳定性。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs awk">void key_init()<br>&#123;<br>    gpio_config_t io_conf;<br>    <span class="hljs-regexp">//</span>bit mask of the pins that you want to set,e.g.GPIO18/<span class="hljs-number">19</span> 配置GPIO_OUT寄存器<br>    io_conf.pin_bit_mask = BIT64(KEY_GPIO);  <span class="hljs-regexp">//</span> 使用BIT64替代<span class="hljs-number">1</span>ULL&lt;&lt;BLINK_GPIO2<br>    <span class="hljs-regexp">//</span>IO模式：输入输出 如果不定义输入输出模式，将无法获取引脚电平<br>    io_conf.mode = GPIO_MODE_INPUT;<br>    <span class="hljs-regexp">//</span>下拉电阻：禁止<br>    io_conf.pull_down_en = <span class="hljs-number">0</span>;<br>    <span class="hljs-regexp">//</span>上拉电阻：禁止<br>    io_conf.pull_up_en = <span class="hljs-number">1</span>;<br>    <span class="hljs-regexp">//</span>IO中断类型：禁止中断<br>    io_conf.intr_type = GPIO_INTR_DISABLE;<br>    <span class="hljs-regexp">//</span>使用给定设置配置GPIO<br>    gpio_config(&amp;io_conf);<br><br>&#125;<br><br><span class="hljs-regexp">//</span>按键处理函数<br><span class="hljs-regexp">//</span>返回按键值<br><span class="hljs-regexp">//m</span>ode:<span class="hljs-number">0</span>,不支持连续按;<span class="hljs-number">1</span>,支持连续按;<br><span class="hljs-regexp">//</span><span class="hljs-number">0</span>，没有任何按键按下<br><span class="hljs-regexp">//</span><span class="hljs-number">1</span>，WKUP按下 WK_UP<br><span class="hljs-regexp">//</span>注意此函数有响应优先级,KEY0&gt;KEY1&gt;KEY2&gt;WK_UP!!<br>uint8_t KEY_Scan(uint8_t mode)<br>&#123;<br>    <span class="hljs-keyword">if</span>(KEY==<span class="hljs-number">0</span>)<br>    &#123;<br>    	usleep(<span class="hljs-number">10000</span>);<br>        <span class="hljs-keyword">if</span>(KEY==<span class="hljs-number">0</span>)<br>        	return KEY_PRES;<br>    &#125;<br><br>    return <span class="hljs-number">0</span>;   <span class="hljs-regexp">//</span>无按键按下<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="4、外部中断"><a href="#4、外部中断" class="headerlink" title="4、外部中断"></a>4、外部中断</h2><p>参考IDF官方例程：C:\Espressif\frameworks\esp-idf-v5.0\examples\peripherals\gpio\generic_gpio</p>
<blockquote>
<p>中断里面调用ESP_LOGX或printf都会导致系统重启。所以不要再中断里调用打印函数</p>
</blockquote>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exti.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_attr.h&quot;</span> <span class="hljs-comment">// IRAM_ATTR 库</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;driver/gpio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;led.h&gt;</span></span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief  GPIO配置为中断输入模式。下降沿触发</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return</span><br><span class="hljs-comment"> *     - none</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">exti_init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">gpio_config_t</span> io_conf;<br>    <span class="hljs-comment">//IO中断类型：下降沿</span><br>    io_conf.intr_type = GPIO_INTR_NEGEDGE;<br>    <span class="hljs-comment">//IO模式：输入</span><br>    io_conf.mode = GPIO_MODE_INPUT;<br>    <span class="hljs-comment">//bit mask of the pins that you want to set,e.g.GPIO18/19 配置GPIO_OUT寄存器</span><br>    io_conf.pin_bit_mask = <span class="hljs-built_in">BIT64</span>(GPIO_NUM_4);<br>    <span class="hljs-comment">//下拉电阻：禁止</span><br>    io_conf.pull_down_en = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//上拉电阻：禁止</span><br>    io_conf.pull_up_en = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//使用给定设置配置GPIO</span><br>    <span class="hljs-built_in">gpio_config</span>(&amp;io_conf);<br><br>    <span class="hljs-comment">// 安装GPIO ISR处理程序服务。开启整个gpio的中断</span><br>    <span class="hljs-comment">// ESP_INTR_FLAG_LEVEL1 优先级最低</span><br>    <span class="hljs-built_in">gpio_install_isr_service</span>(ESP_INTR_FLAG_LEVEL1);<br>    <span class="hljs-comment">//添加中断回调处理函数</span><br>    <span class="hljs-built_in">gpio_isr_handler_add</span>(GPIO_NUM_4, gpio_isr_handler, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">//gpio_isr_handler</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>中断函数</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// 定义 gpio isr 中断服务处理函数。</span><br><span class="hljs-comment">// IRAM_ATTR 是将函数定义在iRAM区 提高中断程序加载速度</span><br>void IRAM_ATTR <span class="hljs-built_in">gpio_isr_handler</span>()<br>&#123;<br>	<span class="hljs-built_in">led_toggle</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a>主程序</h3><p>主程序只调用一个初始化程序。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-comment">// 定义一个标签，方便批量换名字</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>* tagInfo = <span class="hljs-string">&quot;tagInfo&quot;</span>;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">app_main</span>(<span class="hljs-keyword">void</span>)<br>&#123;<br>	uint8_t <span class="hljs-built_in">key</span>;<br>	<span class="hljs-title function_">led_init</span>();<br>	<span class="hljs-title function_">exti_init</span>();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	<span class="hljs-built_in">key</span>=<span class="hljs-title function_">KEY_Scan</span>(<span class="hljs-number">0</span>); 		    <span class="hljs-comment">//得到键值</span><br>    	<span class="hljs-keyword">if</span>(<span class="hljs-built_in">key</span>)<br>    		<span class="hljs-title function_">ESP_LOGI</span>(tagInfo,<span class="hljs-string">&quot;keyValue = %d\r\n&quot;</span>,<span class="hljs-built_in">key</span>);<br>    	<span class="hljs-comment">//led_toggle(LED_GPIO, 0);</span><br>        <span class="hljs-title function_">usleep</span>(<span class="hljs-number">10000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>没触发一次中断，LED反转一次</p>
<h2 id="串口"><a href="#串口" class="headerlink" title="串口"></a>串口</h2><p>参考：ESP-IDF 编程指南：API参考»  外设 API » 通用异步接收器&#x2F;发送器 (UART)<br>参考例程：esp-idf-v5.0\examples\peripherals\uart\uart_async_rxtxtasks</p>
<h3 id="功能概述"><a href="#功能概述" class="headerlink" title="功能概述"></a>功能概述</h3><p>下文介绍了如何使用 UART 驱动程序的函数和数据类型在 ESP32-S3 和其他 UART 设备之间建立通信。基本编程流程分为以下几个步骤：</p>
<ol>
<li>设置通信参数 - 设置波特率、数据位、停止位等</li>
<li>设置通信管脚 - 分配连接设备的管脚</li>
<li>安装驱动程序 - 为 UART 驱动程序分配 ESP32-S3 资源</li>
<li>运行 UART 通信 - 发送&#x2F;接收数据</li>
<li>使用中断 - 触发特定通信事件的中断</li>
<li>删除驱动程序 - 如无需 UART 通信，则释放已分配的资源</li>
</ol>
<p>步骤 1 到 3 为配置阶段，步骤 4 为 UART 运行阶段，步骤 5 和 6 为可选步骤。</p>
<p>UART 驱动程序函数通过 uart_port_t 识别不同的 UART 控制器。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void uart<span class="hljs-constructor">_init(<span class="hljs-params">void</span>)</span> &#123;<br>    const uart_config_t uart_config = &#123;<br>        .baud_rate = <span class="hljs-number">115200</span>,  <span class="hljs-comment">// 波特率</span><br>        .data_bits = UART_DATA_8_BITS,  <span class="hljs-comment">// 数据位</span><br>        .parity = UART_PARITY_DISABLE, <span class="hljs-comment">// 奇偶校验</span><br>        .stop_bits = UART_STOP_BITS_1,  <span class="hljs-comment">// 停止位</span><br>        .flow_ctrl = UART_HW_FLOWCTRL_DISABLE, <span class="hljs-comment">// 流控</span><br>        .source_clk = UART_SCLK_DEFAULT,   <span class="hljs-comment">// 时钟源</span><br>    &#125;;<br>    <span class="hljs-comment">// We won&#x27;t use a buffer for sending data.</span><br>    uart<span class="hljs-constructor">_driver_install(UART_NUM_1, RX_BUF_SIZE <span class="hljs-operator">*</span> 2, 0, 0, NULL, 0)</span>;<br>    uart<span class="hljs-constructor">_param_config(UART_NUM_1, &amp;<span class="hljs-params">uart_config</span>)</span>;<br>    uart<span class="hljs-constructor">_set_pin(UART_NUM_1, TXD_PIN, RXD_PIN, UART_PIN_NO_CHANGE, UART_PIN_NO_CHANGE)</span>;<br><br>    x<span class="hljs-constructor">TaskCreate(<span class="hljs-params">uart_rx_task</span>, <span class="hljs-string">&quot;uart_rx_task&quot;</span>, 1024<span class="hljs-operator">*</span>2, NULL, <span class="hljs-params">configMAX_PRIORITIES</span>, NULL)</span>;<br>    x<span class="hljs-constructor">TaskCreate(<span class="hljs-params">uart_tx_task</span>, <span class="hljs-string">&quot;uart_tx_task&quot;</span>, 1024<span class="hljs-operator">*</span>4, NULL, <span class="hljs-params">configMAX_PRIORITIES</span>-1, NULL)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 接受缓存大小</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> RX_BUF_SIZE = <span class="hljs-number">1024</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TXD_PIN (GPIO_NUM_17)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RXD_PIN (GPIO_NUM_18)</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uart_sendData</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* logName, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(data);<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> txBytes = <span class="hljs-built_in">uart_write_bytes</span>(UART_NUM_1, data, len);<br>    <span class="hljs-built_in">ESP_LOGI</span>(logName, <span class="hljs-string">&quot;Wrote %d bytes&quot;</span>, txBytes);<br>    <span class="hljs-keyword">return</span> txBytes;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">uart_tx_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *TX_TASK_TAG = <span class="hljs-string">&quot;TX_TASK&quot;</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    	<span class="hljs-built_in">uart_sendData</span>(TX_TASK_TAG, <span class="hljs-string">&quot;Hello world&quot;</span>);<br>        <span class="hljs-built_in">vTaskDelay</span>(<span class="hljs-number">2000</span> / portTICK_PERIOD_MS);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">uart_rx_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *RX_TASK_TAG = <span class="hljs-string">&quot;RX_TASK&quot;</span>;<br>    <span class="hljs-type">uint8_t</span>* data = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(RX_BUF_SIZE+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">int</span> rxBytes = <span class="hljs-built_in">uart_read_bytes</span>(UART_NUM_1, data, RX_BUF_SIZE, <span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<br>        <span class="hljs-keyword">if</span> (rxBytes &gt; <span class="hljs-number">0</span>) &#123;<br>            data[rxBytes] = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">ESP_LOGI</span>(RX_TASK_TAG, <span class="hljs-string">&quot;Read %d bytes: &#x27;%s&#x27;&quot;</span>, rxBytes, data);<br>            <span class="hljs-comment">//以下语句会导致系统重启，原因未知</span><br>            <span class="hljs-comment">//ESP_LOG_BUFFER_HEXDUMP(RX_TASK_TAG, data, rxBytes, ESP_LOG_INFO);</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">free</span>(data);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="串口DMA"><a href="#串口DMA" class="headerlink" title="串口DMA"></a>串口DMA</h2><p>目前并没有查询到DMA模式</p>
<h2 id="LED-PWM-控制器-LEDC"><a href="#LED-PWM-控制器-LEDC" class="headerlink" title="LED PWM 控制器 (LEDC)"></a>LED PWM 控制器 (LEDC)</h2><p>LED PWM 控制器用于生成控制 LED 的脉冲宽度调制信号 (PWM)，具有占空比自动渐变等专门功能。该外设也可成生成 PWM 信号用作其他用途。</p>
<h3 id="主要特性"><a href="#主要特性" class="headerlink" title="主要特性"></a>主要特性</h3><p>LED PWM 控制器具有如下特性:<br>• 八个独立的 PWM 生成器（即八个通道）<br>• 四个独立定时器，可实现小数分频<br>• 占空比自动渐变（即 PWM 信号占空比可逐渐增加或减小，无须处理器干预），渐变完成时产生中断<br>• 输出 PWM 信号相位可调<br>• 低功耗模式 (Light-sleep mode) 下可输出 PWM 信号<br>• PWM 最大精度为 14 位<br>四个定时器具有相同的功能和运行方式，下文将四个定时器统称为定时器x（x 的范围是 0 到 3）。八个 PWM 生成器的功能和运行方式也相同，下文将统称为 PWM n（n 的范围是 0 到 7）。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681832517482.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<blockquote>
<p>从以上描述可以得到以下信息：</p>
<ul>
<li>只有8个PWM输出</li>
<li>结合之前讲解的GPIO矩阵，这8个PWM可以配置到任意引脚</li>
<li>定时器决定了PWM的频率，因此可以只使用一个定时器，生成8路频率相同的PWM（占空比可不同）。如果要频率不同，就必须再使用一个定时器。</li>
</ul>
</blockquote>
<h3 id="功能概览"><a href="#功能概览" class="headerlink" title="功能概览"></a>功能概览</h3><p>设置 LEDC 通道分三步完成。注意，ESP32-S3 仅支持设置通道为<strong>低速模式</strong>。</p>
<ul>
<li>定时器配置 指定 PWM 信号的频率和占空比分辨率。</li>
<li>通道配置 绑定定时器和输出 PWM 信号的 GPIO。</li>
<li>改变 PWM 信号 输出 PWM 信号来驱动 LED。可通过软件控制或使用硬件渐变功能来改变 LED 的亮度。</li>
</ul>
<p>另一个可选步骤是可以在渐变终端设置一个中断。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681832958649.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<blockquote>
<p>首次 LEDC 配置时，建议先配置定时器（调用函数 ledc_timer_config()），再配置通道（调用函数 ledc_channel_config()）。这样可以确保 IO 脚上的 PWM 信号自有输出开始其频率就是正确的。</p>
</blockquote>
<h3 id="定时器配置"><a href="#定时器配置" class="headerlink" title="定时器配置"></a>定时器配置</h3><p>要设置定时器，可调用函数 ledc_timer_config()，并将包括如下配置参数的数据结构ledc_timer_config_t 传递给该函数：</p>
<ul>
<li>速度模式（值必须为 LEDC_LOW_SPEED_MODE）</li>
<li>定时器索引 ledc_timer_t</li>
<li>PWM 信号频率</li>
<li>PWM 占空比分辨率</li>
<li>时钟源 ledc_clk_cfg_t</li>
</ul>
<p>频率和占空比分辨率相互关联。PWM 频率越高，占空比分辨率越低，反之亦然。</p>
<p>时钟源同样可以限制PWM频率。选择的时钟源频率越高，可以配置的PWM频率上限就越高。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681833166126.png" srcset="/img/loading.gif" lazyload alt="ESP32-S3 LEDC 时钟源特性"></p>
<blockquote>
<p>备注:</p>
<ol>
<li>如果 ESP32-S3 的定时器选用了RC_FAST_CLK作为其时钟源，驱动会通过内部校准来得知这个时钟源的实际频率。这样确保了输出PWM信号频率的精准性。</li>
<li>ESP32-S3 的所有定时器共用一个时钟源。因此 ESP32-S3 不支持给不同的定时器配置不同的时钟源。</li>
</ol>
</blockquote>
<h3 id="通道配置"><a href="#通道配置" class="headerlink" title="通道配置"></a>通道配置</h3><p>定时器设置好后，请配置所需的通道（ledc_channel_t 之一）。配置通道需调用函数 ledc_channel_config()。</p>
<p>通道的配置与定时器设置类似，需向通道配置函数传递包括通道配置参数的结构体 ledc_channel_config_t 。</p>
<p>此时，通道会按照 ledc_channel_config_t 的配置开始运作，并在选定的 GPIO 上生成由定时器设置指定的频率和占空比的 PWM 信号。在通道运作过程中，可以随时通过调用函数 ledc_stop() 将其暂停。</p>
<h3 id="改变-PWM-信号"><a href="#改变-PWM-信号" class="headerlink" title="改变 PWM 信号"></a>改变 PWM 信号</h3><p>通道开始运行、生成具有恒定占空比和频率的 PWM 信号之后，有几种方式可以改变该信号。驱动 LED 时，主要通过改变占空比来变化光线亮度。</p>
<p>以下两节介绍了如何使用软件和硬件改变占空比。如有需要，PWM 信号的频率也可更改，详见 <strong>改变 PWM 频率</strong> 一节。</p>
<blockquote>
<p>备注<br>在 ESP32-S3 的 LED PWM 控制器中，所有的定时器和通道都只支持低速模式。对 PWM 设置的任何改变，都需要由软件显式地触发（见下文）。</p>
</blockquote>
<h4 id="使用软件改变-PWM-占空比"><a href="#使用软件改变-PWM-占空比" class="headerlink" title="使用软件改变 PWM 占空比"></a>使用软件改变 PWM 占空比</h4><p>调用函数 ledc_set_duty() 可以设置新的占空比。之后，调用函数 ledc_update_duty() 使新配置生效。要查看当前设置的占空比，可使用 <em>get</em> 函数 ledc_get_duty()。</p>
<p>另外一种设置占空比和其他通道参数的方式是调用 通道配置 一节提到的函数 ledc_channel_config()。</p>
<p>传递给函数的占空比数值范围取决于选定的 duty_resolution，应为 0 至 (2 ** duty_resolution) - 1。例如，如选定的占空比分辨率为 10，则占空比的数值范围为 0 至 1023。此时分辨率为 ~0.1%。</p>
<h4 id="使用硬件改变-PWM-占空比"><a href="#使用硬件改变-PWM-占空比" class="headerlink" title="使用硬件改变 PWM 占空比"></a>使用硬件改变 PWM 占空比</h4><p>LED PWM 控制器硬件可逐渐改变占空比的数值。要使用此功能，需用函数 ledc_fade_func_install() 使能渐变，之后用下列可用渐变函数之一配置：</p>
<ul>
<li>ledc_set_fade_with_time()</li>
<li>ledc_set_fade_with_step()</li>
<li>ledc_set_fade()</li>
</ul>
<p>最后需要调用 ledc_fade_start() 开启渐变。渐变可以在阻塞或非阻塞模式下运行，具体区别请查看 ledc_fade_mode_t。需要特别注意的是，不管在哪种模式下，下一次渐变或是单次占空比配置的指令生效都必须等到前一次渐变完成或被中止。中止一个正在运行中的渐变需要调用函数 ledc_fade_stop()。</p>
<p>此外，在使能渐变后，每个通道都可以额外通过调用 ledc_cb_register() 注册一个回调函数用以获得渐变完成的事件通知。回调函数的原型被定义在 ledc_cb_t。每个回调函数都应当返回一个布尔值给驱动的中断处理函数，用以表示是否有高优先级任务被其唤醒。此外，值得注意的是，由于驱动的中断处理函数被放在了 IRAM 中， 回调函数和其调用的函数也需要被放在 IRAM 中。 ledc_cb_register() 会检查回调函数及函数上下文的指针地址是否在正确的存储区域。</p>
<p>如不需要渐变和渐变中断，可用函数 ledc_fade_func_uninstall() 关闭。</p>
<h4 id="改变-PWM-频率"><a href="#改变-PWM-频率" class="headerlink" title="改变 PWM 频率"></a>改变 PWM 频率</h4><p>LED PWM 控制器 API 有多种方式即时改变 PWM 频率：</p>
<ul>
<li>通过调用函数 ledc_set_freq() 设置频率。可用函数 ledc_get_freq() 查看当前频率。</li>
<li>通过调用函数 ledc_bind_channel_timer() 将其他定时器绑定到该通道来改变频率和占空比分辨率。</li>
<li>通过调用函数 ledc_channel_config() 改变通道的定时器。</li>
</ul>
<h4 id="控制-PWM-的更多方式"><a href="#控制-PWM-的更多方式" class="headerlink" title="控制 PWM 的更多方式"></a>控制 PWM 的更多方式</h4><p>有一些较底层的定时器特定函数可用于更改 PWM 设置：</p>
<ul>
<li>ledc_timer_set()</li>
<li>ledc_timer_rst()</li>
<li>ledc_timer_pause()</li>
<li>ledc_timer_resume()</li>
</ul>
<p>前两个功能可通过函数 ledc_channel_config() 在后台运行，在定时器配置后启动。</p>
<h4 id="使用中断"><a href="#使用中断" class="headerlink" title="使用中断"></a>使用中断</h4><p>配置 LED PWM 控制器通道时，可在 ledc_channel_config_t 中选取参数 ledc_intr_type_t ，在渐变完成时触发中断。</p>
<p>要注册处理程序来处理中断，可调用函数 ledc_isr_register()。</p>
<h3 id="频率和占空比分辨率支持范围"><a href="#频率和占空比分辨率支持范围" class="headerlink" title="频率和占空比分辨率支持范围"></a>频率和占空比分辨率支持范围</h3><p>LED PWM 控制器主要用于驱动 LED。该控制器 PWM 占空比设置的分辨率范围较广。比如，PWM 频率为 5 kHz 时，占空比分辨率最大可为 13 位。这意味着占空比可为 0 至 100% 之间的任意值，分辨率为 ~0.012%（2 ^ 13 &#x3D; 8192 LED 亮度的离散电平）。然而，这些参数取决于为 LED PWM 控制器定时器计时的时钟信号，LED PWM 控制器为通道提供时钟（具体可参考 定时器配置 和 ESP32-S3 技术参考手册 &gt; LED PWM 计时器 (LEDC) [PDF]）。</p>
<p>LED PWM 控制器可用于生成频率较高的信号，足以为数码相机模组等其他设备提供时钟。此时，最大频率可为 40 MHz，占空比分辨率为 1 位。也就是说，占空比固定为 50%，无法调整。</p>
<p>LED PWM 控制器 API 会在设定的频率和占空比分辨率超过 LED PWM 控制器硬件范围时报错。例如，试图将频率设置为 20 MHz、占空比分辨率设置为 3 位时，串行端口监视器上会报告如下错误：</p>
<p>E (196) ledc: requested frequency and duty resolution cannot be achieved, try reducing freq_hz or duty_resolution. div_param&#x3D;128<br>此时，占空比分辨率或频率必须降低。比如，将占空比分辨率设置为 2 会解决这一问题，让占空比设置为 25% 的倍数，即 25%、50% 或 75%。</p>
<p>如设置的频率和占空比分辨率低于所支持的最低值，LED PWM 驱动器也会反映并报告，如：</p>
<p>E (196) ledc: requested frequency and duty resolution cannot be achieved, try increasing freq_hz or duty_resolution. div_param&#x3D;128000000<br>占空比分辨率通常用 ledc_timer_bit_t 设置，范围是 10 至 15 位。如需较低的占空比分辨率（上至 10，下至 1），可直接输入相应数值。</p>
<h3 id="程序编写"><a href="#程序编写" class="headerlink" title="程序编写"></a>程序编写</h3><h4 id="实验一，软件修改占空比"><a href="#实验一，软件修改占空比" class="headerlink" title="实验一，软件修改占空比"></a>实验一，软件修改占空比</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;driver/ledc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_err.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_TIMER             LEDC_TIMER_0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_MODE              LEDC_LOW_SPEED_MODE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_OUTPUT_IO          (5) <span class="hljs-comment">// Define the output GPIO</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_CHANNEL            LEDC_CHANNEL_0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_DUTY_RES           LEDC_TIMER_13_BIT <span class="hljs-comment">// Set duty resolution to 13 bits</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_DUTY               (4095) <span class="hljs-comment">// Set duty to 50%. ((2 ** 13) - 1) * 50% = 4095</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDC_FREQUENCY          (5000) <span class="hljs-comment">// Frequency in Hertz. Set frequency at 5 kHz</span></span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">example_ledc_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Prepare and then apply the LEDC PWM timer configuration</span><br>    <span class="hljs-type">ledc_timer_config_t</span> ledc_timer = &#123;<br>        .speed_mode       = LEDC_MODE,<br>        .timer_num        = LEDC_TIMER,<br>        .duty_resolution  = LEDC_DUTY_RES,<br>        .freq_hz          = LEDC_FREQUENCY,  <span class="hljs-comment">// Set output frequency at 5 kHz</span><br>        .clk_cfg          = LEDC_AUTO_CLK<br>    &#125;;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">ledc_timer_config</span>(&amp;ledc_timer));<br><br>    <span class="hljs-comment">// Prepare and then apply the LEDC PWM channel configuration</span><br>    <span class="hljs-type">ledc_channel_config_t</span> ledc_channel = &#123;<br>        .speed_mode     = LEDC_MODE,<br>        .channel        = LEDC_CHANNEL,<br>        .timer_sel      = LEDC_TIMER,<br>        .intr_type      = LEDC_INTR_DISABLE,<br>        .gpio_num       = LEDC_OUTPUT_IO,<br>        .duty           = <span class="hljs-number">0</span>, <span class="hljs-comment">// Set duty to 0%</span><br>        .hpoint         = <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">ledc_channel_config</span>(&amp;ledc_channel));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Set the LEDC peripheral configuration</span><br>    <span class="hljs-built_in">example_ledc_init</span>();<br>    <span class="hljs-comment">// Set duty to 50%</span><br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">ledc_set_duty</span>(LEDC_MODE, LEDC_CHANNEL, LEDC_DUTY));<br>    <span class="hljs-comment">// Update duty to apply the new value</span><br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">ledc_update_duty</span>(LEDC_MODE, LEDC_CHANNEL));<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出波形<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681907849053.jpg" srcset="/img/loading.gif" lazyload alt="enter description here"><br>后期可以调用</p>
<ul>
<li>ledc_set_duty</li>
<li>ledc_update_duty<br>改变PWM占空比</li>
</ul>
<h3 id="实验二，硬件修改占空比"><a href="#实验二，硬件修改占空比" class="headerlink" title="实验二，硬件修改占空比"></a>实验二，硬件修改占空比</h3><p>硬件修改只能实现渐变，我们设置好参数后，硬件就会自动修改PWM，不需要软件再参与</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br>void ledc<span class="hljs-constructor">_init(<span class="hljs-params">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// Prepare and then apply the LEDC PWM timer configuration</span><br>    ledc_timer_config_t ledc_timer = &#123;<br>        .speed_mode       = LEDC_MODE,<br>        .timer_num        = LEDC_TIMER,<br>        .duty_resolution  = LEDC_DUTY_RES,<br>        .freq_hz          = LEDC_FREQUENCY,  <span class="hljs-comment">// Set output frequency at 5 kHz</span><br>        .clk_cfg          = LEDC_AUTO_CLK<br>    &#125;;<br>    ledc<span class="hljs-constructor">_timer_config(&amp;<span class="hljs-params">ledc_timer</span>)</span>;<br><br>    <span class="hljs-comment">// Prepare and then apply the LEDC PWM channel configuration</span><br>    ledc_channel_config_t ledc_channel = &#123;<br>        .speed_mode     = LEDC_MODE,<br>        .channel        = LEDC_CHANNEL,<br>        .timer_sel      = LEDC_TIMER,<br>        .intr_type      = LEDC_INTR_DISABLE,<br>        .gpio_num       = LEDC_OUTPUT_IO,<br>        .duty           = <span class="hljs-number">0</span>, <span class="hljs-comment">// Set duty to 0%</span><br>        .hpoint         = <span class="hljs-number">0</span><br>    &#125;;<br>    ledc<span class="hljs-constructor">_channel_config(&amp;<span class="hljs-params">ledc_channel</span>)</span>;<br><br>    <span class="hljs-comment">// 设置占空比</span><br>    ledc<span class="hljs-constructor">_set_duty(LEDC_MODE, LEDC_CHANNEL, LEDC_DUTY)</span>;<br>    <span class="hljs-comment">// 更新，应用生效</span><br>    ledc<span class="hljs-constructor">_update_duty(LEDC_MODE, LEDC_CHANNEL)</span>;<br>    <span class="hljs-comment">// 初始化渐变fade服务</span><br>    ledc<span class="hljs-constructor">_fade_func_install(0)</span>;<br><br>    <span class="hljs-comment">// 指定ledc通道，在设定的时间time内ms，从0渐变到 期望脉宽duty（0~定时器的满分辨率，需要手动计算）</span><br>    <span class="hljs-comment">// 渐变到的期望脉宽值（与定时器Bit有关，100%占空比对应满分辨率）</span><br>    ledc<span class="hljs-constructor">_set_fade_with_time(LEDC_MODE,LEDC_CHANNEL, 8192, 10000)</span>;<br>    ledc<span class="hljs-constructor">_fade_start(LEDC_MODE,LEDC_CHANNEL, LEDC_FADE_NO_WAIT)</span>;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>仅仅是初始化程序修改了，增加了三个函数。</p>
<ul>
<li>占空比达到期望值后，就会一直保持期望脉宽</li>
<li>实际测试，按13bit频率算，8192才是100%占空比，8191不行（不是从0开始的吗，不解）</li>
<li>软件和硬件修改PWM，那个最后一次使用，那个生效，同一时间两者只能有一个可用</li>
<li>硬件PWM还可以配合中断，实现脉宽的连续递增递减，淡入淡出</li>
</ul>
<p>输出波形，占空比自动渐变<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681911098616.jpg" srcset="/img/loading.gif" lazyload alt="enter description here"><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1681911106385.jpg" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="ADC"><a href="#ADC" class="headerlink" title="ADC"></a>ADC</h2><ul>
<li>Wi-Fi也使用ADC2，即只要WIFI工作，ADC2就不能工作。因此建议只是用ADC1</li>
<li>ADC引脚是特定的引脚，不可使用IO MUX任意指定</li>
</ul>
<p>每个 ADC 单元支持两种工作模式，ADC 单次采样模式和ADC连续采样（DMA）模式。</p>
<ul>
<li>ADC 单次采样模式适用于低频采样操作。</li>
<li>ADC 连续采样（DMA）模式适用于高频连续采样动作。</li>
<li>最大12位，位数减少会减小内存占用</li>
</ul>
<p>配置顺序：</p>
<ul>
<li>设置通道引脚</li>
<li>设置精度、衰减倍数</li>
<li>读取转换结果（数字）</li>
<li>可选：将数字结果转换为电压（相对于参考电压引脚），需要先执行校准</li>
</ul>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">/<span class="hljs-symbol">*</span>  ESP32 ADC 衰减系数 与 量程 对照表<br><br>    +----------+------------+--------------------------+------------------+<br>    |<span class="hljs-string">   SoC    </span>|<span class="hljs-string"> attenuation</span>|<span class="hljs-string">   suggested range (mV)   </span>|<span class="hljs-string">  full range (V)  </span>|<br>    +==========+============+==========================+==================+<br>    |<span class="hljs-string">          </span>|<span class="hljs-string">  0         </span>|<span class="hljs-string">     100 ~ 800            </span>|<span class="hljs-string">     0 ~ 1.1      </span>|<br>    |<span class="hljs-string">          +------------+--------------------------+------------------+</span><br><span class="hljs-string">    </span>|<span class="hljs-string">          </span>|<span class="hljs-string">  2.5       </span>|<span class="hljs-string">     100 ~ 1100           </span>|<span class="hljs-string">     0 ~ 1.5      </span>|<br>    |<span class="hljs-string"> ESP32-S2 +------------+--------------------------+------------------+</span><br><span class="hljs-string">    </span>|<span class="hljs-string">          </span>|<span class="hljs-string">  6         </span>|<span class="hljs-string">     150 ~ 1350           </span>|<span class="hljs-string">     0 ~ 2.2      </span>|<br>    |<span class="hljs-string">          +------------+--------------------------+------------------+</span><br><span class="hljs-string">    </span>|<span class="hljs-string">          </span>|<span class="hljs-string">  11        </span>|<span class="hljs-string">     150 ~ 2600           </span>|<span class="hljs-string">     0 ~ 3.9      </span>|<br>    +----------+------------+--------------------------+------------------+<br><br><span class="hljs-symbol">*</span>/<br><br></code></pre></td></tr></table></figure>
<h3 id="程序编写-1"><a href="#程序编写-1" class="headerlink" title="程序编写"></a>程序编写</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;adc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;soc/soc_caps.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_adc/adc_oneshot.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_adc/adc_cali.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_adc/adc_cali_scheme.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_log.h&quot;</span></span><br><span class="hljs-comment">//-------------ADC1 Init---------------//</span><br><span class="hljs-type">adc_oneshot_unit_handle_t</span> adc1_handle;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><br><br><br>    <span class="hljs-type">adc_oneshot_unit_init_cfg_t</span> init_config1 = &#123;<br>        .unit_id = ADC_UNIT_1,<br>		.ulp_mode = ADC_ULP_MODE_DISABLE,<span class="hljs-comment">//协处理器，与低功耗有关，暂时不用</span><br>    &#125;;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_oneshot_new_unit</span>(&amp;init_config1, &amp;adc1_handle));<br><br>    <span class="hljs-comment">//-------------ADC1 Config---------------//</span><br>    <span class="hljs-type">adc_oneshot_chan_cfg_t</span> config = &#123;<br>        .bitwidth = ADC_BITWIDTH_DEFAULT,<br>        .atten = ADC_ATTEN_DB_11,<br>    &#125;;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_oneshot_config_channel</span>(adc1_handle, ADC_CHANNEL_7, &amp;config));<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> adc_raw[<span class="hljs-number">2</span>][<span class="hljs-number">10</span>];<br><span class="hljs-type">const</span> <span class="hljs-type">static</span> <span class="hljs-type">char</span> *TAG = <span class="hljs-string">&quot;ADC_TEST&quot;</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_loop</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_oneshot_read</span>(adc1_handle, ADC_CHANNEL_7, &amp;adc_raw[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]));<br>    <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;ADC%d Channel[%d] Raw Data: %d&quot;</span>, ADC_UNIT_1 + <span class="hljs-number">1</span>, ADC_CHANNEL_7, adc_raw[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br>&#125;<br><br><br></code></pre></td></tr></table></figure>
<p>主程序</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 定义一个标签，方便批量换名字</span><br>static const <span class="hljs-built_in">char</span>* tagInfo = <span class="hljs-string">&quot;tagInfo&quot;</span>;<br><br>void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br><br>	<span class="hljs-comment">//uart_init();</span><br>    ledc<span class="hljs-constructor">_init()</span>;<br>    adc<span class="hljs-constructor">_init()</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	adc<span class="hljs-constructor">_loop()</span>;<br>    	<span class="hljs-constructor">ESP_LOGI(<span class="hljs-params">tagInfo</span>,<span class="hljs-string">&quot;running\r\n&quot;</span>)</span>;<br>        sleep(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="实验现象："><a href="#实验现象：" class="headerlink" title="实验现象："></a>实验现象：</h3><p>将引脚8连接到3.3V和GND，串口输出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">8317</span>) ADC_TEST: ADC1 Channel[<span class="hljs-number">7</span>] Raw Data: <span class="hljs-number">4095</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">8317</span>) tagInfo: running<br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">9317</span>) ADC_TEST: ADC1 Channel[<span class="hljs-number">7</span>] Raw Data: <span class="hljs-number">4095</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">9317</span>) tagInfo: running<br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">10317</span>) ADC_TEST: ADC1 Channel[<span class="hljs-number">7</span>] Raw Data: <span class="hljs-number">1097</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">10317</span>) tagInfo: running<br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">11317</span>) ADC_TEST: ADC1 Channel[<span class="hljs-number">7</span>] Raw Data: <span class="hljs-number">0</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">11317</span>) tagInfo: running<br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">12317</span>) ADC_TEST: ADC1 Channel[<span class="hljs-number">7</span>] Raw Data: <span class="hljs-number">0</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">12317</span>) tagInfo: running<br></code></pre></td></tr></table></figure>

<h2 id="ADC连续转换模式"><a href="#ADC连续转换模式" class="headerlink" title="ADC连续转换模式"></a>ADC连续转换模式</h2><p>连续转换模式实际使用的是DMA，我们将需要转换的通道序列传给DMA，它就会自动按顺序转换数据，并存储到我们指定的内存数组中。</p>
<ul>
<li>没完成一组序列转换，就是一帧</li>
<li>连续转换支持开辟内存缓存多帧数据（通常转换回避读取快）</li>
</ul>
<h4 id="程序编写-2"><a href="#程序编写-2" class="headerlink" title="程序编写"></a>程序编写</h4><p>参考例程：C:\Espressif\frameworks\esp-idf-v5.0\examples\peripherals\adc\continuous_read</p>
<ul>
<li>channel[3] 就是我们的转换序列，这里有三个</li>
<li>例程里最多只能7个通道，有一个bug，以修改</li>
<li>例程里使用了ADC2，但实际采集为0，已修改仅使用ADC1</li>
<li>例程中衰减倍数改为11，可以测量3.3V<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;adc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sdkconfig.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_log.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/FreeRTOS.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/task.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/semphr.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_adc/adc_continuous.h&quot;</span></span><br><br><span class="hljs-type">const</span> <span class="hljs-type">static</span> <span class="hljs-type">char</span> *TAG = <span class="hljs-string">&quot;ADC_TEST&quot;</span>;<br><span class="hljs-type">static</span> TaskHandle_t s_task_handle;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXAMPLE_READ_LEN   256</span><br><br><br><span class="hljs-type">static</span> <span class="hljs-type">adc_channel_t</span> channel[<span class="hljs-number">3</span>] = &#123;ADC_CHANNEL_2, ADC_CHANNEL_3, ADC_CHANNEL_8&#125;;<br><br><span class="hljs-comment">//-------------ADC1 Init---------------//</span><br><span class="hljs-type">adc_continuous_handle_t</span> handle = <span class="hljs-literal">NULL</span>;<br><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> IRAM_ATTR <span class="hljs-title">s_conv_done_cb</span><span class="hljs-params">(<span class="hljs-type">adc_continuous_handle_t</span> handle, <span class="hljs-type">const</span> <span class="hljs-type">adc_continuous_evt_data_t</span> *edata, <span class="hljs-type">void</span> *user_data)</span></span><br><span class="hljs-function"></span>&#123;<br>    BaseType_t mustYield = pdFALSE;<br>    <span class="hljs-comment">//Notify that ADC continuous driver has done enough number of conversions</span><br>    <span class="hljs-built_in">vTaskNotifyGiveFromISR</span>(s_task_handle, &amp;mustYield);<br><br>    <span class="hljs-keyword">return</span> (mustYield == pdTRUE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_init</span><span class="hljs-params">(<span class="hljs-type">adc_channel_t</span> *channel, <span class="hljs-type">uint8_t</span> channel_num, <span class="hljs-type">adc_continuous_handle_t</span> *out_handle)</span></span><br><span class="hljs-function"></span>&#123;<br><br>    <span class="hljs-type">adc_continuous_handle_cfg_t</span> adc_config = &#123;<br>        .max_store_buf_size = <span class="hljs-number">1024</span>,  <span class="hljs-comment">// 转换结果缓存，超出结果将丢失，字节</span><br>        .conv_frame_size = EXAMPLE_READ_LEN,  <span class="hljs-comment">// 一帧的大小，包含多个转换结果</span><br>    &#125;;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_continuous_new_handle</span>(&amp;adc_config, &amp;handle));<br><br>    <span class="hljs-type">adc_continuous_config_t</span> dig_cfg = &#123;<br>        .sample_freq_hz = <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>,  <span class="hljs-comment">// 最大100kSPS</span><br>        .conv_mode = ADC_CONV_SINGLE_UNIT_1,  <span class="hljs-comment">// S3仅支持ADC1。不支持ADC2</span><br>		<span class="hljs-comment">// 参考adc_digi_output_data_t    C:\Espressif\frameworks\esp-idf-v5.0\components\hal\include\hal\adc_types.h</span><br>		<span class="hljs-comment">// 不同芯片会有不同的输出格式 每个转换结果是一个结构体，并不单单是一个adc数据</span><br>		<span class="hljs-comment">// s3就只有一个TYPE2</span><br>        .format = ADC_DIGI_OUTPUT_FORMAT_TYPE2,<br>    &#125;;<br><br>    <span class="hljs-type">adc_digi_pattern_config_t</span> adc_pattern[SOC_ADC_PATT_LEN_MAX] = &#123;<span class="hljs-number">0</span>&#125;;<br>    dig_cfg.pattern_num = channel_num;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; channel_num; i++) &#123;<br>        <span class="hljs-type">uint8_t</span> ch = channel[i];<br>        adc_pattern[i].atten = ADC_ATTEN_DB_11;<br>        adc_pattern[i].channel = ch;<br>        adc_pattern[i].unit = ADC_UNIT_1;<br>        adc_pattern[i].bit_width = ADC_BITWIDTH_12;  <span class="hljs-comment">// SOC_ADC_DIGI_MAX_BITWIDTH</span><br><br>        <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;adc_pattern[%d].atten is :%x&quot;</span>, i, adc_pattern[i].atten);<br>        <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;adc_pattern[%d].channel is :%x&quot;</span>, i, adc_pattern[i].channel);<br>        <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;adc_pattern[%d].unit is :%x&quot;</span>, i, adc_pattern[i].unit);<br>    &#125;<br>    dig_cfg.adc_pattern = adc_pattern;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_continuous_config</span>(handle, &amp;dig_cfg));<br><br>    *out_handle = handle;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">check_valid_data</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">adc_digi_output_data_t</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> unit = data-&gt;type2.unit;<br>    <span class="hljs-keyword">if</span> (unit &gt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (data-&gt;type2.channel &gt;= <span class="hljs-built_in">SOC_ADC_CHANNEL_NUM</span>(unit)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_loop</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">esp_err_t</span> ret;<br>    <span class="hljs-type">uint32_t</span> ret_num = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint8_t</span> result[EXAMPLE_READ_LEN] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">memset</span>(result, <span class="hljs-number">0xcc</span>, EXAMPLE_READ_LEN);<br><br>    s_task_handle = <span class="hljs-built_in">xTaskGetCurrentTaskHandle</span>();<br><br>    <span class="hljs-type">adc_continuous_handle_t</span> handle = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-built_in">adc_init</span>(channel, <span class="hljs-built_in">sizeof</span>(channel) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">adc_channel_t</span>), &amp;handle);<br><br>    <span class="hljs-comment">// 注册转换完成回调函数</span><br>    <span class="hljs-type">adc_continuous_evt_cbs_t</span> cbs = &#123;<br>        .on_conv_done = s_conv_done_cb,<br>    &#125;;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_continuous_register_event_callbacks</span>(handle, &amp;cbs, <span class="hljs-literal">NULL</span>));<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">adc_continuous_start</span>(handle));<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * This is to show you the way to use the ADC continuous mode driver event callback.</span><br><span class="hljs-comment">         * This `ulTaskNotifyTake` will block when the data processing in the task is fast.</span><br><span class="hljs-comment">         * However in this example, the data processing (print) is slow, so you barely block here.</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * Without using this event callback (to notify this task), you can still just call</span><br><span class="hljs-comment">         * `adc_continuous_read()` here in a loop, with/without a certain block timeout.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-built_in">ulTaskNotifyTake</span>(pdTRUE, portMAX_DELAY);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>            ret = <span class="hljs-built_in">adc_continuous_read</span>(handle, result, EXAMPLE_READ_LEN, &amp;ret_num, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (ret == ESP_OK) &#123;<br>                <span class="hljs-built_in">ESP_LOGI</span>(<span class="hljs-string">&quot;TASK&quot;</span>, <span class="hljs-string">&quot;ret is %x, ret_num is %&quot;</span>PRIu32, ret, ret_num);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ret_num; i += SOC_ADC_DIGI_RESULT_BYTES) &#123;<br>                    <span class="hljs-type">adc_digi_output_data_t</span> *p = (<span class="hljs-type">void</span>*)&amp;result[i];<br><br>					<span class="hljs-keyword">if</span> (<span class="hljs-built_in">check_valid_data</span>(p)) &#123;<br>						<span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;Unit: %d,_Channel: %d, Value: %x&quot;</span>, p-&gt;type2.unit+<span class="hljs-number">1</span>, p-&gt;type2.channel, p-&gt;type2.data);<br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						<span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;Invalid data [%d_%d_%x]&quot;</span>, p-&gt;type2.unit+<span class="hljs-number">1</span>, p-&gt;type2.channel, p-&gt;type2.data);<br>					&#125;<br>                &#125;<br>                <span class="hljs-comment">/**</span><br><span class="hljs-comment">                 * Because printing is slow, so every time you call `ulTaskNotifyTake`, it will immediately return.</span><br><span class="hljs-comment">                 * To avoid a task watchdog timeout, add a delay here. When you replace the way you process the data,</span><br><span class="hljs-comment">                 * usually you don&#x27;t need this delay (as this task will block for a while).</span><br><span class="hljs-comment">                 */</span><br>                <span class="hljs-built_in">vTaskDelay</span>(<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret == ESP_ERR_TIMEOUT) &#123;<br>                <span class="hljs-comment">//We try to read `EXAMPLE_READ_LEN` until API returns timeout, which means there&#x27;s no available data</span><br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="LCD-SPI接口"><a href="#LCD-SPI接口" class="headerlink" title="LCD-SPI接口"></a>LCD-SPI接口</h2><p>参考资料：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/peripherals/lcd.html">ESP-IDF 编程指南：API 参考 » 外设 API » LCD</a><br>参考IDF官方例程：C:\Espressif\frameworks\esp-idf-v5.0\examples\get-started\blink\main\blink_example_main.c</p>
<h3 id="SPI接口与引脚"><a href="#SPI接口与引脚" class="headerlink" title="SPI接口与引脚"></a>SPI接口与引脚</h3><h4 id="SPI接口"><a href="#SPI接口" class="headerlink" title="SPI接口"></a>SPI接口</h4><p>ESP32-S3 具有以下 SPI 接口：<br>• SPI0，供 ESP32-S3 和加密 DMA (EDMA) 访问封装内或封装外 flash&#x2F;PSRAM<br>• SPI1，供 CPU 访问封装内或封装外 flash&#x2F;PSRAM<br>• SPI2，通用 SPI 控制器，具有单独的 DMA 通道，主机80MHz，从机60MHz<br>• SPI3，通用 SPI 控制器，和部分外设共用一个 DMA 通道，主机80MHz，从机60MHz<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/%E8%A1%A8_3-2._SPI_%E7%AE%A1%E8%84%9A%E9%85%8D%E7%BD%AE.jpg" srcset="/img/loading.gif" lazyload alt="表 3-2"><br>结合 前言-GPIO交换矩阵可知</p>
<ul>
<li>EPS32 S3芯片的SPI0&#x2F;1用于外部flash和PSRAM.所以只有SP2&#x2F;3可用</li>
<li>ESP32 S3 中SPI3和部分外设公用DMA通道，因此速度受限</li>
<li>ESP32 S3推荐使用SPI2作为LCD的接口</li>
</ul>
<p>EPS32 只有SPI2可用。SPI0&#x2F;1用于flash和PSRAM<br>可连接 GDMA 通道。</p>
<ul>
<li>在主机模式下，时钟频率最高为 80 MHz，支持 SPI 传输的四种时钟模式。</li>
<li>在从机模式下，时钟频率最高为 60 MHz，也支持 SPI 传输的四种时钟模式。</li>
</ul>
<p>另外ESP32的普通GPIO最大只能30MHz，而IOMUX默认的SPI，CLK最大可以设置到80MHz。所以为了提高刷屏速度，尽量使用硬件的IOMUX端口。</p>
<p>ESP32的SPI默认使用DMA，在传输长度较长的数据时可以明显提高效率</p>
<h4 id="SPI引脚"><a href="#SPI引脚" class="headerlink" title="SPI引脚"></a>SPI引脚</h4><p>SPI2的IO MUX 管脚如下。SPI3可以可以映射到任意引脚<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/FSPISPI3_%E6%80%BB%E7%BA%BF%E4%BF%A1%E5%8F%B7%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0.jpg" srcset="/img/loading.gif" lazyload alt="FSPISPI3 总线信号功能描述"></p>
<h2 id="看门狗"><a href="#看门狗" class="headerlink" title="看门狗"></a>看门狗</h2><h2 id="定时器中断"><a href="#定时器中断" class="headerlink" title="定时器中断"></a>定时器中断</h2><h2 id="输入捕获"><a href="#输入捕获" class="headerlink" title="输入捕获"></a>输入捕获</h2><h2 id="电容触摸"><a href="#电容触摸" class="headerlink" title="电容触摸"></a>电容触摸</h2><h2 id="触摸"><a href="#触摸" class="headerlink" title="触摸"></a>触摸</h2><h2 id="LCD-SPI"><a href="#LCD-SPI" class="headerlink" title="LCD SPI"></a>LCD SPI</h2><p>参考例程：<a target="_blank" rel="noopener" href="https://github.com/espressif/esp-bsp/tree/master/components/lcd">https://github.com/espressif/esp-bsp/tree/master/components/lcd</a></p>
<h2 id="LCD-LVGL"><a href="#LCD-LVGL" class="headerlink" title="LCD LVGL"></a>LCD LVGL</h2><p>参考程序：<a target="_blank" rel="noopener" href="https://github.com/espressif/esp-bsp">https://github.com/espressif/esp-bsp</a><br>其中LVGL接口程序：<a target="_blank" rel="noopener" href="https://github.com/espressif/esp-bsp/tree/master/components/esp_lvgl_port">https://github.com/espressif/esp-bsp/tree/master/components/esp_lvgl_port</a></p>
<p>一直过程中需要修改<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/%E5%9B%BE%E5%83%8F_1.png" srcset="/img/loading.gif" lazyload alt="图像 1"></p>
<p>sdkconfig 打开颜色交换。部分LCD适用，如果你发向颜色不对<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/%E5%9B%BE%E5%83%8F_3.png" srcset="/img/loading.gif" lazyload alt="图像 3"></p>
<h2 id="RTC"><a href="#RTC" class="headerlink" title="RTC"></a>RTC</h2><p>编程指南： API 参考 » System API » 系统时间<br>RTC不太实用，我们使用另一个SNTP从网络获取时间，见下一章节</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>ESP32-S3 使用两种硬件时钟源建立和保持系统时间。根据应用目的及对系统时间的精度要求，既可以仅使用其中一种时钟源，也可以同时使用两种时钟源。这两种硬件时钟源为：</p>
<ul>
<li><p>RTC 定时器：RTC 定时器在任何睡眠模式下及在任何复位后均可保持系统时间（上电复位除外，因为上电复位会重置 RTC 定时器）。时钟频率偏差取决于 RTC 定时器时钟源，该偏差只会在睡眠模式下影响时间精度。睡眠模式下，时间分辨率为 6.667 μs。</p>
</li>
<li><p>高分辨率定时器：高分辨率定时器在睡眠模式下及在复位后不可用，但其时间精度更高。该定时器使用 APB_CLK 时钟源（通常为 80 MHz），时钟频率偏差小于 ±10 ppm，时间分辨率为 1 μs。</p>
</li>
</ul>
<p>高分辨率定时器无法获取的年月日，重启后计数归零。因此还是用RTC，另外使用RTC还需要外部电池和低功耗模式，维持RTC的运行，否则 如果整个系统彻底断电重启，则日期回到初始状态。</p>
<h3 id="RTC-定时器时钟源"><a href="#RTC-定时器时钟源" class="headerlink" title="RTC 定时器时钟源"></a>RTC 定时器时钟源</h3><p>RTC 定时器有以下时钟源：</p>
<ul>
<li><p>内置 136 kHz RC 振荡器 （默认）：Deep-sleep 模式下电流消耗最低，不依赖任何外部元件。但由于温度波动会影响该时钟源的频率稳定性，在 Deep-sleep 和 Light-sleep 模式下都有可能发生时间偏移。</p>
</li>
<li><p>外置 32 kHz 晶振：需要将一个 32 kHz 晶振连接到 XTAL_32K_P 和 XTAL_32K_N 管脚。频率稳定性更高，但在 Deep-sleep 模式下电流消耗略高（比默认模式高 1 μA）。</p>
</li>
<li><p>管脚 XTAL_32K_P 外置 32 kHz 振荡器：允许使用由外部电路产生的 32 kHz 时钟。外部时钟信号必须连接到管脚 XTAL_32K_P。正弦波信号的振幅应小于 1.2 V，方波信号的振幅应小于 1 V。正常模式下，电压范围应为 0.1 &lt; Vcm &lt; 0.5 xVamp，其中 Vamp 代表信号振幅。使用此时钟源时，管脚 XTAL_32K_P 无法用作 GPIO 管脚。</p>
</li>
<li><p>内置 17.5 MHz 振荡器的 256 分频时钟 (~68 kHz)：频率稳定性优于 内置 136 kHz RC 振荡器，同样无需外部元件，但 Deep-sleep 模式下电流消耗更高（比默认模式高 5 μA）。</p>
</li>
</ul>
<p>时钟源的选择取决于系统时间精度要求和睡眠模式下的功耗要求。要修改 RTC 时钟源，请在项目配置中设置 CONFIG_RTC_CLK_SRC。</p>
<p>模组中不自带外置晶振的，所以还需要自己搭建电路，这里测试使用内部振荡器。</p>
<h2 id="SNTP"><a href="#SNTP" class="headerlink" title="SNTP"></a>SNTP</h2><p>参考资料：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/system/system_time.html#sntp-time-synchronization">SNTP 时间同步</a></p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><ul>
<li>SNTP 简单网络时间协议（Simple Network Time Protocol），由 NTP 改编而来。</li>
<li>SNTP 主要用来同步因特网中的计算机时钟。在 RFC2030 中定义。</li>
<li>SNTP 基于UDP协议，存在SNTP服务器和SNTP客户端</li>
<li>SNTP 有单播和广播两种模式。</li>
<li>单播模式下，SNTP客户端定时访问SNTP服务器获得准确的时间信息，用于同步时间。</li>
<li>广播模式下，SNTP服务器周期性地发送消息给指定的IP广播地址或者IP多播地址，用户SNTP客户端同步时间。</li>
<li>网络中存在多个SNTP服务器，SNTP客户端可以选择多个SNTP服务器作为外部时间源，当某个SNTP服务器故障断开连接时，可以及时切换到其他SNTP服务器。</li>
<li>ESP32的SNTP同步功能是基于lwIP SNTP库，功能实现很简单，请见下文。</li>
</ul>
<h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><p>3.1 时间同步状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// SNTP sync status</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> &#123;<br>    SNTP_SYNC_STATUS_RESET,         <span class="hljs-comment">// Reset status.</span><br>    SNTP_SYNC_STATUS_COMPLETED,     <span class="hljs-comment">// Time is synchronized.</span><br>    SNTP_SYNC_STATUS_IN_PROGRESS,   <span class="hljs-comment">// Smooth time sync in progress.</span><br>&#125; <span class="hljs-type">sntp_sync_status_t</span>;<br></code></pre></td></tr></table></figure>

<p>3.2 时间同步模式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// SNTP time update mode</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> &#123;<br>    SNTP_SYNC_MODE_IMMED,   <span class="hljs-comment">/* 立即更新时间 */</span><br>    SNTP_SYNC_MODE_SMOOTH,  <span class="hljs-comment">/* 平滑更新，如果时间差别不大，软件会慢慢将时间调整到网络时间，而不是立即改变，这样用户就看不出来时间更改了，但如果时间差别太大（&gt;35min），也会立即更新时间 */</span><br>&#125; <span class="hljs-type">sntp_sync_mode_t</span>;<br></code></pre></td></tr></table></figure>
<p>3.3 SNTP工作模式<br>默认单播</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* SNTP operating modes: default is to poll using unicast.</span><br><span class="hljs-comment">   The mode has to be set before calling sntp_init(). */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SNTP_OPMODE_POLL            0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SNTP_OPMODE_LISTENONLY      1</span><br></code></pre></td></tr></table></figure>

<p>3.3 关键函数<br>设置同步模式。<br><code>void sntp_set_sync_mode(sntp_sync_mode_t sync_mode)</code></p>
<p>获取同步模式。<br><code>sntp_sync_mode_t sntp_get_sync_mode(void)</code></p>
<p>设置时间同步状态。<br><code>void sntp_set_sync_status(sntp_sync_status_t sync_status)</code></p>
<p>获取时间同步状态。<br><code>sntp_sync_status_t sntp_get_sync_status(void)</code></p>
<p>设置时间同步通知回调函数<br><code>void sntp_set_time_sync_notification_cb(sntp_sync_time_cb_t callback)</code></p>
<p>设置 SNTP 操作的同步间隔。<br>注意：SNTPv4 RFC 4330 强制最小同步间隔为 15 秒。此同步间隔将用于通过 SNT​​P 的下一次尝试更新时间。要应用新的同步间隔，请调用 sntp_restart() 函数，否则，它将在最后一个间隔到期后应用。<br><code>void sntp_set_sync_interval(uint32_t interval_ms)</code></p>
<p>获取 SNTP 操作的同步间隔。<br><code>uint32_t sntp_get_sync_interval(void)</code></p>
<p>设置SNTP工作模式，单播或者广播<br><code>void sntp_setoperatingmode(u8_t operating_mode)</code></p>
<p>设置SNTP服务器<br><code>void sntp_setservername(u8_t idx, const char *server)</code></p>
<p>SNTP初始化。<br><code>void sntp_init(void)</code></p>
<p>SNTP停止。<br><code>void sntp_stop(void)</code></p>
<p>重新启动 SNTP（先停止，再初始化）。<br><code>bool sntp_restart(void)</code></p>
<h3 id="wifi配置"><a href="#wifi配置" class="headerlink" title="wifi配置"></a>wifi配置</h3><p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/connect_config.jpg" srcset="/img/loading.gif" lazyload alt="connect config"></p>
<h3 id="示例程序"><a href="#示例程序" class="headerlink" title="示例程序"></a>示例程序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;esp_log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lwip/err.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lwip/apps/sntp.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;protocol_examples_common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_sntp.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/event_groups.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/FreeRTOS.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/task.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_system.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_event.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_log.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_attr.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_sleep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;nvs_flash.h&quot;</span></span><br><br><span class="hljs-comment">// 定义一个标签，方便批量换名字</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span>* tagInfo = <span class="hljs-string">&quot;tagInfo&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span>* TAG = <span class="hljs-string">&quot;SNTP&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_time</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">time_t</span> second;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">tm</span> *datetime;<br><br>    <span class="hljs-built_in">time</span>(&amp;second);<br>    datetime = <span class="hljs-built_in">localtime</span>(&amp;second);<br>    <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;The current time is: %04d/%02d/%02d %02d:%02d:%02d. by Lonly&quot;</span>, datetime-&gt;tm_year+<span class="hljs-number">1900</span>, datetime-&gt;tm_mon+<span class="hljs-number">1</span>, datetime-&gt;tm_mday, datetime-&gt;tm_hour, datetime-&gt;tm_min, datetime-&gt;tm_sec);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">get_sntp_status</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> status = <span class="hljs-built_in">sntp_get_sync_status</span>();<br>    <span class="hljs-keyword">switch</span>(status)&#123;<br>        <span class="hljs-keyword">case</span> SNTP_SYNC_STATUS_RESET:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;RESET&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SNTP_SYNC_STATUS_COMPLETED:<br>        <span class="hljs-built_in">sntp_stop</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;COMPLETED&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SNTP_SYNC_STATUS_IN_PROGRESS:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;PROGRESS&quot;</span>;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">initialize_sntp</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;Initializing SNTP&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> LWIP_DHCP_GET_NTP_SRV</span><br>    <span class="hljs-built_in">sntp_servermode_dhcp</span>(<span class="hljs-number">1</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-built_in">sntp_setoperatingmode</span>(SNTP_OPMODE_POLL);<br>    <span class="hljs-comment">// sntp_setservername(0, &quot;pool.ntp.org&quot;);</span><br>    <span class="hljs-comment">// sntp_setservername(0, &quot;210.72.145.44&quot;);  // 国家授时中心服务器 IP 地址</span><br>    <span class="hljs-built_in">sntp_setservername</span>(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;ntp1.aliyun.com&quot;</span>);<br><br>    <span class="hljs-comment">// sntp_set_time_sync_notification_cb(time_sync_notification_cb);</span><br>    <span class="hljs-built_in">sntp_set_sync_mode</span>(SNTP_SYNC_MODE_IMMED);<br>    <span class="hljs-comment">// sntp_set_sync_interval(15*1000);</span><br>    <span class="hljs-built_in">sntp_init</span>();<br>    <span class="hljs-comment">// sntp_restart();</span><br>    <span class="hljs-comment">// ESP_LOGI(TAG, &quot;SNTP interval: %d&quot;, sntp_get_sync_interval());</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">nvs_flash_init</span>();<br>    <span class="hljs-built_in">esp_netif_init</span>();<br>    <span class="hljs-built_in">esp_event_loop_create_default</span>();<br>    <span class="hljs-built_in">example_connect</span>();<br><br>    <span class="hljs-built_in">initialize_sntp</span>();<br>	<span class="hljs-comment">//uart_init();</span><br>    <span class="hljs-comment">//ledc_init();</span><br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	<span class="hljs-built_in">ESP_LOGI</span>(tagInfo,<span class="hljs-string">&quot;running\r\n&quot;</span>);<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">ESP_LOGI</span>(TAG, <span class="hljs-string">&quot;sntp sync status: %s |%d&quot;</span>, <span class="hljs-built_in">get_sntp_status</span>(), i++);<br>        <span class="hljs-built_in">vTaskDelay</span>(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<br>		<span class="hljs-built_in">get_time</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">16603</span>) example_connect: Wi-Fi disconnected, trying to reconnect...<br><span class="hljs-attribute">I</span> (<span class="hljs-number">19013</span>) example_connect: Wi-Fi disconnected, trying to reconnect...<br><span class="hljs-attribute">I</span> (<span class="hljs-number">21413</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">21413</span>) wifi:state: init -&gt; auth (b0)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">22413</span>) wifi:state: auth -&gt; init (<span class="hljs-number">200</span>)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">22423</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">22423</span>) example_connect: WiFi Connect failed <span class="hljs-number">7</span> times, stop reconnect.<br><span class="hljs-attribute">I</span> (<span class="hljs-number">22423</span>) SNTP: Initializing SNTP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">22433</span>) tagInfo: running<br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">23433</span>) SNTP: sntp sync status: RESET |<span class="hljs-number">0</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">24433</span>) SNTP: The current time is: <span class="hljs-number">2023</span>/<span class="hljs-number">07</span>/<span class="hljs-number">16</span> <span class="hljs-number">11</span>:<span class="hljs-number">06</span>:<span class="hljs-number">42</span>. by Lonly<br><span class="hljs-attribute">I</span> (<span class="hljs-number">24433</span>) tagInfo: running<br></code></pre></td></tr></table></figure>
<h2 id="非易失性存储-NVS"><a href="#非易失性存储-NVS" class="headerlink" title="非易失性存储 (NVS)"></a>非易失性存储 (NVS)</h2><p>参考资料：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/storage/nvs_flash.html">非易失性存储库</a><br>ESP-IDF storage 目录下提供了数个代码示例：</p>
<p>再说NVS前，请先阅读前面章节：<strong>Partition Tables分区表</strong></p>
<h3 id="1、NVS介绍"><a href="#1、NVS介绍" class="headerlink" title="1、NVS介绍"></a>1、NVS介绍</h3><p>非易失性存储 (NVS) 库主要用于在 flash 中存储键值格式的数据。</p>
<p>NVS 库通过调用 esp_partitionAPI 使用主 flash 的部分空间，即类型为 data 且子类型为 nvs 的所有分区。</p>
<h3 id="2、操作流程"><a href="#2、操作流程" class="headerlink" title="2、操作流程"></a>2、操作流程</h3><p>读操作流程：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689432933040.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>写操作流程<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689432957921.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="3、关键函数"><a href="#3、关键函数" class="headerlink" title="3、关键函数"></a>3、关键函数</h3><ul>
<li><p>初始化默认的 NVS 分区。</p>
</li>
<li><p>此 API 初始化默认 NVS 分区。默认 NVS 分区是分区表中标记为“nvs”的分区。<br><code>esp_err_t nvs_flash_init(void)</code></p>
</li>
<li><p>擦除默认的 NVS 分区。</p>
</li>
<li><p>擦除默认 NVS 分区的所有内容（带有标签“nvs”的分区）。<br><code>esp_err_t nvs_flash_erase(void)</code></p>
</li>
<li><p>从默认 NVS 分区打开具有给定命名空间的非易失性存储。<br>-多个内部 ESP-IDF 和第三方应用程序模块可以将它们的键值对存储在 NVS 模块中。为了减少可能的键名冲突，每个模块都可以使用自己的命名空间。默认 NVS 分区是分区表中标记为“nvs”的分区。<br><code>esp_err_t nvs_open(const char* name, nvs_open_mode_t open_mode, nvs_handle_t *out_handle)</code></p>
</li>
<li><p>获取给定键的 int8_t 值</p>
</li>
<li><p>这些函数根据给定的名称检索键的值。如果key不存在，或者请求的变量类型与设置值时使用的类型不匹配，则返回错误。<br><code>esp_err_t nvs_get_i8 (nvs_handle_t c_handle, const char* key, int32_t* out_value)</code></p>
</li>
<li><p>为给定键设置 int8_t 值</p>
</li>
<li><p>设置键的值，给定它的名称。nvs_commit请注意，实际存储在调用之前不会更新。<br><code>esp_err_t nvs_get_i8 (nvs_handle_t handle, const char* key, int32_t value)</code></p>
</li>
<li><p>将任何挂起的更改写入非易失性存储。</p>
</li>
<li><p>设置任何值后，必须调用 nvs_commit() 以确保将更改写入非易失性存储。个别实现可能会在其他时间写入存储，但这不能保证。<br><code>esp_err_t nvs_commit(nvs_handle_t c_handle)</code></p>
</li>
<li><p>关闭handle并释放所有分配的资源。</p>
</li>
<li><p>handle不再使用，则应为使用 nvs_open 打开的每个handle调用此函数。</p>
</li>
<li><p>关闭句柄可能不会自动将更改写入非易失性存储。这必须使用 nvs_commit 函数显式完成。<br><code>void nvs_close(nvs_handle_t handle)</code></p>
</li>
<li><p>擦除具有给定键名的键值对。<br><code>esp_err_t nvs_erase_key(nvs_handle_t handle, const char *key)</code></p>
</li>
<li><p>擦除命名空间中的所有键值对。<br><code>esp_err_t nvs_erase_all(nvs_handle_t handle);</code></p>
</li>
</ul>
<h3 id="示例1：随机整数读取"><a href="#示例1：随机整数读取" class="headerlink" title="示例1：随机整数读取"></a>示例1：随机整数读取</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#<span class="hljs-keyword">include</span> &lt;stdio.h&gt;<br>#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/FreeRTOS.h&quot;</span><br>#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/task.h&quot;</span><br>#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_system.h&quot;</span><br>#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_log.h&quot;</span><br><br>#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;nvs_flash.h&quot;</span><br>#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;nvs.h&quot;</span><br><br>static const <span class="hljs-built_in">char</span> *TAG = <span class="hljs-string">&quot;nvs_kv&quot;</span>;<br>static const <span class="hljs-built_in">char</span> *KEY = <span class="hljs-string">&quot;nvs_demo_key&quot;</span>;<br><br>void delay<span class="hljs-constructor">_ms(<span class="hljs-params">uint32_t</span> <span class="hljs-params">millisecond</span>)</span><br>&#123;<br>    v<span class="hljs-constructor">TaskDelay(<span class="hljs-params">millisecond</span> <span class="hljs-operator">/</span> <span class="hljs-params">portTICK_RATE_MS</span>)</span>;<br>&#125;<br><br><span class="hljs-built_in">int</span> get<span class="hljs-constructor">_value()</span><br>&#123;<br>    esp_err_t err;<br>    nvs_handle_t handle;   <br>    <span class="hljs-built_in">int</span> value=<span class="hljs-number">0</span>;<br> <br>    err = nvs<span class="hljs-constructor">_open(<span class="hljs-string">&quot;nvs&quot;</span>, NVS_READWRITE, &amp;<span class="hljs-params">handle</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK) &#123;<br>        <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;Error (%s) opening NVS handle!&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        err = nvs<span class="hljs-constructor">_get_i32(<span class="hljs-params">handle</span>, KEY, &amp;<span class="hljs-params">value</span>)</span>;<br>        <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>            <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;get_value (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);  <br>    &#125;<br>    nvs<span class="hljs-constructor">_close(<span class="hljs-params">handle</span>)</span>;<br>    return value;<br>&#125;<br><br>void set<span class="hljs-constructor">_value(<span class="hljs-params">int</span> <span class="hljs-params">value</span>)</span><br>&#123;<br>    esp_err_t err;<br>    nvs_handle_t handle;  <br>    <br>    err = nvs<span class="hljs-constructor">_open(<span class="hljs-string">&quot;nvs&quot;</span>, NVS_READWRITE, &amp;<span class="hljs-params">handle</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK) &#123;<br>        <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;Error (%s) opening NVS handle!&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>    &#125; <br>    <span class="hljs-keyword">else</span> <br>    &#123;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;set_value %d&quot;</span>, <span class="hljs-params">value</span>)</span>;<br>        <br>        err = nvs<span class="hljs-constructor">_set_i32(<span class="hljs-params">handle</span>, KEY, <span class="hljs-params">value</span>)</span>;<br>        <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>            <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;set_value (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>); <br><br>        err = nvs<span class="hljs-constructor">_commit(<span class="hljs-params">handle</span>)</span>;<br>        <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>            <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;nvs_commit (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>    &#125;<br>    nvs<span class="hljs-constructor">_close(<span class="hljs-params">handle</span>)</span>;<br>&#125;<br><br>void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// Initialize NVS</span><br>    esp_err_t err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    <span class="hljs-keyword">if</span> (err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NO_FREE_PAGES<span class="hljs-operator"> || </span>err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NEW_VERSION_FOUND) &#123;<br>        <span class="hljs-comment">// NVS partition was truncated and needs to be erased</span><br>        <span class="hljs-comment">// Retry nvs_flash_init</span><br>        <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">nvs_flash_erase</span>()</span>);<br>        err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    &#125;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">err</span> )</span>;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;<br>        delay<span class="hljs-constructor">_ms(3000)</span>;<br>        <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;get_value = %d&quot;</span>, <span class="hljs-params">get_value</span>()</span>);<br>        set<span class="hljs-constructor">_value(<span class="hljs-params">rand</span>()</span>%<span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689479627063.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="示例2：数组读取"><a href="#示例2：数组读取" class="headerlink" title="示例2：数组读取"></a>示例2：数组读取</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *NVS_KEY = <span class="hljs-string">&quot;nvs_demo_key3&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-type">esp_err_t</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">esp_err_t</span> err;<br>	<span class="hljs-type">nvs_handle_t</span> my_handle;<br>    <span class="hljs-comment">// Open</span><br>    <span class="hljs-comment">// Open</span><br>    err = <span class="hljs-built_in">nvs_open</span>(NVS_KEY, NVS_READWRITE, &amp;my_handle);<br>    <span class="hljs-keyword">if</span> (err != ESP_OK) <span class="hljs-keyword">return</span> err;<br><br>    <span class="hljs-comment">// Read the size of memory space required for blob</span><br>    <span class="hljs-type">size_t</span> required_size = <span class="hljs-number">0</span>;  <span class="hljs-comment">// value will default to 0, if not set yet in NVS</span><br>    err = <span class="hljs-built_in">nvs_get_blob</span>(my_handle, <span class="hljs-string">&quot;run_time&quot;</span>, <span class="hljs-literal">NULL</span>, &amp;required_size);<br>    <span class="hljs-keyword">if</span> (err != ESP_OK &amp;&amp; err != ESP_ERR_NVS_NOT_FOUND) <span class="hljs-keyword">return</span> err;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Run time:\n&quot;</span>);<br>    <span class="hljs-comment">// Read previously saved blob if available</span><br>    <span class="hljs-keyword">if</span> (required_size == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Nothing saved yet!\n&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">uint32_t</span>* run_time = <span class="hljs-built_in">malloc</span>(required_size);<br>        err = <span class="hljs-built_in">nvs_get_blob</span>(my_handle, <span class="hljs-string">&quot;run_time&quot;</span>, run_time, &amp;required_size);<br>        <span class="hljs-keyword">if</span> (err != ESP_OK) &#123;<br>            <span class="hljs-built_in">free</span>(run_time);<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; required_size / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>); i++) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: %ld\n&quot;</span>, i + <span class="hljs-number">1</span>, run_time[i]);<br>        &#125;<br>        <span class="hljs-built_in">free</span>(run_time);<br>    &#125;<br><br>    <span class="hljs-comment">// Close</span><br>    <span class="hljs-built_in">nvs_close</span>(my_handle);<br>    <span class="hljs-keyword">return</span> ESP_OK;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">esp_err_t</span> <span class="hljs-title">setValue</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">esp_err_t</span> err;<br>	<span class="hljs-type">nvs_handle_t</span> my_handle;<br>	<span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> s_countTest =<span class="hljs-number">0</span> ;<br>	err = <span class="hljs-built_in">nvs_open</span>(NVS_KEY, NVS_READWRITE, &amp;my_handle);<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) <span class="hljs-keyword">return</span> err;<br><br>	<span class="hljs-comment">// Write</span><br>	<span class="hljs-comment">//ESP_LOGI(tagInfo, &quot;set_value %d&quot;, value);</span><br>	<span class="hljs-comment">// Read the size of memory space required for blob</span><br>	<span class="hljs-comment">/*先使用一次nvs_get_blob函数，但是第三个参数输出地址使用的是NULL，</span><br><span class="hljs-comment">		表示读出的数据不保存，因为这里使用只是为了看一下 &quot;run_time&quot; 处是否</span><br><span class="hljs-comment">		有数据，只是先读一下数据，看一下读完以后 required_size 还是不是0</span><br><span class="hljs-comment">		*/</span><br>	<span class="hljs-type">size_t</span> required_size = <span class="hljs-number">0</span>;  <span class="hljs-comment">// value will default to 0, if not set yet in NVS</span><br>	err = <span class="hljs-built_in">nvs_get_blob</span>(my_handle, <span class="hljs-string">&quot;run_time&quot;</span>, <span class="hljs-literal">NULL</span>, &amp;required_size);<br>	<span class="hljs-keyword">if</span> (err != ESP_OK &amp;&amp; err != ESP_ERR_NVS_NOT_FOUND) <span class="hljs-keyword">return</span> err;<br><br>	<span class="hljs-comment">// Write value including previously saved blob if available</span><br>	<span class="hljs-comment">//</span><br><br>	<span class="hljs-type">uint32_t</span>* run_time = <span class="hljs-built_in">malloc</span>(required_size + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>));<br>    <span class="hljs-keyword">if</span> (required_size &gt; <span class="hljs-number">0</span>) &#123;<br>        err = <span class="hljs-built_in">nvs_get_blob</span>(my_handle, <span class="hljs-string">&quot;run_time&quot;</span>, run_time, &amp;required_size);<br>        <span class="hljs-keyword">if</span> (err != ESP_OK) &#123;<br>            <span class="hljs-built_in">free</span>(run_time);<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>    &#125;<br><br>	required_size += <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>);<br>	run_time[required_size / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>) - <span class="hljs-number">1</span>] = s_countTest++;<br>	err = <span class="hljs-built_in">nvs_set_blob</span>(my_handle, <span class="hljs-string">&quot;run_time&quot;</span>, run_time, required_size);<br>	<span class="hljs-built_in">free</span>(run_time);<br><br>	<span class="hljs-keyword">if</span> (err != ESP_OK) <span class="hljs-keyword">return</span> err;<br><br>	<span class="hljs-comment">// Commit</span><br>	err = <span class="hljs-built_in">nvs_commit</span>(my_handle);<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) <span class="hljs-keyword">return</span> err;<br><br>	<span class="hljs-comment">// Close</span><br>	<span class="hljs-built_in">nvs_close</span>(my_handle);<br>	<span class="hljs-keyword">return</span> ESP_OK;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">nvs_handle_t</span> my_handle;<br>    <span class="hljs-comment">// Initialize NVS</span><br>    <span class="hljs-type">esp_err_t</span> err = <span class="hljs-built_in">nvs_flash_init</span>();<br>    <span class="hljs-keyword">if</span> (err == ESP_ERR_NVS_NO_FREE_PAGES || err == ESP_ERR_NVS_NEW_VERSION_FOUND) &#123;<br>        <span class="hljs-comment">// NVS partition was truncated and needs to be erased</span><br>        <span class="hljs-comment">// Retry nvs_flash_init</span><br>        <span class="hljs-built_in">ESP_ERROR_CHECK</span>(<span class="hljs-built_in">nvs_flash_erase</span>());<br>        err = <span class="hljs-built_in">nvs_flash_init</span>();<br>    &#125;<br>    <span class="hljs-built_in">ESP_ERROR_CHECK</span>( err );<br>    <span class="hljs-comment">// Open</span><br>    <span class="hljs-built_in">nvs_open</span>(NVS_KEY, NVS_READWRITE, &amp;my_handle);<br><br>    <span class="hljs-built_in">nvs_erase_key</span>(my_handle,<span class="hljs-string">&quot;run_time&quot;</span>);<br><br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	<span class="hljs-built_in">vTaskDelay</span>(<span class="hljs-number">2000</span> / portTICK_PERIOD_MS);<br>        <span class="hljs-built_in">getValue</span>();<br>        <span class="hljs-built_in">setValue</span>(<span class="hljs-built_in">rand</span>()%<span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>运行结果<br>每2s追加一个数据，并读取出来<br>这里用到了擦除函数</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"> <span class="hljs-attribute">(0) cpu_start</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Starting scheduler on APP CPU.</span><br><span class="hljs-attribute">Run time</span><span class="hljs-punctuation">:</span><br><span class="hljs-attribute">Nothing saved yet!</span><br><span class="hljs-attribute">Run time</span><span class="hljs-punctuation">:</span><br><span class="hljs-attribute">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br><span class="hljs-attribute">Run time</span><span class="hljs-punctuation">:</span><br><span class="hljs-attribute">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br><span class="hljs-attribute">2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br><span class="hljs-attribute">Run time</span><span class="hljs-punctuation">:</span><br><span class="hljs-attribute">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br><span class="hljs-attribute">2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br><span class="hljs-attribute">3</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2</span><br><span class="hljs-attribute">Run time</span><span class="hljs-punctuation">:</span><br><span class="hljs-attribute">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br><span class="hljs-attribute">2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br><span class="hljs-attribute">3</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2</span><br><span class="hljs-attribute">4</span><span class="hljs-punctuation">:</span> <span class="hljs-string">3</span><br></code></pre></td></tr></table></figure>


<h3 id="示例3：字符串数组读取"><a href="#示例3：字符串数组读取" class="headerlink" title="示例3：字符串数组读取"></a>示例3：字符串数组读取</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static const <span class="hljs-built_in">char</span> *NVS_HANDLE = <span class="hljs-string">&quot;nvs_demo_handle&quot;</span>;<br>static const <span class="hljs-built_in">char</span> *NVS_KEY = <span class="hljs-string">&quot;nvs_demo_key&quot;</span>;<br><br>esp_err_t get<span class="hljs-constructor">Value()</span><br>&#123;<br>	esp_err_t err;<br>	nvs_handle_t my_handle;<br>    <span class="hljs-comment">// Open</span><br>    <span class="hljs-comment">// Open</span><br>    err = nvs<span class="hljs-constructor">_open(NVS_HANDLE, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>    <span class="hljs-comment">// Read the size of memory space required for blob</span><br>    size_t required_size = <span class="hljs-number">0</span>;  <span class="hljs-comment">// value will default to 0, if not set yet in NVS</span><br>    err = nvs<span class="hljs-constructor">_get_str(<span class="hljs-params">my_handle</span>, NVS_KEY, NULL, &amp;<span class="hljs-params">required_size</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK<span class="hljs-operator"> &amp;&amp; </span>err != ESP_ERR_NVS_NOT_FOUND) return err;<br>    printf(<span class="hljs-string">&quot;Run time:\n&quot;</span>);<br>    <span class="hljs-comment">// Read previously saved blob if available</span><br>    <span class="hljs-keyword">if</span> (required_size<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) &#123;<br>        printf(<span class="hljs-string">&quot;Nothing saved yet!\n&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    	<span class="hljs-built_in">char</span>* get_char = malloc(required_size);<br>        err = nvs<span class="hljs-constructor">_get_str(<span class="hljs-params">my_handle</span>, NVS_KEY, <span class="hljs-params">get_char</span>, &amp;<span class="hljs-params">required_size</span>)</span>;<br>        <span class="hljs-keyword">if</span> (err != ESP_OK) &#123;<br>            free(get_char);<br>            return err;<br>        &#125;<br>        printf(<span class="hljs-string">&quot;test str is: %s \nsize is %d \n&quot;</span>,get_char,required_size);<br><br>        free(get_char);<br>    &#125;<br><br>    <span class="hljs-comment">// Close</span><br>    nvs<span class="hljs-constructor">_close(<span class="hljs-params">my_handle</span>)</span>;<br>    return ESP_OK;<br>&#125;<br><br>esp_err_t set<span class="hljs-constructor">Value(<span class="hljs-params">int</span> <span class="hljs-params">value</span>)</span><br>&#123;<br>	esp_err_t err;<br>	nvs_handle_t my_handle;<br>	<span class="hljs-built_in">char</span> test_str<span class="hljs-literal">[]</span>=<span class="hljs-string">&quot;this is my test str,boom!&quot;</span>;<br><br>	err = nvs<span class="hljs-constructor">_open(NVS_HANDLE, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>	err = nvs<span class="hljs-constructor">_set_str(<span class="hljs-params">my_handle</span>, NVS_KEY, <span class="hljs-params">test_str</span>)</span>;<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br>	<span class="hljs-comment">// Commit</span><br>	err = nvs<span class="hljs-constructor">_commit(<span class="hljs-params">my_handle</span>)</span>;<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>	<span class="hljs-comment">// Close</span><br>	nvs<span class="hljs-constructor">_close(<span class="hljs-params">my_handle</span>)</span>;<br>	return ESP_OK;<br>&#125;<br>void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br>	nvs_handle_t my_handle;<br>    <span class="hljs-comment">// Initialize NVS</span><br>    esp_err_t err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    <span class="hljs-keyword">if</span> (err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NO_FREE_PAGES<span class="hljs-operator"> || </span>err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NEW_VERSION_FOUND) &#123;<br>        <span class="hljs-comment">// NVS partition was truncated and needs to be erased</span><br>        <span class="hljs-comment">// Retry nvs_flash_init</span><br>        <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">nvs_flash_erase</span>()</span>);<br>        err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    &#125;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">err</span> )</span>;<br>    <span class="hljs-comment">// Open</span><br>    nvs<span class="hljs-constructor">_open(NVS_KEY, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br><br>    nvs<span class="hljs-constructor">_erase_key(<span class="hljs-params">my_handle</span>,<span class="hljs-string">&quot;run_time&quot;</span>)</span>;<br><br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	v<span class="hljs-constructor">TaskDelay(2000 <span class="hljs-operator">/</span> <span class="hljs-params">portTICK_PERIOD_MS</span>)</span>;<br>        get<span class="hljs-constructor">Value()</span>;<br>        set<span class="hljs-constructor">Value(<span class="hljs-params">rand</span>()</span>%<span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs subunit">Run time:<br><span class="hljs-keyword">test </span>str is: this is my test str,boom!<br>size is 26<br>Run time:<br><span class="hljs-keyword">test </span>str is: this is my test str,boom!<br>size is 26<br></code></pre></td></tr></table></figure>

<h3 id="示例4：结构体"><a href="#示例4：结构体" class="headerlink" title="示例4：结构体"></a>示例4：结构体</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 定义一个标签，方便批量换名字</span><br>static const <span class="hljs-built_in">char</span>* tagInfo = <span class="hljs-string">&quot;tagInfo&quot;</span>;<br><br>static const <span class="hljs-built_in">char</span> *NVS_HANDLE = <span class="hljs-string">&quot;nvs_demo_handle&quot;</span>;<br>static const <span class="hljs-built_in">char</span> *NVS_KEY = <span class="hljs-string">&quot;nvs_demo_key&quot;</span>;<br>typedef <span class="hljs-keyword">struct</span> &#123;<br>    uint8_t a, b, c;<br>    uint32_t x, y;<br>&#125; test_struct;<br><br>esp_err_t get<span class="hljs-constructor">Value()</span><br>&#123;<br>	esp_err_t err;<br>	nvs_handle_t my_handle;<br>	test_struct value;<br>    <span class="hljs-comment">//test_struct value;</span><br>    size_t length = sizeof(value);<br>    <span class="hljs-comment">// Open</span><br>    <span class="hljs-comment">// Open</span><br>    err = nvs<span class="hljs-constructor">_open(NVS_HANDLE, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>    <span class="hljs-comment">// Read the size of memory space required for blob</span><br>    size_t required_size = <span class="hljs-number">0</span>;  <span class="hljs-comment">// value will default to 0, if not set yet in NVS</span><br>    err = nvs<span class="hljs-constructor">_get_blob(<span class="hljs-params">my_handle</span>, NVS_KEY, NULL, &amp;<span class="hljs-params">required_size</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK<span class="hljs-operator"> &amp;&amp; </span>err != ESP_ERR_NVS_NOT_FOUND) return err;<br>    <span class="hljs-comment">// Read previously saved blob if available</span><br>    <span class="hljs-keyword">if</span> (required_size<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) &#123;<br>        printf(<span class="hljs-string">&quot;Nothing saved yet!\n&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        err = nvs<span class="hljs-constructor">_get_blob(<span class="hljs-params">my_handle</span>, NVS_KEY, &amp;<span class="hljs-params">value</span>, &amp;<span class="hljs-params">length</span>)</span>;<br>        <span class="hljs-keyword">if</span> (err != ESP_OK) &#123;<br>            return err;<br>        &#125;<br>        <span class="hljs-constructor">ESP_LOGE(<span class="hljs-params">tagInfo</span>, <span class="hljs-string">&quot;get_value &#123;a=%d, b=%d, c=%d, x=%ld, y=%ld&#125;&quot;</span>, <span class="hljs-params">value</span>.<span class="hljs-params">a</span>, <span class="hljs-params">value</span>.<span class="hljs-params">b</span>, <span class="hljs-params">value</span>.<span class="hljs-params">c</span>, <span class="hljs-params">value</span>.<span class="hljs-params">x</span>, <span class="hljs-params">value</span>.<span class="hljs-params">y</span>)</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">// Close</span><br>    nvs<span class="hljs-constructor">_close(<span class="hljs-params">my_handle</span>)</span>;<br>    return ESP_OK;<br>&#125;<br><br>esp_err_t set<span class="hljs-constructor">Value(<span class="hljs-params">test_struct</span>  <span class="hljs-params">value</span>)</span><br>&#123;<br>	esp_err_t err;<br>	nvs_handle_t my_handle;<br>	size_t length = sizeof(value);<br><br><br>	err = nvs<span class="hljs-constructor">_open(NVS_HANDLE, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>    <span class="hljs-constructor">ESP_LOGI(<span class="hljs-params">tagInfo</span>, <span class="hljs-string">&quot;set_value &#123;a=%d, b=%d, c=%d, x=%ld, y=%ld&#125;, length=%d&quot;</span>, <span class="hljs-params">value</span>.<span class="hljs-params">a</span>, <span class="hljs-params">value</span>.<span class="hljs-params">b</span>, <span class="hljs-params">value</span>.<span class="hljs-params">c</span>, <span class="hljs-params">value</span>.<span class="hljs-params">x</span>, <span class="hljs-params">value</span>.<span class="hljs-params">y</span>, <span class="hljs-params">length</span>)</span>;<br><br>	err = nvs<span class="hljs-constructor">_set_blob(<span class="hljs-params">my_handle</span>, NVS_KEY, &amp;<span class="hljs-params">value</span>,<span class="hljs-params">length</span>)</span>;<br><br>	<span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br>	<span class="hljs-comment">// Commit</span><br>	err = nvs<span class="hljs-constructor">_commit(<span class="hljs-params">my_handle</span>)</span>;<br>	<span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>	<span class="hljs-comment">// Close</span><br>	nvs<span class="hljs-constructor">_close(<span class="hljs-params">my_handle</span>)</span>;<br>	return ESP_OK;<br>&#125;<br>void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br>	nvs_handle_t my_handle;<br>    <span class="hljs-comment">// Initialize NVS</span><br>    esp_err_t err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    <span class="hljs-keyword">if</span> (err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NO_FREE_PAGES<span class="hljs-operator"> || </span>err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NEW_VERSION_FOUND) &#123;<br>        <span class="hljs-comment">// NVS partition was truncated and needs to be erased</span><br>        <span class="hljs-comment">// Retry nvs_flash_init</span><br>        <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">nvs_flash_erase</span>()</span>);<br>        err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    &#125;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">err</span> )</span>;<br>    <span class="hljs-comment">// Open</span><br>    nvs<span class="hljs-constructor">_open(NVS_KEY, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br><br>    nvs<span class="hljs-constructor">_erase_key(<span class="hljs-params">my_handle</span>,<span class="hljs-string">&quot;run_time&quot;</span>)</span>;<br><br><br>    test_struct value;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	get<span class="hljs-constructor">Value()</span>;<br><br><br>    	v<span class="hljs-constructor">TaskDelay(2000 <span class="hljs-operator">/</span> <span class="hljs-params">portTICK_PERIOD_MS</span>)</span>;<br>        value.a = rand<span class="hljs-literal">()</span>%<span class="hljs-number">10</span>;<br>         value.b = rand<span class="hljs-literal">()</span>%<span class="hljs-number">10</span>;<br>         value.c = rand<span class="hljs-literal">()</span>%<span class="hljs-number">10</span>;<br>         value.x = rand<span class="hljs-literal">()</span>%<span class="hljs-number">1000</span>;<br>         value.y = rand<span class="hljs-literal">()</span>%<span class="hljs-number">1000</span>;<br>        set<span class="hljs-constructor">Value(<span class="hljs-params">value</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">E (344) tagInfo: get_value &#123;<span class="hljs-attribute">a</span>=8, <span class="hljs-attribute">b</span>=2, <span class="hljs-attribute">c</span>=6, <span class="hljs-attribute">x</span>=256, <span class="hljs-attribute">y</span>=119&#125;<br>I (2344) tagInfo: set_value &#123;<span class="hljs-attribute">a</span>=3, <span class="hljs-attribute">b</span>=3, <span class="hljs-attribute">c</span>=2, <span class="hljs-attribute">x</span>=529, <span class="hljs-attribute">y</span>=700&#125;, <span class="hljs-attribute">length</span>=12<br>E (2354) tagInfo: get_value &#123;<span class="hljs-attribute">a</span>=3, <span class="hljs-attribute">b</span>=3, <span class="hljs-attribute">c</span>=2, <span class="hljs-attribute">x</span>=529, <span class="hljs-attribute">y</span>=700&#125;<br>I (4354) tagInfo: set_value &#123;<span class="hljs-attribute">a</span>=8, <span class="hljs-attribute">b</span>=2, <span class="hljs-attribute">c</span>=6, <span class="hljs-attribute">x</span>=256, <span class="hljs-attribute">y</span>=119&#125;, <span class="hljs-attribute">length</span>=12<br>E (4364) tagInfo: get_value &#123;<span class="hljs-attribute">a</span>=8, <span class="hljs-attribute">b</span>=2, <span class="hljs-attribute">c</span>=6, <span class="hljs-attribute">x</span>=256, <span class="hljs-attribute">y</span>=119&#125;<br>I (6364) tagInfo: set_value &#123;<span class="hljs-attribute">a</span>=1, <span class="hljs-attribute">b</span>=1, <span class="hljs-attribute">c</span>=3, <span class="hljs-attribute">x</span>=705, <span class="hljs-attribute">y</span>=108&#125;, <span class="hljs-attribute">length</span>=12<br>E (6374) tagInfo: get_value &#123;<span class="hljs-attribute">a</span>=1, <span class="hljs-attribute">b</span>=1, <span class="hljs-attribute">c</span>=3, <span class="hljs-attribute">x</span>=705, <span class="hljs-attribute">y</span>=108&#125;<br></code></pre></td></tr></table></figure>

<h3 id="命名空间和键值对"><a href="#命名空间和键值对" class="headerlink" title="命名空间和键值对"></a>命名空间和键值对</h3><ul>
<li>类比于文件夹，我们如果想要存储一个文件，esp是强制要有一个文件夹的，然后你可以在这个文件夹中存放自己的数据，这就是命名空间</li>
<li>命名空间（handle, ）类似于文件夹名字，我们只有先找到文件夹，打开文件夹，才能读取里面的各个文件数据</li>
<li>键值对（key）类似于我们的文件名，也就是我们的变量名，可以通过键值对找到我们存储的变量，所以建议键值对名称和变量名保持一致，便于理解和阅读</li>
<li>目前不支持浮点数存储，可以考虑将浮点数扩到整数倍（1000倍）转换成整数存储<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689479127153.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
</ul>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/536174984">ESP32-C3入门教程 基础篇（八、NVS — 非易失性存储库的使用）</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jasper_JA/article/details/102915660">ESP32_学习笔记（一）NVS的操作（存储和读取大数组）（为什么存入数据成功，读取却为零的原因）</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/kangweijian/article/details/125489688">ESP32-C3入门教程 基础篇⑪——Non-Volatile Storage (NVS) 非易失性存储参数的读写</a></li>
</ul>
<h2 id="量产烧写设备配置和序列号-NVS-partition分区确认-NVS-分区生成程序-csv转bin"><a href="#量产烧写设备配置和序列号-NVS-partition分区确认-NVS-分区生成程序-csv转bin" class="headerlink" title="量产烧写设备配置和序列号, NVS partition分区确认, NVS 分区生成程序, csv转bin"></a>量产烧写设备配置和序列号, NVS partition分区确认, NVS 分区生成程序, csv转bin</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/storage/nvs_partition_gen.html">NVS 分区生成程序</a></p>
<h3 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h3><p>设备量产的时候，每个设备都有不同的序列号、配置参数等。<br>这就需要提供不同的固件给不同的设备，出厂前直接烧写到设备Flash中。</p>
<p>这一操作需要用到NVS（非易失性存储）和NVS 分区生成程序。</p>
<p>NVS 分区生成程序 (nvs_flash&#x2F;nvs_partition_generator&#x2F;nvs_partition_gen.py) 根据 CSV 文件中的键值对生成二进制文件。该二进制文件与 非易失性存储器 (NVS) 中定义的 NVS 结构兼容。NVS 分区生成程序适合用于生成二进制数据（Blob），其中包括设备生产时可从外部烧录的 ODM&#x2F;OEM 数据。这也使得生产制造商在使用同一个应用固件的基础上，通过自定义参数，如序列号，为每个设备生成不同配置的二进制 NVS 分区。</p>
<h3 id="2、操作流程-1"><a href="#2、操作流程-1" class="headerlink" title="2、操作流程"></a>2、操作流程</h3><ul>
<li>IDE打开分区表</li>
<li>编辑分区表</li>
<li>下载分区表</li>
<li>编写nvs程序读取分区表数据</li>
<li>下载主程序</li>
</ul>
<h3 id="3、编辑分区表"><a href="#3、编辑分区表" class="headerlink" title="3、编辑分区表"></a>3、编辑分区表</h3><p>打开分区表编辑器并编辑</p>
<ul>
<li>文件大小必须大于0x3000，否则无法将csv文件转换成bin文件</li>
<li>add row添加行</li>
<li>save 保存 csv文件</li>
<li>geberate 生成bin文件<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/nvs_table.jpg" srcset="/img/loading.gif" lazyload alt="nvs table"></li>
</ul>
<p>随后我们可以在项目文件夹下看到生成的 .csv和.bin 文件。也可以使用excel编辑csv文件（不推荐）<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/nvs_csv.jpg" srcset="/img/loading.gif" lazyload alt="nvs csv"></p>
<p>然后需要使用 flash download 软件下载 .bin 分区文件</p>
<ul>
<li>地址0x9000<br>如果点击 START 没有反应，没有下载，那说明 .bin 文件有问题。一般是 .csv 中 value一栏数据错误，上图第四行的 root.pem.key 文件并不存在，所以下载就会出现错误，删除重新生成 .bin 文件就能够下载了<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/download_nvs.jpg" srcset="/img/loading.gif" lazyload alt="download nvs"></li>
</ul>
<p>同样的你可以编辑多个命名空间<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689498664075.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="4、示例程序"><a href="#4、示例程序" class="headerlink" title="4、示例程序"></a>4、示例程序</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 定义一个标签，方便批量换名字</span><br>static const <span class="hljs-built_in">char</span>* TAG = <span class="hljs-string">&quot;tagInfo&quot;</span>;<br><br>static const <span class="hljs-built_in">char</span> *NVS_HANDLE = <span class="hljs-string">&quot;myHandle&quot;</span>;<br><br>esp_err_t get<span class="hljs-constructor">Value()</span><br>&#123;<br>	esp_err_t err;<br>	nvs_handle_t my_handle;<br><br>    <span class="hljs-comment">// Open</span><br>    err = nvs<span class="hljs-constructor">_open(NVS_HANDLE, NVS_READWRITE, &amp;<span class="hljs-params">my_handle</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK) return err;<br><br>    <span class="hljs-built_in">char</span> *name, *rootCa;<br>    uint8_t age;<br>    uint32_t baudrate;<br>    unsigned <span class="hljs-built_in">int</span> nameLen, rootCaLen;<br><br>    err = nvs<span class="hljs-constructor">_get_u8(<span class="hljs-params">my_handle</span>, <span class="hljs-string">&quot;age&quot;</span>, &amp;<span class="hljs-params">age</span>)</span>;<br>    <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>        <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;get_value age (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;get_value age = %d&quot;</span>, <span class="hljs-params">age</span>)</span>;<br><br>    err = nvs<span class="hljs-constructor">_get_u32(<span class="hljs-params">my_handle</span>, <span class="hljs-string">&quot;baudrate&quot;</span>, &amp;<span class="hljs-params">baudrate</span>)</span>;<br>    <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>        <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;get_value uartBaudrate (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;get_value uartBaudrate = %ld&quot;</span>, <span class="hljs-params">baudrate</span>)</span>;<br><br>    err = nvs<span class="hljs-constructor">_get_str(<span class="hljs-params">my_handle</span>,<span class="hljs-string">&quot;name&quot;</span>, NULL, &amp;<span class="hljs-params">nameLen</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK<span class="hljs-operator"> &amp;&amp; </span>err != ESP_ERR_NVS_NOT_FOUND) return err;<br>    <span class="hljs-comment">// Read previously saved blob if available</span><br>    <span class="hljs-keyword">if</span> (nameLen<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) &#123;<br>        printf(<span class="hljs-string">&quot;Nothing saved yet!\n&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    	name = malloc(nameLen);<br>    	<span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;nameLen = %d&quot;</span>, <span class="hljs-params">nameLen</span>)</span>;<br><br>        err = nvs<span class="hljs-constructor">_get_str(<span class="hljs-params">my_handle</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-params">name</span>, &amp;<span class="hljs-params">nameLen</span>)</span>;<br>        <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>            <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;get_value name (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;get_value name = %s&quot;</span>, <span class="hljs-params">name</span>)</span>;<br>        free(name);<br>    &#125;<br><br><br>    err = nvs<span class="hljs-constructor">_get_str(<span class="hljs-params">my_handle</span>,<span class="hljs-string">&quot;root&quot;</span>, NULL, &amp;<span class="hljs-params">rootCaLen</span>)</span>;<br>    <span class="hljs-keyword">if</span> (err != ESP_OK<span class="hljs-operator"> &amp;&amp; </span>err != ESP_ERR_NVS_NOT_FOUND) return err;<br>    <span class="hljs-comment">// Read previously saved blob if available</span><br>    <span class="hljs-keyword">if</span> (rootCaLen<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) &#123;<br>        printf(<span class="hljs-string">&quot;Nothing saved yet!\n&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    	rootCa = malloc(rootCaLen);<br>    	<span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;rootCaLen = %d&quot;</span>, <span class="hljs-params">nameLen</span>)</span>;<br><br>        err = nvs<span class="hljs-constructor">_get_str(<span class="hljs-params">my_handle</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-params">rootCa</span>, &amp;<span class="hljs-params">rootCaLen</span>)</span>;<br>        <span class="hljs-keyword">if</span>(err!=ESP_OK)<br>            <span class="hljs-constructor">ESP_LOGE(TAG, <span class="hljs-string">&quot;get_value name (%s)&quot;</span>, <span class="hljs-params">esp_err_to_name</span>(<span class="hljs-params">err</span>)</span>);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;get_value rootCa = %s&quot;</span>, <span class="hljs-params">rootCa</span>)</span>;<br>        free(rootCa);<br>    &#125;<br><br><br><br>    nvs<span class="hljs-constructor">_close(<span class="hljs-params">my_handle</span>)</span>;<br>    return ESP_OK;<br>&#125;<br><br>void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// Initialize NVS</span><br>    esp_err_t err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    <span class="hljs-keyword">if</span> (err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NO_FREE_PAGES<span class="hljs-operator"> || </span>err<span class="hljs-operator"> == </span>ESP_ERR_NVS_NEW_VERSION_FOUND) &#123;<br>        <span class="hljs-comment">// NVS partition was truncated and needs to be erased</span><br>        <span class="hljs-comment">// Retry nvs_flash_init</span><br>        <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">nvs_flash_erase</span>()</span>);<br>        err = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    &#125;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">err</span> )</span>;<br>    <span class="hljs-comment">// Open</span><br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    	get<span class="hljs-constructor">Value()</span>;<br><br>    	v<span class="hljs-constructor">TaskDelay(2000 <span class="hljs-operator">/</span> <span class="hljs-params">portTICK_PERIOD_MS</span>)</span>;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">346054</span>) tagInfo: get_value age = <span class="hljs-number">28</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">346054</span>) tagInfo: get_value uartBaudrate = <span class="hljs-number">9600</span><br><span class="hljs-attribute">E</span> (<span class="hljs-number">346054</span>) tagInfo: nameLen = <span class="hljs-number">9</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">346054</span>) tagInfo: get_value name = LonlyPan<br><span class="hljs-attribute">E</span> (<span class="hljs-number">346054</span>) tagInfo: rootCaLen = <span class="hljs-number">9</span><br><span class="hljs-attribute">E</span> (<span class="hljs-number">346064</span>) tagInfo: get_value name (ESP_ERR_NVS_NOT_FOUND)<br></code></pre></td></tr></table></figure>

<h2 id="WIFI-Scan"><a href="#WIFI-Scan" class="headerlink" title="WIFI Scan"></a>WIFI Scan</h2><p>参考资料：<a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_wifi.html">Wi-Fi 库</a><br>应用示例：ESP-IDF 仓库的 <a target="_blank" rel="noopener" href="https://github.com/espressif/esp-idf/tree/4fc2e5cb95/examples/wifi">wifi </a></p>
<h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>Wi-Fi 库支持配置及监控 ESP32-C3 Wi-Fi 连网功能。支持配置：</p>
<ul>
<li>station 模式（即 STA 模式或 Wi-Fi 客户端模式），此时 ESP32-C3 连接到接入点 (AP)。</li>
<li>AP 模式（即 Soft-AP 模式或接入点模式），此时基站连接到 ESP32-C3。</li>
<li>station&#x2F;AP 共存模式（ESP32-C3 既是接入点，同时又作为基站连接到另外一个接入点）。</li>
<li>上述模式的各种安全模式（WPA、WPA2、WPA3 等）。</li>
<li>扫描接入点（包括主动扫描及被动扫描）。</li>
<li>使用混杂模式监控 IEEE802.11 Wi-Fi 数据包。</li>
</ul>
<h3 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h3><p>程序流程</p>
<ol>
<li>nvs_flash_init，初始化默认 NVS 分区。</li>
<li>esp_netif_init，初始化底层TCP&#x2F;IP堆栈</li>
<li>esp_event_loop_create_default，创建默认事件循环。</li>
<li>esp_netif_create_default_wifi_sta，使用默认WiFi Station配置创建esp_netif 对象，将netif连接到WiFi并注册默认WiFi处理程序。</li>
<li>esp_wifi_init，为 WiFi 驱动初始化 WiFi 分配资源，如 WiFi 控制结构、RX&#x2F;TX 缓冲区、WiFi NVS 结构等，这个 WiFi 也启动 WiFi 任务。必须先调用此API，然后才能调用所有其他WiFi API</li>
<li>esp_wifi_set_mode，设置WiFi工作模式为station、soft-AP或station+soft-AP，默认模式为soft-AP模式。本程序设置为station</li>
<li>esp_wifi_start，根据配置，启动WiFi</li>
<li>esp_wifi_scan_start，扫描所有有效的AP</li>
<li>esp_wifi_scan_get_ap_records，获取上次扫描中找到的AP列表</li>
<li>esp_wifi_scan_get_ap_num，获取上次扫描中找到的AP数</li>
</ol>
<h3 id="示例程序-1"><a href="#示例程序-1" class="headerlink" title="示例程序"></a>示例程序</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 扫面列表大小</span><br>#define DEFAULT_SCAN_LIST_SIZE <span class="hljs-number">10</span><br><br>static const <span class="hljs-built_in">char</span> *TAG = <span class="hljs-string">&quot;scan&quot;</span>;<br><br><span class="hljs-comment">// 打印加密模式</span><br>static void print<span class="hljs-constructor">_auth_mode(<span class="hljs-params">int</span> <span class="hljs-params">authmode</span>)</span><br>&#123;<br>    switch (authmode) &#123;<br>    case WIFI_AUTH_OPEN:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_OPEN&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_OWE:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_OWE&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WEP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WEP&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WPA_PSK:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WPA_PSK&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WPA2_PSK:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WPA2_PSK&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WPA_WPA2_PSK:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WPA_WPA2_PSK&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WPA2_ENTERPRISE:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WPA2_ENTERPRISE&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WPA3_PSK:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WPA3_PSK&quot;</span>)</span>;<br>        break;<br>    case WIFI_AUTH_WPA2_WPA3_PSK:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_WPA2_WPA3_PSK&quot;</span>)</span>;<br>        break;<br>    default:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Authmode \tWIFI_AUTH_UNKNOWN&quot;</span>)</span>;<br>        break;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 打印密码类型</span><br>static void print<span class="hljs-constructor">_cipher_type(<span class="hljs-params">int</span> <span class="hljs-params">pairwise_cipher</span>, <span class="hljs-params">int</span> <span class="hljs-params">group_cipher</span>)</span><br>&#123;<br>    switch (pairwise_cipher) &#123;<br>    case WIFI_CIPHER_TYPE_NONE:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_NONE&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_WEP40:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_WEP40&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_WEP104:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_WEP104&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_TKIP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_TKIP&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_CCMP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_CCMP&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_TKIP_CCMP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_TKIP_CCMP&quot;</span>)</span>;<br>        break;<br>    default:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Pairwise Cipher \tWIFI_CIPHER_TYPE_UNKNOWN&quot;</span>)</span>;<br>        break;<br>    &#125;<br><br>    switch (group_cipher) &#123;<br>    case WIFI_CIPHER_TYPE_NONE:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_NONE&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_WEP40:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_WEP40&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_WEP104:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_WEP104&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_TKIP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_TKIP&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_CCMP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_CCMP&quot;</span>)</span>;<br>        break;<br>    case WIFI_CIPHER_TYPE_TKIP_CCMP:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_TKIP_CCMP&quot;</span>)</span>;<br>        break;<br>    default:<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Group Cipher \tWIFI_CIPHER_TYPE_UNKNOWN&quot;</span>)</span>;<br>        break;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/* Initialize Wi-Fi as sta and set scan method */</span><br>static void wifi<span class="hljs-constructor">_scan(<span class="hljs-params">void</span>)</span><br>&#123;<br>	<span class="hljs-comment">// 初始化底层TCP/IP堆栈</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_netif_init</span>()</span>);<br>    <span class="hljs-comment">// 创建默认事件循环</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_event_loop_create_default</span>()</span>);<br>    <span class="hljs-comment">// 使用默认WiFi Station配置创建esp_netif 对象，将netif连接到WiFi并注册默认WiFi处理程序。</span><br>    esp_netif_t *sta_netif = esp<span class="hljs-constructor">_netif_create_default_wifi_sta()</span>;<br>    <span class="hljs-keyword">assert</span>(sta_netif);<br><br>    wifi_init_config_t cfg = <span class="hljs-constructor">WIFI_INIT_CONFIG_DEFAULT()</span>;<br>    <span class="hljs-comment">// 为 WiFi 驱动初始化 WiFi 分配资源，如 WiFi 控制结构、RX/TX 缓冲区、WiFi NVS 结构等，这个 WiFi 也启动 WiFi 任务。必须先调用此API，然后才能调用所有其他WiFi API</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_wifi_init</span>(&amp;<span class="hljs-params">cfg</span>)</span>);<br><br>    uint16_t number = DEFAULT_SCAN_LIST_SIZE;<br>    wifi_ap_record_t ap_info<span class="hljs-literal">[DEFAULT<span class="hljs-identifier">_SCAN_LIST_SIZE</span>]</span>;<br>    uint16_t ap_count = <span class="hljs-number">0</span>;<br>    memset(ap_info, <span class="hljs-number">0</span>, sizeof(ap_info));<br>    <span class="hljs-comment">// 设置WiFi工作模式为station、soft-AP或station+soft-AP，默认模式为soft-AP模式。本程序设置为station</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_wifi_set_mode</span>(WIFI_MODE_STA)</span>);<br>    <span class="hljs-comment">// 根据配置，启动WiFi</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_wifi_start</span>()</span>);<br>    <span class="hljs-comment">// 扫描所有有效的AP 阻塞</span><br>    esp<span class="hljs-constructor">_wifi_scan_start(NULL, <span class="hljs-params">true</span>)</span>;<br>    <span class="hljs-comment">// 获取上次扫描中找到的AP列表</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_wifi_scan_get_ap_records</span>(&amp;<span class="hljs-params">number</span>, <span class="hljs-params">ap_info</span>)</span>);<br>    <span class="hljs-comment">// 获取上次扫描中找到的AP数获取上次扫描中找到的AP数</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">esp_wifi_scan_get_ap_num</span>(&amp;<span class="hljs-params">ap_count</span>)</span>);<br>    <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Total APs scanned = %u&quot;</span>, <span class="hljs-params">ap_count</span>)</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; (i &lt; DEFAULT_SCAN_LIST_SIZE)<span class="hljs-operator"> &amp;&amp; </span>(i &lt; ap_count); i++) &#123;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;SSID \t\t%s&quot;</span>, <span class="hljs-params">ap_info</span>[<span class="hljs-params">i</span>].<span class="hljs-params">ssid</span>)</span>;  <span class="hljs-comment">// 名称</span><br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;RSSI \t\t%d&quot;</span>, <span class="hljs-params">ap_info</span>[<span class="hljs-params">i</span>].<span class="hljs-params">rssi</span>)</span>;  <span class="hljs-comment">// 信号强度</span><br>        print<span class="hljs-constructor">_auth_mode(<span class="hljs-params">ap_info</span>[<span class="hljs-params">i</span>].<span class="hljs-params">authmode</span>)</span>;           <span class="hljs-comment">// wifi加密模式</span><br>        <span class="hljs-keyword">if</span> (ap_info<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>.authmode != WIFI_AUTH_WEP) &#123;<br>            print<span class="hljs-constructor">_cipher_type(<span class="hljs-params">ap_info</span>[<span class="hljs-params">i</span>].<span class="hljs-params">pairwise_cipher</span>, <span class="hljs-params">ap_info</span>[<span class="hljs-params">i</span>].<span class="hljs-params">group_cipher</span>)</span>;<br>        &#125;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Channel \t\t%d\n&quot;</span>, <span class="hljs-params">ap_info</span>[<span class="hljs-params">i</span>].<span class="hljs-params">primary</span>)</span>;  <span class="hljs-comment">// 信道</span><br>    &#125;<br><br>&#125;<br><br>void app<span class="hljs-constructor">_main(<span class="hljs-params">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// Initialize NVS</span><br>	<span class="hljs-comment">// 初始化默认 NVS 分区，wifi库会使用nvs存储信息</span><br>    esp_err_t ret = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    <span class="hljs-keyword">if</span> (ret<span class="hljs-operator"> == </span>ESP_ERR_NVS_NO_FREE_PAGES<span class="hljs-operator"> || </span>ret<span class="hljs-operator"> == </span>ESP_ERR_NVS_NEW_VERSION_FOUND) &#123;<br>        <span class="hljs-constructor">ESP_ERROR_CHECK(<span class="hljs-params">nvs_flash_erase</span>()</span>);<br>        ret = nvs<span class="hljs-constructor">_flash_init()</span>;<br>    &#125;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">ret</span> )</span>;<br><br>    wifi<span class="hljs-constructor">_scan()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">539</span>) wifi:mode : sta (<span class="hljs-number">34</span>:<span class="hljs-number">85</span>:<span class="hljs-number">18</span>:<span class="hljs-number">98</span>:<span class="hljs-number">06</span>:dc)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">539</span>) wifi:enable tsf<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3039</span>) scan: Total APs scanned = <span class="hljs-number">3</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3039</span>) scan: SSID             hannto-printer-honey1s_mibtDE14<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3039</span>) scan: RSSI             -<span class="hljs-number">39</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3039</span>) scan: Authmode         WIFI_AUTH_WPA2_PSK<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3039</span>) scan: Pairwise Cipher  WIFI_CIPHER_TYPE_CCMP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3049</span>) scan: Group Cipher     WIFI_CIPHER_TYPE_CCMP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3049</span>) scan: Channel          <span class="hljs-number">6</span><br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3059</span>) scan: SSID             DIRECT-<span class="hljs-number">9</span>C-EPSON-A511AF<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3059</span>) scan: RSSI             -<span class="hljs-number">50</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3069</span>) scan: Authmode         WIFI_AUTH_WPA2_PSK<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3069</span>) scan: Pairwise Cipher  WIFI_CIPHER_TYPE_CCMP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3079</span>) scan: Group Cipher     WIFI_CIPHER_TYPE_CCMP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3079</span>) scan: Channel          <span class="hljs-number">6</span><br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3089</span>) scan: SSID             <span class="hljs-number">15</span>-<span class="hljs-number">501</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3089</span>) scan: RSSI             -<span class="hljs-number">55</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">3089</span>) scan: Authmode         WIFI_AUTH_WPA_WPA2_PSK<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3099</span>) scan: Pairwise Cipher  WIFI_CIPHER_TYPE_CCMP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3099</span>) scan: Group Cipher     WIFI_CIPHER_TYPE_CCMP<br><span class="hljs-attribute">I</span> (<span class="hljs-number">3109</span>) scan: Channel          <span class="hljs-number">6</span><br><br></code></pre></td></tr></table></figure>

<h2 id="WIFI-Station模式"><a href="#WIFI-Station模式" class="headerlink" title="WIFI Station模式"></a>WIFI Station模式</h2><p>本博文描述ESP32-C3作为Station基站模式接入到WiFi AP热点。</p>
<h3 id="操作流程-1"><a href="#操作流程-1" class="headerlink" title="操作流程"></a>操作流程</h3><ul>
<li>nvs_flash_init，初始化默认 NVS 分区。</li>
<li>esp_netif_init，初始化底层TCP&#x2F;IP堆栈。</li>
<li>esp_event_loop_create_default，创建默认事件循环。</li>
<li>esp_netif_create_default_wifi_sta，使用默认WiFi Station配置创建esp_netif对象，将netif连接到WiFi并注册默认WiFi处理程序。</li>
<li>esp_wifi_init，为 WiFi 驱动初始化 WiFi 分配资源，如 WiFi 控制结构、RX&#x2F;TX 缓冲区、WiFi NVS 结构等，这个 WiFi 也启动 WiFi 任务。必须先调用此API，然后才能调用所有其他WiFi API</li>
<li>esp_event_handler_instance_register，监听WIFI_EVENTWiFi 任意事件，触发事件后，进入回调函数</li>
<li>esp_event_handler_instance_register，监听IP_EVENT从连接的AP获得IP的事件，触发事件后，进入回调函数</li>
<li>esp_wifi_set_mode，设置WiFi工作模式为station、soft-AP或station+soft-AP，默认模式为soft-AP模式。本程序设置为station</li>
<li>esp_wifi_set_config，设置 ESP32 STA 或 AP 的配置。本程序设置为STA，并包含WiFi SSID和密码等信息</li>
<li>esp_wifi_start，根据配置，启动WiFi</li>
<li>xEventGroupWaitBits，等待事件，打印连接成功信息</li>
<li>esp_event_handler_instance_unregister，取消WIFI_EVENT事件监听</li>
<li>esp_event_handler_instance_unregister，取消IP_EVENT事件监听</li>
</ul>
<h3 id="注册事件回调函数"><a href="#注册事件回调函数" class="headerlink" title="注册事件回调函数"></a>注册事件回调函数</h3><ul>
<li><strong>WIFI_EVENT_STA_START</strong>：station启动时，<code>esp_wifi_connect</code>连接</li>
<li><strong>WIFI_EVENT_STA_DISCONNECTED</strong>：从AP失去连接时，，连接次数小于最大连接次数时，<code>esp_wifi_connect</code> 连接</li>
<li><strong>IP_EVENT_STA_GOT_IP</strong>：从连接的AP获得IP时，打印IP</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void event<span class="hljs-constructor">_handler(<span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">arg</span>, <span class="hljs-params">esp_event_base_t</span> <span class="hljs-params">event_base</span>, <span class="hljs-params">int32_t</span> <span class="hljs-params">event_id</span>, <span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">event_data</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>WIFI_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>WIFI_EVENT_STA_START) &#123;<br>        esp<span class="hljs-constructor">_wifi_connect()</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>WIFI_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>WIFI_EVENT_STA_DISCONNECTED) &#123;<br>        <span class="hljs-keyword">if</span> (s_retry_num &lt; EXAMPLE_ESP_MAXIMUM_RETRY) &#123;<br>            esp<span class="hljs-constructor">_wifi_connect()</span>;<br>            s_retry_num++;<br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;retry to connect to the AP&quot;</span>)</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            x<span class="hljs-constructor">EventGroupSetBits(<span class="hljs-params">s_wifi_event_group</span>, WIFI_FAIL_BIT)</span>;<br>        &#125;<br>        <span class="hljs-constructor">ESP_LOGI(TAG,<span class="hljs-string">&quot;connect to the AP fail&quot;</span>)</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>IP_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>IP_EVENT_STA_GOT_IP) &#123;<br>        ip_event_got_ip_t* event = (ip_event_got_ip_t*) event_data;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;got ip:&quot;</span> IPSTR, IP2STR(&amp;<span class="hljs-params">event</span>-&gt;<span class="hljs-params">ip_info</span>.<span class="hljs-params">ip</span>)</span>);<br>        s_retry_num = <span class="hljs-number">0</span>;<br>        x<span class="hljs-constructor">EventGroupSetBits(<span class="hljs-params">s_wifi_event_group</span>, WIFI_CONNECTED_BIT)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="关键函数"><a href="#关键函数" class="headerlink" title="关键函数"></a>关键函数</h3><p>将事件回调函数注册到特定循环</p>
<ul>
<li>[in] event_base：要为其注册事件的基本 ID</li>
<li>[in] event_id：要为其注册事件的 ID</li>
<li>[in] event_handler：事件被调度时的回调函数</li>
<li>[in] event_handler_arg：事件被调度时的回调函数的参数</li>
<li>[out] instance：事件被调度时的回调函数的实例，取消该注册所必须的参数。如果不取消，则可以不保存</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">esp_err_t esp<span class="hljs-constructor">_event_handler_instance_register(<span class="hljs-params">esp_event_base_t</span> <span class="hljs-params">event_base</span>, <span class="hljs-params">int32_t</span>  <span class="hljs-params">event_id</span>, <span class="hljs-params">esp_event_handler_t</span> <span class="hljs-params">event_handler</span>, <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">event_handler_arg</span>, <span class="hljs-params">esp_event_handler_instance_t</span> <span class="hljs-operator">*</span><span class="hljs-params">instance</span>)</span><br></code></pre></td></tr></table></figure>


<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><p>新建项目，选择example，选择WiFi—&gt;getting_started-&gt;station<br>同时在sdconfig中设置wifi名和密码<br>下载运行</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689514858699.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h2 id="WIFI-AP"><a href="#WIFI-AP" class="headerlink" title="WIFI AP"></a>WIFI AP</h2><h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ul>
<li>nvs_flash_init，初始化默认 NVS 分区。</li>
<li>esp_netif_init，初始化底层TCP&#x2F;IP堆栈</li>
<li>esp_event_loop_create_default，创建默认事件循环。</li>
<li>esp_netif_create_default_wifi_ap，使用默认WiFi AP配置创建esp_netif对象，将netif连接到WiFi并注册默认WiFi处理程序。</li>
<li>esp_wifi_init，为 WiFi 驱动初始化 WiFi 分配资源，如 WiFi 控制结构、RX&#x2F;TX 缓冲区、WiFi NVS 结构等，这个 WiFi 也启动 WiFi 任务。必须先调用此API，然后才能调用所有其他WiFi API</li>
<li>esp_event_handler_instance_register，监听WIFI_EVENTWiFi 任意事件，触发事件后，进入回调函数</li>
<li>esp_wifi_set_mode，设置WiFi工作模式为station、soft-AP或station+soft-AP，默认模式为soft-AP模式。本程序设置为AP</li>
<li>esp_wifi_set_config，设置 ESP32 STA 或 AP 的配置</li>
<li>esp_wifi_start，根据配置，启动WiFi</li>
</ul>
<h3 id="注册事件回调函数-1"><a href="#注册事件回调函数-1" class="headerlink" title="注册事件回调函数"></a>注册事件回调函数</h3><p>WIFI_EVENT_AP_STACONNECTED：一个station连接到AP时<br>WIFI_EVENT_AP_STADISCONNECTED：一个station断开连接时</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void wifi<span class="hljs-constructor">_event_handler(<span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">arg</span>, <span class="hljs-params">esp_event_base_t</span> <span class="hljs-params">event_base</span>, <span class="hljs-params">int32_t</span> <span class="hljs-params">event_id</span>, <span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">event_data</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (event_id<span class="hljs-operator"> == </span>WIFI_EVENT_AP_STACONNECTED) &#123;<br>        wifi_event_ap_staconnected_t* event = (wifi_event_ap_staconnected_t*) event_data;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;station &quot;</span>MACSTR<span class="hljs-string">&quot; join, AID=%d&quot;</span>, MAC2STR(<span class="hljs-params">event</span>-&gt;<span class="hljs-params">mac</span>)</span>, event-&gt;aid);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_id<span class="hljs-operator"> == </span>WIFI_EVENT_AP_STADISCONNECTED) &#123;<br>        wifi_event_ap_stadisconnected_t* event = (wifi_event_ap_stadisconnected_t*) event_data;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;station &quot;</span>MACSTR<span class="hljs-string">&quot; leave, AID=%d&quot;</span>, MAC2STR(<span class="hljs-params">event</span>-&gt;<span class="hljs-params">mac</span>)</span>, event-&gt;aid);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="关键函数-1"><a href="#关键函数-1" class="headerlink" title="关键函数"></a>关键函数</h3><p>关键函数<br>6.1 将事件回调函数注册到特定循环</p>
<ul>
<li>[in] event_base：要为其注册事件的基本 ID</li>
<li>[in] event_id：要为其注册事件的 ID</li>
<li>[in] event_handler：事件被调度时的回调函数</li>
<li>[in] event_handler_arg：事件被调度时的回调函数的参数</li>
<li>[out] instance：事件被调度时的回调函数的实例，取消该注册所必须的参数。如果不取消，则可以不保存</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">esp_err_t esp<span class="hljs-constructor">_event_handler_instance_register(<span class="hljs-params">esp_event_base_t</span> <span class="hljs-params">event_base</span>, <span class="hljs-params">int32_t</span>  <span class="hljs-params">event_id</span>, <span class="hljs-params">esp_event_handler_t</span> <span class="hljs-params">event_handler</span>, <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">event_handler_arg</span>, <span class="hljs-params">esp_event_handler_instance_t</span> <span class="hljs-operator">*</span><span class="hljs-params">instance</span>)</span><br></code></pre></td></tr></table></figure>

<h3 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h3><p>新建项目，选择example，选择WiFi—&gt;getting_started-&gt;station<br>同时在sdconfig中设置wifi名和密码<br>下载运行</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">564</span>) phy_init: phy_version <span class="hljs-number">503</span>,<span class="hljs-number">13653</span>eb,Jun  <span class="hljs-number">1</span> <span class="hljs-number">2022</span>,<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">08</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">604</span>) wifi:mode : softAP (<span class="hljs-number">34</span>:<span class="hljs-number">85</span>:<span class="hljs-number">18</span>:<span class="hljs-number">98</span>:<span class="hljs-number">06</span>:dd)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">604</span>) wifi:Total power save buffer number: <span class="hljs-number">16</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">614</span>) wifi:Init max length of beacon: <span class="hljs-number">752</span>/<span class="hljs-number">752</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">614</span>) wifi:Init max length of beacon: <span class="hljs-number">752</span>/<span class="hljs-number">752</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">614</span>) wifi softAP: wifi_init_softap finished. SSID:lonly password:mypassword channel:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">16004</span>) wifi:new:&lt;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&gt;, old:&lt;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&gt;, ap:&lt;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&gt;, sta:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">16004</span>) wifi:station: f2:bf:ee:fa:<span class="hljs-number">2</span>c:<span class="hljs-number">4</span>c join, AID=<span class="hljs-number">1</span>, bgn, <span class="hljs-number">40</span>U<br><span class="hljs-attribute">I</span> (<span class="hljs-number">16034</span>) wifi softAP: station f2:bf:ee:fa:<span class="hljs-number">2</span>c:<span class="hljs-number">4</span>c join, AID=<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">16224</span>) esp_netif_lwip: DHCP server assigned IP to a client, IP is: <span class="hljs-number">192.168.4.2</span><br><span class="hljs-attribute">W</span> (<span class="hljs-number">17534</span>) wifi:&lt;ba-add&gt;idx:<span class="hljs-number">2</span> (ifx:<span class="hljs-number">1</span>, f2:bf:ee:fa:<span class="hljs-number">2</span>c:<span class="hljs-number">4</span>c), tid:<span class="hljs-number">0</span>, ssn:<span class="hljs-number">15</span>, winSize:<span class="hljs-number">64</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">31574</span>) wifi:station: f2:bf:ee:fa:<span class="hljs-number">2</span>c:<span class="hljs-number">4</span>c leave, AID = <span class="hljs-number">1</span>, bss_flags is <span class="hljs-number">134259</span>, bss:<span class="hljs-number">0</span>x3fcf2d54<br><span class="hljs-attribute">I</span> (<span class="hljs-number">31574</span>) wifi:new:&lt;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&gt;, ap:&lt;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&gt;, sta:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">W</span> (<span class="hljs-number">31574</span>) wifi:&lt;ba-del&gt;idx<br><span class="hljs-attribute">I</span> (<span class="hljs-number">31584</span>) wifi softAP: station f2:bf:ee:fa:<span class="hljs-number">2</span>c:<span class="hljs-number">4</span>c leave, AID=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>


<h2 id="WIFI-配网-基于EspTouchForAndroid"><a href="#WIFI-配网-基于EspTouchForAndroid" class="headerlink" title="WIFI 配网-基于EspTouchForAndroid"></a>WIFI 配网-基于EspTouchForAndroid</h2><h3 id="WiFi配网方式"><a href="#WiFi配网方式" class="headerlink" title="WiFi配网方式"></a>WiFi配网方式</h3><p>WiFi配网即：用户通过App&#x2F;小程序&#x2F;网页等途径将WiFi的SSID和密码等信息发送给ESP32，方式有很多种：</p>
<ul>
<li>SoftAP 配网：ESP32 会建立一个 Wi-Fi 热点，用户将手机连接到这个热点后将要连接的 Wi-Fi 信息发送给 ESP32。这种配网模式需要用户手动连接到 ESP32 的热点网络，这会让用户感到奇怪和不友好，不过这种方式很可靠，设备端的代码也简单。</li>
<li>Bluetooth Low Energy 配网：ESP32 会进行 Bluetooth Low Energy 广播，附近的手机收到该广播后会询问用户是否进行 Bluetooth Low Energy 连接，如选择连接，则手机即可将信息发送给 ESP32。在这个的过程中用户无需切换 Wi-Fi 网络，但是需要打开蓝牙，用户体验相对 SoftAP 配网好一些。但是，需要在设备端加入蓝牙相关代码，这会增加固件的大小，并在配网完成前占用一定内存。</li>
<li>Smartconfig 配网：这种方式不需要建立任何通信链路，手机端通过发送不同长度的 UDP 广播包来表示 Wi-Fi 信息，ESP32 在混杂模式监听信号覆盖范围内的所有数据帧，通过一定算法得到 Wi-Fi 信息。缺点是配网成功率受环境的影响较大。<ul>
<li>SmartConfig有很多种，EspTouch（APP）、AirKiss(微信)、EspTouchV2（APP）等</li>
</ul>
</li>
<li>WEB 配网：在 ESP32 上建立热点，使用手机连接上后在浏览器打开配置网页，在网页中完成配网，这种方式很可靠，而且允许在电脑端完成配网，缺点是需要在设备端占用空间来嵌入网页。</li>
</ul>
<h3 id="主程序-1"><a href="#主程序-1" class="headerlink" title="主程序"></a>主程序</h3><ul>
<li>nvs_flash_init，初始化默认 NVS 分区</li>
<li>esp_netif_init，初始化底层TCP&#x2F;IP堆栈</li>
<li>esp_event_loop_create_default，创建默认事件循环</li>
<li>esp_netif_create_default_wifi_sta，使用默认WiFi Station配置创建esp_netif对象，将netif连接到WiFi并注册默认WiFi处理程序</li>
<li>esp_wifi_init，为 WiFi 驱动初始化 WiFi 分配资源，如 WiFi 控制结构、RX&#x2F;TX 缓冲区、WiFi NVS 结构等，这个 WiFi 也启动 WiFi 任务。必须先调用此API，然后才能调用所有其他WiFi API</li>
<li>esp_event_handler_instance_register，监听WIFI_EVENTWiFi 任意事件，触发事件后，进入回调函数</li>
<li>esp_event_handler_instance_register，监听IP_EVENT从连接的AP获得IP的事件，触发事件后，进入回调函数</li>
<li>esp_event_handler_instance_register，监听SC_EVENT从SmartConfig任意事件，触发事件后，进入回调函数</li>
<li>esp_wifi_set_mode，设置WiFi工作模式为station、soft-AP或station+soft-AP，默认模式为soft-AP模式。本程序设置为station</li>
<li>esp_wifi_start，根据配置，启动WiFi</li>
</ul>
<h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><ul>
<li>WIFI_EVENT_STA_START，WiFi station 模式启动时：</li>
<li>创建smartconfig_example_task线程，开始SmartConfig</li>
<li>WIFI_EVENT_STA_DISCONNECTED，WiFi station 模式失去连接</li>
<li>清除CONNECTED_BIT标志位</li>
<li>IP_EVENT_STA_GOT_IP，WiFi station 模式从连接的AP那获得IP</li>
<li>设置CONNECTED_BIT标志位</li>
<li>SC_EVENT_SCAN_DONE，SmartConfig 扫描AP列表结束</li>
<li>SC_EVENT_FOUND_CHANNEL，SmartConfig 从目标AP找到频道</li>
<li>SC_EVENT_GOT_SSID_PSWD，SmartConfig 获得WiFi信息（SSID和密码）时：</li>
<li>解析出WiFi的SSID和密码</li>
<li>esp_wifi_disconnect断开当前WiFi连接</li>
<li>esp_wifi_set_configWiFI配置，设置WIFI_IF_STA模式，设置WiFi的SSID和密码</li>
<li>esp_wifi_connectWiFi连接</li>
<li>SC_EVENT_SEND_ACK_DONE，SmartConfig 给App发送完成ACK</li>
<li>设置ESPTOUCH_DONE_BIT标志位</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void event<span class="hljs-constructor">_handler(<span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">arg</span>, <span class="hljs-params">esp_event_base_t</span> <span class="hljs-params">event_base</span>, <span class="hljs-params">int32_t</span> <span class="hljs-params">event_id</span>, <span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">event_data</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>WIFI_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>WIFI_EVENT_STA_START) &#123;<br>        x<span class="hljs-constructor">TaskCreate(<span class="hljs-params">smartconfig_example_task</span>, <span class="hljs-string">&quot;smartconfig_example_task&quot;</span>, 4096, NULL, 3, NULL)</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>WIFI_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>WIFI_EVENT_STA_DISCONNECTED) &#123;<br>        esp<span class="hljs-constructor">_wifi_connect()</span>;<br>        x<span class="hljs-constructor">EventGroupClearBits(<span class="hljs-params">s_wifi_event_group</span>, CONNECTED_BIT)</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>IP_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>IP_EVENT_STA_GOT_IP) &#123;<br>        x<span class="hljs-constructor">EventGroupSetBits(<span class="hljs-params">s_wifi_event_group</span>, CONNECTED_BIT)</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>SC_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>SC_EVENT_SCAN_DONE) &#123;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Scan done&quot;</span>)</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>SC_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>SC_EVENT_FOUND_CHANNEL) &#123;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Found channel&quot;</span>)</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>SC_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>SC_EVENT_GOT_SSID_PSWD) &#123;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;Got SSID and password&quot;</span>)</span>;<br><br>        smartconfig_event_got_ssid_pswd_t *evt = (smartconfig_event_got_ssid_pswd_t *)event_data;<br>        wifi_config_t wifi_config;<br>        uint8_t ssid<span class="hljs-literal">[<span class="hljs-number">33</span>]</span> = &#123; <span class="hljs-number">0</span> &#125;;<br>        uint8_t password<span class="hljs-literal">[<span class="hljs-number">65</span>]</span> = &#123; <span class="hljs-number">0</span> &#125;;<br>        uint8_t rvd_data<span class="hljs-literal">[<span class="hljs-number">33</span>]</span> = &#123; <span class="hljs-number">0</span> &#125;;<br><br>        bzero(&amp;wifi_config, sizeof(wifi_config_t));<br>        memcpy(wifi_config.sta.ssid, evt-&gt;ssid, sizeof(wifi_config.sta.ssid));<br>        memcpy(wifi_config.sta.password, evt-&gt;password, sizeof(wifi_config.sta.password));<br>        wifi_config.sta.bssid_set = evt-&gt;bssid_set;<br>        <span class="hljs-keyword">if</span> (wifi_config.sta.bssid_set<span class="hljs-operator"> == </span><span class="hljs-literal">true</span>) &#123;<br>            memcpy(wifi_config.sta.bssid, evt-&gt;bssid, sizeof(wifi_config.sta.bssid));<br>        &#125;<br><br>        memcpy(ssid, evt-&gt;ssid, sizeof(evt-&gt;ssid));<br>        memcpy(password, evt-&gt;password, sizeof(evt-&gt;password));<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;SSID:%s&quot;</span>, <span class="hljs-params">ssid</span>)</span>;<br>        <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;PASSWORD:%s&quot;</span>, <span class="hljs-params">password</span>)</span>;<br>        <span class="hljs-keyword">if</span> (evt-&gt;<span class="hljs-keyword">type</span><span class="hljs-operator"> == </span>SC_TYPE_ESPTOUCH_V2) &#123;<br>            <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_smartconfig_get_rvd_data</span>(<span class="hljs-params">rvd_data</span>, <span class="hljs-params">sizeof</span>(<span class="hljs-params">rvd_data</span>)</span>) );<br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;RVD_DATA:&quot;</span>)</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">33</span>; i++) &#123;<br>                printf(<span class="hljs-string">&quot;%02x &quot;</span>, rvd_data<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>);<br>            &#125;<br>            printf(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_wifi_disconnect</span>()</span> );<br>        <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_wifi_set_config</span>(WIFI_IF_STA, &amp;<span class="hljs-params">wifi_config</span>)</span> );<br>        esp<span class="hljs-constructor">_wifi_connect()</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event_base<span class="hljs-operator"> == </span>SC_EVENT<span class="hljs-operator"> &amp;&amp; </span>event_id<span class="hljs-operator"> == </span>SC_EVENT_SEND_ACK_DONE) &#123;<br>        x<span class="hljs-constructor">EventGroupSetBits(<span class="hljs-params">s_wifi_event_group</span>, ESPTOUCH_DONE_BIT)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="SmartConfig线程"><a href="#SmartConfig线程" class="headerlink" title="SmartConfig线程"></a>SmartConfig线程</h3><ul>
<li>esp_smartconfig_set_type设置SmartConfig的协议类型为SC_TYPE_ESPTOUCH。协议类型有：SC_TYPE_ESPTOUCH、SC_TYPE_AIRKISS、SC_TYPE_ESPTOUCH_AIRKISS、SC_TYPE_ESPTOUCH_V2等</li>
<li>esp_smartconfig_start启动SmartConfig</li>
<li>等待ESPTOUCH_DONE_BIT标志位<ul>
<li>esp_smartconfig_stop停止SmartConfig<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void smartconfig<span class="hljs-constructor">_example_task(<span class="hljs-params">void</span> <span class="hljs-operator">*</span> <span class="hljs-params">parm</span>)</span><br>&#123;<br>    EventBits_t uxBits;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_smartconfig_set_type</span>(SC_TYPE_ESPTOUCH)</span> );<br>    smartconfig_start_config_t cfg = <span class="hljs-constructor">SMARTCONFIG_START_CONFIG_DEFAULT()</span>;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_smartconfig_start</span>(&amp;<span class="hljs-params">cfg</span>)</span> );<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        uxBits = x<span class="hljs-constructor">EventGroupWaitBits(<span class="hljs-params">s_wifi_event_group</span>, CONNECTED_BIT | ESPTOUCH_DONE_BIT, <span class="hljs-params">true</span>, <span class="hljs-params">false</span>, <span class="hljs-params">portMAX_DELAY</span>)</span>;<br>        <span class="hljs-keyword">if</span>(uxBits &amp; CONNECTED_BIT) &#123;<br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;WiFi Connected to ap&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(uxBits &amp; ESPTOUCH_DONE_BIT) &#123;<br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;smartconfig over&quot;</span>)</span>;<br>            esp<span class="hljs-constructor">_smartconfig_stop()</span>;<br>            v<span class="hljs-constructor">TaskDelete(NULL)</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><ul>
<li>回调函数和SmartConfig线程是通过xEventGroupWaitBits、xEventGroupSetBits、xEventGroupClearBits等函数进行通信<ul>
<li>回调函数设置或清楚Bits,xEventGroupSetBits、xEventGroupClearBits</li>
<li>SmartConfig线程通过循环等待xEventGroupWaitBits</li>
</ul>
</li>
</ul>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/smart_liucheng_.jpg" srcset="/img/loading.gif" lazyload alt="smart liucheng "></p>
<h3 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h3><p>新建项目，选择example，选择WiFi—&gt;smart_config<br>下载运行</p>
<ul>
<li>下载、安装、打开EspTouchForAndroid App</li>
<li>输入WiFi密码，确认即可</li>
<li>注意：ESP32只支持2.4GHz WiFi，还不支持5GHz WiF</li>
</ul>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689519238551.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">600</span>) wifi:mode : sta (<span class="hljs-number">34</span>:<span class="hljs-number">85</span>:<span class="hljs-number">18</span>:<span class="hljs-number">98</span>:<span class="hljs-number">06</span>:dc)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">600</span>) wifi:enable tsf<br><span class="hljs-attribute">I</span> (<span class="hljs-number">660</span>) smartconfig: SC version: V3.<span class="hljs-number">0</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">5470</span>) wifi:ic_enable_sniffer<br><span class="hljs-attribute">I</span> (<span class="hljs-number">5470</span>) smartconfig: Start to find channel...<br><span class="hljs-attribute">I</span> (<span class="hljs-number">5470</span>) smartconfig_example: Scan done<br><span class="hljs-attribute">I</span> (<span class="hljs-number">57790</span>) smartconfig: TYPE: ESPTOUCH<br><span class="hljs-attribute">I</span> (<span class="hljs-number">57800</span>) smartconfig: T|AP MAC: <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">57800</span>) smartconfig: Found channel <span class="hljs-literal">on</span> <span class="hljs-number">6</span>-<span class="hljs-number">0</span>. Start to get ssid and password...<br><span class="hljs-attribute">I</span> (<span class="hljs-number">57800</span>) smartconfig_example: Found channel<br><span class="hljs-attribute">I</span> (<span class="hljs-number">63120</span>) smartconfig: T|pswd: <span class="hljs-number">15996264842</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">63120</span>) smartconfig: T|ssid: <span class="hljs-number">15</span>-<span class="hljs-number">501</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">63120</span>) smartconfig: T|bssid: <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">63120</span>) wifi:ic_disable_sniffer<br><span class="hljs-attribute">I</span> (<span class="hljs-number">63120</span>) smartconfig_example: Got SSID and password<br><span class="hljs-attribute">I</span> (<span class="hljs-number">63120</span>) smartconfig_example: SSID:<span class="hljs-number">15</span>-<span class="hljs-number">501</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">63130</span>) smartconfig_example: PASSWORD:<span class="hljs-number">15996264842</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">63180</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">64160</span>) wifi:state: init -&gt; auth (b0)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">64160</span>) wifi:state: auth -&gt; assoc (<span class="hljs-number">0</span>)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">64220</span>) wifi:state: assoc -&gt; run (<span class="hljs-number">10</span>)<br><span class="hljs-attribute">W</span> (<span class="hljs-number">64240</span>) wifi:&lt;ba-add&gt;idx:<span class="hljs-number">0</span> (ifx:<span class="hljs-number">0</span>, <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span>), tid:<span class="hljs-number">5</span>, ssn:<span class="hljs-number">0</span>, winSize:<span class="hljs-number">64</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">64360</span>) wifi:connected with <span class="hljs-number">15</span>-<span class="hljs-number">501</span>, aid = <span class="hljs-number">8</span>, channel <span class="hljs-number">6</span>, BW20, bssid = <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">64360</span>) wifi:security: WPA2-PSK, phy: bgn, rssi: -<span class="hljs-number">52</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">64370</span>) wifi:pm start, type: <span class="hljs-number">1</span><br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">64370</span>) wifi:set rx beacon pti, rx_bcn_pti: <span class="hljs-number">0</span>, bcn_timeout: <span class="hljs-number">0</span>, mt_pti: <span class="hljs-number">25000</span>, mt_time: <span class="hljs-number">10000</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">64440</span>) wifi:BcnInt:<span class="hljs-number">102400</span>, DTIM:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">65440</span>) esp_netif_handlers: sta ip: <span class="hljs-number">192.168.0.108</span>, mask: <span class="hljs-number">255.255.255.0</span>, gw: <span class="hljs-number">192.168.0.1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">65440</span>) smartconfig_example: WiFi Connected to ap<br><span class="hljs-attribute">W</span> (<span class="hljs-number">65830</span>) wifi:&lt;ba-add&gt;idx:<span class="hljs-number">1</span> (ifx:<span class="hljs-number">0</span>, <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span>), tid:<span class="hljs-number">6</span>, ssn:<span class="hljs-number">2</span>, winSize:<span class="hljs-number">64</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">68460</span>) smartconfig_example: smartconfig over<br></code></pre></td></tr></table></figure>

<h2 id="WIFI-配网-基于AirKiss"><a href="#WIFI-配网-基于AirKiss" class="headerlink" title="WIFI 配网-基于AirKiss"></a>WIFI 配网-基于AirKiss</h2><p>本文主要是基于Airkiss的SmartConfig智能配网，流程原理与EspTouch基本相同，都是通过udp广播的方式将WiFi AP的SSID和密码发送出去，只是通信协议和数据格式不同而已。</p>
<p>EspTouch是乐鑫的提供的WiFi配网协议，提供了Android&#x2F;IOS源码<br>Airkiss是微信提供的WiFi配网协议，如果是基于微信生态开发的应用，如小程序、公众号等，则优先选择它</p>
<h3 id="代码修改"><a href="#代码修改" class="headerlink" title="代码修改"></a>代码修改</h3><p>smartconfig_main.c中函数smartconfig_example_task中的esp_smartconfig_set_type设置SmartConfig通信协议修改掉，如下</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void smartconfig<span class="hljs-constructor">_example_task(<span class="hljs-params">void</span> <span class="hljs-operator">*</span> <span class="hljs-params">parm</span>)</span><br>&#123;<br>    EventBits_t uxBits;<br>    <span class="hljs-comment">// ESP_ERROR_CHECK( esp_smartconfig_set_type(SC_TYPE_ESPTOUCH) );</span><br>	<span class="hljs-comment">// 修改为下面这一句，其它保持一致</span><br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_smartconfig_set_type</span>(SC_TYPE_ESPTOUCH_AIRKISS)</span> );<br>    smartconfig_start_config_t cfg = <span class="hljs-constructor">SMARTCONFIG_START_CONFIG_DEFAULT()</span>;<br>    <span class="hljs-constructor">ESP_ERROR_CHECK( <span class="hljs-params">esp_smartconfig_start</span>(&amp;<span class="hljs-params">cfg</span>)</span> );<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        uxBits = x<span class="hljs-constructor">EventGroupWaitBits(<span class="hljs-params">s_wifi_event_group</span>, CONNECTED_BIT | ESPTOUCH_DONE_BIT, <span class="hljs-params">true</span>, <span class="hljs-params">false</span>, <span class="hljs-params">portMAX_DELAY</span>)</span>;<br>        <span class="hljs-keyword">if</span>(uxBits &amp; CONNECTED_BIT) &#123;<br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;WiFi Connected to ap&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(uxBits &amp; ESPTOUCH_DONE_BIT) &#123;<br>            <span class="hljs-constructor">ESP_LOGI(TAG, <span class="hljs-string">&quot;smartconfig over&quot;</span>)</span>;<br>            esp<span class="hljs-constructor">_smartconfig_stop()</span>;<br>            v<span class="hljs-constructor">TaskDelete(NULL)</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="配网"><a href="#配网" class="headerlink" title="配网"></a>配网</h3><ul>
<li>微信搜索：乐鑫信息科技</li>
<li>菜单商铺 —&gt; Airkiss设备</li>
<li>输入WiFi密码，点击连接</li>
<li>注意：ESP32只支持2.4GHz WiFi，还不支持5GHz WiFi</li>
</ul>
<p>或直接扫描下面二维码<br>官方给的工具网址为：<a target="_blank" rel="noopener" href="https://iot.espressif.cn/configWXDeviceWiFi.html">https://iot.espressif.cn/configWXDeviceWiFi.html</a><br>可以利用<a target="_blank" rel="noopener" href="https://www.hlcode.cn/url">网址二维码生成器</a>将链接转二维码，像我生成的二维码：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/5e4c1a97-6c05-4222-ae70-0ae6ef4ac87d.png" srcset="/img/loading.gif" lazyload alt="5e4c1a97-6c05-4222-ae70-0ae6ef4ac87d"></p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689520072550.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span> (<span class="hljs-number">611</span>) wifi:mode : sta (<span class="hljs-number">34</span>:<span class="hljs-number">85</span>:<span class="hljs-number">18</span>:<span class="hljs-number">98</span>:<span class="hljs-number">06</span>:dc)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">611</span>) wifi:enable tsf<br><span class="hljs-attribute">I</span> (<span class="hljs-number">661</span>) smartconfig: SC version: V3.<span class="hljs-number">0</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">5471</span>) wifi:ic_enable_sniffer<br><span class="hljs-attribute">I</span> (<span class="hljs-number">5471</span>) smartconfig: Start to find channel...<br><span class="hljs-attribute">I</span> (<span class="hljs-number">5471</span>) smartconfig_example: Scan done<br><span class="hljs-attribute">I</span> (<span class="hljs-number">25221</span>) smartconfig: TYPE: AIRKISS<br><span class="hljs-attribute">I</span> (<span class="hljs-number">25221</span>) smartconfig: T|AP MAC: <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">25231</span>) smartconfig: Found channel <span class="hljs-literal">on</span> <span class="hljs-number">6</span>-<span class="hljs-number">0</span>. Start to get ssid and password...<br><span class="hljs-attribute">I</span> (<span class="hljs-number">25231</span>) smartconfig_example: Found channel<br><span class="hljs-attribute">I</span> (<span class="hljs-number">28451</span>) smartconfig: T|pswd: <span class="hljs-number">15996264842</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">28451</span>) smartconfig: T|ssid: <span class="hljs-number">15</span>-<span class="hljs-number">501</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">28451</span>) wifi:ic_disable_sniffer<br><span class="hljs-attribute">I</span> (<span class="hljs-number">28451</span>) smartconfig_example: Got SSID and password<br><span class="hljs-attribute">I</span> (<span class="hljs-number">28451</span>) smartconfig_example: SSID:<span class="hljs-number">15</span>-<span class="hljs-number">501</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">28461</span>) smartconfig_example: PASSWORD:<span class="hljs-number">15996264842</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">28561</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">29541</span>) wifi:state: init -&gt; auth (b0)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">29571</span>) wifi:state: auth -&gt; assoc (<span class="hljs-number">0</span>)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">29591</span>) wifi:state: assoc -&gt; run (<span class="hljs-number">10</span>)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">32701</span>) wifi:state: run -&gt; init (fc0)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">32701</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">32701</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">35121</span>) wifi:new:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, old:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, ap:&lt;<span class="hljs-number">255</span>,<span class="hljs-number">255</span>&gt;, sta:&lt;<span class="hljs-number">6</span>,<span class="hljs-number">0</span>&gt;, prof:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">35121</span>) wifi:state: init -&gt; auth (b0)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">35131</span>) wifi:state: auth -&gt; assoc (<span class="hljs-number">0</span>)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">35231</span>) wifi:state: assoc -&gt; run (<span class="hljs-number">10</span>)<br><span class="hljs-attribute">I</span> (<span class="hljs-number">35331</span>) wifi:connected with <span class="hljs-number">15</span>-<span class="hljs-number">501</span>, aid = <span class="hljs-number">8</span>, channel <span class="hljs-number">6</span>, BW20, bssid = <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">35331</span>) wifi:security: WPA2-PSK, phy: bgn, rssi: -<span class="hljs-number">52</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">35341</span>) wifi:pm start, type: <span class="hljs-number">1</span><br><br><span class="hljs-attribute">I</span> (<span class="hljs-number">35341</span>) wifi:set rx beacon pti, rx_bcn_pti: <span class="hljs-number">0</span>, bcn_timeout: <span class="hljs-number">0</span>, mt_pti: <span class="hljs-number">25000</span>, mt_time: <span class="hljs-number">10000</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">35341</span>) wifi:BcnInt:<span class="hljs-number">102400</span>, DTIM:<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">36441</span>) esp_netif_handlers: sta ip: <span class="hljs-number">192.168.0.108</span>, mask: <span class="hljs-number">255.255.255.0</span>, gw: <span class="hljs-number">192.168.0.1</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">36441</span>) smartconfig_example: WiFi Connected to ap<br><span class="hljs-attribute">W</span> (<span class="hljs-number">37211</span>) wifi:&lt;ba-add&gt;idx:<span class="hljs-number">0</span> (ifx:<span class="hljs-number">0</span>, <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span>), tid:<span class="hljs-number">5</span>, ssn:<span class="hljs-number">3</span>, winSize:<span class="hljs-number">64</span><br><span class="hljs-attribute">W</span> (<span class="hljs-number">37231</span>) wifi:&lt;ba-add&gt;idx:<span class="hljs-number">1</span> (ifx:<span class="hljs-number">0</span>, <span class="hljs-number">58</span>:<span class="hljs-number">41</span>:<span class="hljs-number">20</span>:<span class="hljs-number">1</span>e:<span class="hljs-number">06</span>:<span class="hljs-number">19</span>), tid:<span class="hljs-number">6</span>, ssn:<span class="hljs-number">1</span>, winSize:<span class="hljs-number">64</span><br><span class="hljs-attribute">I</span> (<span class="hljs-number">39631</span>) smartconfig_example: smartconfig over<br></code></pre></td></tr></table></figure>
<h2 id="http-request-client"><a href="#http-request-client" class="headerlink" title="http request client"></a>http request client</h2><h3 id="ESP-HTTP-client介绍"><a href="#ESP-HTTP-client介绍" class="headerlink" title="ESP HTTP client介绍"></a>ESP HTTP client介绍</h3><p>包含:</p>
<ul>
<li>启用https</li>
<li>位于： Component config &gt; ESP HTTP client</li>
<li>此选项将通过链接esp-tls库并初始化SSL传输来启用https协议</li>
<li>Default value: Yes (enabled)</li>
</ul>
<p><code>CONFIG_ESP_HTTP_CLIENT_ENABLE_HTTPS</code></p>
<ul>
<li><p>启用HTTP基本身份验证</p>
</li>
<li><p>位于：Component config &gt; ESP HTTP client</p>
</li>
<li><p>此选项将启用HTTP基本身份验证。它在默认情况下被禁用，因为基本身份验证使用未加密的编码，因此在不使用TLS时会引入漏洞</p>
</li>
<li><p>Default value: Yes (enabled)<br><code>CONFIG_ESP_HTTP_CLIENT_ENABLE_BASIC_AUTH</code></p>
</li>
<li><p>启用HTTP摘要式身份验证</p>
</li>
<li><p>Found in: Component config &gt; ESP HTTP client</p>
</li>
<li><p>此选项将启用HTTP摘要身份验证。默认情况下，它是启用的，但使用 不建议配置，因为密码可以从exchange中派生，因此它引入了 不使用TLS时的漏洞</p>
</li>
<li><p>Default value:默认值：No (disabled)否（禁用</p>
</li>
</ul>
<p><code>CONFIG_ESP_HTTP_CLIENT_ENABLE_DIGEST_AUTH</code></p>
<h2 id="HTTP简介"><a href="#HTTP简介" class="headerlink" title="HTTP简介"></a>HTTP简介</h2><p>HTTP协议是Hyper Text Transfer Protocol超文本传输协议的缩写，基于TCP传输层协议进行通信，采用客户端-服务器模型（C&#x2F;S架构），属于应用层协议<br>HTTP数据传输是透明的，明文传输涉及到通信安全时，传输层上可套接TLS&#x2F;SSL协议进行加密，也就是HTTPS<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E4%B9%90%E9%91%ABESP32_S3%E6%95%99%E7%A8%8B_%E5%9F%BA%E4%BA%8EESP-IDF_v5.0/1689772272405.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p><strong>特点</strong></p>
<ul>
<li>HTTP默认使用80端口，HTTPS默认使用443端口</li>
<li>无状态，协议对于事务处理没有记忆能力，每次都是一个新的连接，服务端不会记录前后的请求信息（针对这个问题，引入Cookie将记录加密存储到客户端中）</li>
<li>无连接，限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接；（HTTP1.1版本支持持久连接的方法）</li>
<li>媒体独立，允许传输任意类型的数据对象，传输类型由Content-Type定义</li>
</ul>
<h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><ul>
<li>esp_http_client_init()，创建一个 esp_http_client_handle_t 实例，即基于给定的 esp_http_client_config_t 配置创建 HTTP 客户端句柄。此函数必须第一个被调用。若用户未明确定义参数的配置值，则使用默认值。</li>
<li>其次调用 esp_http_client_perform()，执行 esp_http_client 的所有操作，包括打开连接、交换数据、关闭连接（如需要），同时在当前任务完成前阻塞该任务。所有相关的事件（在 esp_http_client_config_t 中指定）将通过事件处理程序被调用。</li>
<li>最后调用 esp_http_client_cleanup() 来关闭连接（如有），并释放所有分配给 HTTP 客户端实例的内存。此函数必须在操作完成后最后一个被调用。</li>
</ul>
<h3 id="持久连接"><a href="#持久连接" class="headerlink" title="持久连接"></a>持久连接</h3><p>持久连接是 HTTP 客户端在多次交换中重复使用同一连接的方法。如果服务器没有使用 Connection: close 头来请求关闭连接，连接就会一直保持开放，用于其他新请求。</p>
<p>为了使 ESP HTTP 客户端充分利用持久连接的优势，建议尽可能多地使用同一个句柄实例来发起请求，可参考应用示例中的函数 http_rest_with_url 和 http_rest_with_hostname_path。示例中，一旦创建连接，即会在连接关闭前发出多个请求（如 GET、 POST、 PUT 等）。</p>
<h3 id="HTTPS-请求"><a href="#HTTPS-请求" class="headerlink" title="HTTPS 请求"></a>HTTPS 请求</h3><p>ESP HTTP 客户端支持使用 mbedTLS 的 SSL 连接，需将 url 配置为以 https 开头，或将 transport_type 设置为 HTTP_TRANSPORT_OVER_SSL。可以通过 CONFIG_ESP_HTTP_CLIENT_ENABLE_HTTPS 来配置 HTTPS 支持（默认启用）。</p>
<p>备注</p>
<p>在发起 HTTPS 请求时，如需服务器验证，首先需要向 esp_http_client_config_t 配置中的 cert_pem 成员提供额外的根证书（PEM 格式）。用户还可以通过 esp_http_client_config_t 配置中的 crt_bundle_attach 成员，使用 ESP x509 Certificate Bundle 进行服务器验证。</p>
<p>如需了解上文备注中的实现细节，请参考应用示例中的函数 https_with_url 和 https_with_hostname_path。</p>
<p>HTTP 流</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">esp_http_client_config_t</span> config = &#123;<br>    .url = <span class="hljs-string">&quot;https://www.howsmyssl.com&quot;</span>, <span class="hljs-comment">// url</span><br>    .cert_pem = howsmyssl_com_root_cert_pem_start,<span class="hljs-comment">//证书</span><br>&#125;;<br><span class="hljs-type">esp_http_client_handle_t</span> client = <span class="hljs-built_in">esp_http_client_init</span>(&amp;config);<br></code></pre></td></tr></table></figure>
<p>传递配置形参，url成员必填，如果跳过证书可将元素skip_cert_common_name_check改为TRUE</p>
<ul>
<li>url：常见的链接，传输协议（https）+域名或IP（host）+ 端口号（port） +路径（path）+查询字符串(query)+锚点<code>https://www.baidu.com/swd=hello&amp;rsv_spt=1#5</code><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs awk">/**<br> * @brief HTTP configuration<br> */<br>typedef struct &#123;<br>    const char                  *url; <span class="hljs-regexp">//u</span>rl请求接口必须配置               <span class="hljs-regexp">/*!&lt; HTTP URL, the information on the URL is most important, it overrides the other fields below, if any */</span><br>    const char                  *host; <span class="hljs-regexp">//</span>服务器域名或ip地址              <span class="hljs-regexp">/*!&lt; Domain or IP as string */</span><br>    int                             port; <span class="hljs-regexp">//</span>端口 http默认<span class="hljs-number">80</span> https 默认<span class="hljs-number">443</span>                <span class="hljs-regexp">/*!&lt; Port to connect, default depend on esp_http_client_transport_t (80 or 443) */</span><br>    const char                  *username;  <span class="hljs-regexp">//</span>用户名，认证使用         <span class="hljs-regexp">/*!&lt; Using for Http authentication */</span><br>    const char                  *password;  <span class="hljs-regexp">//</span>用户密码，认证使用         <span class="hljs-regexp">/*!&lt; Using for Http authentication */</span><br>    esp_http_client_auth_type_t auth_type; <span class="hljs-regexp">//</span>认证方式          <span class="hljs-regexp">/*!&lt; Http authentication type, see `esp_http_client_auth_type_t` */</span><br>    const char                  *path;  <span class="hljs-regexp">//</span>路径             <span class="hljs-regexp">/*!&lt; HTTP Path, if not set, default is `/</span>` */<br>    const char                  *query;  <span class="hljs-regexp">//</span>请求参数            <span class="hljs-regexp">/*!&lt; HTTP query */</span><br>    const char                  *cert_pem;    <span class="hljs-regexp">//</span>证书       <span class="hljs-regexp">/*!&lt; SSL server certification, PEM format as string, if the client requires to verify server */</span><br>    const char                  *client_cert_pem;    <span class="hljs-regexp">/*!&lt; SSL client certification, PEM format as string, if the server requires to verify client */</span><br>    const char                  *client_key_pem;     <span class="hljs-regexp">/*!&lt; SSL client key, PEM format as string, if the server requires to verify client */</span><br>    esp_http_client_method_t    method;  <span class="hljs-regexp">//</span>请求方式 post get                 <span class="hljs-regexp">/*!&lt; HTTP Method */</span><br>    int                         timeout_ms;  <span class="hljs-regexp">//</span>请求超时             <span class="hljs-regexp">/*!&lt; Network timeout in milliseconds */</span><br>    bool                        disable_auto_redirect;    <span class="hljs-regexp">/*!&lt; Disable HTTP automatic redirects */</span><br>    int                         max_redirection_count;    <span class="hljs-regexp">/*!&lt; Max number of redirections on receiving HTTP redirect status code, using default value if zero*/</span><br>    int                         max_authorization_retries;    <span class="hljs-regexp">/*!&lt; Max connection retries on receiving HTTP unauthorized status code, using default value if zero. Disables authorization retry if -1*/</span><br>    http_event_handle_cb        event_handler;  <span class="hljs-regexp">//</span>可注册回调           <span class="hljs-regexp">/*!&lt; HTTP Event Handle */</span><br>    esp_http_client_transport_t transport_type;  <span class="hljs-regexp">//</span> 传输方式 tcp ssl        <span class="hljs-regexp">/*!&lt; HTTP transport type, see `esp_http_client_transport_t` */</span><br>    int                         buffer_size; <span class="hljs-regexp">//</span>接收缓存大小             <span class="hljs-regexp">/*!&lt; HTTP receive buffer size */</span><br>    int                         buffer_size_tx; <span class="hljs-regexp">//</span>发送缓存大小          <span class="hljs-regexp">/*!&lt; HTTP transmit buffer size */</span><br>    void                        *user_data;  <span class="hljs-regexp">//</span>http用户数据             <span class="hljs-regexp">/*!&lt; HTTP user_data context */</span><br>    bool                        is_async;  <span class="hljs-regexp">//</span>同步模式               <span class="hljs-regexp">/*!&lt; Set asynchronous mode, only supported with HTTPS for now */</span><br>    bool                        use_global_ca_store;       <span class="hljs-regexp">/*!&lt; Use a global ca_store for all the connections in which this bool is set. */</span><br>    bool                        skip_cert_common_name_check; <span class="hljs-regexp">//</span>跳过证书   <span class="hljs-regexp">/*!&lt; Skip any validation of server certificate CN field */</span><br>&#125; esp_http_client_config_t;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>其次调用 esp_http_client_perform()，执行 esp_http_client 的所有操作，包括打开连接、交换数据、关闭连接（如需要），同时在当前任务完成前阻塞该任务。所有相关的事件（在 esp_http_client_config_t 中指定）将通过事件处理程序被调用。</p>
<p>最后调用 esp_http_client_cleanup() 来关闭连接（如有），并释放所有分配给 HTTP 客户端实例的内存。此函数必须在操作完成后最后一个被调用。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/weibanggang/p/9454581.html">https://www.cnblogs.com/weibanggang/p/9454581.html</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7106310756580196388">https://juejin.cn/post/7106310756580196388</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2097221">https://cloud.tencent.com/developer/article/2097221</a></p>
<h2 id="待机唤醒"><a href="#待机唤醒" class="headerlink" title="待机唤醒"></a>待机唤醒</h2><h2 id="内部温度"><a href="#内部温度" class="headerlink" title="内部温度"></a>内部温度</h2><h2 id="DAC"><a href="#DAC" class="headerlink" title="DAC"></a>DAC</h2><h2 id="PWM-DAC"><a href="#PWM-DAC" class="headerlink" title="PWM DAC"></a>PWM DAC</h2><h2 id="IIC"><a href="#IIC" class="headerlink" title="IIC"></a>IIC</h2><h2 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h2><h2 id="DMA"><a href="#DMA" class="headerlink" title="DMA"></a>DMA</h2><h3 id="串口-DMA"><a href="#串口-DMA" class="headerlink" title="串口 DMA"></a>串口 DMA</h3><h3 id="SPI-DMA"><a href="#SPI-DMA" class="headerlink" title="SPI DMA"></a>SPI DMA</h3><h3 id="LCD-DMA"><a href="#LCD-DMA" class="headerlink" title="LCD DMA"></a>LCD DMA</h3><h2 id="SRAM"><a href="#SRAM" class="headerlink" title="SRAM"></a>SRAM</h2><h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><h2 id="SD"><a href="#SD" class="headerlink" title="SD"></a>SD</h2><h2 id="FATFS"><a href="#FATFS" class="headerlink" title="FATFS"></a>FATFS</h2><h2 id="汉字显示"><a href="#汉字显示" class="headerlink" title="汉字显示"></a>汉字显示</h2><h2 id="图片显示"><a href="#图片显示" class="headerlink" title="图片显示"></a>图片显示</h2><h2 id="照相机"><a href="#照相机" class="headerlink" title="照相机"></a>照相机</h2><h2 id="音乐播放"><a href="#音乐播放" class="headerlink" title="音乐播放"></a>音乐播放</h2><h2 id="视频播放"><a href="#视频播放" class="headerlink" title="视频播放"></a>视频播放</h2><h2 id="手写识别"><a href="#手写识别" class="headerlink" title="手写识别"></a>手写识别</h2><h2 id="输入法"><a href="#输入法" class="headerlink" title="输入法"></a>输入法</h2><h2 id="串口IAP"><a href="#串口IAP" class="headerlink" title="串口IAP"></a>串口IAP</h2><h2 id="USB、OTA"><a href="#USB、OTA" class="headerlink" title="USB、OTA"></a>USB、OTA</h2><h2 id="RTOS"><a href="#RTOS" class="headerlink" title="RTOS"></a>RTOS</h2><h2 id="WIFI网络"><a href="#WIFI网络" class="headerlink" title="WIFI网络"></a>WIFI网络</h2><h2 id="蓝牙"><a href="#蓝牙" class="headerlink" title="蓝牙"></a>蓝牙</h2><h2 id="温度传感器"><a href="#温度传感器" class="headerlink" title="温度传感器"></a>温度传感器</h2><h2 id="MPU6050"><a href="#MPU6050" class="headerlink" title="MPU6050"></a>MPU6050</h2><h2 id="Cmake学习"><a href="#Cmake学习" class="headerlink" title="Cmake学习"></a>Cmake学习</h2><p>cmake_minimum_required()： cmake最小支持版本<br>include()：cmake 包含<br>project(): cmake 工程名<br>idf_component_register(): idf文件注册</p>
<ul>
<li>参数：SCRS 源文件</li>
<li>INCLUDE_DIRS .h头文件</li>
<li>REQUIRES 依赖</li>
</ul>
<p>file()： 文件操作命令</p>
<ul>
<li>参数： GLOB 通过正则表达式匹配文件名并保存到变量中</li>
</ul>
<h1 id="ESP32-x2F-ESP8266程序下载电路"><a href="#ESP32-x2F-ESP8266程序下载电路" class="headerlink" title="ESP32&#x2F;ESP8266程序下载电路"></a>ESP32&#x2F;ESP8266程序下载电路</h1><h2 id="官方一键下载电路分析"><a href="#官方一键下载电路分析" class="headerlink" title="官方一键下载电路分析"></a>官方一键下载电路分析</h2><p><a target="_blank" rel="noopener" href="https://www.espressif.com/zh-hans/products/modules">https://www.espressif.com/zh-hans/products/modules</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/145369083">https://zhuanlan.zhihu.com/p/145369083</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41975300/article/details/104834771">https://blog.csdn.net/weixin_41975300/article/details/104834771</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/woniulx2014/article/details/117172805">https://blog.csdn.net/woniulx2014/article/details/117172805</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wutongpro/article/details/109101063">https://blog.csdn.net/wutongpro/article/details/109101063</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d7c0dbb223a0">https://www.jianshu.com/p/d7c0dbb223a0</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/fe98713e40eb">https://www.jianshu.com/p/fe98713e40eb</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cai-zi/p/13942615.html">https://www.cnblogs.com/cai-zi/p/13942615.html</a></p>
<p>官方下载程序的SDK代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># issue reset-to-bootloader:</span><br>   <span class="hljs-comment"># RTS = either CH_PD/EN or nRESET (both active low = chip in reset</span><br>   <span class="hljs-comment"># DTR = GPIO0 (active low = boot to flasher)</span><br>   <span class="hljs-comment">#</span><br>   <span class="hljs-comment"># DTR &amp; RTS are active low signals,</span><br>   <span class="hljs-comment"># ie True = pin @ 0V, False = pin @ VCC.</span><br>   <span class="hljs-keyword">if</span> mode != <span class="hljs-string">&#x27;no_reset&#x27;</span>:<br>       self._setDTR(<span class="hljs-literal">False</span>)  <span class="hljs-comment"># IO0=HIGH</span><br>   <span class="hljs-number">1</span>)  self._setRTS(<span class="hljs-literal">True</span>)   <span class="hljs-comment"># EN=LOW, chip in reset</span><br>       time.sleep(<span class="hljs-number">0.1</span>)<br>   <span class="hljs-number">2</span>)  self._setDTR(<span class="hljs-literal">True</span>)   <span class="hljs-comment"># IO0=LOW</span><br>   <span class="hljs-number">3</span>)  self._setRTS(<span class="hljs-literal">False</span>)  <span class="hljs-comment"># EN=HIGH, chip out of reset</span><br>       time.sleep(<span class="hljs-number">0.05</span>)<br>   <span class="hljs-number">4</span>)  self._setDTR(<span class="hljs-literal">False</span>)  <span class="hljs-comment"># IO0=HIGH, done</span><br><br></code></pre></td></tr></table></figure>
<p>分析代码可知，下载程序有四步：</p>
<ol>
<li>IO0&#x3D;HIGH  EN&#x3D;LOW, chip in reset  延时 100ms</li>
<li>IO0&#x3D;LOW EN&#x3D;HIGH, chip out of reset  延时 50ms</li>
<li>IO0&#x3D;HIGH done<br>程序下载流程：</li>
<li>芯片断电，设置 IO0 &#x3D; 0  EN &#x3D; 0 进入下载模式</li>
<li>上电，</li>
</ol>
<h2 id="S2-硬件设计注意事项"><a href="#S2-硬件设计注意事项" class="headerlink" title="S2 硬件设计注意事项"></a>S2 硬件设计注意事项</h2><ul>
<li>IO0相当于 WAKEUP，EN相当于 RESET</li>
<li>U0TXD 需串联 499R 电阻，S2 模组已经内置。</li>
<li>S2模组的管脚 IO26 默认用于连接至模组上集成的 PSRAM 的 CS 端，不可用于其他功能</li>
<li>IO0 和  IO46 为系统启动模式功能。为0下载模式，为1从内部flash启动<table>
<thead>
<tr>
<th>管脚</th>
<th>默认</th>
<th>SPI启动模式</th>
<th>下载启动模式</th>
</tr>
</thead>
<tbody><tr>
<td>IO0</td>
<td>上拉</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>IO46</td>
<td>下拉</td>
<td>x</td>
<td>0</td>
</tr>
<tr>
<td>复位放开后， 管脚和普通管脚功能相同</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li>IO45 设置 VDD_SPI 电压。下拉为3.3V，上拉为1.8V。S2模组中 VDD_SPI为扩展的SPI、PSRAM电压。</li>
<li>GPIO18 作为 U1RXD，在芯片上电时是不确定状态，可能会影响芯片正常进入下载启动模式，需要在外部增加一个上拉电阻来解决</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6f2042f7064e">用Arduino玩ESP32（05）：GPIO使用</a></p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/00-%E9%A1%B9%E7%9B%AE/" class="category-chain-item">00-项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>乐鑫ESP32 S3教程_基于ESP-IDF v5.0</div>
      <div>http://lonlypan.com/2022/05/08/乐鑫ESP32 S2教程_基于ESP-IDF v4.4/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>LonlyPan</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年5月8日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                <i class="iconfont icon-nc"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/06/04/%E8%AE%A4%E7%9F%A5%E5%A4%A9%E6%80%A7/" title="认知天性">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">认知天性</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/05/08/%E5%B5%8C%E5%85%A5%E5%BC%8F%E9%9D%A2%E8%AF%95-C%E8%AF%AD%E8%A8%80%E5%86%8D%E5%AD%A6%E4%B9%A0/" title="嵌入式面试-C语言再学习">
                        <span class="hidden-mobile">嵌入式面试-C语言再学习</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.16/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"geH90Q7ihl9Si5Llagt8GcC2-MdYXbMMI","appKey":"fO2rYFt9wStdv0SX7C7omkal","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://geh90q7i.api.lncldglobal.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-copyright"> 2019-2022 |</i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?f56279d43c733d547ea06f75f8e05d89";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
