

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="LonlyPan">
  <meta name="keywords" content="LonlyPan个人站，LonlyPan，Lonly，致简，丢了幸福的猪，逍遥勿忘心安">
  
    <meta name="description" content="系统移植篇LInux系统移植概念操作系统向下管理硬件（I&#x2F;O，设备接口），向上提供接口（进程管理+文件IO+网络协议+数据库等，被APP软件调用 bootloader（U-Boot） -&gt; Linux内核 -&gt; 根文件系统(rootfs) 。这三者一起构成了一个完整的Linux系统，一个可以正常使用、功能完善的Linux系统。 开发板上电后首先运行 SOC 内部 iROM 中">
<meta property="og:type" content="article">
<meta property="og:title" content="嵌入式Linux学习笔记-系统移植篇">
<meta property="og:url" content="http://lonlypan.com/2022/07/10/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/index.html">
<meta property="og:site_name" content="LonlyPan个人站">
<meta property="og:description" content="系统移植篇LInux系统移植概念操作系统向下管理硬件（I&#x2F;O，设备接口），向上提供接口（进程管理+文件IO+网络协议+数据库等，被APP软件调用 bootloader（U-Boot） -&gt; Linux内核 -&gt; 根文件系统(rootfs) 。这三者一起构成了一个完整的Linux系统，一个可以正常使用、功能完善的Linux系统。 开发板上电后首先运行 SOC 内部 iROM 中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/嵌入式Linux学习笔记/1654315471941.png">
<meta property="article:published_time" content="2022-07-10T14:35:00.000Z">
<meta property="article:modified_time" content="2022-07-10T14:35:00.000Z">
<meta property="article:author" content="LonlyPan">
<meta property="article:tag" content="LonlyPan个人站，LonlyPan，Lonly，致简，丢了幸福的猪，逍遥勿忘心安">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/嵌入式Linux学习笔记/1654315471941.png">
  
  
  <title>嵌入式Linux学习笔记-系统移植篇 - LonlyPan个人站</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"lonlypan.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"f56279d43c733d547ea06f75f8e05d89","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>LonlyPan的博客站</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/books/">
                <i class="iconfont icon-book"></i>
                书影
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                朋友
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="嵌入式Linux学习笔记-系统移植篇"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-10 22:35" pubdate>
          2022年7月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          56k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          469 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">嵌入式Linux学习笔记-系统移植篇</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2022年7月10日 晚上
                  
                
              </p>
            
            <div class="markdown-body">
              
              <h1 id="系统移植篇"><a href="#系统移植篇" class="headerlink" title="系统移植篇"></a>系统移植篇</h1><h2 id="LInux系统移植概念"><a href="#LInux系统移植概念" class="headerlink" title="LInux系统移植概念"></a>LInux系统移植概念</h2><p>操作系统向下管理硬件（I&#x2F;O，设备接口），向上提供接口（进程管理+文件IO+网络协议+数据库等，被APP软件调用</p>
<p>bootloader（U-Boot） -&gt; Linux内核 -&gt; 根文件系统(rootfs) 。这三者一起构成了一个完整的Linux系统，一个可以正常使用、功能完善的Linux系统。</p>
<p>开发板上电后首先运行 SOC 内部 iROM 中固化的代码（BL0），这段代码先对基本的软银见环境（时钟等）初始化，然后检测拨码开关获取启动方式，再将对应存储器（SD卡）中的Uboot搬移到内存，然后跳转到uboot运行<br>uboot开始运行后首先对开发板软硬件环境初始化，然后将 linux内核、设备树（dtb） 、根文件系统（rootfs）从外部存储器（或网络）搬移到内存，然后跳转到linux运行<br>linux开始运行，先对系统环境初始化，当系统启动完成后，linux再从内存中（或网络）挂在根文件系统</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1652410941723.png" srcset="/img/loading.gif" lazyload alt="1652410941723"></p>
<p>根据启动过程得出移植步骤：</p>
<ul>
<li>uboot移植</li>
<li>linux内核移植（包含设备树）</li>
<li>根文件系统移植</li>
</ul>
<h2 id="uboot简介"><a href="#uboot简介" class="headerlink" title="uboot简介"></a>uboot简介</h2><p>嵌入式系统上电后先执行bootloader、先初始化DDR，Flash 等外设，然后将 Linux 内核从 Flash(NAND，NOR FLASH，SD，MMC等)中读取到 DDR 中，最后启动Linux内核。</p>
<p>bootloader和Linux内核的关系就跟PC上的BIOS和Windows的关系一样，bootloader就相当于BIOS。</p>
<p>现成的bootloader软件有很多，比如U-Boot、vivi、RedBoot等等，其中以U-Boot使用最为广泛，为了方便书写，本书会将U-Boot写为uboot。</p>
<p>一般不会直接用uboot官方的U-Boot源码的。uboot官方的uboot源码是给半导体厂商准备的，半导体厂商会下载uboot官方的uboot源码，然后将自家相应的芯片移植进去。也就是说半导体厂商会自己维护一个版本的uboot，这个版本的uboot相当于是他们定制的。既然是定制的，那么肯定对自家的芯片支持会很全，虽然uboot官网的源码中一般也会支持他们的芯片，但是绝对是没有半导体厂商自己维护的uboot全面</p>
<p>NXP官方uboot下载地址：<a target="_blank" rel="noopener" href="https://source.codeaurora.org/external/imx/">https://source.codeaurora.org/external/imx/</a> </p>
<p>正点原子教程和NXP官方教程中的 linux与uboot下载链接都失效了，上面是最新的链接。这个网站是Linux基金会维护的一个开源网站。有点类似github。<br>在页面最底部找到 uboot-imx，点进去。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657549783413.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>点开Tags栏。记住下面的链接地址。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1657425111997.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>找到你想下载的版本，比如我想下载rel_imx_4.1.15_2.1.0_ga版本。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1657425180071.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>通过git clone下载（电脑需预先安装git），地址就是上面记住的链接地址，用-b指定你想下载的tag或分支。注意空格</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">git</span> clone https://source.codeaurora.org/external/imx/linux-imx -b rel_imx_4.<span class="hljs-number">1</span>.<span class="hljs-number">15</span>_2.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>_ga<br></code></pre></td></tr></table></figure>
<blockquote>
<p>uboot并不是越新越好，新版本只是添加了对新处理器得到支持，越新越冗余</p>
</blockquote>
<p>后面我们学习uboot移植的时候就是使用 uboot-imx-rel_imx_4.1.15_2.1.0_ga.tar.bz2 版本</p>
<p><strong>参考资料：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/123160029">nfs下载镜像报错File lookup fail、“TTTTTTTTTTTTTTT”</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/huohongpeng/article/details/106472024">NXP IMX6ULL老版本源码下载方法</a><h2 id="U-Boot移植"><a href="#U-Boot移植" class="headerlink" title="U-Boot移植"></a>U-Boot移植</h2></li>
</ul>
<p>uboot 移植的一般流程：</p>
<ol>
<li><p>在 uboot 中找到参考的开发平台，一般是原厂的开发板。</p>
</li>
<li><p>参考原厂开发板移植 uboot 到我们所使用的开发板</p>
<h3 id="alentek-uboot编译烧录测试"><a href="#alentek-uboot编译烧录测试" class="headerlink" title="alentek-uboot编译烧录测试"></a>alentek-uboot编译烧录测试</h3></li>
<li><p>正点原子 uboot 复制到 ubuntu的linux -&gt; uboot -&gt; alentek_uboot下，解压</p>
</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -vxjf uboot-imx-<span class="hljs-number">2016</span>.<span class="hljs-number">03</span>-<span class="hljs-number">2</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>-gee88051-v1.<span class="hljs-number">6</span>.tar.bz2<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>创建sh文件<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">vim</span> mx6ull_alientek_emmc.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>
填入内容：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/bash</span><br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- distclean<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- mx6ull_14x14_ddr512_emmc_defconfig<br>make <span class="hljs-attribute">V</span>=1 <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- -j16<br></code></pre></td></tr></table></figure>
编译：<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">chmod 777 mx6ull_alientek_emmc.<span class="hljs-keyword">sh</span> <span class="hljs-comment">//给予可执行权限</span><br>./mx6ull_alientek_emmc.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>
烧录：<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">chmod <span class="hljs-number">777</span> imxdownload <span class="hljs-regexp">//</span>给予 imxdownload 可执行权限<br>.<span class="hljs-regexp">/imxdownload u-boot.bin /</span>dev<span class="hljs-regexp">/sdd /</span><span class="hljs-regexp">/烧写到 SD 卡中，不能烧写到/</span>dev/sda 或 sda1 里面<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="NXP-uboot编译烧录测试"><a href="#NXP-uboot编译烧录测试" class="headerlink" title="NXP-uboot编译烧录测试"></a>NXP-uboot编译烧录测试</h3><p>首先在 Ubuntu 中安装 ncurses 库， 否则编译会报错，安装命令如下：<br><code>sudo apt-get install libncurses5-dev</code></p>
<ol>
<li>原版Uboot复制到ubuntu中，解压<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -jvxf uboot-imx-rel_imx_4.<span class="hljs-number">1</span>.<span class="hljs-number">15</span>_2.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>_ga.tar.bz2 <br></code></pre></td></tr></table></figure></li>
<li>创建sh文件<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">vim</span> mx6ull_14x14_emmc.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>
填入内容：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/bash</span><br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- distclean<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- mx6ull_14x14_evk_emmc_defconfig<br>make <span class="hljs-attribute">V</span>=1 <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- -j16<br></code></pre></td></tr></table></figure></li>
<li>编译：<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">chmod 777 mx6ull_14x14_emmc.<span class="hljs-keyword">sh</span> <span class="hljs-comment">//给予可执行权限</span><br>./mx6ull_14x14_emmc.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure></li>
<li>烧录：<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">chmod <span class="hljs-number">777</span> imxdownload <span class="hljs-regexp">//</span>给予 imxdownload 可执行权限<br>.<span class="hljs-regexp">/imxdownload u-boot.bin /</span>dev<span class="hljs-regexp">/sdd /</span><span class="hljs-regexp">/烧写到 SD 卡中，不能烧写到/</span>dev/sda 或 sda1 里面<br></code></pre></td></tr></table></figure></li>
</ol>
<p>运行输出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">U</span>-Boot <span class="hljs-number">2016</span>.<span class="hljs-number">03</span> (Jun <span class="hljs-number">12</span> <span class="hljs-number">2022</span> - <span class="hljs-number">10</span>:<span class="hljs-number">24</span>:<span class="hljs-number">10</span> +<span class="hljs-number">0800</span>)<br><br><span class="hljs-attribute">CPU</span>:   Freescale i.MX6ULL rev1.<span class="hljs-number">1</span> <span class="hljs-number">69</span> MHz (running at <span class="hljs-number">396</span> MHz)<br><span class="hljs-attribute">CPU</span>:   Industrial temperature grade (-<span class="hljs-number">40</span>C to <span class="hljs-number">105</span>C) at <span class="hljs-number">46</span>C<br><span class="hljs-attribute">Reset</span> cause: POR<br><span class="hljs-attribute">Board</span>: MX6ULL <span class="hljs-number">14</span>x14 EVK<br><span class="hljs-attribute">I2C</span>:   ready<br><span class="hljs-attribute">DRAM</span>:  <span class="hljs-number">512</span> MiB<br><span class="hljs-attribute">MMC</span>:   FSL_SDHC: <span class="hljs-number">0</span>, FSL_SDHC: <span class="hljs-number">1</span><br><span class="hljs-attribute">unsupported</span> panel ATK-LCD-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600<br><span class="hljs-attribute">In</span>:    serial<br><span class="hljs-attribute">Out</span>:   serial<br><span class="hljs-attribute">Err</span>:   serial<br><span class="hljs-attribute">switch</span> to partitions #<span class="hljs-number">0</span>, OK<br><span class="hljs-attribute">mmc0</span> is current device<br><span class="hljs-attribute">Net</span>:   FEC1<br><span class="hljs-attribute">Normal</span> Boot<br><span class="hljs-attribute">Hit</span> any key to stop autoboot:  <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>可以发现 CPU频率显示69MHz，如果使用 528MHz 的 I.MX6ULL，此处会显示主频为 528MHz。但是如果使用 800MHz 的 I.MX6ULL 的话此处会显示 69MHz，这个是 uboot 文件的bug，只作为输出，不影响实际运行，可以不用管。不管是528MHz还是800MHz的I.MX6ULL，此时都运行在 396MHz。</p>
<p>可以打开 arch\arm\cpu\armv7\mx6\soc.c 文件，修改这个小bug，修改后的如下：</p>
<ul>
<li>注释代码就是原来的代码，其下面的时修改后的，共两处</li>
</ul>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta">#<span class="hljs-keyword">define</span> OCOTP_CFG3_SPEED_528MHZ 1</span><br><span class="hljs-comment">//#define OCOTP_CFG3_SPEED_696MHZ 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OCOTP_CFG3_SPEED_792MHZ 2</span><br><br>u32 <span class="hljs-built_in">get_cpu_speed_grade_hz</span>(void)<br>&#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">ocotp_regs</span> *ocotp = (<span class="hljs-keyword">struct</span> <span class="hljs-type">ocotp_regs</span> *)OCOTP_BASE_ADDR;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">fuse_bank</span> *bank = &amp;ocotp-&gt;bank[<span class="hljs-number">0</span>];<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">fuse_bank0_regs</span> *fuse =<br>		(<span class="hljs-keyword">struct</span> <span class="hljs-type">fuse_bank0_regs</span> *)bank-&gt;fuse_regs;<br>	uint32_t val;<br><br>	val = <span class="hljs-built_in">readl</span>(&amp;fuse-&gt;cfg3);<br>	val &gt;&gt;= OCOTP_CFG3_SPEED_SHIFT;<br>	val &amp;= <span class="hljs-number">0x3</span>;<br><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_cpu_type</span>(MXC_CPU_MX6UL) || <span class="hljs-built_in">is_cpu_type</span>(MXC_CPU_MX6ULL)) &#123;<br>		<span class="hljs-keyword">if</span> (val == OCOTP_CFG3_SPEED_528MHZ)<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">528000000</span>;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val == OCOTP_CFG3_SPEED_792MHZ)<br>			<span class="hljs-comment">//return 69600000;</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-number">792000000</span>;<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p><strong>参考资料：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.openedv.com/forum.php?mod=viewthread&tid=315050&highlight=uboot+%EF%BF%BD%EF%BF%BD%C6%B5">修复使用 792MHz 的 I.MX6ULL，uboot显示主频为 69MHz</a></li>
</ul>
<h3 id="uboot修改移植"><a href="#uboot修改移植" class="headerlink" title="uboot修改移植"></a>uboot修改移植</h3><h4 id="1-添加开发板默认配置文件"><a href="#1-添加开发板默认配置文件" class="headerlink" title="1. 添加开发板默认配置文件"></a>1. 添加开发板默认配置文件</h4><p>前置配置，不同的配置决定了编译时会调用不同的文件（包括后面要修改的），是最高一级的配置文件。</p>
<ol>
<li>创建自定义配置文件  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> configs<br><span class="hljs-built_in">cp</span> mx6ull_14x14_evk_emmc_defconfig mx6ull_alientek_emmc_defconfig<br></code></pre></td></tr></table></figure>
修改内容<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_SYS_EXTRA_OPTIONS</span>=<span class="hljs-string">&quot;IMX_CONFIG=board/freescale/mx6ull_alientek_emmc/imximage.cfg,MX6ULL_EVK_EMMC_REWORK&quot;</span><br><span class="hljs-attr">CONFIG_ARM</span>=y<br><span class="hljs-attr">CONFIG_ARCH_MX6</span>=y<br><span class="hljs-attr">CONFIG_TARGET_MX6ULL_ALIENTEK_EMMC</span>=y<br><span class="hljs-attr">CONFIG_CMD_GPIO</span>=y<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-添加开发板对应的头文件"><a href="#2-添加开发板对应的头文件" class="headerlink" title="2. 添加开发板对应的头文件"></a>2. 添加开发板对应的头文件</h4><p>里面有很多宏定义，这些宏定义基本用于配置 uboot，也有一些<br>I.MX6ULL 的配置项目。</p>
<p>拷贝头文件</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cp <span class="hljs-keyword">include</span><span class="hljs-regexp">/configs/m</span>x6ullevk.h mx6ull_alientek_emmc.h<br></code></pre></td></tr></table></figure>
<p>将</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __MX6ULLEVK_CONFIG_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __MX6ULLEVK_CONFIG_H</span><br></code></pre></td></tr></table></figure>
<p>改为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __MX6ULL_ALIENTEK_EMMC_CONFIG_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __MX6ULL_ALIENTEK_EMMC_CONFIG_H</span><br></code></pre></td></tr></table></figure>
<p>其他内容默认</p>
<h4 id="3-添加开发板对应的板级文件夹"><a href="#3-添加开发板对应的板级文件夹" class="headerlink" title="3. 添加开发板对应的板级文件夹"></a>3. 添加开发板对应的板级文件夹</h4><p>uboot 中每个板子都有一个对应的文件夹来存放板级文件，比如开发板上外设驱动文件等<br>等。</p>
<p>复制 mx6ullevk文件夹，将其重命名为 mx6ull_alientek_emmc，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> board/freescale/<br><span class="hljs-built_in">cp</span> mx6ullevk/ -r mx6ull_alientek_emmc<br></code></pre></td></tr></table></figure>
<p>进 入mx6ull_alientek_emmc目 录 中 ， 将 其 中 的mx6ullevk.c文 件 重 命 名 为mx6ull_alientek_emmc.c，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> mx6ull_alientek_emmc<br><span class="hljs-built_in">mv</span> mx6ullevk.c mx6ull_alientek_emmc.c<br></code></pre></td></tr></table></figure>

<p>1). 修改 mx6ull_alientek_emmc 目录下的 Makefile 文件</p>
<ul>
<li>重点是第 6 行的 obj-y，改为 mx6ull_alientek_emmc.o，这样才会编译 mx6ull_alientek_emmc.c<br>这个文件。<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment"># (C) Copyright 2015 Freescale Semiconductor, Inc.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># SPDX-License-Identifier:	GPL-2.0+</span><br><span class="hljs-comment">#</span><br><br>obj-y  := mx6ull_alientek_emmc.o<br><br>extra-<span class="hljs-variable">$(</span>CONFIG_USE_PLUGIN) :=  plugin.bin<br><span class="hljs-variable">$(</span>obj)/plugin.<span class="hljs-symbol">bin:</span> <span class="hljs-variable">$(</span>obj)/plugin.o<br>	<span class="hljs-variable">$(</span>OBJCOPY) -O binary --gap-fill <span class="hljs-number">0xff</span> <span class="hljs-variable">$&lt;</span> <span class="hljs-variable">$@</span><br></code></pre></td></tr></table></figure>
2). 修改 mx6ull_alientek_emmc 目录下的 imximage.cfg 文件<br>将 imximage.cfg 中的下面一句：<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">PLUGIN board<span class="hljs-regexp">/freescale/m</span>x6ullevk/plugin.bin <span class="hljs-number">0</span>x00907000<br></code></pre></td></tr></table></figure>
改为：<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">PLUGIN board<span class="hljs-regexp">/freescale/m</span>x6ull_alientek_emmc /plugin.bin <span class="hljs-number">0</span>x00907000<br></code></pre></td></tr></table></figure>
3). 修改 mx6ull_alientek_emmc 目录下的 Kconfig 文件<br>修改 Kconfig 文件，修改后的内容如下：<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">if</span> TARGET_MX6ULL_ALIENTEK_EMMC<br><br>config SYS_BOARD<br>	<span class="hljs-keyword">default</span> <span class="hljs-string">&quot;mx6ull_alientek_emmc&quot;</span><br><br>config SYS_VENDOR<br>	<span class="hljs-keyword">default</span> <span class="hljs-string">&quot;freescale&quot;</span><br><br>config SYS_SOC<br>	<span class="hljs-keyword">default</span> <span class="hljs-string">&quot;mx6&quot;</span><br><br>config SYS_CONFIG_NAME<br>	<span class="hljs-keyword">default</span> <span class="hljs-string">&quot;mx6ull_alientek_emmc&quot;</span><br><br>endif<br></code></pre></td></tr></table></figure>
4). 修改 mx6ull_alientek_emmc 目录下的 MAINTAINERS 文件<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts">MX6ULL_ALIENTEK_EMMC BOARD<br><span class="hljs-symbol">M:</span>	Peng Fan <span class="hljs-params">&lt;peng.fan@nxp.com&gt;</span><br><span class="hljs-symbol">S:</span>	Maintained<br><span class="hljs-symbol">F:</span>	board<span class="hljs-keyword">/freescale/</span>mx6ull_alientek_emmc/<br><span class="hljs-symbol">F:</span>	include<span class="hljs-keyword">/configs/</span>mx6ull_alientek_emmc.h<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="4-修改-U-Boot-图形界面配置文件"><a href="#4-修改-U-Boot-图形界面配置文件" class="headerlink" title="4. 修改 U-Boot 图形界面配置文件"></a>4. 修改 U-Boot 图形界面配置文件</h4><p>uboot 是支持图形界面配置，关于 uboot 的图形界面配置下一章会详细的讲解。修改文件<br>arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;mx6&#x2F;Kconfig(如果用的 I.MX6UL 的话，应该修改 arch&#x2F;arm&#x2F;Kconfig 这个文<br>件)，在 207 行加入如下内容：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp">config TARGET_MX6ULL_ALIENTEK_EMMC<br>	<span class="hljs-built_in">bool</span> <span class="hljs-string">&quot;Support mx6ull_alientek_emmc&quot;</span><br>	<span class="hljs-keyword">select</span> MX6ULL<br>	<span class="hljs-keyword">select</span> DM<br>	<span class="hljs-keyword">select</span> DM_THERMAL<br></code></pre></td></tr></table></figure>
<p>在最后一行的 endif 的前一行添加如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> <span class="hljs-string">&quot;board/freescale/mx6ull_alientek_emmc/Kconfig&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="5-编译新-uboot"><a href="#5-编译新-uboot" class="headerlink" title="5. 编译新 uboot"></a>5. 编译新 uboot</h4><p>在 uboot 根目录下新建一个名为 mx6ull_alientek_emmc.sh 的 shell 脚本，在这个 shell 脚本<br>里面输入如下内容：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/bash</span><br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- distclean<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- mx6ull_alientek_emmc_defconfig<br>make <span class="hljs-attribute">V</span>=1 <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- -j16<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">chmod <span class="hljs-number">777</span> mx6ull_alientek_emmc.sh<br><span class="hljs-regexp">//</span>给予可执行权限，一次即可<br>./mx6ull_alientek_emmc.sh<br><span class="hljs-regexp">//</span>运行脚本编译 uboot<br></code></pre></td></tr></table></figure>
<p>等待编译完成 ， 编译完成后输入如下命令 ， 查看一下添加的mx6ull_alientek_emmc.h 这个头文件有没有被引用。<br>如果有很多文件都引用了 mx6ull_alientek_emmc.h 这个头文件，那就说明新板子添加成功，如图所示：<br><code>grep -nR &quot;mx6ull_alientek_emmc.h&quot;</code><br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1655001869905.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h4 id="6-LCD驱动修改"><a href="#6-LCD驱动修改" class="headerlink" title="6. LCD驱动修改"></a>6. LCD驱动修改</h4><p>一般 uboot 中修改驱动基本都是在 xxx.h 和 xxx.c 这两个文件中进行的，xxx 为板子名称，<br>比如 mx6ull_alientek_emmc.h 和 mx6ull_alientek_emmc.c 这两个文件。<br>一般修改 LCD 驱动重点注意以下几点：<br>①、LCD 所使用的 GPIO，查看 uboot 中 LCD 的 IO 配置是否正确。<br>②、LCD 背光引脚 GPIO 的配置。<br>③、LCD 配置参数是否正确。<br>正点原子的 I.MX6U-ALPHA 开发板 LCD 原理图和 NXP 官方 I.MX6ULL 开发板一致，所以 IO 部分就不用修改了。需要修改的之后 LCD 参数，<br>打开文件 mx6ull_alientek_emmc.c，找到如下所示内容：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">struct display_info_t const displays[] = </span><span class="hljs-template-variable">&#123;&#123;</span><br><span class="hljs-template-variable">	<span class="hljs-name">.bus</span> = MX6UL_LCDIF1_BASE_ADDR,</span><br><span class="hljs-template-variable">	.addr = <span class="hljs-number">0</span>,</span><br><span class="hljs-template-variable">	.pixfmt = <span class="hljs-number">24</span>,</span><br><span class="hljs-template-variable">	.detect = <span class="hljs-literal">NULL</span>,</span><br><span class="hljs-template-variable">	.enable	= do_enable_parallel_lcd,</span><br><span class="hljs-template-variable">	.mode	= &#123;</span><br><span class="hljs-template-variable">		.name			= <span class="hljs-string">&quot;TFT7016&quot;</span>,</span><br><span class="hljs-template-variable">		.xres           = <span class="hljs-number">1024</span>,</span><br><span class="hljs-template-variable">		.yres           = <span class="hljs-number">600</span>,</span><br><span class="hljs-template-variable">		.pixclock       = <span class="hljs-number">19531</span>,</span><br><span class="hljs-template-variable">		.left_margin    = <span class="hljs-number">140</span>,</span><br><span class="hljs-template-variable">		.right_margin   = <span class="hljs-number">160</span>,</span><br><span class="hljs-template-variable">		.upper_margin   = <span class="hljs-number">20</span>,</span><br><span class="hljs-template-variable">		.lower_margin   = <span class="hljs-number">12</span>,</span><br><span class="hljs-template-variable">		.hsync_len      = <span class="hljs-number">20</span>,</span><br><span class="hljs-template-variable">		.vsync_len      = <span class="hljs-number">3</span>,</span><br><span class="hljs-template-variable">		.sync           = <span class="hljs-number">0</span>,</span><br><span class="hljs-template-variable">		.vmode          = FB_VMODE_NONINTERLACED</span><br><span class="hljs-template-variable">&#125; &#125; &#125;;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>pixfmt 是像素格式，也就是一个像素点是多少位，如果是 RGB565 的话就是 16 位，如果是 888 的话就是 24 位，一般使用 RGB888。</li>
<li>name：LCD 名字，要和环境变量中的 panel 相等。</li>
<li>xres、yres：LCD X 轴和 Y 轴像素数量。</li>
<li>pixclock：像素时钟，每个像素时钟周期的长度，单位为皮秒。<ul>
<li>以正点原子的 7 寸 1024*600 分辨率的屏幕(ATK7016)为例，屏幕要求的像素时钟为 51.2MHz，因此：pixclock&#x3D;(1&#x2F;51200000)*10^12&#x3D;19531</li>
</ul>
</li>
<li>left_margin：HBP，水平同步后肩。</li>
<li>right_margin：HFP，水平同步前肩。</li>
<li>upper_margin：VBP，垂直同步后肩。</li>
<li>lower_margin：VFP，垂直同步前肩。</li>
<li>hsync_len：HSPW，行同步脉宽。</li>
<li>vsync_len：VSPW，垂直同步脉宽。</li>
<li>vmode：大多数使用 FB_VMODE_NONINTERLACED，也就是不使用隔行扫描。</li>
</ul>
<p>以上参数都可以从lCD的规格书中获取。</p>
<p>打开 mx6ull_alientek_emmc.h，找到所有如下语句：<br><code>panel=TFT43AB</code><br>将其改为：<br><code>panel=TFT7016</code></p>
<p>也就是设置 panel 为 TFT7016，panel 的值要与示例代码中的.name 成员变量的值一致。修改完成以后重新编译一遍 uboot 并烧写到 SD 中启动。重启以后 LCD 驱动一般就会工作正常了，LCD 上回显示 NXP 的 logo。</p>
<p>但是有可能会遇到LCD 并没有工作，还是黑屏，这是什么原因呢？在 uboot 命令模式输入“print”来查看环境变<br>量 panel 的值，会发现 panel 的值要是 TFT43AB(或其他的，反正不是 TFT7016)，这是因为之前有将环境变量保存到 EMMC 中，uboot 启动以后会先从 EMMC 中读取环境变量，如果 EMMC 中没有环境变量的话才会使用 mx6ull_alientek_emmc.h 中的默认环境变量。如果 EMMC 中的环境变量 panel 不等于 TFT7016，那么 LCD 显示肯定不正常.。<br>在uboot 中修改 panel 的值为 TFT7016 即可，在 uboot 的命令模式下输入如下命令：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> panel TFT7016<br><span class="hljs-attribute">saveenv</span><br></code></pre></td></tr></table></figure>
<h4 id="7-网络驱动修改"><a href="#7-网络驱动修改" class="headerlink" title="7. 网络驱动修改"></a>7. 网络驱动修改</h4><ol>
<li>网络 PHY 地址修改<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">331</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_ENET_DEV  1</span><br><span class="hljs-number">332</span><br><span class="hljs-number">333</span> <span class="hljs-meta">#<span class="hljs-keyword">if</span> (CONFIG_FEC_ENET_DEV == 0)</span><br><span class="hljs-number">334</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> IMX_FEC_BASE</span><br>ENET_BASE_ADDR<br><span class="hljs-number">335</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_MXC_PHYADDR 0x2</span><br><span class="hljs-number">336</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_XCV_TYPE RMII</span><br><span class="hljs-number">337</span> <span class="hljs-meta">#<span class="hljs-keyword">elif</span> (CONFIG_FEC_ENET_DEV == 1)</span><br><span class="hljs-number">338</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> IMX_FEC_BASE</span><br>ENET2_BASE_ADDR<br><span class="hljs-number">339</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_MXC_PHYADDR 0x1</span><br><span class="hljs-number">340</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_XCV_TYPE  RMII</span><br><span class="hljs-number">341</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">342</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_ETHPRIME   <span class="hljs-string">&quot;FEC&quot;</span></span><br><span class="hljs-number">343</span><br><span class="hljs-number">344</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_PHYLIB</span><br><span class="hljs-number">345</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_PHY_MICREL</span><br><span class="hljs-number">346</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
第 331 行的宏 CONFIG_FEC_ENET_DEV 用于选择使用哪个网口，默认为 1，也就是选择ENET2。第 335 行为 ENET1 的 PHY 地址，默认是 0X2，第 339 行为 ENET2 的 PHY 地址，默认为 0x1。正点原子的 I.MX6U-ALPHA 开发板 ENET1 的 PHY 地址为0X0，ENET2 的 PHY 地址为 0X1，所以需要将第 335 行的宏 CONFIG_FEC_MXC_PHYADDR改为 0x0。</li>
</ol>
<p>第 345 行定了一个宏 CONFIG_PHY_MICREL，此宏用于使能 uboot 中 Micrel 公司的 PHY驱动，KSZ8081 这颗 PHY 芯片就是 Micrel 公司生产的，不过 Micrel 已经被 Microchip 收购了。如果要使用 LAN8720A，那么就得将CONFIG_PHY_MICREL 改为 CONFIG_PHY_SMSC，也就是使能 uboot 中的 SMSC 公司中的 PHY 驱动，因为 LAN8720A 就是 SMSC 公司生产的。所<br>以示例代码 33.2.7.1 有三处要修改：<br>①、修改 ENET1 网络 PHY 的地址。<br>②、修改 ENET2 网络 PHY 的地址。<br>③、使能 SMSC 公司的 PHY 驱动。<br>修改后的网络 PHY 地址参数如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_ENET_DEV		1</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> (CONFIG_FEC_ENET_DEV == 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMX_FEC_BASE			ENET_BASE_ADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_MXC_PHYADDR          0x0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_XCV_TYPE             RMII</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> (CONFIG_FEC_ENET_DEV == 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMX_FEC_BASE			ENET2_BASE_ADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_MXC_PHYADDR		0x1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_FEC_XCV_TYPE		RMII</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_ETHPRIME			<span class="hljs-string">&quot;FEC&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_PHYLIB</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_PHY_SMSC</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<ol start="2">
<li>删除 uboot 中 74LV595 的驱动代码<br>uboot 中网络 PHY 芯片地址修改完成以后就是网络复位引脚的驱动修改了，打开mx6ull_alientek_emmc.c，找到如下代码：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOX_SDI IMX_GPIO_NR(5, 10)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOX_STCP IMX_GPIO_NR(5, 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOX_SHCP IMX_GPIO_NR(5, 11)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOX_OE  IMX_GPIO_NR(5, 8)</span><br></code></pre></td></tr></table></figure>
以 IOX 开头的宏定义是 74LV595 的相关 GPIO，因为 NXP 官方I.MX6ULL EVK 开发板使用 74LV595 来扩展 IO，两个网络的复位引脚就是由 74LV595 来控制的。正点原子的 I.MX6U-ALPHA 开发板并没有使用 74LV595，因此我们将代码删除掉，替换为如下所示代码：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENET1_RESET IMX_GPIO_NR(5, 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENET2_RESET IMX_GPIO_NR(5, 8)</span><br></code></pre></td></tr></table></figure>
ENET1 的复位引脚连接到 SNVS_TAMPER7 上，对应 GPIO5_IO07，ENET2 的复位引脚连接到 SNVS_TAMPER8 上，对应 GPIO5_IO08。继续在 mx6ull_alientek_emmc.c 中找到如下代码：</li>
</ol>
<ul>
<li>代码是 74LV595 的 IO 配置参数结构体，将其删除掉。<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">static iomux_v3_cfg_t const iox_pads[] = &#123;<br>	<span class="hljs-regexp">/* IOX_SDI */</span><br>	MX6_PAD_BOOT_MODE0__GPIO5_IO10 | MUX_PAD_CTRL(NO_PAD_CTRL),<br>	<span class="hljs-regexp">/* IOX_SHCP */</span><br>	MX6_PAD_BOOT_MODE1__GPIO5_IO11 | MUX_PAD_CTRL(NO_PAD_CTRL),<br>	<span class="hljs-regexp">/* IOX_STCP */</span><br>	MX6_PAD_SNVS_TAMPER7__GPIO5_IO07 | MUX_PAD_CTRL(NO_PAD_CTRL),<br>	<span class="hljs-regexp">/* IOX_nOE */</span><br>	MX6_PAD_SNVS_TAMPER8__GPIO5_IO08 | MUX_PAD_CTRL(NO_PAD_CTRL),<br>&#125;;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>示例继续在mx6ull_alientek_emmc.c 中找到函数 iox74lv_init 函数是 74LV595 的初始化函数，iox74lv_set 函数用于控制 74LV595 的 IO 输出电平，将这两个函数全部删除掉！</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs scss">static void <span class="hljs-built_in">iox74lv_init</span>(void)<br>&#123;<br>	int <span class="hljs-selector-tag">i</span>;<br>	<span class="hljs-built_in">gpio_direction_output</span>(IOX_OE, <span class="hljs-number">0</span>);<br>	......<br>	<span class="hljs-built_in">gpio_direction_output</span>(IOX_STCP, <span class="hljs-number">1</span>);<br>&#125;;<br><br>void <span class="hljs-built_in">iox74lv_set</span>(int index)<br>&#123;<br>	int <span class="hljs-selector-tag">i</span>;<br>	......<br>	<span class="hljs-built_in">gpio_direction_output</span>(IOX_STCP, <span class="hljs-number">1</span>);<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在 mx6ull_alientek_emmc.c 中找到 board_init 函数，此函数是板子初始化函数，会被 board_init_r 调用，board_init 函数内容如下：</p>
<ul>
<li>board_init 会调用 imx_iomux_v3_setup_multiple_pads 和 iox74lv_init 这两个函数来初始化 74lv595 的 GPIO，将这两行删除掉。至此，mx6ull_alientek_emmc.c 中关于 74LV595 芯片的驱动代码都删除掉了，接下来就是添加 I.MX6U-ALPHA 开发板两个网络复位引脚了。<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> board<span class="hljs-constructor">_init(<span class="hljs-params">void</span>)</span><br>&#123;<br>	......<br>	imx<span class="hljs-constructor">_iomux_v3_setup_multiple_pads(<span class="hljs-params">iox_pads</span>, ARRAY_SIZE(<span class="hljs-params">iox_pads</span>)</span>);<br>	iox74lv<span class="hljs-constructor">_init()</span>;<br>	......<br>	return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>添加 I.MX6U-ALPHA 开发板网络复位引脚驱动<br>在 mx6ull_alientek_emmc.c 中找到如下所示代码并修改如下：</li>
</ol>
<ul>
<li>添加了 651和667 两行代码，分别是 ENET1 和 ENET2 的复位 IO 配置参数。<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">640</span> static iomux_v3_cfg_t const fec1_pads[] = &#123;<br><span class="hljs-number">641</span> 	MX6_PAD_GPIO1_IO06__ENET1_MDIO <span class="hljs-string">| MUX_PAD_CTRL(MDIO_PAD_CTRL),</span><br><span class="hljs-number">642</span> 	MX6_PAD_GPIO1_IO07__ENET1_MDC <span class="hljs-string">| MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br>......<br><span class="hljs-number">649</span> 	MX6_PAD_ENET1_RX_ER__ENET1_RX_ER <span class="hljs-string">| MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="hljs-number">650</span> 	MX6_PAD_ENET1_RX_EN__ENET1_RX_EN <span class="hljs-string">| MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="hljs-number">651</span>		MX6_PAD_SNVS_TAMPER7__GPIO5_IO07 <span class="hljs-string">| MUX_PAD_CTRL(NO_PAD_CTRL),</span><br><span class="hljs-number">652</span> &#125;;<br><span class="hljs-number">653</span><br><span class="hljs-number">654</span> static iomux_v3_cfg_t const fec2_pads[] = &#123;<br><span class="hljs-number">655</span> 	MX6_PAD_GPIO1_IO06__ENET2_MDIO <span class="hljs-string">| MUX_PAD_CTRL(MDIO_PAD_CTRL),</span><br><span class="hljs-number">656</span> 	MX6_PAD_GPIO1_IO07__ENET2_MDC <span class="hljs-string">| MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br>......<br><span class="hljs-number">665</span> 	MX6_PAD_ENET2_RX_EN__ENET2_RX_EN <span class="hljs-string">| MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="hljs-number">666</span> 	MX6_PAD_ENET2_RX_ER__ENET2_RX_ER <span class="hljs-string">| MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="hljs-number">667</span> 	MX6_PAD_SNVS_TAMPER8__GPIO5_IO08 <span class="hljs-string">| MUX_PAD_CTRL(NO_PAD_CTRL),</span><br><span class="hljs-number">668</span> &#125;;<br></code></pre></td></tr></table></figure>
继续在文件 mx6ull_alientek_emmc.c 中找到函数 setup_iomux_fec，函数 setup_iomux_fec 就是根据 fec1_pads 和 fec2_pads 这两个网络 IO 配置数组来初始化I.MX6ULL 的网络 IO。我们需要在其中添加网络复位 IO 的初始化代码，并且复位一下 PHY 芯片，修改后的 setup_iomux_fec 函数如下</li>
<li>第 676 行<del>679 行和第 685 行</del>688 行分别对应 ENET1 和 ENET2 的复位 IO 初始化，将这两个 IO 设置为输出并且硬件复位一下 LAN8720A，这个硬件复位很重要！否则可能导致 uboot 无法识别 LAN8720A。<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">668 </span>static void setup_iomux_fec(<span class="hljs-keyword">int</span> fec_id)<br><span class="hljs-symbol">669 </span>&#123;<br><span class="hljs-symbol">670 </span>	<span class="hljs-keyword">if</span> (fec_id == <span class="hljs-number">0</span>)<br><span class="hljs-symbol">671 </span>	&#123;<br><span class="hljs-number">672</span><br><span class="hljs-symbol">673 </span>		imx_iomux_v3_setup_multiple_pads(fec1_pads,<br><span class="hljs-symbol">674 </span>				ARRAY_SIZE(fec1_pads));<br><span class="hljs-number">675</span><br><span class="hljs-symbol">676 </span>		gpio_direction_output(ENET1_RESET, <span class="hljs-number">1</span>);<br><span class="hljs-symbol">677 </span>		gpio_set_value(ENET1_RESET, <span class="hljs-number">0</span>);<br><span class="hljs-symbol">678 </span>		mdelay(<span class="hljs-number">20</span>);<br><span class="hljs-symbol">679 </span>		gpio_set_value(ENET1_RESET, <span class="hljs-number">1</span>);<br><span class="hljs-symbol">680 </span>	&#125;<br><span class="hljs-symbol">681 </span>	<span class="hljs-keyword">else</span><br><span class="hljs-symbol">682 </span>	&#123;<br><span class="hljs-symbol">683 </span>		imx_iomux_v3_setup_multiple_pads(fec2_pads,<br><span class="hljs-symbol">684 </span>		ARRAY_SIZE(fec2_pads));<br><span class="hljs-symbol">685 </span>		gpio_direction_output(ENET2_RESET, <span class="hljs-number">1</span>);<br><span class="hljs-symbol">686 </span>		gpio_set_value(ENET2_RESET, <span class="hljs-number">0</span>);<br><span class="hljs-symbol">687 </span>		mdelay(<span class="hljs-number">20</span>);<br><span class="hljs-symbol">688 </span>		gpio_set_value(ENET2_RESET, <span class="hljs-number">1</span>);<br><span class="hljs-symbol">689 </span>	&#125;<br><span class="hljs-symbol">690 </span>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>修改 drivers&#x2F;net&#x2F;phy&#x2F;phy.c 文件中的函数 genphy_update_link<br>uboot 中的 LAN8720A 驱动有点问题，打开文件drivers&#x2F;net&#x2F;phy&#x2F;phy.c，找到函数 genphy_update_link，这是个通用 PHY 驱动函数，此函数用于更新 PHY 的连接状态和速度。使用 LAN8720A 的时候需要在此函数中添加一些代码，修改后的<br>函数 genphy_update_link 如下所示：<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">221</span> <span class="hljs-built_in">int</span> genphy<span class="hljs-constructor">_update_link(<span class="hljs-params">struct</span> <span class="hljs-params">phy_device</span> <span class="hljs-operator">*</span><span class="hljs-params">phydev</span>)</span><br><span class="hljs-number">222</span> &#123;<br><span class="hljs-number">223</span> 	unsigned <span class="hljs-built_in">int</span> mii_reg;<br><span class="hljs-number">224</span><br><span class="hljs-number">225</span> 	#ifdef CONFIG_PHY_SMSC<br><span class="hljs-number">226</span> 		static <span class="hljs-built_in">int</span> lan8720_flag = <span class="hljs-number">0</span>;<br><span class="hljs-number">227</span> 		<span class="hljs-built_in">int</span> bmcr_reg = <span class="hljs-number">0</span>;<br><span class="hljs-number">228</span> 		<span class="hljs-keyword">if</span> (lan8720_flag<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">229</span> 			bmcr_reg = phy<span class="hljs-constructor">_read(<span class="hljs-params">phydev</span>, MDIO_DEVAD_NONE, MII_BMCR)</span>;<br><span class="hljs-number">230</span> 			phy<span class="hljs-constructor">_write(<span class="hljs-params">phydev</span>, MDIO_DEVAD_NONE, MII_BMCR, BMCR_RESET)</span>;<br><span class="hljs-number">231</span> 			<span class="hljs-keyword">while</span>(phy<span class="hljs-constructor">_read(<span class="hljs-params">phydev</span>, MDIO_DEVAD_NONE, MII_BMCR)</span> &amp; <span class="hljs-number">0X8000</span>) &#123;<br><span class="hljs-number">232</span> 				udelay(<span class="hljs-number">100</span>);<br><span class="hljs-number">233</span> 			&#125;<br><span class="hljs-number">234</span> 			phy<span class="hljs-constructor">_write(<span class="hljs-params">phydev</span>, MDIO_DEVAD_NONE, MII_BMCR, <span class="hljs-params">bmcr_reg</span>)</span>;<br><span class="hljs-number">235</span> 			lan8720_flag = <span class="hljs-number">1</span>;<br><span class="hljs-number">236</span> 		&#125;<br><span class="hljs-number">237</span> 	#endif<br><span class="hljs-number">238</span><br><span class="hljs-number">239</span> 	<span class="hljs-comment">/*</span><br><span class="hljs-comment">240 	* Wait if the link is up, and autonegotiation is in progress</span><br><span class="hljs-comment">241 	* (ie - we&#x27;re capable and it&#x27;s not done)</span><br><span class="hljs-comment">242 	*/</span><br><span class="hljs-number">243</span> 	mii_reg = phy<span class="hljs-constructor">_read(<span class="hljs-params">phydev</span>, MDIO_DEVAD_NONE, MII_BMSR)</span>;<br>......<br><span class="hljs-number">291</span><br><span class="hljs-number">292</span> 	return <span class="hljs-number">0</span>;<br><span class="hljs-number">293</span> &#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>225 行<del>237 行就是新添加的代码，为条件编译代码段，只有使用 SMSC 公司的 PHY 这段代码才会执行(目前只测试了 LAN8720A，SMSC 公司其他的芯片还未测试)。第 229 行读取LAN8720A 的 BMCR 寄存器(寄存器地址为 0)，此寄存器为 LAN8720A 的配置寄存器，这里先读取此寄存器的默认值并保存起来。230 行向寄存器 BMCR 寄存器写入 BMCR_RESET(值为0X8000)，因为 BMCR 的 bit15 是软件复位控制位，因此 230 行就是软件复位 LAN8720A，复位<br>完成以后此位会自动清零。第 231</del>233 行等待 LAN8720A 软件复位完成，也就是判断 BMCR的 bit15 位是否为 1，为 1 的话表示还没有复位完成。第 234 行重新向 BMCR 寄存器写入以前的值，也就是 229 行读出的那个值。</p>
<p>至此网络的复位引脚驱动修改完成，重新编译 uboot，然后将 u-boot.bin 烧写到 SD 卡中并启动，uboot 启动信息所示：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">U</span>-Boot <span class="hljs-number">2016</span>.<span class="hljs-number">03</span> (Jun <span class="hljs-number">12</span> <span class="hljs-number">2022</span> - <span class="hljs-number">10</span>:<span class="hljs-number">24</span>:<span class="hljs-number">10</span> +<span class="hljs-number">0800</span>)<br><br><span class="hljs-attribute">CPU</span>:   Freescale i.MX6ULL rev1.<span class="hljs-number">1</span> <span class="hljs-number">69</span> MHz (running at <span class="hljs-number">396</span> MHz)<br><span class="hljs-attribute">CPU</span>:   Industrial temperature grade (-<span class="hljs-number">40</span>C to <span class="hljs-number">105</span>C) at <span class="hljs-number">48</span>C<br><span class="hljs-attribute">Reset</span> cause: POR<br><span class="hljs-attribute">Board</span>: MX6ULL <span class="hljs-number">14</span>x14 EVK<br><span class="hljs-attribute">I2C</span>:   ready<br><span class="hljs-attribute">DRAM</span>:  <span class="hljs-number">512</span> MiB<br><span class="hljs-attribute">MMC</span>:   FSL_SDHC: <span class="hljs-number">0</span>, FSL_SDHC: <span class="hljs-number">1</span><br><span class="hljs-attribute">unsupported</span> panel ATK-LCD-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600<br><span class="hljs-attribute">In</span>:    serial<br><span class="hljs-attribute">Out</span>:   serial<br><span class="hljs-attribute">Err</span>:   serial<br><span class="hljs-attribute">switch</span> to partitions #<span class="hljs-number">0</span>, OK<br><span class="hljs-attribute">mmc0</span> is current device<br><span class="hljs-attribute">Net</span>:   FEC1<br><span class="hljs-attribute">Normal</span> Boot<br><span class="hljs-attribute">Hit</span> any key to stop autoboot:  <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>从图 33.2.6.4 中可以看到“Net： FEC1”这一行，提示当前使用的 FEC1 这个网口，也就是 ENET2。在 uboot 中使用网络之前要先设置几个环境变量，命令如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> ipaddr <span class="hljs-number">192.168.1.55</span>          //开发板 IP 地址<br><span class="hljs-attribute">setenv</span> ethaddr b8:ae:<span class="hljs-number">1</span>d:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    //开发板网卡 MAC 地址<br><span class="hljs-attribute">setenv</span> gatewayip <span class="hljs-number">192.168.1.1</span>	    //开发板默认网关<br><span class="hljs-attribute">setenv</span> netmask <span class="hljs-number">255.255.255.0</span>	    //开发板子网掩码<br><span class="hljs-attribute">setenv</span> serverip <span class="hljs-number">192.168.1.250</span>	    //服务器地址，也就是 Ubuntu 地址<br><span class="hljs-attribute">saveenv</span>	                            //保存环境变量<br></code></pre></td></tr></table></figure>
<p>设置好环境变量以后就可以在 uboot 中使用网络了，用网线将 I.MX6U-ALPHA 上的 ENET2与电脑或者路由器连接起来，保证开发板和电脑在同一个网段内，通过 ping 命令来测试一下网络连(与ubuntu主机))，命令如下：<br>ping 192.168.1.250</p>
<p>如果主机一直ping不通，请尝试关闭ubuntu，退出虚拟机（包括后台），然后重新打开虚拟机和ubuntu，再尝试使用开发板ping主机网络。</p>
<blockquote>
<p>ps：一次使用时，重启了路由器，PC电脑无线网络重连（我的开发板和PC都连接到路由器）。然后开发板ping网络不同，重启ubuntu也不行，在ubuntu打开浏览器也没有网络，于是退出虚拟机，重开。后一切正常。</p>
</blockquote>
<p>如果ping或dhcp后系统不断重启（如下所示），那是因为交叉编译链版本太高，不兼容，请参考 <strong>开发环境搭建</strong> 章节，重新安装旧版的编译环境。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs ada"><br>=&gt; ping <span class="hljs-number">192.168</span>.<span class="hljs-number">0.198</span><br>FEC1 Waiting <span class="hljs-keyword">for</span> PHY auto negotiation to complete... done<br>Using FEC1 device<br>data <span class="hljs-keyword">abort</span><br>pc : [&lt;9<span class="hljs-type">ff83ad0</span>&gt;]          lr : [&lt;9<span class="hljs-type">ff84d98</span>&gt;]<br>reloc pc : [&lt;8783<span class="hljs-type">bad0</span>&gt;]    lr : [&lt;8783<span class="hljs-type">cd98</span>&gt;]<br>sp : 9<span class="hljs-type">ef45d08</span>  ip : 00000000     <span class="hljs-type">fp</span> : 9<span class="hljs-type">ff53520</span><br>r10: <span class="hljs-number">00000002</span>  r9 : 9<span class="hljs-type">ef45eb8</span>     r8 : 00000000<br>r7 : 00000001  <span class="hljs-type">r6</span> : 00000000     <span class="hljs-type">r5</span> : 0000002<span class="hljs-type">a</span>  r4 : 9<span class="hljs-type">ffed0ce</span><br>r3 : 14000045  <span class="hljs-type">r2</span> : <span class="hljs-type">bc00a8c0</span>     r1 : 9<span class="hljs-type">ef45d10</span>  r0 : 9<span class="hljs-type">ffed0ce</span><br>Flags: nZCv  IRQs off  FIQs off  Mode SVC_32<br>Resetting CPU ...<br><br>resetting ...<br><br><br>=&gt; dhcp<br>FEC1 Waiting <span class="hljs-keyword">for</span> PHY auto negotiation to complete... done<br>BOOTP broadcast <span class="hljs-number">1</span><br>data <span class="hljs-keyword">abort</span><br>pc : [&lt;9<span class="hljs-type">ff821e0</span>&gt;]          lr : [&lt;9<span class="hljs-type">ff839e4</span>&gt;]<br>reloc pc : [&lt;8783<span class="hljs-type">a1e0</span>&gt;]    lr : [&lt;8783<span class="hljs-type">b9e4</span>&gt;]<br>sp : 9<span class="hljs-type">ef45cc0</span>  ip : 00000000     <span class="hljs-type">fp</span> : 9<span class="hljs-type">ff534c8</span><br>r10: <span class="hljs-number">00000001</span>  r9 : 9<span class="hljs-type">ef45eb8</span>     r8 : 9<span class="hljs-type">ffecbe8</span><br>r7 : 0000000<span class="hljs-type">e</span>  r6 : 9<span class="hljs-type">ffeef30</span>     r5 : 00000000  <span class="hljs-type">r4</span> : 9<span class="hljs-type">ffed0ce</span><br>r3 : 00060101  <span class="hljs-type">r2</span> : 00000008     <span class="hljs-type">r1</span> : 9<span class="hljs-type">ffed0a2</span>  r0 : 0000000<span class="hljs-type">e</span><br>Flags: nZCv  IRQs off  FIQs off  Mode SVC_32<br>Resetting CPU ...<br><br>resetting ...<br><br></code></pre></td></tr></table></figure>

<h4 id="8-开发板名称修改"><a href="#8-开发板名称修改" class="headerlink" title="8. 开发板名称修改"></a>8. 开发板名称修改</h4><p>在 uboot 启动信息中会有“Board: MX6ULL 14x14 EVK”这一句，也就是说板子名字为“MX6ULL 14x14 EVK”，要将其改为我们所使用的板子名字，比如“MX6ULL ALIENTEK EMMC”或者“MX6ULL ALIENTEK NAND”。打开文件 mx6ull_alientek_emmc.c，找到函数<br>checkboard，将其改为如下所示内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">checkboard</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_mx6ull_9x9_evk</span>())<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Board: MX6ULL 9x9 EVK\n&quot;</span>);<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Board: MX6ULL ALIENTEK EMMC\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>至此 uboot 的驱动部分就修改完成了，uboot 移植也完成了</p>
<h4 id="9-uboot-启动linux测试"><a href="#9-uboot-启动linux测试" class="headerlink" title="9. uboot 启动linux测试"></a>9. uboot 启动linux测试</h4><p>uboot 的最终目的就是启动 Linux 内核，所以需要通过启动 Linux 内核来判断 uboot 移植是否成功。</p>
<blockquote>
<p>uboot在linux启动后，就失效了，但会传递一些信息给linux<br>所以uboot中的设备驱动是不能在linux中使用的，所以linux中也要有上面移植时的那些设备驱动，这在后面linux驱动开发再讲解。</p>
</blockquote>
<h5 id="从-EMMC-启动-Linux-系统"><a href="#从-EMMC-启动-Linux-系统" class="headerlink" title="从 EMMC 启动 Linux 系统"></a>从 EMMC 启动 Linux 系统</h5><p>从 EMMC 启动也就是将编译出来的 Linux 镜像文件 zImage 和设备树文件保存在 EMMC中，uboot 从 EMMC 中读取这两个文件并启动，这个是我们产品最终的启动方式。但是我们目前还没有讲解如何移植 linux 和设备树文件，以及如何将 zImage 和设备树文件保存到 EMMC中。不过大家拿到手的 I.MX6U-ALPHA 开发板(EMMC 版本)已经将 zImage 文件和设备树文件烧写到了 EMMC 中，所以我们可以直接读取来测试。先检查一下 EMMC 的分区 1 中有没有zImage 文件和设备树文件，输入命令</p>
<p><code>ls mmc 1:1</code><br>结果下所示：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs subunit">=&gt; ls mmc 1:1<br>    38823   imx6ull<span class="hljs-string">-14</span>x14-emmc<span class="hljs-string">-10</span>.1<span class="hljs-string">-1280</span>x800-c.dtb<br>    38823   imx6ull<span class="hljs-string">-14</span>x14-emmc<span class="hljs-string">-4</span>.3<span class="hljs-string">-480</span>x272-c.dtb<br>    38823   imx6ull<span class="hljs-string">-14</span>x14-emmc<span class="hljs-string">-4</span>.3<span class="hljs-string">-800</span>x480-c.dtb<br>    38823   imx6ull<span class="hljs-string">-14</span>x14-emmc<span class="hljs-string">-7</span><span class="hljs-string">-1024</span>x600-c.dtb<br>    38823   imx6ull<span class="hljs-string">-14</span>x14-emmc<span class="hljs-string">-7</span><span class="hljs-string">-800</span>x480-c.dtb<br>    39655   imx6ull<span class="hljs-string">-14</span>x14-emmc-hdmi.dtb<br>    39563   imx6ull<span class="hljs-string">-14</span>x14-emmc-vga.dtb<br>  6786272   zimage<br><br>8 file(s), 0 dir(s)<br></code></pre></td></tr></table></figure>

<p>uboot启动，进入命令模式，设置如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> bootargs &#x27;console=ttymxc0,<span class="hljs-number">115200</span> root=/dev/mmcblk1p2 rootwait rw&#x27;<br><span class="hljs-attribute">setenv</span> bootcmd &#x27;mmc dev <span class="hljs-number">1</span>; fatload mmc <span class="hljs-number">1</span>:<span class="hljs-number">1</span> <span class="hljs-number">80800000</span> zImage; fatload mmc <span class="hljs-number">1</span>:<span class="hljs-number">1</span> <span class="hljs-number">83000000</span> imx6ull-<span class="hljs-number">14</span>x14-emmc-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600-c.dtb; bootz <span class="hljs-number">80800000</span> - <span class="hljs-number">83000000</span>;&#x27;<br><span class="hljs-attribute">saveenv</span><br></code></pre></td></tr></table></figure>
<p>设置好以后直接输入 boot，或者 run bootcmd 即可启动 Linux 内核，如果 Linux 内核启动成功的话就会输出如下的启动信息：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">=&gt; boot<br>switch to partitions <span class="hljs-comment">#0, OK</span><br>mmc1(part <span class="hljs-number">0</span>) is current device<br>reading zImage<br><span class="hljs-number">6786272</span> bytes <span class="hljs-keyword">read</span> <span class="hljs-keyword">in</span> <span class="hljs-number">226</span> <span class="hljs-keyword">ms</span> <span class="hljs-title">(28</span>.<span class="hljs-number">6</span> MiB/s)<br>reading imx6ull-<span class="hljs-number">14</span>x14-emmc-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600-c.dtb<br><span class="hljs-number">38823</span> bytes <span class="hljs-keyword">read</span> <span class="hljs-keyword">in</span> <span class="hljs-number">20</span> <span class="hljs-keyword">ms</span> <span class="hljs-title">(1</span>.<span class="hljs-number">9</span> MiB/s)<br>Kernel image @ <span class="hljs-number">0</span>x80800000 [ <span class="hljs-number">0</span>x000000 - <span class="hljs-number">0</span>x678ce0 ]<br><span class="hljs-comment">## Flattened Device Tree blob at 83000000</span><br>   Booting using the fdt blob at <span class="hljs-number">0</span>x83000000<br>   Using Device Tree <span class="hljs-keyword">in</span> place at <span class="hljs-number">83000000</span>, end <span class="hljs-number">8300</span>c7a6<br><br>Starting kernel ...<br><br>[    <span class="hljs-number">0.000000</span>] Booting Linux on physical CPU <span class="hljs-number">0</span>x0<br>......<br></code></pre></td></tr></table></figure>

<h5 id="从网络启动-Linux-系统"><a href="#从网络启动-Linux-系统" class="headerlink" title="从网络启动 Linux 系统"></a>从网络启动 Linux 系统</h5><blockquote>
<p>前提必须先设置好开发板的网络参数和服务器地址。详见上文 <code>网络驱动修改</code></p>
<p>从网络启动 linux 系统的唯一目的就是为了调试！不管是为了调试 linux 系统还是 linux 下的驱动。每次修改 linux 系统文件或者 linux 下的某个驱动以后都要将其烧写到 EMMC 中去测试，这样太麻烦了。我们可以设置 linux 从网络启动，也就是将 linux 镜像文件和根文件系统都放到 Ubuntu 下某个指定的文件夹中，这样每次重新编译 linux 内核或者某个 linux 驱动以后只需要使用 cp 命令将其拷贝到这个指定的文件夹中即可，这样就不用需要频繁的烧写 EMMC。我们可以通过 nfs 或者 tftp 从 Ubuntu 中下载 zImage 和设备树文件，根文件系统的话也可以通过 nfs 挂载。</p>
</blockquote>
<p>这里我们使用 tftp 从 Ubuntu 中下载 zImage 和设备树文件，前提是要将 zImage 和设备树文件放到 Ubuntu 下的 tftp 目录中</p>
<p>需要在 Ubuntu 上搭建 TFTP 服务器，需要安装 tftp-hpa 和 tftpd-hpa，命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install tftp-hpa tftpd-hpa<br>sudo apt-<span class="hljs-built_in">get</span> install xinetd<br></code></pre></td></tr></table></figure>
<p>在用户目录下新建一个目录存放文件，命令如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot<br>chmod <span class="hljs-number">777</span> <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot<br></code></pre></td></tr></table></figure>
<p>新建文件<code>sudo vi /etc/xinetd.d/tftp</code>，然后在里面输入如下内容：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs abnf">server tftp<br>&#123;<br>	socket_type	<span class="hljs-operator">=</span> dgram<br>	protocol	<span class="hljs-operator">=</span> udp<br>	wait	<span class="hljs-operator">=</span> yes<br>	user	<span class="hljs-operator">=</span> root<br>	server	<span class="hljs-operator">=</span> /usr/sbin/in.tftpd<br>	server_args	<span class="hljs-operator">=</span> -s /home/lonly/linux/tftpboot/<br>	disable	<span class="hljs-operator">=</span> no<br>	per_source	<span class="hljs-operator">=</span> <span class="hljs-number">11</span><br>	cps	<span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-number">2</span><br>	flags	<span class="hljs-operator">=</span> IPv4<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完了以后启动 tftp 服务，命令如下：<br><code>sudo service tftpd-hpa start</code><br>打开 <code>sudo vi /etc/default/tftpd-hpa</code> 文件，将其修改为如下所示内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/default/tftpd-hpa</span><br><br><span class="hljs-attr">TFTP_USERNAME</span>=<span class="hljs-string">&quot;tftp&quot;</span><br><span class="hljs-attr">TFTP_DIRECTORY</span>=<span class="hljs-string">&quot;/home/lonly/linux/tftpboot&quot;</span><br><span class="hljs-attr">TFTP_ADDRESS</span>=<span class="hljs-string">&quot;:69&quot;</span><br><span class="hljs-attr">TFTP_OPTIONS</span>=<span class="hljs-string">&quot;-l -c -s&quot;</span><br></code></pre></td></tr></table></figure>
<p>重启 tftp 服务器：<br><code>sudo service tftpd-hpa restart</code></p>
<p>将 zImage 镜像文件 和 设备树 拷贝到 tftpboot 文件夹中，并且给予 zImage 相应的权限，命令如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">cp zImage <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot/<br>cp imx6ull-<span class="hljs-number">14</span>x14-emmc-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600-c.dtb <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot/<br>cd <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot/<br>chmod <span class="hljs-number">777</span> zImage<br>chmod <span class="hljs-number">777</span> imx6ull-<span class="hljs-number">14</span>x14-emmc-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600-c.dtb<br></code></pre></td></tr></table></figure>

<p>uboot启动，设置如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> bootargs &#x27;console=ttymxc0,<span class="hljs-number">115200</span> root=/dev/mmcblk1p2 rootwait rw&#x27;<br><span class="hljs-attribute">setenv</span> bootcmd &#x27;tftp <span class="hljs-number">80800000</span> zImage; tftp <span class="hljs-number">83000000</span> imx6ull-<span class="hljs-number">14</span>x14-emmc-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600-c.dtb; bootz <span class="hljs-number">80800000</span> - <span class="hljs-number">83000000</span>&#x27;<br><span class="hljs-attribute">saveenv</span><br></code></pre></td></tr></table></figure>
<p>重启<code>boot</code></p>
<p>显示如下：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs clean">=&gt; boot<br>Using FEC1 device<br>TFTP <span class="hljs-keyword">from</span> server <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.254</span>; our IP address is <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.111</span><br>Filename <span class="hljs-string">&#x27;zImage&#x27;</span>.<br>Load address: <span class="hljs-number">0x80800000</span><br>Loading: #################################################################<br>         #################################################################<br>         #################################################################<br>         #############################################################T ####<br>         #################################################################<br>         ###################################################T ##############<br>         #################################################################<br>         ########<br>         <span class="hljs-number">204.1</span> KiB/s<br>done<br>Bytes transferred = <span class="hljs-number">6785480</span> (<span class="hljs-number">6789</span>c8 hex)<br>Using FEC1 device<br>TFTP <span class="hljs-keyword">from</span> server <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.254</span>; our IP address is <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.111</span><br>Filename <span class="hljs-string">&#x27;imx6ull-14x14-emmc-7-1024x600-c.dtb&#x27;</span>.<br>Load address: <span class="hljs-number">0x83000000</span><br>Loading: ###<br>         <span class="hljs-number">233.4</span> KiB/s<br>done<br>Bytes transferred = <span class="hljs-number">39327</span> (<span class="hljs-number">999</span>f hex)<br>Kernel image @ <span class="hljs-number">0x80800000</span> [ <span class="hljs-number">0x000000</span> - <span class="hljs-number">0x6789c8</span> ]<br>## Flattened Device Tree blob at <span class="hljs-number">83000000</span><br>   Booting using the fdt blob at <span class="hljs-number">0x83000000</span><br>   Using Device Tree <span class="hljs-keyword">in</span> place at <span class="hljs-number">83000000</span>, end <span class="hljs-number">8300</span>c99e<br><br>Starting kernel ...<br></code></pre></td></tr></table></figure>

<h3 id="bootcmd-和-bootargs-环境变量"><a href="#bootcmd-和-bootargs-环境变量" class="headerlink" title="bootcmd 和 bootargs 环境变量"></a>bootcmd 和 bootargs 环境变量</h3><p>bootcmd 和 bootagrs 是采用类似 shell 脚本语言编写的，里面有很多的变量引用，这些变量其实都是环境变量 ， 有很多是NXP自 己定义的 。 文件mx6ull_alientek_emmc.h 中的宏 <code>CONFIG_EXTRA_ENV_SETTINGS</code> 保存着这些环境变量的默认值。</p>
<ul>
<li>bootcmd：保存着 uboot 默认命令</li>
<li>bootargs：保存着 uboot 传递给 Linux 内核的参数</li>
</ul>
<h4 id="bootcmd"><a href="#bootcmd" class="headerlink" title="bootcmd"></a>bootcmd</h4><p>bootcmd 保存着 uboot 默认命令，uboot 倒计时结束以后就会执行 bootcmd 中的命令。<br>可以在 uboot 启动以后进入命令行设置 bootcmd 环境变量的值。板子第一次运行 uboot 的时候都会使用默认值来设置 bootcmd 环境变量</p>
<p>文件 include&#x2F;env_default.h。指定了很多环境变量的默认值，比如 bootcmd 的默认值就是CONFIG_BOOTCOMMAND，bootargs 的默认值就是 CONFIG_BOOTARGS。我们可以在 mx6ull_alientek_emmc.h 文件中通过设置宏 CONFIG_BOOTCOMMAND 来设置 bootcmd 的默认值，</p>
<p>打开文 件 mx6ull_alientek_emmc.h，找到宏 <code>CONFIG_BOOTCOMMAND</code> ,</p>
<p>经过分析，浓缩出来的仅仅是 4 行精华：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mmc</span> dev <span class="hljs-number">1</span>	//切换到 EMMC<br><span class="hljs-attribute">fatload</span> mmc <span class="hljs-number">1</span>:<span class="hljs-number">1</span> <span class="hljs-number">0</span>x80800000 zImage	//读取 zImage 到 <span class="hljs-number">0</span>x80800000 处<br><span class="hljs-attribute">fatload</span> mmc <span class="hljs-number">1</span>:<span class="hljs-number">1</span> <span class="hljs-number">0</span>x83000000 imx6ull-<span class="hljs-number">14</span>x14-evk.dtb //读取设备树到 <span class="hljs-number">0</span>x83000000 处<br><span class="hljs-attribute">bootz</span> <span class="hljs-number">0</span>x80800000 - <span class="hljs-number">0</span>x83000000	//启动 Linux<br></code></pre></td></tr></table></figure>
<p>NXP 官方将 CONFIG_BOOTCOMMAND 写的这么复杂只有一个目的：为了兼容多个板子，所以写了个很复杂的脚本。当我们明确知道我们所使用的板子的时候就可以大幅简化宏CONFIG_BOOTCOMMAND的 设 置 ， 比如我们要从EMMC启 动 ，那么宏<br>CONFIG_BOOTCOMMAND 就可简化为：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment">#define CONFIG_BOOTCOMMAND \</span><br><span class="hljs-string">&quot;mmc dev 1;&quot;</span> <span class="hljs-string">\</span><br><span class="hljs-string">&quot;fatload mmc 1:1 0x80800000 zImage;&quot;</span> <span class="hljs-string">\</span><br><span class="hljs-string">&quot;fatload mmc 1:1 0x83000000 imx6ull-alientek-emmc.dtb;&quot;</span> <span class="hljs-string">\</span><br><span class="hljs-string">&quot;bootz 0x80800000 - 0x83000000;&quot;</span><br></code></pre></td></tr></table></figure>
<p>或者可以直接在 uboot  启动后，使用命令设置 bootcmd 的值，这个值就是保存到 EMMC 中的，命令如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> bootcmd &#x27;mmc dev <span class="hljs-number">1</span>; fatload mmc <span class="hljs-number">1</span>:<span class="hljs-number">1</span> <span class="hljs-number">80800000</span> zImage; fatload mmc <span class="hljs-number">1</span>:<span class="hljs-number">1</span> <span class="hljs-number">83000000</span> imx6ull-<span class="hljs-number">14</span>x14-emmc-<span class="hljs-number">7</span>-<span class="hljs-number">1024</span>x600-c.dtb; bootz <span class="hljs-number">80800000</span> - <span class="hljs-number">83000000</span>;&#x27;<br></code></pre></td></tr></table></figure>

<h4 id="bootargs"><a href="#bootargs" class="headerlink" title="bootargs"></a>bootargs</h4><p>bootargs 保存着 uboot 传递给 Linux 内核的参数，bootargs 环境变量是由 mmcargs 设置的，mmcargs 环境变量如下：<br><code>mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; root=$&#123;mmcroot&#125;</code><br>其中 console&#x3D;ttymxc0，baudrate&#x3D;115200，mmcroot&#x3D;&#x2F;dev&#x2F;mmcblk1p2 rootwait rw，因此将mmcargs 展开以后就是：<br><code>mmcargs=setenv bootargs console= ttymxc0, 115200 root= /dev/mmcblk1p2 rootwait rw</code></p>
<p>常用的参数有：</p>
<ol>
<li><p>console<br>console 用来设置 linux 终端(或者叫控制台)，也就是通过什么设备来和 Linux 进行交互，是串口还是 LCD 屏幕？一般设置串口作为 Linux 终端。这里设置 console 为 ttymxc0，因为 linux启动以后 I.MX6ULL 的串口 1 在 linux 下的设备文件就是&#x2F;dev&#x2F;ttymxc0，ttymxc0 后面有个“,115200”，这是设置串口的波特率</p>
</li>
<li><p>root<br>root 用来设置根文件系统的位置，root&#x3D;&#x2F;dev&#x2F;mmcblk1p2 用于指明根文件系统存放在mmcblk1 设备的分区 2 中。EMMC 版本的核心板启动 linux 以后会存在&#x2F;dev&#x2F;mmcblk0、&#x2F;dev&#x2F;mmcblk1、&#x2F;dev&#x2F;mmcblk0p1、&#x2F;dev&#x2F;mmcblk0p2、&#x2F;dev&#x2F;mmcblk1p1 和&#x2F;dev&#x2F;mmcblk1p2 这样的文件，其中&#x2F;dev&#x2F;mmcblkx(x&#x3D;0<del>n)表示 mmc 设备，而&#x2F;dev&#x2F;mmcblkxpy(x&#x3D;0</del>n,y&#x3D;1~n)表示 mmc 设备x 的分区 y。在 I.MX6U-ALPHA 开发板中&#x2F;dev&#x2F;mmcblk1 表示 EMMC，而&#x2F;dev&#x2F;mmcblk1p2 表示EMMC 的分区 2。<br>root 后面有“rootwait rw”，rootwait 表示等待 mmc 设备初始化完成以后再挂载，否则的话mmc 设备还没初始化完成就挂载根文件系统会出错的。rw 表示根文件系统是可以读写的，不加rw 的话可能无法在根文件系统中进行写操作，只能进行读操作。</p>
</li>
<li><p>rootfstype</p>
</li>
</ol>
<p>此选项一般配置 root 一起使用，rootfstype 用于指定根文件系统类型，如果根文件系统为ext 格式的话此选项无所谓。如果根文件系统是 yaffs、jffs 或 ubifs 的话就需要设置此选项，指定根文件系统的类型。</p>
<h2 id="linux内核移植"><a href="#linux内核移植" class="headerlink" title="linux内核移植"></a>linux内核移植</h2><h3 id="Linux-内核获取"><a href="#Linux-内核获取" class="headerlink" title="Linux 内核获取"></a>Linux 内核获取</h3><p>NXP 会从 <a target="_blank" rel="noopener" href="https://www.kernel.org/">https://www.kernel.org</a> 下载某个版本的 Linux 内核，然后将其移植到自己的 CPU上，测试成功以后就会将其开放给 NXP 的 CPU 开发者。开发者下载 NXP 提供的 Linux 内核，然后将其移植到自己的产品上。</p>
<p>课参考上文uboot源码下载方式，从网站中下载NXP的linux内核源码<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657549798768.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>rel_imx_4.1.15_2.1.0_ga版本。与正点原子教程一样<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657549835485.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h3 id="Linux-内核初次编译"><a href="#Linux-内核初次编译" class="headerlink" title="Linux 内核初次编译"></a>Linux 内核初次编译</h3><p>编译内核之前需要先在 ubuntu 上安装 lzop 库，否则内核编译会失败！命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install lzop<br></code></pre></td></tr></table></figure>

<p>在 Ubuntu中新建名为 “ alientek_linux ” 的文件夹 ， 然后将正点原子移植好的 Linux 源码 linux-imx-4.1.15-2.1.0-g8a006db.tar.bz2 这个压缩包拷贝到前面新建的 alientek_linux 文件夹中并解压，命令如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -vxjf linux-imx-<span class="hljs-number">4</span>.<span class="hljs-number">1</span>.<span class="hljs-number">15</span>-<span class="hljs-number">2</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>-g8a006db.tar.bz2<br></code></pre></td></tr></table></figure>

<p>编译出对应的 Linux 镜像文件。新建名为<br>“mx6ull_alientek_emmc.sh”的 shell 脚本，然后在这个 shell 脚本里面输入如下所示内容：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/sh</span><br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- distclean<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- imx_v7_defconfig<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- menuconfig<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- all -j16<br></code></pre></td></tr></table></figure>
<p>第 2 行，执行“make distclean”，清理工程，所以 mx6ull_alientek_emmc.sh 每次都会清理一下工程。如果通过图形界面配置了 Linux，但是还没保存新的配置文件，那么就要慎重使用mx6ull_alientek_emmc.sh 编译脚本了，因为它会把你的配置信息都删除掉！<br>第 3 行，执行“make xxx_defconfig”，配置工程。<br>第 4 行，执行“make menuconfig”，打开图形配置界面，对 Linux 进行配置，如果不想每次编译都打开图形配置界面的话可以将这一行删除掉。<br>第 5 行，执行“make”，编译 Linux 源码。</p>
<p>可以看出，Linux 的编译过程基本和 uboot 一样，都要先执行“make xxx_defconfig”来配置一下，然后在执行“make”进行编译。如果需要使用图形界面配置的话就执行“make menuconfig”。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo chmod <span class="hljs-number">777</span> mx6ull_alientek_emmc.sh<br><span class="hljs-regexp">//</span>给予可执行权限，一次即可<br>./mx6ull_alientek_emmc.sh<br><span class="hljs-regexp">//</span>运行脚本编译 uboot<br></code></pre></td></tr></table></figure>

<p>Linux 的图行界面配置和 uboot 是一样的，这里我们不需要做任何的配置，直接按两下 ESC键退出，退出图形界面以后会自动开始编译 Linux。等待编译完成，大概十几分钟。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657550586516.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>编译完成以后就会在 arch&#x2F;arm&#x2F;boot 这个目录下生成一个叫做 zImage 的文件，zImage 就是我们要用的 Linux 镜像文件。另外也会在 arch&#x2F;arm&#x2F;boot&#x2F;dts 下生成很多.dtb 文件，这些.dtb 就是设备树文件。</p>
<h3 id="Linux-工程目录分析"><a href="#Linux-工程目录分析" class="headerlink" title="Linux 工程目录分析"></a>Linux 工程目录分析</h3><p>我们在分析 Linux 之前一定要先在 Ubuntu 中编译一下 Linux，因为编译过程会生成一些文件，而生成的这些恰恰是分析<br>Linux 不可或缺的文件。编译完成以后使用 tar 压缩命令对其进行压缩并使用 Filezilla 软件将压缩后的 uboot 源码拷贝到 Windows 下。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657550674132.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657550811416.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<h4 id="1、arch-目录"><a href="#1、arch-目录" class="headerlink" title="1、arch 目录"></a>1、arch 目录</h4><p>这个目录是和架构有关的目录，比如 arm、arm64、avr32、x86 等等架构。每种架构都对应一个目录，在这些目录中又有很多子目录，比如 boot、common、configs 等等，以 arch&#x2F;arm 为例，其子目录如图 35.3.3 所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657550899567.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>图 35.3.3 是 arch&#x2F;arm 的一部分子目录，这些子目录用于控制系统引导、系统调用、动态调频、主频设置等。arch&#x2F;arm&#x2F;configs 目录是不同平台的默认配置文件：xxx_defconfig，如图 35.3.4所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657550940237.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>在 arch&#x2F;arm&#x2F;configs 中就包含有 I.MX6U-ALPHA 开发板的默认配置文件：imx_v7_defconfig，执行“make imx_v7_defconfig”即可完成配置。<br>arch&#x2F;arm&#x2F;boot&#x2F;dts 目录里面是对应开发平台的设备树文件，正点原子 I.MX6U-ALPHA 开发板对应的设备树文件如图 35.3.5 所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657550960076.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>arch&#x2F;arm&#x2F;boot 目录下会保存编译出来的 Image 和 zImage 镜像文件，而 zImage 就是我们要用的 linux 镜像文件。</p>
<p>arch&#x2F;arm&#x2F;mach-xxx 目录分别为相应平台的驱动和初始化文件，比如 mach-imx 目录里面就是 I.MX 系列 CPU 的驱动和初始化文件。</p>
<h4 id="2、block-目录"><a href="#2、block-目录" class="headerlink" title="2、block 目录"></a>2、block 目录</h4><p>block 是 Linux 下块设备目录，像 SD 卡、EMMC、NAND、硬盘等存储设备就属于块设备，<br>block 目录中存放着管理块设备的相关文件。</p>
<h4 id="3、crypto-目录"><a href="#3、crypto-目录" class="headerlink" title="3、crypto 目录"></a>3、crypto 目录</h4><p>crypto 目录里面存放着加密文件，比如常见的 crc、crc32、md4、md5、hash 等加密算法。</p>
<h4 id="4、Documentation-目录"><a href="#4、Documentation-目录" class="headerlink" title="4、Documentation 目录"></a>4、Documentation 目录</h4><p>此目录里面存放着 Linux 相关的文档，如果要想了解 Linux 某个功能模块或驱动架构的功<br>能，就可以在 Documentation 目录中查找有没有对应的文档。</p>
<h4 id="5、drivers-目录"><a href="#5、drivers-目录" class="headerlink" title="5、drivers 目录"></a>5、drivers 目录</h4><p>驱动目录文件，此目录根据驱动类型的不同，分门别类进行整理，比如 drivers&#x2F;i2c 就是 I2C<br>相关驱动目录，drivers&#x2F;gpio 就是 GPIO 相关的驱动目录，这是我们学习的重点。</p>
<h4 id="6、firmware-目录"><a href="#6、firmware-目录" class="headerlink" title="6、firmware 目录"></a>6、firmware 目录</h4><p>此目录用于存放固件。</p>
<h4 id="7、fs-目录"><a href="#7、fs-目录" class="headerlink" title="7、fs 目录"></a>7、fs 目录</h4><p>此目录存放文件系统，比如 fs&#x2F;ext2、fs&#x2F;ext4、fs&#x2F;f2fs 等，分别是 ext2、ext4 和 f2fs 等文件系<br>统。</p>
<h3 id="内核移植"><a href="#内核移植" class="headerlink" title="内核移植"></a>内核移植</h3><h4 id="创建VSCode工程"><a href="#创建VSCode工程" class="headerlink" title="创建VSCode工程"></a>创建VSCode工程</h4><p>这里我们使用 NXP 官方提供的 Linux 源码，将其移植到正点原子 I.MX6U-ALPHA 开发板上。使用 FileZilla 将其发送到 Ubuntu<br>中并解压，得到名为 linux-imx-rel_imx_4.1.15_2.1.0_ga 的目录，</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -vxjf linux-imx-rel_imx_4.<span class="hljs-number">1</span>.<span class="hljs-number">15</span>_2.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>_ga.tar.bz2<br></code></pre></td></tr></table></figure>

<p>为了和 NXP 官方的名字区分，将其重命名为 “ linux-imx-rel_imx_4.1.15_2.1.0_ga_alientek”，命令如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mv</span> linux-imx-rel_imx_4.<span class="hljs-number">1</span>.<span class="hljs-number">15</span>_2.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>_ga linux-imx-rel_imx_4.<span class="hljs-number">1</span>.<span class="hljs-number">15</span>_2.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>_ga_alientek<br></code></pre></td></tr></table></figure>
<p>完成以后创建 VSCode 工程，<br>新建 .vscode&#x2F;settings.json 文件屏蔽不用文件夹显示，内容如下</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&#123;<br>    <span class="hljs-string">&quot;search.exclude&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;**/node_modules&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/bower_components&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/*.o&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;**/*.su&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;**/*.cmd&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;Documentation&quot;</span><span class="hljs-symbol">:true</span>,<br><br>        <span class="hljs-regexp">/* 屏蔽不用的架构相关的文件 */</span><br>        <span class="hljs-string">&quot;arch/alpha&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arc&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm64&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/avr32&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/[b-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/plat*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-[a-h]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-[n-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-i[n-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-m[e-v]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-k*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-l*&quot;</span><span class="hljs-symbol">:true</span>,<br><br>        <span class="hljs-regexp">/* 屏蔽排除不用的配置文件 */</span><br>        <span class="hljs-string">&quot;arch/arm/configs/[a-h]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/[j-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/imo*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/in*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/io*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/ix*&quot;</span><span class="hljs-symbol">:true</span>,<br><br>        <span class="hljs-regexp">/* 屏蔽掉不用的 DTB 文件 */</span><br>        <span class="hljs-string">&quot;arch/arm/boot/dts/[a-h]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/[k-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/in*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx1*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx7*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx2*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx3*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx5*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6d*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6q*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6s*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6ul-*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6ull-9x9*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6ull-14x14-ddr*&quot;</span><span class="hljs-symbol">:true</span>,<br>    &#125;,<br>    <span class="hljs-string">&quot;files.exclude&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;**/.git&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/.svn&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/.hg&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/CVS&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/.DS_Store&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;**/*.o&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;**/*.su&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;**/*.cmd&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;Documentation&quot;</span><span class="hljs-symbol">:true</span>,<br><br>        <span class="hljs-regexp">/* 屏蔽不用的架构相关的文件 */</span><br>        <span class="hljs-string">&quot;arch/alpha&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arc&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm64&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/avr32&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/[b-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/plat*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-[a-h]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-[n-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-i[n-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-m[e-v]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-k*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/mach-l*&quot;</span><span class="hljs-symbol">:true</span>,<br><br>        <span class="hljs-regexp">/* 屏蔽排除不用的配置文件 */</span><br>        <span class="hljs-string">&quot;arch/arm/configs/[a-h]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/[j-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/imo*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/in*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/io*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/configs/ix*&quot;</span><span class="hljs-symbol">:true</span>,<br><br>        <span class="hljs-regexp">/* 屏蔽掉不用的 DTB 文件 */</span><br>        <span class="hljs-string">&quot;arch/arm/boot/dts/[a-h]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/[k-z]*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/in*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx1*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx7*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx2*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx3*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx5*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6d*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6q*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6s*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6ul-*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6ull-9x9*&quot;</span><span class="hljs-symbol">:true</span>,<br>        <span class="hljs-string">&quot;arch/arm/boot/dts/imx6ull-14x14-ddr*&quot;</span><span class="hljs-symbol">:true</span>,<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<h4 id="NXP内核编译"><a href="#NXP内核编译" class="headerlink" title="NXP内核编译"></a>NXP内核编译</h4><h5 id="修改顶层Makefile"><a href="#修改顶层Makefile" class="headerlink" title="修改顶层Makefile"></a>修改顶层Makefile</h5><p>修改顶层 Makefile，直接在顶层 Makefile 文件里面定义 ARCH 和 CROSS_COMPILE 这两个的变量值为 arm 和 arm-linux-gnueabihf-，结果如图所示：</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657634667576.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>图中第 252 和 253 行分别设置了 ARCH 和 CROSS_COMPILE 这两个变量的值，这样在编译的时候就不用输入很长的命令了。</p>
<h5 id="配置并编译-Linux-内核"><a href="#配置并编译-Linux-内核" class="headerlink" title="配置并编译 Linux 内核"></a>配置并编译 Linux 内核</h5><p>和 uboot 一样，在编译 Linux 内核之前要先配置 Linux 内核。每个板子都有其对应的默认配 置 文 件 ， 这 些 默 认 配 置 文 件 保 存 在 arch&#x2F;arm&#x2F;configs 目 录 中 。 imx_v7_defconfig 和imx_v7_mfg_defconfig 都可作为 I.MX6ULL EVK 开发板所使用的默认配置文件。但是这里建议使用 imx_v7_mfg_defconfig 这个默认配置文件，首先此配置文件默认支持 I.MX6UL 这款芯片，而且重要的一点就是此文件编译出来的 zImage 可以通过 NXP 官方提供的 MfgTool 工具烧写！！imx_v7_mfg_defconfig 中的“mfg”的意思就是 MfgTool。</p>
<p>进入到 Ubuntu 中的 Linux 源码根目录下，执行如下命令配置 Linux 内核：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">make clean  <span class="hljs-regexp">//</span>第一次编译 Linux 内核之前先清理一下<br>make imx_v7_mfg_defconfig   <span class="hljs-regexp">//</span>配置 Linux 内核<br></code></pre></td></tr></table></figure>
<p>配置完成以后如图 37.2.2.1 所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657634658847.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>配置完成以后就可以编译了，使用如下命令编译 Linux 内核：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">make -j16  <span class="hljs-regexp">//</span>编译 Linux 内核<br></code></pre></td></tr></table></figure>

<p>也可 以 创 建 一 个 编 译 脚 本 ，imx6ull_nxp_emmc.sh，脚本内容如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/sh</span><br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- distclean<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- imx_v7_mfg_defconfig<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- menuconfig<br>make <span class="hljs-attribute">ARCH</span>=arm <span class="hljs-attribute">CROSS_COMPILE</span>=arm-linux-gnueabihf- all -j16<br></code></pre></td></tr></table></figure>

<p>第 2 行，清理工程。<br>第 3 行，使用默认配置文件 imx_alientek_emmc_defconfig 来配置 Linux 内核。<br>第 4 行，打开 Linux 的图形配置界面，如果不需要每次都打开图形配置界面可以删除此行。<br>第 5 行，编译 Linux。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">chmod 777 imx6ull_alientek_emmc.<span class="hljs-keyword">sh</span>  <span class="hljs-comment">//给予可执行权限</span><br>./imx6ull_alientek_emmc.<span class="hljs-keyword">sh</span>  <span class="hljs-comment">//执行 shell 脚本编译内核</span><br></code></pre></td></tr></table></figure>
<p>等待编译完成，结果如图 37.2.2.2 所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657634708747.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>Linux 内核编译完成以后会在 arch&#x2F;arm&#x2F;boot 目录下生成 zImage 镜像文件，如果使用设备树的话还会在 arch&#x2F;arm&#x2F;boot&#x2F;dts 目录下开发板对应的.dtb(设备树)文件，比如 imx6ull-14x14-evk.dtb就是 NXP 官方的 I.MX6ULL EVK 开发板对应的设备树文件。至此我们得到两个文件：<br>①、Linux 内核镜像文件：zImage。<br>②、NXP 官方 I.MX6ULL EVK 开发板对应的设备树文件：imx6ull-14x14-evk.dtb。</p>
<h5 id="Linux-内核启动测试"><a href="#Linux-内核启动测试" class="headerlink" title="Linux 内核启动测试"></a>Linux 内核启动测试</h5><p>将上一小节编译出来的 zImage 和 imx6ull-14x14-evk.dtb 复制到 Ubuntu 中的 tftp 目录下，因为我们要在 uboot 中使用 tftp 命令将其下载到开发板中，拷贝命令如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cp arch<span class="hljs-regexp">/arm/</span>boot<span class="hljs-regexp">/zImage /</span>home<span class="hljs-regexp">/lonly/</span>linux<span class="hljs-regexp">/tftpboot/</span> -f<br>cp arch<span class="hljs-regexp">/arm/</span>boot<span class="hljs-regexp">/dts/im</span>x6ull-<span class="hljs-number">14</span>x14-evk.dtb <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot/ -f<br></code></pre></td></tr></table></figure>
<p>拷贝完成以后就可以测试了，启动开发板，进入 uboot 命令行模式，环境变量 bootargs 内容如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">setenv bootargs &#x27;console=ttymxc0,<span class="hljs-number">115200</span> root=/dev/mmcblk1p2 rootwait rw&#x27;<br></code></pre></td></tr></table></figure>
<p>然后输入如下命令将zImage 和 imx6ull-14x14-evk.dtb 下载到开发板中并启动：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> bootcmd &#x27;tftp <span class="hljs-number">80800000</span> zImage; tftp <span class="hljs-number">83000000</span> imx6ull-<span class="hljs-number">14</span>x14-evk.dtb; bootz <span class="hljs-number">80800000</span> - <span class="hljs-number">83000000</span>&#x27;<br><span class="hljs-attribute">saveenv</span><br><span class="hljs-attribute">boot</span><br></code></pre></td></tr></table></figure>
<p>结果图 37.2.3.1 所示：只要出现如下内容就表示成功</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657636430554.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>如果EMMC里没有跟文件系统的话，会显示如下错误</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657635727173.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Kernel</span> panic - not syncing: VFS: Unable to mount root fs <span class="hljs-literal">on</span> unknown-block(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>
<p>也就是提示内核崩溃，因为 VFS(虚拟文件系统)不能挂载根文件系统，因为根文件系统目录不存在。即使根文件系统目录存在，如果根文件系统目录里面是空的依旧会提示内核崩溃。这个就是根文件系统缺失导致的内核崩溃，但是内核是启动了的，只是根文件系统不存在而已。</p>
<h4 id="添加自己的开发板"><a href="#添加自己的开发板" class="headerlink" title="添加自己的开发板"></a>添加自己的开发板</h4><p>参考 I.MX6ULL EVK 开发板的设置，在 Linux 内核中添加正点原子的 I.MX6U-ALPHA 开发板。</p>
<h5 id="添加开发板默认配置文件"><a href="#添加开发板默认配置文件" class="headerlink" title="添加开发板默认配置文件"></a>添加开发板默认配置文件</h5><p>将arch&#x2F;arm&#x2F;configs目 录 下 的imx_v7_mfg_defconfig重 新 复 制 一 份 ， 命 名 为imx_alientek_emmc_defconfig，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-built_in">arch</span>/arm/configs<br><span class="hljs-built_in">cp</span> imx_v7_mfg_defconfig imx_alientek_emmc_defconfig<br></code></pre></td></tr></table></figure>
<p>以后 imx_alientek_emmc_defconfig 就是正点原子的 EMMC 版开发板默认配置文件了。<br>以后就可以使用如下命令来配置正点原子 EMMC 版开发板对应的 Linux 内核了：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make imx_alientek_emmc_defconfig</span><br></code></pre></td></tr></table></figure>

<h5 id="添加开发板对应的设备树文件"><a href="#添加开发板对应的设备树文件" class="headerlink" title="添加开发板对应的设备树文件"></a>添加开发板对应的设备树文件</h5><p>添加适合正点原子 EMMC 版开发板的设备树文件，进入目录 arch&#x2F;arm&#x2F;boot&#x2F;dts 中，复制一份 imx6ull-14x14-evk.dts，然后将其重命名为 imx6ull-alientek-emmc.dts，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-built_in">arch</span>/arm/boot/dts<br><span class="hljs-built_in">cp</span> imx6ull-14x14-evk.dts imx6ull-alientek-emmc.dts<br></code></pre></td></tr></table></figure>
<p>.dts 是设备树源码文件，编译 Linux 的时候会将其编译为.dtb 文件。imx6ull-alientek-emmc.dts创 建 好 以 后 我 们 还 需 要 修 改 文 件arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;Makefile ， 找 到 “ dtb-$(CONFIG_SOC_IMX6ULL)”配置项，在此配置项中加入“imx6ull-alientek-emmc.dtb” ，如下所示：</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">400 </span>dtb-$(CONFIG_SOC_IMX6ULL) += \<br><span class="hljs-symbol">401 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2.dtb \<br><span class="hljs-symbol">402 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-adc.dtb \<br><span class="hljs-symbol">403 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-cs42888.dtb \<br><span class="hljs-symbol">404 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-ecspi.dtb \<br><span class="hljs-symbol">405 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-emmc.dtb \<br><span class="hljs-symbol">406 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-epdc.dtb \<br><span class="hljs-symbol">407 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-flexcan2.dtb \<br><span class="hljs-symbol">408 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-gpmi-weim.dtb \<br><span class="hljs-symbol">409 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-lcdif.dtb \<br><span class="hljs-symbol">410 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-ldo.dtb \<br><span class="hljs-symbol">411 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-qspi.dtb \<br><span class="hljs-symbol">412 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-qspi-all.dtb \<br><span class="hljs-symbol">413 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-tsc.dtb \<br><span class="hljs-symbol">414 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-uart2.dtb \<br><span class="hljs-symbol">415 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-usb.dtb \<br><span class="hljs-symbol">416 </span>imx6ull-<span class="hljs-number">14</span>x14-ddr3-arm2-wm8958.dtb \<br><span class="hljs-symbol">417 </span>imx6ull-<span class="hljs-number">14</span>x14-evk.dtb \<br><span class="hljs-symbol">418 </span>imx6ull-<span class="hljs-number">14</span>x14-evk-btwifi.dtb \<br><span class="hljs-symbol">419 </span>imx6ull-<span class="hljs-number">14</span>x14-evk-emmc.dtb \<br><span class="hljs-symbol">420 </span>imx6ull-<span class="hljs-number">14</span>x14-evk-gpmi-weim.dtb \<br><span class="hljs-symbol">421 </span>imx6ull-<span class="hljs-number">14</span>x14-evk-usb-certi.dtb \<br><span class="hljs-symbol">422 </span>imx6ull-alientek-emmc.dtb \<br></code></pre></td></tr></table></figure>
<p>第 422 行为“imx6ull-alientek-emmc.dtb”，这样编译 Linux 的时候就可以从 imx6ull-alientek-emmc.dts 编译出 imx6ull-alientek-emmc.dtb 文件了。</p>
<p>这里可以先编译测试一下，看是否则正确，再进行下面的修改操作。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cp arch<span class="hljs-regexp">/arm/</span>boot<span class="hljs-regexp">/zImage /</span>home<span class="hljs-regexp">/lonly/</span>linux<span class="hljs-regexp">/tftpboot/</span> -f<br>cp arch<span class="hljs-regexp">/arm/</span>boot<span class="hljs-regexp">/dts/im</span>x6ull-alientek-emmc.dtb <span class="hljs-regexp">/home/</span>lonly<span class="hljs-regexp">/linux/</span>tftpboot/ -f<br></code></pre></td></tr></table></figure>


<p>拷贝完成以后就可以测试了，启动开发板，进入 uboot 命令行模式，环境变量 bootargs 内容如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c">setenv bootargs &#x27;console=ttymxc0,<span class="hljs-number">115200</span> root=/dev/mmcblk1p2 rootwait rw&#x27;<br>setenv bootcmd &#x27;tftp <span class="hljs-number">80800000</span> zImage; tftp <span class="hljs-number">83000000</span> imx6ull-alientek-emmc.dtb; bootz <span class="hljs-number">80800000</span> - <span class="hljs-number">83000000</span>&#x27;<br>saveenv<br>boot<br></code></pre></td></tr></table></figure>

<p>如果出现下述状态，是因为没有根文件系统，使用开发板的话，厂家一般都会在emmc中下载好根文件系统，所以不会出现如下错误，这里并不影响测试linux内核和设备树。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1658042955983.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<blockquote>
<p>这里正点原子视频教程中还出现了emmc设备树问题，视频弹幕反馈和自己实测并不会出现<br>如果上述启动信息中有该行内容：<code>mmcblk1: mmc1:0001 8GTF4R 7.28 GiB</code> ，表示你的emmc是没问题的（不同内存卡容量可能不同）</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Waiting</span> for root device /dev/mmcblk1p2...<br><span class="hljs-attribute">hub</span> <span class="hljs-number">1</span>-<span class="hljs-number">1</span>:<span class="hljs-number">1</span>.<span class="hljs-number">0</span>: USB hub found<br><span class="hljs-attribute">mmc1</span>: MAN_BKOPS_EN bit is not set<br><span class="hljs-attribute">hub</span> <span class="hljs-number">1</span>-<span class="hljs-number">1</span>:<span class="hljs-number">1</span>.<span class="hljs-number">0</span>: <span class="hljs-number">4</span> ports detected<br><span class="hljs-attribute">mmc1</span>: new HS200 MMC card at address <span class="hljs-number">0001</span><br><span class="hljs-attribute">mmcblk1</span>: mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R <span class="hljs-number">7</span>.<span class="hljs-number">28</span> GiB<br><span class="hljs-attribute">mmcblk1boot0</span>: mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R partition <span class="hljs-number">1</span> <span class="hljs-number">4</span>.<span class="hljs-number">00</span> MiB<br><span class="hljs-attribute">mmcblk1boot1</span>: mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R partition <span class="hljs-number">2</span> <span class="hljs-number">4</span>.<span class="hljs-number">00</span> MiB<br><span class="hljs-attribute">mmcblk1rpmb</span>: mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R partition <span class="hljs-number">3</span> <span class="hljs-number">512</span> KiB<br></code></pre></td></tr></table></figure>
<h5 id="主频修改"><a href="#主频修改" class="headerlink" title="主频修改"></a>主频修改</h5><p>正点原子 I.MX6U-ALPHA 开发板所使用的 I.MX6ULL 芯片主频都是 792MHz 的。后续可能会生产 528MHz 核心板供企业级批量用户，但是开发板搭配的都是 792MHz 主频的，本节教程也就以 792MHz 的核心板为例讲解。</p>
<p>1、设置 I.MX6U-ALPHA 开发板工作在 792MHz</p>
<p>确保 EMMC 中的根文件系统可用！然后重新启动开发板，进入终端(可以输入命令)，输入如下命令查看 cpu 信息：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>cpuinfo<br></code></pre></td></tr></table></figure>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657802714406.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>在中有 BogoMIPS 这一条，此时 BogoMIPS 为 3.00，BogoMIPS 是 Linux 系统中衡量处理器运行速度的一个“尺子”，我们可以通过 BogoMIPS 值来大致的判断当前处理器的性能。处理器性能越强，主频越高，BogoMIPS 值就越大。BogoMIPS 只是粗略的计算 CPU 性能，并不十分准确。</p>
<p>进入到目录<code>cd /sys/devices/system/cpu/cpu0/cpufreq</code>中，此目录下会有很多文件，此目录中记录了 CPU 频率等信息<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657802753901.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<ul>
<li>cpuinfo_cur_freq：当前 cpu 工作频率，从 CPU 寄存器读取到的工作频率。</li>
<li>cpuinfo_max_freq：处理器所能运行的最高工作频率(单位: KHz）。</li>
<li>cpuinfo_min_freq ：处理器所能运行的最低工作频率(单位: KHz）。</li>
<li>cpuinfo_transition_latency：处理器切换频率所需要的时间(单位:ns)。</li>
<li>scaling_available_frequencies：处理器支持的主频率列表(单位: KHz）。</li>
<li>scaling_available_governors：当前内核中支持的所有 governor(调频)类型。</li>
<li>scaling_cur_freq：保存着 cpufreq 模块缓存的当前 CPU 频率，不会对 CPU 硬件寄存器进</li>
<li>行检查。</li>
<li>scaling_driver：该文件保存当前 CPU 所使用的调频驱动。</li>
<li>scaling_governor：governor(调频)策略，Linux 内核一共有 5 中调频策略，<ul>
<li>①、Performance，最高性能，直接用最高频率，不考虑耗电。</li>
<li>②、Interactive，一开始直接用最高频率，然后根据 CPU 负载慢慢降低。</li>
<li>③、Powersave，省电模式，通常以最低频率运行，系统性能会受影响，一般不会用这个！</li>
<li>④、Userspace，可以在用户空间手动调节频率。</li>
<li>⑤、Ondemand，定时检查负载，然后根据负载来调节频率。负载低的时候降低 CPU 频率，这样省电，负载高的时候提高 CPU 频率，增加性能。</li>
</ul>
</li>
<li>scaling_max_freq：governor(调频)可以调节的最高频率。</li>
<li>cpuinfo_min_freq：governor(调频)可以调节的最低频率。</li>
<li>stats 目录下给出了 CPU 各种运行频率的统计情况，比如 CPU 在各频率下的运行时间以及变频次数。<br>使用如下命令查看当前 CPU 频率：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> cpuinfo_cur_freq<br></code></pre></td></tr></table></figure>
<img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657802844631.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>从图可以看出，当前 CPU 频率为 198MHz，工作频率很低！其他的值如下（使用<code>cat</code>查看上述文件）：<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">cpuinfo_cur_freq</span> = <span class="hljs-number">198000</span><br><span class="hljs-attr">cpuinfo_max_freq</span> = <span class="hljs-number">792000</span><br><span class="hljs-attr">cpuinfo_min_freq</span> = <span class="hljs-number">198000</span><br><span class="hljs-attr">scaling_cur_freq</span> = <span class="hljs-number">198000</span><br><span class="hljs-attr">scaling_max_freq</span> = <span class="hljs-number">792000</span><br><span class="hljs-attr">scaling_min_freq</span> = <span class="hljs-number">198000</span><br><span class="hljs-attr">scaling_available_frequencies</span> = <span class="hljs-number">198000</span> <span class="hljs-number">396000</span> <span class="hljs-number">528000</span> <span class="hljs-number">792000</span><br><span class="hljs-attr">scaling_governor</span> = <span class="hljs-literal">on</span>demand<br></code></pre></td></tr></table></figure></li>
</ul>
<p>调频策略为 ondemand，也就是定期检查负载，然后根据负载情况调节 CPU 频率。查看 stats 目录下的 time_in_state 文件可以看到 CPU 在各频率下的工作时间，命令如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/sys/</span>bus<span class="hljs-regexp">/cpu/</span>devices<span class="hljs-regexp">/cpu0/</span>cpufreq<span class="hljs-regexp">/stats/</span>time_in_state<br></code></pre></td></tr></table></figure>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1657803051168.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>假如我们想让 CPU 一直工作在 792MHz 那该怎么办？很简单，配置 Linux 内核，将调频策略选择为 performance。或者修改 imx_alientek_emmc_defconfig 文件，此文件中有下面几行：<br><code>cd arch/arm/configs</code></p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">41 </span>CONFIG_CPU_FREQ_DEFAULT_GOV_ONDEMAND=y<br><span class="hljs-symbol">42 </span>CONFIG_CPU_FREQ_GOV_POWERSAVE=y<br><span class="hljs-symbol">43 </span>CONFIG_CPU_FREQ_GOV_USERSPACE=y<br><span class="hljs-symbol">44 </span>CONFIG_CPU_FREQ_GOV_INTERACTIVE=y<br></code></pre></td></tr></table></figure>
<p>第 41 行，配置 ondemand 为默认调频策略。<br>第 42 行，使能 powersave 策略。<br>第 43 行，使能 userspace 策略。<br>第 44 行，使能 interactive 策略。 </p>
<p>在 41 行前面添加：<br><code>CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE=y</code><br>结果下所示：</p>
<blockquote>
<p>这里正点原子教程中的配置文件是用图形界面生成的，我这是修改的原始的config文件，所以文件内容和修改的地方与教程不同<br>并且教程中修改是错误的，按教程修改后仍是 Ondemand 策略</p>
</blockquote>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_CPU_FREQ_GOV_POWERSAVE</span>=y<br><span class="hljs-attr">CONFIG_CPU_FREQ_GOV_USERSPACE</span>=y<br><span class="hljs-attr">CONFIG_CPU_FREQ_GOV_ONDEMAND</span>=y<br><span class="hljs-attr">CONFIG_CPU_FREQ_GOV_CONSERVATIVE</span>=y<br></code></pre></td></tr></table></figure>

<p>修改后，重新启动，查看运行频率和运行策略</p>
<blockquote>
<p>ATK-IMX6U 是根文件系统中的用户名</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ruby">root<span class="hljs-variable">@ATK</span>-<span class="hljs-variable constant_">IMX6U</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># cd /sys/devices/system/cpu/cpu0/cpufreq</span><br>root<span class="hljs-variable">@ATK</span>-<span class="hljs-variable constant_">IMX6U</span><span class="hljs-symbol">:/sys/devices/system/cpu/cpu0/cpufreq</span><span class="hljs-comment"># cat cpuinfo_cur_freq</span><br><span class="hljs-number">792000</span><br>root<span class="hljs-variable">@ATK</span>-<span class="hljs-variable constant_">IMX6U</span><span class="hljs-symbol">:/sys/devices/system/cpu/cpu0/cpufreq</span><span class="hljs-comment"># cat scaling_governor</span><br>performance<br><br></code></pre></td></tr></table></figure>


<h5 id="使能-8-线-EMMC-驱动"><a href="#使能-8-线-EMMC-驱动" class="headerlink" title="使能 8 线 EMMC 驱动"></a>使能 8 线 EMMC 驱动</h5><p>Linux 内核驱动里面 EMMC 默认是 4 线模式的，4 线模式肯定没有 8 线模式的速度快，所以我们将 EMMC 的驱动修改为 8 线模式。打开设备树文件 imx6ull-alientek-emmc.dts，找到如下所示内容：</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">734 </span>&amp;usdhc2 &#123;<br><span class="hljs-symbol">735 </span>pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-string">&quot;state_100mhz&quot;</span>, <span class="hljs-string">&quot;state_200mhz&quot;</span>;<br><span class="hljs-symbol">736 </span>pinctrl-<span class="hljs-number">0</span> = &lt;&amp;pinctrl_usdhc2_8bit&gt;;<br><span class="hljs-symbol">737 </span>pinctrl-<span class="hljs-number">1</span> = &lt;&amp;pinctrl_usdhc2_8bit_100mhz&gt;;<br><span class="hljs-symbol">738 </span>pinctrl-<span class="hljs-number">2</span> = &lt;&amp;pinctrl_usdhc2_8bit_200mhz&gt;;<br><span class="hljs-symbol">739 </span>bus-<span class="hljs-keyword">width</span> = &lt;<span class="hljs-number">8</span>&gt;;<br><span class="hljs-symbol">740 </span>non-<span class="hljs-comment">removable;</span><br><span class="hljs-symbol">741 </span>status = <span class="hljs-string">&quot;okay&quot;</span>;<br><span class="hljs-symbol">742 </span>&#125;;<br></code></pre></td></tr></table></figure>

<p>单独编译设备树文件 </p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make dtbs</span><br></code></pre></td></tr></table></figure>

<h5 id="修改网络驱动"><a href="#修改网络驱动" class="headerlink" title="修改网络驱动"></a>修改网络驱动</h5><p>因为在后面学习 Linux 驱动开发的时候要用到网络调试驱动，所以必须要把网络驱动调试好。在讲解 uboot 移植的时候就已经说过了，正点原子开发板的网络和 NXP 官方的网络硬件上不同，网络 PHY 芯片由 KSZ8081 换为了 LAN8720A，两个网络 PHY 芯片的复位 IO 也不同。所以 Linux 内核自带的网络驱动是驱动不起来 I.MX6U-ALPHA 开发板上的网络的，需要做修改。</p>
<p>这里先不修改，查看linux启动信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Configuring network interfaces... fec 20b4000.ethernet eth0:</span> <span class="hljs-string">Freescale</span> <span class="hljs-string">FEC</span> <span class="hljs-string">PHY</span> <span class="hljs-string">driver</span> [<span class="hljs-string">Generic</span> <span class="hljs-string">PHY</span>] <span class="hljs-string">(mii_bus:phy_addr=20b4000.ethernet:01,</span> <span class="hljs-string">irq=-1)</span><br><span class="hljs-attr">IPv6:</span> <span class="hljs-string">ADDRCONF(NETDEV_UP):</span> <span class="hljs-attr">eth0:</span> <span class="hljs-string">link</span> <span class="hljs-string">is</span> <span class="hljs-string">not</span> <span class="hljs-string">ready</span><br><span class="hljs-string">done.</span><br><span class="hljs-attr">Starting system message bus:</span> <span class="hljs-string">Starting</span> <span class="hljs-string">Xserver</span><br><span class="hljs-string">dbus.</span><br><span class="hljs-string">Starting</span> <span class="hljs-string">Connection</span> <span class="hljs-string">Manager</span><br><span class="hljs-attr">Starting Dropbear SSH server:</span> <span class="hljs-string">dropbear.</span><br><span class="hljs-string">Starting</span> <span class="hljs-string">rpcbind</span> <span class="hljs-string">daemon...done.</span><br><span class="hljs-attr">starting statd:</span> <span class="hljs-string">done</span><br><span class="hljs-attr">Starting advanced power management daemon:</span> <span class="hljs-literal">No</span> <span class="hljs-string">APM</span> <span class="hljs-string">support</span> <span class="hljs-string">in</span> <span class="hljs-string">kernel</span><br><span class="hljs-string">(failed.)</span><br><span class="hljs-attr">Starting atd:</span> <span class="hljs-string">OK</span><br><span class="hljs-attr">exportfs:</span> <span class="hljs-string">can&#x27;t</span> <span class="hljs-string">open</span> <span class="hljs-string">/etc/exports</span> <span class="hljs-string">for</span> <span class="hljs-string">reading</span><br><span class="hljs-string">NFS</span> <span class="hljs-string">daemon</span> <span class="hljs-string">support</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">in</span> <span class="hljs-string">kernel</span><br><span class="hljs-string">Starting</span> <span class="hljs-string">system</span> <span class="hljs-string">log</span> <span class="hljs-string">daemon...0</span><br><span class="hljs-string">Starting</span> <span class="hljs-string">kernel</span> <span class="hljs-string">log</span> <span class="hljs-string">daemon...0</span><br> <span class="hljs-string">*</span> <span class="hljs-attr">Starting Avahi mDNS/DNS-SD Daemon:</span> <span class="hljs-string">avahi-daemon</span>                       [ <span class="hljs-string">ok</span> ]<br><span class="hljs-string">Starting</span> <span class="hljs-string">Telephony</span> <span class="hljs-string">daemon</span><br><span class="hljs-string">Starting</span> <span class="hljs-string">Linux</span> <span class="hljs-string">NFC</span> <span class="hljs-string">daemon</span><br><span class="hljs-attr">Starting crond:</span> <span class="hljs-string">OK</span><br><span class="hljs-string">Running</span> <span class="hljs-string">local</span> <span class="hljs-string">boot</span> <span class="hljs-string">scripts</span> <span class="hljs-string">(/etc/rc.local).</span><br><br><span class="hljs-string">root@ATK-IMX6U:~#</span> <span class="hljs-attr">fec 20b4000.ethernet eth0:</span> <span class="hljs-string">Link</span> <span class="hljs-string">is</span> <span class="hljs-string">Up</span> <span class="hljs-bullet">-</span> <span class="hljs-string">100Mbps/Full</span> <span class="hljs-bullet">-</span> <span class="hljs-string">flow</span> <span class="hljs-string">control</span> <span class="hljs-string">rx/tx</span><br><span class="hljs-attr">IPv6:</span> <span class="hljs-string">ADDRCONF(NETDEV_CHANGE):</span> <span class="hljs-attr">eth0:</span> <span class="hljs-string">link</span> <span class="hljs-string">becomes</span> <span class="hljs-string">ready</span><br><span class="hljs-attr">random:</span> <span class="hljs-string">nonblocking</span> <span class="hljs-string">pool</span> <span class="hljs-string">is</span> <span class="hljs-string">initialized</span><br></code></pre></td></tr></table></figure>

<p>其中<br><code>ethernet eth0: Freescale FEC PHY driver [Generic PHY] (mii_bus:phy_addr=20b4000.ethernet:01, irq=-1)</code><br>表示使用默认通用网络驱动</p>
<p><code>root@ATK-IMX6U:~# fec 20b4000.ethernet eth0: Link is Up - 100Mbps/Full - flow control rx/tx IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready </code><br>表示端口0已经连接上网络，可以发现，网络是可以用的，</p>
<p>使用ping和ifconfig测试网络都没问题</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs vim"><br>PING <span class="hljs-number">192.168</span>.<span class="hljs-number">0.254</span> (<span class="hljs-number">192.168</span>.<span class="hljs-number">0.254</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) bytes of data.<br><span class="hljs-number">64</span> bytes from <span class="hljs-number">192.168</span>.<span class="hljs-number">0.254</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">99.2</span> ms<br><span class="hljs-number">64</span> bytes from <span class="hljs-number">192.168</span>.<span class="hljs-number">0.254</span>: icmp_seq=<span class="hljs-number">2</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">3.28</span> ms<br>^C<br>--- <span class="hljs-number">192.168</span>.<span class="hljs-number">0.254</span> ping statistics ---<br><span class="hljs-number">11</span> packets transmitted, <span class="hljs-number">11</span> received, <span class="hljs-number">0</span>% packet loss, time <span class="hljs-number">10016</span>ms<br>rtt <span class="hljs-built_in">min</span>/avg/<span class="hljs-built_in">max</span>/mdev = <span class="hljs-number">2.294</span>/<span class="hljs-number">18.786</span>/<span class="hljs-number">99.204</span>/<span class="hljs-number">32.362</span> ms<br>root@ATK-IMX6U:~# ifconfig<br>eth0      Link encap:Ethernet  HWaddr b8:ae:<span class="hljs-number">1</span>d:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><br>          inet addr:<span class="hljs-number">192.168</span>.<span class="hljs-number">0.174</span>  Bcas<span class="hljs-variable">t:192</span>.<span class="hljs-number">168.0</span>.<span class="hljs-number">255</span>  Mask:<span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span><br>          inet6 addr: fe80::baae:<span class="hljs-number">1</span>dff:fe01:<span class="hljs-number">0</span>/<span class="hljs-number">64</span> Scope:Link<br>          UP BROADCAST RUNNING MULTICAST  MTU:<span class="hljs-number">1500</span>  Metric:<span class="hljs-number">1</span><br>          RX packet<span class="hljs-variable">s:1634</span> error<span class="hljs-variable">s:0</span> dropped:<span class="hljs-number">0</span> overrun<span class="hljs-variable">s:0</span> frame:<span class="hljs-number">0</span><br>          TX packet<span class="hljs-variable">s:109</span> error<span class="hljs-variable">s:0</span> dropped:<span class="hljs-number">0</span> overrun<span class="hljs-variable">s:0</span> carrier:<span class="hljs-number">0</span><br>          collision<span class="hljs-variable">s:0</span> txqueuelen:<span class="hljs-number">1000</span><br>          RX byte<span class="hljs-variable">s:193151</span> (<span class="hljs-number">188.6</span> KiB)  TX byte<span class="hljs-variable">s:12995</span> (<span class="hljs-number">12.6</span> KiB)<br><br><span class="hljs-keyword">lo</span>        Link encap:Local Loopback<br>          inet addr:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>  Mask:<span class="hljs-number">255.0</span>.<span class="hljs-number">0.0</span><br>          inet6 addr: ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span> Scope:Host<br>          UP LOOPBACK RUNNING  MTU:<span class="hljs-number">65536</span>  Metric:<span class="hljs-number">1</span><br>          RX packet<span class="hljs-variable">s:14</span> error<span class="hljs-variable">s:0</span> dropped:<span class="hljs-number">0</span> overrun<span class="hljs-variable">s:0</span> frame:<span class="hljs-number">0</span><br>          TX packet<span class="hljs-variable">s:14</span> error<span class="hljs-variable">s:0</span> dropped:<span class="hljs-number">0</span> overrun<span class="hljs-variable">s:0</span> carrier:<span class="hljs-number">0</span><br>          collision<span class="hljs-variable">s:0</span> txqueuelen:<span class="hljs-number">0</span><br>          RX byte<span class="hljs-variable">s:1552</span> (<span class="hljs-number">1.5</span> KiB)  TX byte<span class="hljs-variable">s:1552</span> (<span class="hljs-number">1.5</span> KiB)<br><br><br></code></pre></td></tr></table></figure>

<p>那为什么修改呢，主要是因为使用默认驱动时网络是没有问题，但硬件终究是不同的，不保证后期使用时不会有问题，比如复位网络等功能。所以这里还是要修改一下，将通用网络驱动改为芯片对应的驱动，即<code>SMSC LAN8720</code>。</p>
<h6 id="1-修改-LAN8720-的复位以及网络时钟引脚驱动"><a href="#1-修改-LAN8720-的复位以及网络时钟引脚驱动" class="headerlink" title="1. 修改 LAN8720 的复位以及网络时钟引脚驱动"></a>1. 修改 LAN8720 的复位以及网络时钟引脚驱动</h6><p>ENET1 复位引脚 ENET1_RST 连接在 I.M6ULL 的 SNVS_TAMPER7 这个引脚上。ENET2的复位引脚 ENET2_RST 连接在 I.MX6ULL 的 SNVS_TAMPER8 上。打开设备树文件 imx6ull-alientek-emmc.dts，找到如下代码：</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">584 </span>pinctrl_spi4: spi4grp &#123;<br><span class="hljs-number">585</span>				fsl,pins = &lt;<br><span class="hljs-number">586</span>						MX6ULL_PAD_BOOT_MODE0__GPIO5_IO10        <span class="hljs-number">0</span>x70a1<br><span class="hljs-number">587</span>						MX6ULL_PAD_BOOT_MODE1__GPIO5_IO11        <span class="hljs-number">0</span>x70a1<br><span class="hljs-number">588</span>						/* MX6ULL_PAD_SNVS_TAMPER7__GPIO5_IO07      <span class="hljs-number">0</span>x70a1 */<br><span class="hljs-number">589</span>						/* MX6ULL_PAD_SNVS_TAMPER8__GPIO5_IO08      <span class="hljs-number">0</span>x80000000 */<br><span class="hljs-number">590</span>				&gt;;<br><span class="hljs-number">591</span>			&#125;;<br></code></pre></td></tr></table></figure>
<p>588 和 589 行就是初始化 SNVS_TAMPER7 和 SNVS_TAMPER8 这两个引脚的，不过是作为了 SPI4 的 IO（开发板中这两个引脚是LAN芯片的复位引脚），这不是我们想要的，所以将 588 和 589 这两行屏蔽！后继续在 imx6ull-alientek-emmc.dts 中找到如下所示代码：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">125</span> spi4 &#123;<br><span class="hljs-number">126</span> compatible = <span class="hljs-string">&quot;spi-gpio&quot;</span>;<br><span class="hljs-number">127</span> pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br><span class="hljs-number">128</span> pinctrl-<span class="hljs-number">0</span> = &lt;&amp;pinctrl_spi4&gt;;<br><span class="hljs-number">129</span> <span class="hljs-regexp">/* pinctrl-assert-gpios = &lt;&amp;gpio5 8 GPIO_ACTIVE_LOW&gt;; */</span><br>......<br><span class="hljs-number">133</span> <span class="hljs-regexp">/* cs-gpios = &lt;&amp;gpio5 7 0&gt;; */</span><br></code></pre></td></tr></table></figure>

<p>第 129 行，设置 GPIO5_IO08 为 SPI4 的一个功能引脚，而 GPIO5_IO08 就是 SNVS_TAMPER8 的 GPIO 功能引脚。<br>第 133 行，设置 GPIO5_IO07 作为 SPI4 的片选引脚，而 GPIO5_IO07 就是 SNVS_TAMPER7的 GPIO 功能引脚。<br>现在我们需要 GPIO5_IO07 和 GPIO5_IO08 分别作为 ENET1 和 ENET2 的复位引脚，将示例代码 37.4.3.2 中的第 129 行和第 133 行处的代码屏蔽掉！！否则会干扰到网络复位引脚！</p>
<p>在 imx6ull-alientek-emmc.dts 里面找到名为“iomuxc_snvs”的节点(561行)，然后在此节点下添加网络复位引脚信息，添加完成以后的“iomuxc_snvs”的节点内容如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">&amp;iomuxc_snvs &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default_snvs&quot;</span>;<br>        pinctrl-<span class="hljs-number">0</span> = &lt;&amp;pinctrl_hog_2&gt;;<br>        imx6ul-evk &#123;<br>......<br><span class="hljs-regexp">/*省略掉其他*/</span><br>				<br>				<span class="hljs-regexp">/*enet1 reset lonly*/</span><br>				pinctrl_enet1_reset: enet1resetgrp &#123;<br>					fsl,pins = &lt;<br>						<span class="hljs-regexp">/* used for enet1 reset */</span><br>						MX6ULL_PAD_SNVS_TAMPER7__GPIO5_IO07 <span class="hljs-number">0</span>x10B0<br>					&gt;;<br><br>				&#125;;<br>				<span class="hljs-regexp">/*enet2 reset lonly*/</span><br>				pinctrl_enet2_reset: enet2resetgrp &#123;<br>					fsl,pins = &lt;<br>					<span class="hljs-regexp">/* used for enet2 reset */</span><br>						MX6ULL_PAD_SNVS_TAMPER8__GPIO5_IO08 <span class="hljs-number">0</span>x10B0<br>					&gt;;<br>				&#125;;<br>        &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>第 1 行，imx6ull-alientek-emmc.dts 文件中 iomuxc_snvs 节点。<br>第 45<del>50 行，ENET1 网络复位引脚配置信息。<br>第 53</del>58 行，ENET2 网络复位引脚配置信息。<br>最后还需要修改一下 ENET1 和 ENET2 的网络时钟引脚配置，继续在 imx6ull-alientek-emmc.dts 中找到如下所示代码：</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">309 </span>pinctrl_enet1: enet1grp &#123;<br><span class="hljs-symbol">310 </span>fsl,pins = &lt;<br><span class="hljs-symbol">311 </span>MX6UL_PAD_ENET1_RX_EN__ENET1_RX_EN<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">312 </span>MX6UL_PAD_ENET1_RX_ER__ENET1_RX_ER<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">313 </span>MX6UL_PAD_ENET1_RX_DATA0__ENET1_RDATA00 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">314 </span>MX6UL_PAD_ENET1_RX_DATA1__ENET1_RDATA01 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">315 </span>MX6UL_PAD_ENET1_TX_EN__ENET1_TX_EN<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">316 </span>MX6UL_PAD_ENET1_TX_DATA0__ENET1_TDATA00 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">317 </span>MX6UL_PAD_ENET1_TX_DATA1__ENET1_TDATA01 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">318 </span>MX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1 <span class="hljs-number">0</span>x4001b009<br><span class="hljs-symbol">319 </span>&gt;;<br><span class="hljs-symbol">320 </span>&#125;;<br><span class="hljs-number">321</span><br><span class="hljs-symbol">322 </span>pinctrl_enet2: enet2grp &#123;<br><span class="hljs-symbol">323 </span>fsl,pins = &lt;<br><span class="hljs-symbol">324 </span>MX6UL_PAD_GPIO1_IO07__ENET2_MDC<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">325 </span>MX6UL_PAD_GPIO1_IO06__ENET2_MDIO<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">326 </span>MX6UL_PAD_ENET2_RX_EN__ENET2_RX_EN<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">327 </span>MX6UL_PAD_ENET2_RX_ER__ENET2_RX_ER<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">328 </span>MX6UL_PAD_ENET2_RX_DATA0__ENET2_RDATA00 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">329 </span>MX6UL_PAD_ENET2_RX_DATA1__ENET2_RDATA01 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">330 </span>MX6UL_PAD_ENET2_TX_EN__ENET2_TX_EN<br><span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">331 </span>MX6UL_PAD_ENET2_TX_DATA0__ENET2_TDATA00 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">332 </span>MX6UL_PAD_ENET2_TX_DATA1__ENET2_TDATA01 <span class="hljs-number">0</span>x1b0b0<br><span class="hljs-symbol">333 </span>MX6UL_PAD_ENET2_TX_CLK__ENET2_REF_CLK2 <span class="hljs-number">0</span>x4001b009<br><span class="hljs-symbol">334 </span>&gt;;<br><span class="hljs-symbol">335 </span>&#125;;<br></code></pre></td></tr></table></figure>
<p>第 318 和 333 行，分别为 ENET1 和 ENET2 的网络时钟引脚配置信息，将这两个引脚的电气属性值改为 0x4001b009，原来默认值为 0x4001b031。修改完成以后记得保存一下 imx6ull-alientek-emmc.dts，网络复位以及时钟引脚驱动就修改好了</p>
<h6 id="2、修改-fec1-和-fec2-节点的-pinctrl-0-属性"><a href="#2、修改-fec1-和-fec2-节点的-pinctrl-0-属性" class="headerlink" title="2、修改 fec1 和 fec2 节点的 pinctrl-0 属性"></a>2、修改 fec1 和 fec2 节点的 pinctrl-0 属性</h6><p>在 imx6ull-alientek-emmc.dts 文件中找到名为“fec1”和“fec2”的这两个节点，修改其中的“pinctrl-0”属性值，修改以后如下所示：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dts"> <span class="hljs-variable">&amp;fec1</span> <span class="hljs-punctuation">&#123;</span><br> 	<span class="hljs-attr">pinctrl-names</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">;</span><br> 	pinctrl<span class="hljs-number">-0</span> = <span class="hljs-params">&lt;<span class="hljs-variable">&amp;pinctrl_enet1</span> <span class="hljs-variable">&amp;pinctrl_enet1_reset</span>&gt;</span><span class="hljs-punctuation">;</span><br> 	<span class="hljs-attr">phy-mode</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmii&quot;</span><span class="hljs-punctuation">;</span><br> 	<span class="hljs-attr">phy-handle</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-variable">&amp;ethphy0</span>&gt;</span><span class="hljs-punctuation">;</span><br> 	<span class="hljs-attr">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;okay&quot;</span><span class="hljs-punctuation">;</span><br> <span class="hljs-punctuation">&#125;;</span><br> <span class="hljs-variable">&amp;fec2</span> <span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">pinctrl-names</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">;</span><br>	pinctrl<span class="hljs-number">-0</span> = <span class="hljs-params">&lt;<span class="hljs-variable">&amp;pinctrl_enet2</span> <span class="hljs-variable">&amp;pinctrl_enet2_reset</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">phy-mode</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmii&quot;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">phy-handle</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-variable">&amp;ethphy1</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;okay&quot;</span><span class="hljs-punctuation">;</span><br>......<br><span class="hljs-punctuation">&#125;;</span><br></code></pre></td></tr></table></figure>
<p>第 3<del>4 行，修改后的 fec1 节点“pinctrl-0”属性值。<br>第 14</del>15 行，修改后的 fec2 节点“pinctrl-0”属性值。</p>
<h6 id="3、修改-LAN8720A-的-PHY-地址"><a href="#3、修改-LAN8720A-的-PHY-地址" class="headerlink" title="3、修改 LAN8720A 的 PHY 地址"></a>3、修改 LAN8720A 的 PHY 地址</h6><p>在 uboot 移植章节中，我们说过 ENET1 的 LAN8720A 地址为 0x0，ENET2 的 LAN8720A地址为 0x1。在 imx6ull-alientek-emmc.dts 中找到如下代码（还是上述“fec1”和“fec2”的这两个节点）：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-number">171</span> <span class="hljs-variable">&amp;fec1</span> <span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">pinctrl-names</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">;</span><br>	pinctrl<span class="hljs-number">-0</span> = <span class="hljs-params">&lt;<span class="hljs-variable">&amp;pinctrl_enet1</span> <span class="hljs-variable">&amp;pinctrl_enet1_reset</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">phy-mode</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmii&quot;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">phy-handle</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-variable">&amp;ethphy0</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;okay&quot;</span><span class="hljs-punctuation">;</span><br><span class="hljs-number">178</span> <span class="hljs-punctuation">&#125;;</span><br><br><span class="hljs-number">180</span> <span class="hljs-variable">&amp;fec2</span> <span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">pinctrl-names</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">;</span><br>	pinctrl<span class="hljs-number">-0</span> = <span class="hljs-params">&lt;<span class="hljs-variable">&amp;pinctrl_enet2</span> <span class="hljs-variable">&amp;pinctrl_enet2_reset</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">phy-mode</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmii&quot;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">phy-handle</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-variable">&amp;ethphy1</span>&gt;</span><span class="hljs-punctuation">;</span><br>	<span class="hljs-attr">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;okay&quot;</span><span class="hljs-punctuation">;</span><br><br><span class="hljs-number">186</span>	<span class="hljs-title class_">mdio</span> <span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-meta">#address-cells = &lt;1&gt;;</span><br>		<span class="hljs-meta">#size-cells = &lt;0&gt;;</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">		ethphy0:</span> <span class="hljs-title class_">ethernet-phy@2</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">compatible</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ethernet-phy-ieee802.3-c22&quot;</span><span class="hljs-punctuation">;</span><br>			<span class="hljs-attr">reg</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">2</span>&gt;</span><span class="hljs-punctuation">;</span><br>		<span class="hljs-punctuation">&#125;;</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">		ethphy1:</span> <span class="hljs-title class_">ethernet-phy@1</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">compatible</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ethernet-phy-ieee802.3-c22&quot;</span><span class="hljs-punctuation">;</span><br>			<span class="hljs-attr">reg</span> <span class="hljs-operator">=</span> <span class="hljs-params">&lt;<span class="hljs-number">1</span>&gt;</span><span class="hljs-punctuation">;</span><br><span class="hljs-number">198</span>		<span class="hljs-punctuation">&#125;;</span><br>	<span class="hljs-punctuation">&#125;;</span><br><span class="hljs-number">200</span> <span class="hljs-punctuation">&#125;;</span><br></code></pre></td></tr></table></figure>
<p>第 171<del>177 行，ENET1 对应的设备树节点。<br>第 179</del>200 行，ENET2 对应的设备树节点。但是第 186~198 行的 mdio 节点描述了 ENET1和 ENET2 的 PHY 地址信息。将示例代码 37.4.3.6 改为如下内容：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">&amp;fec1 &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br>	pinctrl-0 = <span class="hljs-variable">&lt;&amp;pinctrl_enet1 &amp;pinctrl_enet1_reset&gt;</span>;<br>	phy-mode = <span class="hljs-string">&quot;rmii&quot;</span>;<br>	phy-handle = <span class="hljs-variable">&lt;&amp;ethphy0&gt;</span>;<br>177	phy-reset-gpios = <span class="hljs-variable">&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;</span>;<br>178	phy-reset-duration = <span class="hljs-variable">&lt;200&gt;</span>;<br>	status = <span class="hljs-string">&quot;okay&quot;</span>;<br>&#125;;<br><br>&amp;fec2 &#123;<br>	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;<br>	pinctrl-0 = <span class="hljs-variable">&lt;&amp;pinctrl_enet2 &amp;pinctrl_enet2_reset&gt;</span>;<br>	phy-mode = <span class="hljs-string">&quot;rmii&quot;</span>;<br>	phy-handle = <span class="hljs-variable">&lt;&amp;ethphy1&gt;</span>;<br>188	phy-reset-gpios = <span class="hljs-variable">&lt;&amp;gpio5 8 GPIO_ACTIVE_LOW&gt;</span>;<br>189 phy-reset-duration = <span class="hljs-variable">&lt;200&gt;</span>;<br>	status = <span class="hljs-string">&quot;okay&quot;</span>;<br><br>	mdio &#123;<br>		<span class="hljs-comment">#address-cells = &lt;1&gt;;</span><br>		<span class="hljs-comment">#size-cells = &lt;0&gt;;</span><br><br>196		ethphy0: ethernet-phy<span class="hljs-meta">@2</span> &#123;<br>			compatible = <span class="hljs-string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;<br>198			smsc,disable-energy-detect;<br>199			reg = <span class="hljs-variable">&lt;0&gt;</span>;<br>		&#125;;<br><br>202		ethphy1: ethernet-phy<span class="hljs-meta">@1</span> &#123;<br>			compatible = <span class="hljs-string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;<br>204			smsc,disable-energy-detect;<br>205			reg = <span class="hljs-variable">&lt;1&gt;</span>;<br>		&#125;;<br>	&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>第 177 和 178 行，添加了 ENET1 网络复位引脚所使用的 IO 为 GPIO5_IO07，低电平有效。复位低电平信号持续时间为 200ms。<br>第 188 和 189 行，ENET2 网络复位引脚所使用的 IO 为 GPIO5_IO08，同样低电平有效，持续时间同样为 200ms。<br>第 198 和 204 行，“smsc,disable-energy-detect”表明 PHY 芯片是 SMSC 公司的，这样 Linux内核就会找到 SMSC 公司的 PHY 芯片驱动来驱动 LAN8720A。<br>第 196 行，注意“ethernet-phy@”后面的数字是 PHY 的地址，ENET1 的 PHY 地址为 0，所以“@”后面是 0(默认为 2)。<br>第 199 行，reg 的值也表示 PHY 地址，ENET1 的 PHY 地址为 0，所以 reg&#x3D;0。<br>第 202 行，ENET2 的 PHY 地址为 1，因此“@”后面为 1。<br>第 205 行，因为 ENET2 的 PHY 地址为 1，所以 reg&#x3D;1。</p>
<p>至此，LAN8720A 的 PHY 地址就改好了，保存一下 imx6ull-alientek-emmc.dts 文件。然后使用“make dtbs”命令重新编译一下设备树。</p>
<h6 id="4、修改-fec-main-c-文件"><a href="#4、修改-fec-main-c-文件" class="headerlink" title="4、修改 fec_main.c 文件"></a>4、修改 fec_main.c 文件</h6><p>要在 I.MX6ULL上使用LAN8720A，需要修改一下Linux内核源码，打开drivers&#x2F;net&#x2F;ethernet&#x2F;freescale&#x2F;fec_main.c，找到函数 fec_probe，在 fec_probe 中加入如下代码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-number">3438 </span><span class="hljs-string">static</span> <span class="hljs-string">int</span><br><span class="hljs-number">3439 </span><span class="hljs-string">fec_probe(struct</span> <span class="hljs-string">platform_device</span> <span class="hljs-string">*pdev)</span><br><span class="hljs-number">3440</span> &#123;<br><span class="hljs-number">3441 </span><span class="hljs-string">struct</span> <span class="hljs-string">fec_enet_private</span> <span class="hljs-string">*fep;</span><br><span class="hljs-number">3442 </span><span class="hljs-string">struct</span> <span class="hljs-string">fec_platform_data</span> <span class="hljs-string">*pdata;</span><br><span class="hljs-number">3443 </span><span class="hljs-string">struct</span> <span class="hljs-string">net_device</span> <span class="hljs-string">*ndev;</span><br><span class="hljs-number">3444 </span><span class="hljs-string">int</span> <span class="hljs-string">i</span>, <span class="hljs-string">irq</span>, <span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span><span class="hljs-string">;</span><br><span class="hljs-number">3445 </span><span class="hljs-string">struct</span> <span class="hljs-string">resource</span> <span class="hljs-string">*r;</span><br><span class="hljs-number">3446 </span><span class="hljs-string">const</span> <span class="hljs-string">struct</span> <span class="hljs-string">of_device_id</span> <span class="hljs-string">*of_id;</span><br><span class="hljs-number">3447 </span><span class="hljs-string">static</span> <span class="hljs-string">int</span> <span class="hljs-string">dev_id;</span><br><span class="hljs-number">3448 </span><span class="hljs-string">struct</span> <span class="hljs-string">device_node</span> <span class="hljs-string">*np</span> <span class="hljs-string">=</span> <span class="hljs-string">pdev-&gt;dev.of_node</span>, <span class="hljs-string">*phy_node;</span><br><span class="hljs-number">3449 </span><span class="hljs-string">int</span> <span class="hljs-string">num_tx_qs;</span><br><span class="hljs-number">3450 </span><span class="hljs-string">int</span> <span class="hljs-string">num_rx_qs;</span><br><span class="hljs-number">3451</span><br><span class="hljs-number">3452</span> <span class="hljs-string">/*</span> <span class="hljs-string">设置</span> <span class="hljs-string">MX6UL_PAD_ENET1_TX_CLK</span> <span class="hljs-string">和</span> <span class="hljs-string">MX6UL_PAD_ENET2_TX_CLK</span><br><span class="hljs-number">3453</span> <span class="hljs-string">*</span> <span class="hljs-string">这两个</span> <span class="hljs-string">IO</span> <span class="hljs-string">的复用寄存器的</span> <span class="hljs-string">SION</span> <span class="hljs-string">位为</span> <span class="hljs-number">1</span><span class="hljs-string">。</span><br><span class="hljs-number">3454</span> <span class="hljs-string">*/</span><br><span class="hljs-number">3455 </span><span class="hljs-string">void</span> <span class="hljs-string">__iomem</span> <span class="hljs-string">*IMX6U_ENET1_TX_CLK;</span><br><span class="hljs-number">3456 </span><span class="hljs-string">void</span> <span class="hljs-string">__iomem</span> <span class="hljs-string">*IMX6U_ENET2_TX_CLK;</span><br><span class="hljs-number">3457</span><br><span class="hljs-number">3458 </span><span class="hljs-string">IMX6U_ENET1_TX_CLK</span> <span class="hljs-string">=</span> <span class="hljs-string">ioremap(0X020E00DC</span>, <span class="hljs-number">4</span><span class="hljs-string">);</span><br><span class="hljs-number">3459 </span><span class="hljs-string">writel(0X14</span>, <span class="hljs-string">IMX6U_ENET1_TX_CLK);</span><br><span class="hljs-number">3460</span><br><span class="hljs-number">3461 </span><span class="hljs-string">IMX6U_ENET2_TX_CLK</span> <span class="hljs-string">=</span> <span class="hljs-string">ioremap(0X020E00FC</span>, <span class="hljs-number">4</span><span class="hljs-string">);</span><br><span class="hljs-number">3462 </span><span class="hljs-string">writel(0X14</span>, <span class="hljs-string">IMX6U_ENET2_TX_CLK);</span><br><span class="hljs-number">3463</span><br><span class="hljs-string">......</span><br><span class="hljs-number">3656 </span><span class="hljs-string">return</span> <span class="hljs-string">ret;</span><br><span class="hljs-number">3657</span> &#125;<br></code></pre></td></tr></table></figure>
<p>第 3455~3462 就是新加入的代码，如果要在 I.MX6ULL 上使用 LAN8720A 就需要设置ENET1 和 ENET2 的 TX_CLK 引脚复位寄存器的 SION 位为 1。</p>
<h6 id="5、配置-Linux-内核，使能-LAN8720-驱动"><a href="#5、配置-Linux-内核，使能-LAN8720-驱动" class="headerlink" title="5、配置 Linux 内核，使能 LAN8720 驱动"></a>5、配置 Linux 内核，使能 LAN8720 驱动</h6><p>在 imx_alientek_emmc_defconfig 添加如下代码（任意行）：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_SMSC_PHY</span>=y<br></code></pre></td></tr></table></figure>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make imx_alientek_emmc_defconfig</span><br></code></pre></td></tr></table></figure>
<h6 id="6、修改-smsc-c"><a href="#6、修改-smsc-c" class="headerlink" title="6、修改 smsc.c"></a>6、修改 smsc.c</h6><p>鉴于 LAN8720A 有“前车之鉴”，那就是在 uboot 中需要对LAN8720A 进行一次软复位，要设置 LAN8720A 的 BMCR(寄存器地址为 0)寄存器 bit15 为 1。所以我猜测，在 Linux 中也需要对 LAN8720A 进行一次软复位。</p>
<p>首先需要找到 LAN8720A 的驱动文件，LAN8720A 的驱动文件是 drivers&#x2F;net&#x2F;phy&#x2F;smsc.c，在此文件中有个叫做 smsc_phy_reset 的函数，看名字都知道这是 SMSC PHY 的复位函数，因此，LAN8720A 肯定也会使用到这个复位函数，修改此函数的内容，修改以后的 smsc_phy_reset函数内容如下所示</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static <span class="hljs-built_in">int</span> smsc<span class="hljs-constructor">_phy_reset(<span class="hljs-params">struct</span> <span class="hljs-params">phy_device</span> <span class="hljs-operator">*</span><span class="hljs-params">phydev</span>)</span><br>&#123;<br><br>	<span class="hljs-built_in">int</span> err, phy_reset;<br>	<span class="hljs-built_in">int</span> msec = <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">struct</span> device_node *np;<br>	<span class="hljs-built_in">int</span> timeout = <span class="hljs-number">50000</span>;<br><span class="hljs-number">7</span>	<span class="hljs-keyword">if</span>(phydev-&gt;addr<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) <span class="hljs-comment">/* FEC1 */</span> &#123;<br>		np = <span class="hljs-keyword">of</span><span class="hljs-constructor">_find_node_by_path(<span class="hljs-string">&quot;/soc/aips-bus@02100000/ethernet@02188000&quot;</span>)</span>;<br>		<span class="hljs-keyword">if</span>(np<span class="hljs-operator"> == </span>NULL) &#123;<br>			return -EINVAL;<br>		&#125;<br><span class="hljs-number">12</span>	&#125;<br><br><span class="hljs-number">14</span>	<span class="hljs-keyword">if</span>(phydev-&gt;addr<span class="hljs-operator"> == </span><span class="hljs-number">1</span>) <span class="hljs-comment">/* FEC2 */</span> &#123;<br>		np = <span class="hljs-keyword">of</span><span class="hljs-constructor">_find_node_by_path(<span class="hljs-string">&quot;/soc/aips-bus@02000000/ethernet@020b4000&quot;</span>)</span>;<br>		<span class="hljs-keyword">if</span>(np<span class="hljs-operator"> == </span>NULL) &#123;<br>			return -EINVAL;<br>		&#125;<br><span class="hljs-number">19</span>	&#125;<br><br><span class="hljs-number">21</span>  err = <span class="hljs-keyword">of</span><span class="hljs-constructor">_property_read_u32(<span class="hljs-params">np</span>, <span class="hljs-string">&quot;phy-reset-duration&quot;</span>, &amp;<span class="hljs-params">msec</span>)</span>;<br>	<span class="hljs-comment">/* A sane reset duration should not be longer than 1s */</span><br>	<span class="hljs-keyword">if</span> (!err<span class="hljs-operator"> &amp;&amp; </span>msec &gt; <span class="hljs-number">1000</span>)<br>		msec = <span class="hljs-number">1</span>;<br><span class="hljs-number">25</span>	phy_reset = <span class="hljs-keyword">of</span><span class="hljs-constructor">_get_named_gpio(<span class="hljs-params">np</span>, <span class="hljs-string">&quot;phy-reset-gpios&quot;</span>, 0)</span>;<br>	<span class="hljs-keyword">if</span> (!gpio<span class="hljs-constructor">_is_valid(<span class="hljs-params">phy_reset</span>)</span>)<br>		return;<br><span class="hljs-number">29</span>	gpio<span class="hljs-constructor">_direction_output(<span class="hljs-params">phy_reset</span>, 0)</span>;<br>	gpio<span class="hljs-constructor">_set_value(<span class="hljs-params">phy_reset</span>, 0)</span>;<br><br>	msleep(msec);<br><span class="hljs-number">32</span>	gpio<span class="hljs-constructor">_set_value(<span class="hljs-params">phy_reset</span>, 1)</span>;<br>	<span class="hljs-built_in">int</span> rc = phy<span class="hljs-constructor">_read(<span class="hljs-params">phydev</span>, MII_LAN83C185_SPECIAL_MODES)</span>;<br>	<span class="hljs-keyword">if</span> (rc &lt; <span class="hljs-number">0</span>)<br>		return rc;<br><br>		<span class="hljs-comment">/* If the SMSC PHY is in power down mode, then set it</span><br><span class="hljs-comment">			* in all capable mode before using it.</span><br><span class="hljs-comment">		*/</span><br><span class="hljs-number">41</span>	<span class="hljs-keyword">if</span> ((rc &amp; MII_LAN83C185_MODE_MASK) ==MII_LAN83C185_MODE_POWERDOWN) &#123;<br>	<span class="hljs-comment">/* set &quot;all capable&quot; mode and reset the phy */</span><br><br>		rc <span class="hljs-pattern-match">|= <span class="hljs-constructor">MII_LAN83C185_MODE_ALL</span>;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">		phy<span class="hljs-constructor">_write(<span class="hljs-params">phydev</span>, MII_LAN83C185_SPECIAL_MODES, <span class="hljs-params">rc</span>)</span>;</span><br><span class="hljs-pattern-match">	&#125;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">48	phy<span class="hljs-constructor">_write(<span class="hljs-params">phydev</span>, MII_BMCR, BMCR_RESET)</span>;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">	<span class="hljs-operator">/</span><span class="hljs-operator">*</span> wait <span class="hljs-keyword">end</span> <span class="hljs-keyword">of</span> reset (max 500 ms) <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">	<span class="hljs-keyword">do</span> &#123;</span><br><span class="hljs-pattern-match">		udelay(10);</span><br><span class="hljs-pattern-match">		<span class="hljs-keyword">if</span> (timeout-- <span class="hljs-operator">==</span> 0)</span><br><span class="hljs-pattern-match">			return -1;</span><br><span class="hljs-pattern-match">		rc = phy<span class="hljs-constructor">_read(<span class="hljs-params">phydev</span>, MII_BMCR)</span>;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">		&#125; <span class="hljs-keyword">while</span> (rc &amp; <span class="hljs-constructor">BMCR_RESET</span>);</span><br><span class="hljs-pattern-match">	return 0;</span><br><span class="hljs-pattern-match">&#125;</span><br></code></pre></td></tr></table></figure>
<p>第 7<del>12 行，获取 FEC1 网卡对应的设备节点。<br>第 14</del>19 行，获取 FEC2 网卡对应的设备节点。<br>第 21 行，从设备树中获取“phy-reset-duration”属性信息，也就是复位时间。<br>第 25 行，从设备树中获取“phy-reset-gpios”属性信息，也就是复位 IO。<br>第 29<del>32 行，设置 PHY 的复位 IO，复位 LAN8720A。<br>第 41</del>48 行，以前的 smsc_phy_reset 函数会判断 LAN8720 是否处于 Powerdown 模式，只有处于 Powerdown 模式的时候才会软复位 LAN8720。这里我们将软复位代码移出来，这样每次调用 smsc_phy_reset 函数 LAN8720A 都会被软复位。<br>最 后 我 们还 需 要在 drivers&#x2F;net&#x2F;phy&#x2F;smsc.c 文 件中添 加 两 个头 文 件， 因为修 改 后的smsc_phy_reset 函数用到了 gpio_direction_output 和 gpio_set_value 这两个函数，需要添加的头文件如下所示：<br>#include &lt;linux&#x2F;of_gpio.h&gt;<br>#include &lt;linux&#x2F;io.h&gt;</p>
<h6 id="7-测试"><a href="#7-测试" class="headerlink" title="7. 测试"></a>7. 测试</h6><p>重新编译linux内核，得到新的镜像文件和设备树文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">starting statd: fec 2188000.ethernet eth1:</span> <span class="hljs-string">Freescale</span> <span class="hljs-string">FEC</span> <span class="hljs-string">PHY</span> <span class="hljs-string">driver</span> [<span class="hljs-string">SMSC</span> <span class="hljs-string">LAN8710/LAN8720</span>] <span class="hljs-string">(mii_bus:phy_addr=20b4000.ethernet:00,</span> <span class="hljs-string">irq=-1)</span><br><span class="hljs-attr">IPv6:</span> <span class="hljs-string">ADDRCONF(NETDEV_UP):</span> <span class="hljs-attr">eth1:</span> <span class="hljs-string">link</span> <span class="hljs-string">is</span> <span class="hljs-string">not</span> <span class="hljs-string">ready</span><br><br><span class="hljs-string">......</span><br><span class="hljs-string">root@ATK-IMX6U:~#</span> <span class="hljs-attr">fec 20b4000.ethernet eth0:</span> <span class="hljs-string">Link</span> <span class="hljs-string">is</span> <span class="hljs-string">Up</span> <span class="hljs-bullet">-</span> <span class="hljs-string">100Mbps/Full</span> <span class="hljs-bullet">-</span> <span class="hljs-string">flow</span> <span class="hljs-string">control</span> <span class="hljs-string">rx/tx</span><br><span class="hljs-attr">IPv6:</span> <span class="hljs-string">ADDRCONF(NETDEV_CHANGE):</span> <span class="hljs-attr">eth0:</span> <span class="hljs-string">link</span> <span class="hljs-string">becomes</span> <span class="hljs-string">ready</span><br></code></pre></td></tr></table></figure>

<p>可以发现网络驱动已经更改为 <code>SMSC LAN8710/LAN8720</code>，并且也已经正常启动。ping测试通过</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">root@ATK-IMX6U:~#<span class="hljs-built_in"> ping </span>192.168.0.254<span class="hljs-built_in"></span><br><span class="hljs-built_in">PING </span>192.168.0.254 (192.168.0.254) 56(84) bytes of data.<br>64 bytes <span class="hljs-keyword">from</span> 192.168.0.254: <span class="hljs-attribute">icmp_seq</span>=1 <span class="hljs-attribute">ttl</span>=64 <span class="hljs-attribute">time</span>=1084 ms<br>64 bytes <span class="hljs-keyword">from</span> 192.168.0.254: <span class="hljs-attribute">icmp_seq</span>=2 <span class="hljs-attribute">ttl</span>=64 <span class="hljs-attribute">time</span>=84.5 ms<br>64 bytes <span class="hljs-keyword">from</span> 192.168.0.254: <span class="hljs-attribute">icmp_seq</span>=3 <span class="hljs-attribute">ttl</span>=64 <span class="hljs-attribute">time</span>=34.7 ms<br>^C<br>--- 192.168.0.254<span class="hljs-built_in"> ping </span>statistics ---<br>3 packets transmitted, 3 received, 0% packet loss, time 2001ms<br>rtt min/avg/max/mdev = 34.771/401.288/1084.497/483.529 ms, pipe 2<br>root@ATK-IMX6U:~#<br></code></pre></td></tr></table></figure>

<p>这里linux的网络是直接启动，但是教程中是要再继续设置的。以下作为备忘：<br>查看网络情况</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ifconfig</span><br></code></pre></td></tr></table></figure>
<p>查看所有网卡</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">ifconfig -<span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure>
<p>打开网卡</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">ifconfig eth0 <span class="hljs-keyword">up</span><br>ifconfig eth1 <span class="hljs-keyword">up</span><br></code></pre></td></tr></table></figure>

<p>设置IP地址</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ifconfig</span> eth0 <span class="hljs-number">192.168.1.251</span><br>ifconfig eth1 <span class="hljs-number">192.168.1.252</span><br></code></pre></td></tr></table></figure>

<h2 id="根文件系统构建"><a href="#根文件系统构建" class="headerlink" title="根文件系统构建"></a>根文件系统构建</h2><h3 id="根文件系统简介"><a href="#根文件系统简介" class="headerlink" title="根文件系统简介"></a>根文件系统简介</h3><p>根文件系统一般也叫做 rootfs，那么什么叫根文件系统？看到“文件系统”这四个字，很多人，包括我第一反应就是 FATFS、FAT、EXT4、YAFFS 和 NTFS 等这样的文件系统。在这里，根文件系统并不是 FATFS 这样的文件系统代码，EXT4 这样的文件系统代码属于 Linux 内核的一部分。Linux 中的根文件系统更像是一个文件夹或者叫做目录(在我看来就是一个文件夹，只不过是特殊的文件夹)，在这个目录里面会有很多的子目录。根目录下和子目录中会有很多的文件，这些文件是 Linux 运行所必须的，比如库、常用的软件和命令、设备文件、配置文件等等。以后我们说到文件系统，如果不特别指明，统一表示根文件系统。</p>
<p>根文件系统是 Linux 内核启动以后挂载(mount)的第一个文件系统，然后从根文件系统中读取初始化脚本，比如 rcS，inittab 等。根文件系统和 Linux 内核是分开的，单独的 Linux 内核是没法正常工作的，必须要搭配根文件系统。如果不提供根文件系统，Linux 内核在启动的时候就会提示内核崩溃(Kernel panic)的提示。</p>
<p>根文件系统的这个“根”字就说明了这个文件系统的重要性，它是其他文件系统的根，没有这个“根”，其他的文件系统或者软件就别想工作。比如我们常用的 ls、mv、ifconfig 等命令其实就是一个个小软件，只是这些软件没有图形界面，而且需要输入命令来运行。这些小软件就保存在根文件系统中，这些小软件是怎么来的呢？这个就是我们本章教程的目的，教大家来构建自己的根文件系统，这个根文件系统是满足 Linux 运行的最小根文件系统，后续我们可以根据自己的实际工作需求不断的去填充这个最小根文件系统，最终使其成为一个相对完善的根文件系统。</p>
<p>在构建根文件系统之前，我们先来看一下根文件系统里面大概都有些什么内容，以 Ubuntu为例，根文件系统的目录名字为‘&#x2F;’，没看错就是一个斜杠，所以输入如下命令就可以进入根目录中：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-keyword">cd</span> /   <span class="hljs-string">//</span>进入根目录<br></code></pre></td></tr></table></figure>
<p>这里就讲解一些常用的子目录：</p>
<h4 id="1、-x2F-bin-目录"><a href="#1、-x2F-bin-目录" class="headerlink" title="1、&#x2F;bin 目录"></a>1、&#x2F;bin 目录</h4><p>看到“bin”大家应该能想到 bin 文件，bin 文件就是可执行文件。所以此目录下存放着系统需要的可执行文件，一般都是一些命令，比如 ls、mv 等命令。此目录下的命令所有的客户都可以使用。</p>
<h4 id="2、-x2F-dev-目录"><a href="#2、-x2F-dev-目录" class="headerlink" title="2、&#x2F;dev 目录"></a>2、&#x2F;dev 目录</h4><p>dev 是 device 的缩写，所以此目录下的文件都是和设备有关的，此目录下的文件都是设备文件。在 Linux 下一切皆文件，即使是硬件设备，也是以文件的形式存在的，比如&#x2F;dev&#x2F;ttymxc0(I.MX6ULL 根目录会有此文件)就表示 I.MX6ULL 的串口 0，我们要想通过串口 0发送或者接收数据就要操作文件&#x2F;dev&#x2F;ttymxc0，通过对文件&#x2F;dev&#x2F;ttymxc0 的读写操作来实现串口0 的数据收发。</p>
<h4 id="3、-x2F-etc-目录"><a href="#3、-x2F-etc-目录" class="headerlink" title="3、&#x2F;etc 目录"></a>3、&#x2F;etc 目录</h4><p>此目录下存放着各种配置文件，大家可以进入 Ubuntu 的 etc 目录看一下，里面的配置文件非常多！但是在嵌入式 Linux 下此目录会很简洁。</p>
<h4 id="4、-x2F-lib-目录"><a href="#4、-x2F-lib-目录" class="headerlink" title="4、&#x2F;lib 目录"></a>4、&#x2F;lib 目录</h4><p>lib 是 library 的简称，也就是库的意思，因此此目录下存放着 Linux 所必须的库文件。这些库文件是共享库，命令和用户编写的应用程序要使用这些库文件。</p>
<h4 id="5、-x2F-mnt-目录"><a href="#5、-x2F-mnt-目录" class="headerlink" title="5、&#x2F;mnt 目录"></a>5、&#x2F;mnt 目录</h4><p>临时挂载目录，一般是空目录，可以在此目录下创建空的子目录，比如&#x2F;mnt&#x2F;sd、&#x2F;mnt&#x2F;usb，这样就可以将 SD 卡或者 U 盘挂载到&#x2F;mnt&#x2F;sd 或者&#x2F;mnt&#x2F;usb 目录中。</p>
<h4 id="6、-x2F-proc-目录"><a href="#6、-x2F-proc-目录" class="headerlink" title="6、&#x2F;proc 目录"></a>6、&#x2F;proc 目录</h4><p>此目录一般是空的，当 Linux 系统启动以后会将此目录作为 proc 文件系统的挂载点，proc是个虚拟文件系统，没有实际的存储设备。proc 里面的文件都是临时存在的，一般用来存储系统运行信息文件。</p>
<h4 id="7、-x2F-usr-目录"><a href="#7、-x2F-usr-目录" class="headerlink" title="7、&#x2F;usr 目录"></a>7、&#x2F;usr 目录</h4><p>要注意，usr 不是 user 的缩写，而是 Unix Software Resource 的缩写，也就是 Unix 操作系统软件资源目录。这里有个小知识点，那就是 Linux 一般被称为类 Unix 操作系统，苹果的 MacOS也是类 Unix 操作系统。关于 Linux 和 Unix 操作系统的渊源大家可以直接在网上找 Linux 的发展历史来看。既然是软件资源目录，因此&#x2F;usr 目录下也存放着很多软件，一般系统安装完成以后此目录占用的空间最多。</p>
<h4 id="8、-x2F-var-目录"><a href="#8、-x2F-var-目录" class="headerlink" title="8、&#x2F;var 目录"></a>8、&#x2F;var 目录</h4><p>此目录存放一些可以改变的数据。</p>
<h4 id="9、-x2F-sbin-目录"><a href="#9、-x2F-sbin-目录" class="headerlink" title="9、&#x2F;sbin 目录"></a>9、&#x2F;sbin 目录</h4><p>此目录页用户存放一些可执行文件，但是此目录下的文件或者说命令只有管理员才能使用，主要用户系统管理。</p>
<h4 id="10、-x2F-sys-目录"><a href="#10、-x2F-sys-目录" class="headerlink" title="10、&#x2F;sys 目录"></a>10、&#x2F;sys 目录</h4><p>系统启动以后此目录作为 sysfs 文件系统的挂载点，sysfs 是一个类似于 proc 文件系统的特殊文件系统，sysfs 也是基于 ram 的文件系统，也就是说它也没有实际的存储设备。此目录是系统设备管理的重要目录，此目录通过一定的组织结构向用户提供详细的内核数据结构信息。</p>
<h4 id="11、-x2F-opt"><a href="#11、-x2F-opt" class="headerlink" title="11、&#x2F;opt"></a>11、&#x2F;opt</h4><p>可选的文件、软件存放区，由用户选择将哪些文件或软件放到此目录中。关于 Linux 的根目录就介绍到这里，接下来的构建根文件系统就是研究如何创建上面这些子目录以及子目录中的文件。</p>
<h3 id="BusyBox-构建根文件系统"><a href="#BusyBox-构建根文件系统" class="headerlink" title="BusyBox 构建根文件系统"></a>BusyBox 构建根文件系统</h3><h4 id="BusyBox-简介"><a href="#BusyBox-简介" class="headerlink" title="BusyBox 简介"></a>BusyBox 简介</h4><p>上一小节说了，根文件系统里面就是一堆的可执行文件和其他文件组成的？难道我们得一个一个的从网上去下载这些文件？显然这是不现实的！那么有没有人或者组织专门干这个事呢？他们负责“收集”这些文件，然后将其打包，像我们这样的开发者可以直接拿来用。答案是有的，它就叫做 BusyBox！其名字分为“Busy”和“Box”，也就是忙碌的盒子。盒子是用来放东西的，忙碌的是因为它要提供根文件系统所需的文件，所以忙碌。BusyBox 是一个集成了大量的 Linux 命令和工具的软件，像 ls、mv、ifconfig 等命令 BusyBox 都会提供。BusyBox 就是一个大的工具箱，这个工具箱里面集成了 Linux 的许多工具和命令。一般下载 BusyBox 的源码，然后配置 BusyBox，选择自己想要的功能，最后编译即可。BusyBox 可以在其官网下载到，官网地址为：<a target="_blank" rel="noopener" href="https://busybox.net/">https://busybox.net/</a></p>
<p>官网比较简陋，如图38.2.1.1 所示：<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/image.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在官网左侧的“Get BusyBox”栏有一行“Download Source”，点击“Download Source”即可打开 BusyBox 的下载页，如图 38.2.1.2 所示：</p>
<p>输入中文是时，如果出现下图所示的输入框，是无法正常输入的，此时可以按 <code>Esc</code> 将或鼠标在界面任意处左键单击，就可以消除该输出框。然后才能正常输入中文命令。</p>
<p>输入中文时，输入法的界面（候选词）会显示在电脑其他地方，而不是在当前命令的光标处。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1658326803580.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>打包时，要进入rootfs 文件夹内部打包，不能和文件夹同级。否则下载后，系统不能工作。<br>可以发现两种打包方式，生成的文件大小是不一样的，具体区别暂不深究，总之要进入文件夹内部再打包。</p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1658332859324.png" srcset="/img/loading.gif" lazyload alt="enter description here"></p>
<p>打包错误导致启动linux后出现的错误，linux无法启动</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">Waiting <span class="hljs-keyword">for</span> root device /dev/mmcblk1p2...<br><span class="hljs-symbol">mmc1:</span> <span class="hljs-built_in">new</span> HS200 MMC card at address <span class="hljs-number">0001</span><br><span class="hljs-symbol">mmcblk1:</span> mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R <span class="hljs-number">7.28</span> GiB<br><span class="hljs-symbol">mmcblk1boot0:</span> mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R partition <span class="hljs-number">1</span> <span class="hljs-number">4.00</span> MiB<br><span class="hljs-symbol">mmcblk1boot1:</span> mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R partition <span class="hljs-number">2</span> <span class="hljs-number">4.00</span> MiB<br><span class="hljs-symbol">mmcblk1rpmb:</span> mmc1:<span class="hljs-number">0001</span> <span class="hljs-number">8</span>GTF4R partition <span class="hljs-number">3</span> <span class="hljs-number">512</span> KiB<br> mmcblk1: p1 p2<br>hub <span class="hljs-number">1</span>-<span class="hljs-number">1</span>:<span class="hljs-number">1.0</span>: USB hub found<br>hub <span class="hljs-number">1</span>-<span class="hljs-number">1</span>:<span class="hljs-number">1.0</span>: <span class="hljs-number">4</span> ports detected<br>kjournald starting.  Commit interval <span class="hljs-number">5</span> seconds<br>EXT3-fs (mmcblk1p2): <span class="hljs-keyword">using</span> internal journal<br>EXT3-fs (mmcblk1p2): mounted filesystem <span class="hljs-keyword">with</span> ordered data mode<br><span class="hljs-symbol">VFS:</span> Mounted root (ext3 filesystem) <span class="hljs-keyword">on</span> device <span class="hljs-number">179</span>:<span class="hljs-number">2</span>.<br><span class="hljs-symbol">devtmpfs:</span> <span class="hljs-keyword">error</span> mounting -<span class="hljs-number">2</span><br>Freeing unused kernel memory: <span class="hljs-number">404</span>K (<span class="hljs-number">8090</span>f000 - <span class="hljs-number">80974000</span>)<br>Kernel panic - <span class="hljs-built_in">not</span> syncing: No working init found.  <span class="hljs-keyword">Try</span> passing init= <span class="hljs-keyword">option</span> <span class="hljs-keyword">to</span> kernel. See Linux Documentation/init.txt <span class="hljs-keyword">for</span> guidance.<br>---[ <span class="hljs-keyword">end</span> Kernel panic - <span class="hljs-built_in">not</span> syncing: No working init found.  <span class="hljs-keyword">Try</span> passing init= <span class="hljs-keyword">option</span> <span class="hljs-keyword">to</span> kernel. See Linux Documentation/init.txt <span class="hljs-keyword">for</span> guidance.<br><br></code></pre></td></tr></table></figure>


<p>修改Linux文件后，不能直接外部断电或复位重启，此时部分文件还在运行缓存中，弱国要重启，最好使用命令 <code>reboot</code>执行重启，系统会自动保存缓存数据后再重启。或者可以使用 <code>sync</code> 命令强制保存。</p>
<p>否则直接外部重启或断电会导致修改的数据丢失，比如刚修改的文件不会被修改，还保持原样。</p>
<blockquote>
<p>系统在运行时，会自动后台不定时保存缓存内容。所以如果怕丢失重要数据，就每次修改后 <code>sync</code>强制更新</p>
</blockquote>
<h2 id="系统烧写"><a href="#系统烧写" class="headerlink" title="系统烧写"></a>系统烧写</h2><p>使用 NXP 官方提供的 MfgTool 工具通过 USB OTG 口来烧写系统。直接将 uboot、 linux kernel、 .dtb(设备树)和 rootfs 这四个文件烧写到板子上的 EMMC、 NAND 或 QSPI Flash 等其他存储设备上。</p>
<h3 id="MfgTool-工具烧写原理"><a href="#MfgTool-工具烧写原理" class="headerlink" title="MfgTool 工具烧写原理"></a>MfgTool 工具烧写原理</h3><ol>
<li>将 firmware 目录中的 uboot、 linux kernel 和.dtb(设备树)，通过 USB OTG下载到开发板的 DDR 中，目的就是在 DDR 中启动 Linux 系统，为后面的烧写做准备。</li>
<li>经过第1步的操作，此时 Linux 系统已经运行起来了，系统运行起来以后完成对 EMMC 的格式化、分区等操作。 EMMC 分区建立好后，从 files 中读取要烧写的 uboot、 linux kernel、 .dtb(设备树)和 rootfs 这 4 个文件，然后将其烧写到 EMMC 中，这个就是 MfgTool 的大概工作流程。</li>
</ol>
<h3 id="1-连接"><a href="#1-连接" class="headerlink" title="1. 连接"></a>1. 连接</h3><ol>
<li>MfgTool 工具下载：是 NXP 提供的专门用于给 I.MX 系列 CPU 烧写系统的软件，可以在 NXP 官网下载到。开发板光盘中路径为： 5、开发工具-&gt;3、NXP官方原版MFG_TOOL烧写工具-&gt;L4.1.15_2.0.0-ga_mfg-tools.tar.gz</li>
<li>解压。选择 mfgtools-with-rootfs.tar.gz（带rootfs文件系统） 这个压缩包， 解压出一个名为 mfgtools-with-rootfs 的文件夹。</li>
<li>进入目录 mfgtools-with-rootfs\mfgtools 中，在此目录下有几个文件夹和很多的.vbs 文件，根据不同开发板选择不同的.vbs烧写脚本。其他的.vbs 烧写脚本用不到，因此可以删除掉<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1667018103844.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>连接USB。MfgTool 是通过 USB OTG 接口将系统烧写进 EMMC 中的<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1667028512687.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>5、拨码开关拨到 USB 下载模式。<blockquote>
<p>如果插了 TF 卡，请弹出 TF 卡，否则电脑不能识别 USB！等识别出来以后再插上 TF 卡！&#x3D;&#x3D;</p>
</blockquote>
</li>
<li>按一下开发板的复位键，此时就会进入到 USB 模式，如果是第一次进入 USB 模式的话可能会久一点，这个是免驱的，因此不需要安装驱动</li>
</ol>
<h3 id="2-系统烧写"><a href="#2-系统烧写" class="headerlink" title="2. 系统烧写"></a>2. 系统烧写</h3><ol start="0">
<li>准备系统文件<ol>
<li>移植编译出来的 uboot 可执行文件： u-boot.imx。</li>
<li>移植编译出来的 zImage 镜像文件</li>
<li>开发板对应的.dtb(设备树)，对于 I.MX6UALPHA 开发板来说就是 imx6ull-alientek-emmc.dtb。</li>
<li>构建的根文件系统 rootfs，这里我们需要对 rootfs 进行打包</li>
</ol>
</li>
<li>双击“ mfgtool2-yocto-mx-evk-emmc.vbs”，打开下载对话框，如图<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1667028740790.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>如果出现“符合 HID 标准的供应商定义设备”就说明连接正常，可以进行烧写</li>
<li>进入如下目录中：<br><code>L4.1.15_2.0.0-ga_mfg-tools/mfgtools-with-rootfs/mfgtools/Profiles/Linux/OS Firmware</code></li>
<li>进入firmeare 文件夹。使用我们自己的编译出来的 zImage、 u-boot.imx 和 imx6ull-alientekemmc.dtb 这三个文件替换掉表中这三个文件。名字要和表的一致，<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1667031953301.png" srcset="/img/loading.gif" lazyload alt="enter description here"></li>
<li>进入files文件夹。同样，用我们编译出来的 zImage、 u-boot.imx 和 imx6ull-alientek-emmc.dtb 和 rootfs 这四个文件替换掉表中四个文件。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AF%87/1667032054203.png" srcset="/img/loading.gif" lazyload alt="enter description here"><br>点击“Start”按钮即可开始烧写</li>
</ol>
<h3 id="网络开机自启动"><a href="#网络开机自启动" class="headerlink" title="网络开机自启动"></a>网络开机自启动</h3><p>Linux是一个单体内核，支持真正的抢占式多任务处理（于用户态，和版本2.6系列之后的内核态[27][28]）、虚拟内存、共享库、请求分页、共享写时复制可执行体（通过内核同页合并）、内存管理、Internet协议族和线程等功能。</p>
<p>设备驱动程序和内核扩展运行于内核空间（在很多CPU架构中是ring 0），可以完全访问硬件，但也有运行于用户空间的一些例外，例如基于FUSE&#x2F;CUSE的文件系统，和部分UIO[29][30]。多数人与Linux一起使用的图形系统不运行在内核中。与标准单体内核不同，Linux的设备驱动程序可以轻易的配置为内核模块，并在系统运行期间可直接装载或卸载。也不同于标准单体内核，设备驱动程序可以在特定条件下被抢占；增加这个特征用于正确处理硬件中断并更好的支持对称多处理[28]。出于自愿选择，Linux内核没有二进制内核接口[31]。</p>
<p>硬件也被集成入文件层级中。用户应用到设备驱动的接口是在&#x2F;dev或&#x2F;sys目录下的入口文件[32]。进程信息也通过&#x2F;proc目录映射到文件系统[32]。<br><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1652321949009.png" srcset="/img/loading.gif" lazyload alt="1652321949009"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Linux%E5%86%85%E6%A0%B8">Linux内核-wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.vbird.org/linux_basic/centos7/">鸟哥linux第四版-基礎學習篇目錄 - for CentOS 7</a></li>
</ul>
<p>shell</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cyut.edu.tw/~ywfan/1109linux/201109chapter11shell%20script.htm">Chapter 11 Shell 和 Shell Script</a></li>
<li><a target="_blank" rel="noopener" href="https://achelous.org/BI-solutions/Linux_shell_version.html">Linux Shell 版本问题</a></li>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/linux4noobs/comments/kufgft/which_of_these_illustrations_of_the_shell_is/">这些贝壳的插图哪一个是准确的？外壳是否仅通过外壳与内核对话？</a></li>
<li><a target="_blank" rel="noopener" href="https://imgur.com/a/VuvJ3dy">https://imgur.com/a/VuvJ3dy</a></li>
<li><a target="_blank" rel="noopener" href="https://kknews.cc/code/3va5oq8.html">一篇文章從了解到入門shell</a></li>
<li><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/932.html">Shell脚本是什么</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gd-luojialin/p/15028076.html">Linux shell脚本</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gushiciku.cn/pl/gLvW/zh-tw">Linux Shell程式設計及自動化運維實現——shell概述及變數</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/bash/manual/bash.html">Bash 参考手册</a></li>
<li><a target="_blank" rel="noopener" href="https://www.techtarget.com/searchdatacenter/definition/bash-Bourne-Again-Shell">bash (Bourne again shell)</a></li>
<li><a target="_blank" rel="noopener" href="https://itsfoss.com/what-is-linux/">什么是 Linux，为什么有 100 种 Linux 发行版？</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/kai_zone/article/details/80444872">linux系统组成及结构</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_13800449/3049118">Linux操作系统综述</a><br><a target="_blank" rel="noopener" href="https://github.com/sunnyandgood/BigData">Linux系统组成.md</a></p>
<p><img src="https://lonly-hexo-img.oss-cn-shanghai.aliyuncs.com/hexo_images/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1652327045769.png" srcset="/img/loading.gif" lazyload alt="1652327045769"></p>
<span id="more"></span>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/01-%E4%B8%93%E4%B8%9A/" class="category-chain-item">01-专业</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>嵌入式Linux学习笔记-系统移植篇</div>
      <div>http://lonlypan.com/2022/07/10/嵌入式Linux学习笔记-系统移植篇/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>LonlyPan</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年7月10日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                <i class="iconfont icon-nc"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/21/%E7%94%B5%E5%AD%90%E5%85%83%E5%99%A8%E4%BB%B6%E4%B8%8E%E7%94%B5%E8%B7%AF%E5%9F%BA%E7%A1%80/" title="电子元器件与电路基础">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">电子元器件与电路基础</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/10/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/" title="嵌入式Linux学习笔记-驱动开发篇">
                        <span class="hidden-mobile">嵌入式Linux学习笔记-驱动开发篇</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.16/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"geH90Q7ihl9Si5Llagt8GcC2-MdYXbMMI","appKey":"fO2rYFt9wStdv0SX7C7omkal","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://geh90q7i.api.lncldglobal.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-copyright"> 2019-2022 |</i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?f56279d43c733d547ea06f75f8e05d89";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
