# 南京霍普斯科技有限公司仪器联机通信协议

该协议适用于公司所有设备之间通信，目前主要用于GC设备

|  版本   |  修改内容   |   完成日期  |  编制   |  审核   |  
| --- | --- | --- | --- | --- | --- | --- | --- |
| V0.1    |   讨论稿  | 20210803   |   吴琼水 |     |     |     |     |
| V1.0    |   初版，添加编号相关协议，修订部分描述错误     | 20220429   |   潘良辉 |     |     |     |     |
| V1.1    |  修改温度和流量的部件名，不再指定其具体功能。描述：AD数据改为检测器数据     | 20220905  |   潘良辉 |     | V1.2  |  添加故障、开关量、模拟量通信协议   |  20221031    | 潘良辉|


TODO：
1. float数据范围小，需要扩大
2. 方法中，方法编号考虑取消
3. 检测器数据，上传时间改为数据序列号（0、1、2...）

## 通信方式约定

+ 适用于采用服务端（Server）-客户端（Client）模式的设备间通信，仪器为服务端，PC机为客户端。一般客户端发送请求，服务端给出应答。

+ 请求和应答是<span style="color:red">**异步**</span>的，即请求发送后，可能不是立即能够收到应答的，指令的执行可能需要几秒或数十秒的时间，可能会延迟。因此
	+ 在指令发出后，可以设定一定的异步等待机制。
	+ 每一个请求，均会有一个应答。
+ 每一个请求数据帧，均会由：帧头标志、命令号、序列号、长度、参数、CRC校验和帧尾等部分组成。

+ 为确保每一帧数据能够正确的传输，或者在发生错误的时候，能够进行重传，一般采用超时重传的方式进行。因此，在请求端，命令发送后，需要进行应答检查，如果在一定的时间内没有收到应答，则需要进行重传。此时，序列号作为识别是否是同一个请求的依据。在接收端，如果重复的收到同一个序列号的请求，在该指令已经在执行的情况下，直接忽略掉该指令。对于一些非常重要的指令，可以采用连续发送2-3遍的方式，防止传输出错而导致的指令没有执行。

+ 对于延时比较大的数据读取命令，可以分拆为2-3条指令，一条表示指令收到了且已经在执行，一条为查询是否准备好的指令，一条为读取结果的指令。

  例如温度的查询，可能在请求发出后，需要几秒钟的时间返回应答，我们可以延时接收。但有的数据采集过程，有可能需要数十秒的时间，此时，我们需要进行指令分拆。

+ 对于执行比较频繁的通信指令，可以不需要请求，直接发送应答，即自动上传模式。


## 二进制码通信协议

### 注意事项

+ 对于整型、浮点型等数据类型，采用小端(Little-Endian)模式，即低地址存放低字节，高地址存放高字节。一般ARM采用小端模式，windows、Apple Mac OS (x86-64)和Linux x86 64-bit也采用小端模式。

### 指令结构

+ 请求指令的格式

  | 字段名称         | 数据       | 说明                                                         |
  | ---------------- | ---------- | ------------------------------------------------------------ |
  | Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
  | CmdID            | 1个字节    | 无符号数，命令ID号。                                         |
  | SequenceID       | 1个字节    | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
  | Parameter Length | 2个字节    | 无符号数。所附带的参数的字节数。                             |
  | Parameters[]     | 无符号字节 | 这里是附带的参数字节数组。没有参数的话，就没有本项数据。     |
  | CRC              | 1个字节    | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，取最终计算结果的最低字节作为CRC值。用于校验参数是否正确。 |
  | End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

+ 应答指令的格式

  | 数据表名称       | 数据       | 说明                                                         |
  | ---------------- | ---------- | ------------------------------------------------------------ |
  | Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
  | CmdID            | 1个字节    | 无符号数，命令ID号。                                         |
  | SequenceID       | 1个字节    | 无符号数。请求的序列号.                                      |
  | **Status**       | 1个字节    | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
  | Parameter Length | 2个字节    | 无符号数。所附带的参数字节数。                               |
  | Parameters[]     | 无符号数组 | 这里是附带的参数，以无符号字节数组来进行存储。如果没有参数的话，就没有本项数据。 |
  | CRC              | 1个字节    | 对除Header、CRC和End外的所有的二进制数所对应的字节，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，取最终计算结果的最低字节作为CRC值。用于校验参数是否正确。 |
  | End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

可见，与请求相比，应答多了一项，就是<span style="color:red">Status</span>项。

___

# 关于GC-FID的通信协议

## 命令ID

## 设备部件编号

+ 对每一个部件都要进行唯一的数字编号，用一个无符号字节表示。
+ 标号始终在一个部件数据的最高字节，如要对部件5设置为温度，那么对应的参数用16进制字节表示应该是：
54 0D 03 05。编号再最高位（最右侧）

编号表如下：
  
![表格](./img/2022-04-29-霍普斯仪器联机通信协议.md/1651212044838.table.html)

## 温度的表示

+ 温度值采用3个字节的整数来表示。假设温度值为x(单位℃)，那么我们将x乘以1000变为整型数字，其可以表示的温度范围为：[-8388.608, 8388.608]℃。正温度用原码保存，负温度用三字节补码保存。
+ 举例如下：
  - 假设温度x=128℃，那么温度用数值表示为：128*1000=128000
  - 假设温度x=-123.456℃，那么温度用数值表示为：-123.456*1000=-123456=0xFF FE 1D C0（四字节补码），现在取低3个字节，得 0xFE 1D C0。

## 流量的表示

+ 流量采用3个字节的整数来表示。假设流量值为x，那么我们将x乘以1000变为整型数字。

## 时间基准

- 以1ms为最小计时单位。采用ARM内部的计时器，获取系统时钟的毫秒数。


## 指令列表

### 设置温度

可以对多个部件进行温度设置。

| 字段名称         | 数据       | 说明                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_SET_TEMPERATURE(1)          | 对温度进行设置                                               |
| SequenceID       | 1个字节    | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节   | 所附带的参数的字节数。                  |
| Parameters[]     | 无符号字节 | 这里是附带的参数字节数组。没有参数的话，就没有本项数据。<br>格式为：每一个部件的温度设置均用1个整型数字，最高字节为部件编号，低3个字节为**有符号**整形数字，其表示温度值的1000倍。如果温度值是负数时，如果用一个4字节的整型数字表示的话，我们进行补码截断，去掉最高字节，保留低3个字节。<br>如要对部件5,6分别设置为200.02℃和-1801。23℃，那么对应的参数应该是：<br>200.02\*1000=200020=0x03 0D 54,把部件编号5放入最高字节，得0x05 03 0D 54<br>-1801.23\*1000=-1801230=0xFF E4 83 F2，这里是负值，去掉最高字节，用三字节补码表示，值为0xE4 83 F2，把6放入最高字节，得0x06 E4 83 F2<br> |
| CRC              | 1个字节    | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

对于这个示例，我们可以进行计算：

| 字段名称         | 数据                       | 说明                                                         |
| ---------------- | -------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                 |                                                              |
| CmdID            | 1                          |                                                              |
| SequenceID       | 5                          | 假设序列号为5                                                |
| Parameter Length | 8                          | 所附带的参数的字节数，8个字节。                              |
| Parameters[]     | 0x54 0D 03 05  F2 83 E4 06 | 每个部件4个字节：部件编号(1个字节)+设定的温度值(3个字节)<br>如要对部件5,6分别设置为200.02℃和-1801.23℃，那么对应的参数用16进制字节表示应该是：<br>54 0D 03 05  F2 83 E4 06 ，一共8个字节，数据小端模式，编号在最高位
|
| CRC              | 0xD6                       | 对除Header和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和。用于校验参数是否正确。1 + 5 + 8 + 0x54 + 0x0D + 0x03 + 0x05 +  0xF2 + 0x83 + 0xE4 + 0x06 = 0x2D6 ,取最低字节，即0xD6作为CRC值 |
| End              | 0xf5f6f7f8                 | 4个字节，用于标识一个数据包的结束                            |

相应的应答为：

| 数据表名称       | 数据       | 说明                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | 1          | 无符号数，命令ID号。                                         |
| SequenceID       | 5          | 无符号数。请求的序列号.                                      |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 0          | 无符号整型数字。所附带的参数字节数。                         |
| Parameters[]     | 空         |                                                              |
| CRC              | 6          | 对除Header和End外的所有的二进制数所对应的字节，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和。用于校验参数是否正确。1+5+0+0=6 |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

### 温度自动上传到PC

由于温度值需要经常去关注，且其变化不快，因此，我们不需要不断的去请求查询温度，我们可以采用自动上传模式。在ARM端，需要定期(如1秒钟)去更新温度值，然后自动发送到PC端，不需要PC端发送请求。可以一次性把所有部件的温度上传到PC端。

应答格式为：

| 数据表名称       | 数据                           | 说明                                                         |
| ---------------- | ------------------------------ | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                     | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | AUTO_RESPONSE_TEMPERATURE(100) | 命令ID号。                                                   |
| SequenceID       | 1个字节                        | 无符号数。序列号自动加1，每发送一次，序列号自动加1。         |
| **Status**       | 0                              | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 2个字节                        | 所附带的参数字节数。                                         |
| Parameters[]     | 参数字节                       | 温度的表示方法同CMD_SET_TEMPERATURE，可以几个部件的温度一起同时上传 |
| CRC              | CRC值                          |                                                              |
| End              | 0xf5f6f7f8                     | 4个字节，用于标识一个数据包的结束                            |

### 设置流量

可以对多个部件进行流量设置。

| 字段名称         | 数据                 | 说明                                                         |
| ---------------- | -------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4           | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_SET_FLOW_RATE(2) | 对流量进行设置                                               |
| SequenceID       | 1个字节              | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节              | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节           | 每个流量采用1个整型数(4个字节)来表示，最高字节为部件编号，低3个字节为流量值(流量\*1000)。 |
| CRC              | 1个字节              | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8           | 4个字节，用于标识一个数据包的结束                            |

相应的应答为：

| 数据表名称       | 数据       | 说明                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | 2          | 无符号数，命令ID号。                                         |
| SequenceID       | 1个字节    | 无符号数。请求的序列号.                                      |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 0          | 无符号整型数字。所附带的参数字节数。                         |
| Parameters[]     | 空         |                                                              |
| CRC              | 1个字节    | 对除Header和End外的所有的二进制数所对应的字节，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

### 流量自动上传到PC

由于流量值需要经常去关注，我们可以采用自动上传模式。在ARM端，需要定期(如1秒钟)去更新流量值，然后自动发送到PC端，不需要PC端发送请求。可以一次性把所有部件的流量上传到PC端。

应答格式为：

| 数据表名称       | 数据                         | 说明                                                         |
| ---------------- | ---------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                   | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | AUTO_RESPONSE_FLOW_RATE(101) | 命令ID号。                                                   |
| SequenceID       | 1个字节                      | 无符号数。序列号自动加1，每发送一次，序列号自动加1。         |
| **Status**       | 0                            | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 2个字节                      | 所附带的参数字节数。                                         |
| Parameters[]     | 参数字节                     | 每个流量采用1个整型数(4个字节)来表示，最高字节为部件编号，低3个字节为流量值。 |
| CRC              | CRC值                        |                                                              |
| End              | 0xf5f6f7f8                   | 4个字节，用于标识一个数据包的结束                            |

### 设置阀件状态

可以对多个部件进行流量设置。

| 字段名称         | 数据                     | 说明                                                         |
| ---------------- | ------------------------ | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4               | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_SET_VALVES_STATUS(3) | 对阀件状态进行设置                                           |
| SequenceID       | 1个字节                  | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                  | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节               | 每个阀件采用无符号单字节数(2个字节)来表示状态。状态(0或1)+部件编号。如编号为61和62的阀的状态分别是0和1，那么参数用十进制字节可以表示发送的数据为：<br/> 00  61  01 62|
| CRC              | 1个字节                  | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8               | 4个字节，用于标识一个数据包的结束                            |

相应的应答为：

| 数据表名称       | 数据       | 说明                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | 3          | 无符号数，命令ID号。                                         |
| SequenceID       | 1个字节    | 无符号数。请求的序列号.                                      |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 0          | 无符号整型数字。所附带的参数字节数。                         |
| Parameters[]     | 空         |                                                              |
| CRC              | 1个字节    | 对除Header和End外的所有的二进制数所对应的字节，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

### 阀件状态自动上传到PC

由于阀件需要经常去关注，我们可以采用自动上传模式。在ARM端，需要定期(如1秒钟)去更新阀件状态值，然后自动发送到PC端，不需要PC端发送请求。可以一次性把所有阀件的状态上传到PC端。

应答格式为：

| 数据表名称       | 数据                             | 说明                                                         |
| ---------------- | -------------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                       | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | AUTO_RESPONSE_VALVES_STATUS(102) | 命令ID号。                                                   |
| SequenceID       | 1个字节                          | 无符号数。序列号自动加1，每发送一次，序列号自动加1。         |
| **Status**       | 0                                | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 2个字节                          | 所附带的参数字节数。                                         |
| Parameters[]     | 参数字节                         | 每个阀件采用无符号单字节数(2个字节)来表示状态。状态(0或1)+部件编号。如编号为61和62的阀的状态分别是0和1，那么参数用十进制字节可以表示发送的数据为：<br/> 00  61  01 62 |
| CRC              | CRC值                            |                                                              |
| End              | 0xf5f6f7f8                       | 4个字节，用于标识一个数据包的结束                            |

### 仪器分析方法状态自动上传

当一个分析方法准备开始以及完成后，自动把这个状态通道给PC端。为了让PC端能够可靠的知道分析即将开始或者已经完成，本指令要求**连续发送至少3遍**。
**方法状态：** 0=正在执行； 1=即将开始； 2=终止

应答格式为：

| 数据表名称       | 数据                             | 说明                                                         |
| ---------------- | -------------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                       | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | AUTO_RESPONSE_METHOD_STATUS(103) | 命令ID号。                                                   |
| SequenceID       | 1个字节                          | 无符号数。序列号自动加1，每发送一次，序列号自动加1。         |
| **Status**       | 0                                | 标识命令执行的状态，0=正常执行； 1=即将开始； 2=终止     |
| Parameter Length | 2个字节                          | 所附带的参数字节数。                                         |
| Parameters[]     | 参数字节                         | 3个字节，当前正在进行或即将结束的方法的状态+方法编号+设备编号。例如FID1的方法2的状态0：00 02 01 |
| CRC              | CRC值                            |                                                              |
| End              | 0xf5f6f7f8                       | 4个字节，用于标识一个数据包的结束                            |

### 仪器故障状态自动上传

当仪器出现自检故障时，自动向PC端发送故障诊断信息。

应答格式为：

| 数据表名称       | 数据                             | 说明                                                         |
| ---------------- | -------------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                       | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | AUTO_RESPONSE_ISSUES_REPORT(104) | 命令ID号。                                                   |
| SequenceID       | 1个字节                          | 无符号数。序列号自动加1，每发送一次，序列号自动加1。         |
| **Status**       | 0                                | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 2个字节                          | 所附带的参数字节数。                                         |
| Parameters[]     | 参数字节                         | 故障编码(故障编码后面再定义)，每个故障1个字节，有几个故障就有几个字节 |
| CRC              | CRC值                            |                                                              |
| End              | 0xf5f6f7f8                       | 4个字节，用于标识一个数据包的结束                            |

### 检测器数据自动上传

将采集到的检测器的数据，自动向PC端发送。可以一次发送几个数据。由于检测器数据是在不断的上传的，为了提高上传效率，最好是几个点打包一起上传。由于现在的检测器采用的是软件模拟SPI总线，其时间的精度是不能保证的，因此，我们记录每一个检测器数据点的获取时间。为了与后面可能会采用的24位ADC兼容，检测器数据采用3个字节存储，将ADC换算成整数uV，如果是负电压，则用3字节补码表示。

应答格式为：

| 数据表名称       | 数据                       | 说明                                                         |
| ---------------- | -------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | AUTO_RESPONSE_AD_DATA(105) | 命令ID号。                                                   |
| SequenceID       | 1个字节                    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。         |
| **Status**       | 0                          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 2个字节                    | 所附带的参数字节数。                                         |
| Parameters[]     | 参数字节                   | 一次可以发送几个检测器数据。每个检测器数据用7个字节表示，格式为：<br>时间(ms，3bytes) + ADC数据(单位uV,3bytes)+设备编号（1bytes）<br>一个方法启动后，时间归0，每次ADC采集成功后，都要记录对应的时间 |
| CRC              | CRC值                      |                                                              |
| End              | 0xf5f6f7f8                 | 4个字节，用于标识一个数据包的结束                            |



### 查询温度设置值

可以同时对多个部件进行温度设置值的查询。

| 字段名称         | 数据                          | 说明                                                         |
| ---------------- | ----------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                    | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_QUERY_TEMPERATURE_SET(30) | 查询温度的设置值                                             |
| SequenceID       | 1个字节                       | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                       | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节                    | 每个部件用1个字节表示，即要查询的部件编号。利用同时传入多个部件编号。 |
| CRC              | 1个字节                       | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8                    | 4个字节，用于标识一个数据包的结束                            |

应答格式为：

| 数据表名称       | 数据       | 说明                                                     |
| ---------------- | ---------- | -------------------------------------------------------- |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                      |
| CmdID            | 30         | 命令ID号。                                               |
| SequenceID       | 1个字节    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。     |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败 |
| Parameter Length | 2个字节    | 所附带的参数字节数。                                     |
| Parameters[]     | 参数字节   | 温度的表示方法同CMD_SET_TEMPERATURE。                    |
| CRC              | CRC值      |                                                          |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                        |

### 查询温度实时测量值

可以同时对多个部件进行温度实时值的查询。

| 字段名称         | 数据                      | 说明                                                         |
| ---------------- | ------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_QUERY_TEMPERATURE(31) | 查询温度的实时测量值                                         |
| SequenceID       | 1个字节                   | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                   | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节                | 每个部件用1个字节表示，即要查询的部件编号。利用同时传入多个部件编号。 |
| CRC              | 1个字节                   | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8                | 4个字节，用于标识一个数据包的结束                            |

应答格式为：

| 数据表名称       | 数据       | 说明                                                     |
| ---------------- | ---------- | -------------------------------------------------------- |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                      |
| CmdID            | 31         | 命令ID号。                                               |
| SequenceID       | 1个字节    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。     |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败 |
| Parameter Length | 2个字节    | 所附带的参数字节数。                                     |
| Parameters[]     | 参数字节   | 温度的表示方法同CMD_SET_TEMPERATURE。                    |
| CRC              | CRC值      |                                                          |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                        |



### 查询流量设置值

可以同时对多个部件进行流量设置值的查询。

| 字段名称         | 数据                        | 说明                                                         |
| ---------------- | --------------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                  | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_QUERY_FLOW_RATE_SET(32) | 查询流量的设置值                                             |
| SequenceID       | 1个字节                     | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                     | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节                  | 每个部件用1个字节表示，即要查询的部件编号。利用同时传入多个部件编号。 |
| CRC              | 1个字节                     | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8                  | 4个字节，用于标识一个数据包的结束                            |

应答格式为：

| 数据表名称       | 数据       | 说明                                                     |
| ---------------- | ---------- | -------------------------------------------------------- |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                      |
| CmdID            | 32         | 命令ID号。                                               |
| SequenceID       | 1个字节    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。     |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败 |
| Parameter Length | 2个字节    | 所附带的参数字节数。                                     |
| Parameters[]     | 参数字节   | 流量的表示方法同CMD_SET_FLOW_RATE。                      |
| CRC              | CRC值      |                                                          |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                        |

### 查询流量实时测量值

可以同时对多个部件进行流量实时值的查询。

| 字段名称         | 数据                    | 说明                                                         |
| ---------------- | ----------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4              | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_QUERY_FLOW_RATE(33) | 查询流量的实时测量值                                         |
| SequenceID       | 1个字节                 | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                 | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节              | 每个部件用1个字节表示，即要查询的部件编号。利用同时传入多个部件编号。 |
| CRC              | 1个字节                 | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8              | 4个字节，用于标识一个数据包的结束                            |

应答格式为：

| 数据表名称       | 数据       | 说明                                                     |
| ---------------- | ---------- | -------------------------------------------------------- |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                      |
| CmdID            | 33         | 命令ID号。                                               |
| SequenceID       | 1个字节    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。     |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败 |
| Parameter Length | 2个字节    | 所附带的参数字节数。                                     |
| Parameters[]     | 参数字节   | 流量的表示方法同CMD_SET_FLOW_RATE。                      |
| CRC              | CRC值      |                                                          |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                        |

### 查询阀的设置值

可以同时对多个阀部件进行设置值的查询。

| 字段名称         | 数据                     | 说明                                                         |
| ---------------- | ------------------------ | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4               | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_QUERY_VALVES_SET(34) | 查询阀的设置值                                               |
| SequenceID       | 1个字节                  | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                  | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节               | 每个部件用1个字节表示，即要查询的部件编号。利用同时传入多个部件编号。 |
| CRC              | 1个字节                  | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8               | 4个字节，用于标识一个数据包的结束                            |

应答格式为：

| 数据表名称       | 数据       | 说明                                                     |
| ---------------- | ---------- | -------------------------------------------------------- |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                      |
| CmdID            | 34         | 命令ID号。                                               |
| SequenceID       | 1个字节    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。     |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败 |
| Parameter Length | 2个字节    | 所附带的参数字节数。                                     |
| Parameters[]     | 参数字节   | 阀的表示方法同CMD_SET_VALVES_STATUS。                    |
| CRC              | CRC值      |                                                          |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                        |

### 查询阀的实时值

可以同时对多个阀部件进行查询。

| 字段名称         | 数据                 | 说明                                                         |
| ---------------- | -------------------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4           | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_QUERY_VALVES(34) | 查询阀的实时值                                               |
| SequenceID       | 1个字节              | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节              | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节           | 每个部件用1个字节表示，即要查询的部件编号。利用同时传入多个部件编号。 |
| CRC              | 1个字节              | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8           | 4个字节，用于标识一个数据包的结束                            |

应答格式为：

| 数据表名称       | 数据       | 说明                                                     |
| ---------------- | ---------- | -------------------------------------------------------- |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                      |
| CmdID            | 34         | 命令ID号。                                               |
| SequenceID       | 1个字节    | 无符号数。序列号自动加1，每发送一次，序列号自动加1。     |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败 |
| Parameter Length | 2个字节    | 所附带的参数字节数。                                     |
| Parameters[]     | 参数字节   | 阀的表示方法同CMD_SET_VALVES_STATUS。                    |
| CRC              | CRC值      |                                                          |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                        |

### 下载分析方法

将分析方法下载到仪器中。

| 字段名称         | 数据                           | 说明                                                         |
| ---------------- | ------------------------------ | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4                     | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_DOWNLOAD_ANALYZE_METHOD(8) | 设置分析方法                                                 |
| SequenceID       | 1个字节                        | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                        | 所附带的参数的字节数。                                       |
| Parameters[]     | 无符号字节                     | 要下载的分析方法，格式见下表                                 |
| CRC              | 1个字节                        | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8                     | 4个字节，用于标识一个数据包的结束                            |

分析方法格式：
- 方法中的阀状态表示方法同CMD_SET_VALVES_STATUS。
 
![表格](./img/2022-04-29-霍普斯仪器联机通信协议.md/1651214575809.table.html)

相应的应答为：

| 数据表名称       | 数据       | 说明                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | 8          | 无符号数，命令ID号。                                         |
| SequenceID       | 1个字节    | 无符号数。请求的序列号.                                      |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 0          | 无符号整型数字。所附带的参数字节数。                         |
| Parameters[]     | 空         |                                                              |
| CRC              | 1个字节    | 对除Header和End外的所有的二进制数所对应的字节，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

### 当前分析方法操作

对当前的分析方法进行操作，包括查询，启动和终止。

| 字段名称         | 数据                     | 说明                                                         |
| ---------------- | ------------------------ | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4               | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | CMD_ANALYZE_METHOD_OP(9) | 当前分析方法的操作                                           |
| SequenceID       | 1个字节                  | 无符号数。请求的序列号，采用静态数字递增，数值超过255后，又变为0。 |
| Parameter Length | 2个字节                  | 所附带的参数的字节数。                                       |
| Parameters[]     | 参数                     | 2个字节，第1个字节：0=查询当前方法的编号及状态， 1=启动分析， 2=结束当前分析方法，第2个字节：设备编号 |
| CRC              | 1个字节                  | 对除Header、CRC和End外的所有的二进制数，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和，最终计算出来的结果取最低字节作为CRC值。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8               | 4个字节，用于标识一个数据包的结束                            |

相应的应答为：

| 数据表名称       | 数据       | 说明                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| Header           | 0xf1f2f3f4 | 4个字节，用于标识一个数据包的开始。                          |
| CmdID            | 9          | 无符号数，命令ID号。                                         |
| SequenceID       | 1个字节    | 无符号数。请求的序列号.                                      |
| **Status**       | 0          | 标识命令执行的状态，0=正常执行； 1=非法命令； 2=执行失败     |
| Parameter Length | 1个字节    | 无符号整型数字。所附带的参数字节数。                         |
| Parameters[]     | 参数       | 3个字节，第1个字节为当前的分析方法编号(如果没有方法的话，=0)； 第2字节为状态：0=正在执行； 1=即将开始； 2=已终止，第3个字节表示设备的编号 |
| CRC              | 1个字节    | 对除Header和End外的所有的二进制数所对应的字节，每一个字节按照<span style="color:blue">无符号字节</span>数据进行求和。用于校验参数是否正确。 |
| End              | 0xf5f6f7f8 | 4个字节，用于标识一个数据包的结束                            |

